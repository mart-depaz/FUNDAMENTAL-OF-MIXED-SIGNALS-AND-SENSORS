<!-- Biometric Registration Modal -->
<!-- This modal allows instructors to register or students to scan biometric for attendance -->

<div class="modal fade" id="biometricRegistrationModal" tabindex="-1" role="dialog" aria-labelledby="biometricRegistrationTitle" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="biometricRegistrationTitle">
                    <i class="fas fa-fingerprint"></i> Biometric Registration
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            
            <div class="modal-body">
                <!-- Tab Navigation -->
                <ul class="nav nav-tabs mb-3" id="biometricTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="register-tab" data-bs-toggle="tab" data-bs-target="#registerPane" 
                                type="button" role="tab" aria-controls="registerPane" aria-selected="true">
                            <i class="fas fa-plus-circle"></i> Register Fingerprint
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="scan-tab" data-bs-toggle="tab" data-bs-target="#scanPane" 
                                type="button" role="tab" aria-controls="scanPane" aria-selected="false">
                            <i class="fas fa-hand-fist"></i> Scan Attendance
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="info-tab" data-bs-toggle="tab" data-bs-target="#infoPane" 
                                type="button" role="tab" aria-controls="infoPane" aria-selected="false">
                            <i class="fas fa-info-circle"></i> Instructions
                        </button>
                    </li>
                </ul>
                
                <!-- Tab Content -->
                <div class="tab-content" id="biometricTabContent">
                    
                    <!-- Register Fingerprint Tab -->
                    <div class="tab-pane fade show active" id="registerPane" role="tabpanel" aria-labelledby="register-tab">
                        <form id="biometricRegisterForm">
                            <div class="form-group mb-3">
                                <label for="biometricCourseSelect" class="form-label">Select Course</label>
                                <select class="form-select" id="biometricCourseSelect" required>
                                    <option value="">-- Select a course --</option>
                                </select>
                                <small class="text-muted">Choose the course where you want to register your fingerprint</small>
                            </div>
                            
                            <div class="card border-info mb-3">
                                <div class="card-body text-center">
                                    <div id="biometricRegisterStatus" class="alert alert-info mb-3" style="display:none;">
                                        <strong>Status:</strong> <span id="registerStatusText"></span>
                                    </div>
                                    
                                    <div class="biometric-visual mb-3">
                                        <div id="fingerprintCircle" style="width: 150px; height: 150px; margin: 0 auto; border: 3px dashed #ccc; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 48px; color: #ccc;">
                                            <i class="fas fa-fingerprint"></i>
                                        </div>
                                    </div>
                                    
                                    <p class="text-muted mb-3">
                                        Place your finger on the ESP32 fingerprint sensor<br>
                                        <small>You will need to scan 3 times for complete enrollment</small>
                                    </p>
                                    
                                    <button type="button" class="btn btn-primary" id="startBiometricRegisterBtn">
                                        <i class="fas fa-play"></i> Start Registration
                                    </button>
                                    <button type="button" class="btn btn-success" id="confirmBiometricRegisterBtn" style="display:none;">
                                        <i class="fas fa-check"></i> Confirm & Save Fingerprint
                                    </button>
                                </div>
                            </div>
                            
                            <div id="biometricRegisterProgress" style="display:none;">
                                <div class="progress mb-3">
                                    <div id="registerProgressBar" class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                                <p id="registerProgressText" class="text-center text-muted"></p>
                                <div id="scanDetailsArea" class="mt-3" style="max-height: 150px; overflow-y: auto;">
                                    <div id="scanDetailsList"></div>
                                </div>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Scan Attendance Tab -->
                    <div class="tab-pane fade" id="scanPane" role="tabpanel" aria-labelledby="scan-tab">
                        <form id="biometricScanForm">
                            <div class="form-group mb-3">
                                <label for="scanCourseSelect" class="form-label">Select Course</label>
                                <select class="form-select" id="scanCourseSelect" required>
                                    <option value="">-- Select a course --</option>
                                </select>
                            </div>
                            
                            <div class="card border-success mb-3">
                                <div class="card-body text-center">
                                    <div id="biometricScanStatus" class="alert alert-info mb-3" style="display:none;">
                                        <strong>Status:</strong> <span id="scanStatusText"></span>
                                    </div>
                                    
                                    <div class="biometric-visual mb-3">
                                        <div id="scanFingerprintCircle" style="width: 150px; height: 150px; margin: 0 auto; border: 3px solid #28a745; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 48px; color: #28a745;">
                                            <i class="fas fa-fingerprint"></i>
                                        </div>
                                    </div>
                                    
                                    <p class="text-muted mb-3">
                                        Place your finger on the sensor to mark attendance<br>
                                        <small>Make sure your fingerprint is already registered for this course</small>
                                    </p>
                                    
                                    <button type="button" class="btn btn-success" id="startBiometricScanBtn">
                                        <i class="fas fa-hand-fist"></i> Start Scan
                                    </button>
                                </div>
                            </div>
                            
                            <div id="biometricScanProgress" style="display:none;">
                                <div class="progress mb-3">
                                    <div id="scanProgressBar" class="progress-bar bg-success" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                                <p id="scanProgressText" class="text-center text-muted"></p>
                            </div>
                            
                            <div id="scanResultsDiv" style="display:none;" class="mt-3">
                                <div id="scanResultAlert" class="alert" role="alert">
                                    <strong id="scanResultTitle"></strong>
                                    <p id="scanResultMessage"></p>
                                </div>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Instructions Tab -->
                    <div class="tab-pane fade" id="infoPane" role="tabpanel" aria-labelledby="info-tab">
                        <div class="card">
                            <div class="card-body">
                                <h6><i class="fas fa-list"></i> Biometric Attendance System - Instructions</h6>
                                
                                <hr>
                                
                                <h7 class="text-primary"><strong>Step 1: Register Your Fingerprint</strong></h7>
                                <ol>
                                    <li>Go to the "Register Fingerprint" tab</li>
                                    <li>Select the course where you want to register</li>
                                    <li>Click "Start Registration"</li>
                                    <li>Place your finger on the ESP32 fingerprint sensor</li>
                                    <li>Follow the on-screen instructions to complete the scan</li>
                                    <li>You may be asked to scan twice for confirmation</li>
                                </ol>
                                
                                <hr>
                                
                                <h7 class="text-success"><strong>Step 2: Mark Attendance Using Biometric</strong></h7>
                                <ol>
                                    <li>Go to the "Scan Attendance" tab</li>
                                    <li>Select the course</li>
                                    <li>Click "Start Scan"</li>
                                    <li>Place your finger on the sensor</li>
                                    <li>Wait for the system to verify your fingerprint</li>
                                    <li>Your attendance will be marked automatically</li>
                                </ol>
                                
                                <hr>
                                
                                <div class="alert alert-info">
                                    <strong><i class="fas fa-lightbulb"></i> Tips:</strong>
                                    <ul>
                                        <li>Keep your finger clean and dry for best results</li>
                                        <li>Place your entire fingertip on the sensor</li>
                                        <li>Make sure there's good lighting in the area</li>
                                        <li>If scan fails, try again with a different finger or adjust the angle</li>
                                    </ul>
                                </div>
                                
                                <div class="alert alert-warning">
                                    <strong><i class="fas fa-exclamation-triangle"></i> Important:</strong>
                                    <ul>
                                        <li>Your biometric data is encrypted and securely stored</li>
                                        <li>You can only register one fingerprint per course</li>
                                        <li>If you change your fingerprint, ask your instructor to re-register you</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="biometricModalSubmitBtn" style="display:none;">Submit</button>
            </div>
        </div>
    </div>
</div>

<script>
// ===== API URL HELPER - Works with Cloudflare Tunnel or Localhost =====
function getApiBaseUrl() {
    // Check if on Cloudflare tunnel (named tunnels or quick tunnels)
    if (window.location.hostname.includes('cfargotunnel.com') || 
        window.location.hostname.includes('trycloudflare.com')) {
        // Use current domain (Cloudflare tunnel will proxy to Django)
        console.log('[Frontend] ✓ Using Cloudflare tunnel API:', window.location.origin);
        return window.location.origin;
    }
    // Check if NOT localhost (custom domain without Cloudflare)
    if (!window.location.hostname.includes('localhost') && 
        !window.location.hostname.includes('127.0.0.1') &&
        !window.location.hostname.includes('192.168')) {
        // Using custom domain
        console.log('[Frontend] ✓ Using custom domain API:', window.location.origin);
        return window.location.origin;
    }
    // Fallback for localhost development
    const localApi = 'http://localhost:8000';
    console.log('[Frontend] ✓ Using localhost API:', localApi);
    return localApi;
}

const API_BASE_URL = getApiBaseUrl();

let enrollmentState = {
    enrollmentId: null,
    courseId: null,
    currentScan: 0,
    isEnrolling: false,
    eventSource: null,
    pollInterval: null,
    lastKnownProgress: -1,  // Track last progress to detect changes
    lastKnownScan: -1,      // Track last scan to detect changes
    readyForConfirmation: false,  // Track if we're waiting for confirmation
    pollCount: 0  // Debug: count polling attempts
};

document.addEventListener('DOMContentLoaded', function() {
    const biometricModal = document.getElementById('biometricRegistrationModal');
    if (!biometricModal) return;
    
    function populateCourseSelects() {
        const courseSelects = document.querySelectorAll('#biometricCourseSelect, #scanCourseSelect');
        
        courseSelects.forEach(select => {
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            const enrolledCourses = window.enrolledCourses || [];
            enrolledCourses.forEach(course => {
                const option = document.createElement('option');
                option.value = course.id;
                option.textContent = `${course.code} - ${course.name}`;
                select.appendChild(option);
            });
        });
    }
    
    populateCourseSelects();
    
    // Register Fingerprint Button
    document.getElementById('startBiometricRegisterBtn')?.addEventListener('click', function() {
        const courseId = document.getElementById('biometricCourseSelect').value;
        if (!courseId) {
            alert('Please select a course');
            return;
        }
        
        startBiometricRegistration(courseId);
    });
    
    // Confirm & Save Fingerprint Button
    document.getElementById('confirmBiometricRegisterBtn')?.addEventListener('click', function() {
        confirmAndSaveFingerprint();
    });
    
    // Start Biometric Scan Button
    document.getElementById('startBiometricScanBtn')?.addEventListener('click', function() {
        const courseId = document.getElementById('scanCourseSelect').value;
        if (!courseId) {
            alert('Please select a course');
            return;
        }
        
        startBiometricScan(courseId);
    });
});

function startBiometricRegistration(courseId) {
    const status = document.getElementById('biometricRegisterStatus');
    const statusText = document.getElementById('registerStatusText');
    const progress = document.getElementById('biometricRegisterProgress');
    const progressBar = document.getElementById('registerProgressBar');
    const progressText = document.getElementById('registerProgressText');
    const startBtn = document.getElementById('startBiometricRegisterBtn');
    const confirmBtn = document.getElementById('confirmBiometricRegisterBtn');
    
    // Reset state
    enrollmentState.currentScan = 0;
    enrollmentState.lastKnownProgress = -1;
    enrollmentState.lastKnownScan = -1;
    enrollmentState.readyForConfirmation = false;
    enrollmentState.pollCount = 0;
    
    // Disable start button
    startBtn.disabled = true;
    confirmBtn.style.display = 'none';
    
    status.style.display = 'block';
    progress.style.display = 'block';
    
    statusText.textContent = 'Initializing enrollment...';
    progressBar.style.width = '0%';
    progressBar.setAttribute('aria-valuenow', '0');
    progressText.textContent = 'Connecting to sensor...';
    
    enrollmentState.courseId = courseId;
    enrollmentState.isEnrolling = true;
    
    console.log('[Frontend] ✓ Starting biometric registration for course:', courseId);
    
    // Send enrollment request to ESP32
    fetch(`${API_BASE_URL}/api/start-enrollment/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            course_id: courseId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            enrollmentState.enrollmentId = data.enrollment_id;
            statusText.textContent = 'Place your finger on the sensor...';
            
            console.log('[Frontend] ✓ Enrollment started');
            console.log('[Frontend]   enrollmentId:', enrollmentState.enrollmentId);
            console.log('[Frontend]   slot:', data.slot);
            
            // Listen for real-time updates from Django
            listenForEnrollmentUpdates();
        } else {
            // Check if enrollment is blocked (another student is processing)
            if (data.status === 'blocked' || data.message.includes('already in progress')) {
                statusText.innerHTML = '<i class="fas fa-hourglass-half text-warning"></i> Another student is currently enrolling. Please wait...';
                progressBar.style.width = '50%';
                console.log('[Frontend] ⚠ Enrollment blocked: another student is processing');
                
                // Show a retry button after a delay
                setTimeout(() => {
                    startBtn.textContent = 'Try Again';
                    startBtn.disabled = false;
                }, 3000);
            } else {
                statusText.innerHTML = '<i class="fas fa-times-circle text-danger"></i> Error: ' + data.message;
                progressBar.style.width = '100%';
                startBtn.disabled = false;
                console.error('[Frontend] ✗ Error starting enrollment:', data.message);
            }
            
            // Reset enrollment flag on error
            enrollmentState.isEnrolling = false;
        }
    })
    .catch(error => {
        console.error('[Frontend] ✗ Network error:', error);
        statusText.textContent = 'Connection error: ' + error.message;
        startBtn.disabled = false;
        enrollmentState.isEnrolling = false;
    });
}


function listenForEnrollmentUpdates() {
    const progressBar = document.getElementById('registerProgressBar');
    const progressText = document.getElementById('registerProgressText');
    const statusText = document.getElementById('registerStatusText');
    const scanDetailsList = document.getElementById('scanDetailsList');
    const confirmBtn = document.getElementById('confirmBiometricRegisterBtn');
    const startBtn = document.getElementById('startBiometricRegisterBtn');
    
    // Clear previous details
    scanDetailsList.innerHTML = '';
    
    const enrollmentId = enrollmentState.enrollmentId;
    console.log('[Frontend] ✓ Starting to listen for enrollment updates:', enrollmentId);
    console.log('[Frontend] Polling interval: 200ms (optimized for 3-scan sequence)');
    
    // Clear previous event source if exists
    if (enrollmentState.eventSource) {
        enrollmentState.eventSource.close();
    }
    
    // Clear any existing poll interval
    if (enrollmentState.pollInterval) {
        clearInterval(enrollmentState.pollInterval);
    }
    
    let lastSeenScan = 0;  // Track last scan we've displayed
    let pollAttempts = 0;
    let maxFailures = 0;
    let confirmationCheckStarted = false;
    let confirmationCheckCount = 0;
    
    // CRITICAL: Create a function to do the actual polling
    const doPoll = () => {
        if (!enrollmentState.isEnrolling && !enrollmentState.readyForConfirmation) {
            console.log('[Frontend] ✓ Stopped polling - enrollment completed or cancelled');
            if (enrollmentState.pollInterval) {
                clearInterval(enrollmentState.pollInterval);
            }
            return false;  // Return false to indicate we should stop
        }
        
        pollAttempts++;
        enrollmentState.pollCount++;
        
        fetch(`${API_BASE_URL}/api/enrollment-status/${enrollmentId}/`, {
            method: 'GET',
            headers: { 
                'Cache-Control': 'no-cache',
                'Pragma': 'no-cache'
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                maxFailures = 0;  // Reset failure counter on success
                const scan = data.current_scan || 0;
                const progress = data.progress || 0;
                const message = data.message || '';
                const status = data.status || 'unknown';
                
                // CRITICAL FIX: Check if status is ready_for_confirmation
                if (status === 'ready_for_confirmation' || (scan === 3 && progress === 100 && message.includes('All scans'))) {
                    console.log(`[Frontend] ✓✓✓ CONFIRMATION STATE DETECTED - status=${status}, scan=${scan}, progress=${progress}%`);
                    
                    if (!confirmationCheckStarted) {
                        confirmationCheckStarted = true;
                        confirmationCheckCount = 0;
                        console.log('[Frontend] ✓ Entering confirmation state - starting aggressive polling');
                    }
                    
                    // In confirmation state, poll MORE FREQUENTLY to catch user clicking confirm button
                    confirmationCheckCount++;
                    
                    // Always update UI when ready for confirmation
                    progressBar.style.width = '100%';
                    progressBar.setAttribute('aria-valuenow', '100');
                    progressText.textContent = 'All 3 scans completed! Click "Confirm & Save" to store the fingerprint.';
                    statusText.innerHTML = '<i class="fas fa-check-circle text-success"></i> All scans captured successfully!';
                    
                    confirmBtn.style.display = 'inline-block';
                    startBtn.disabled = false;
                    
                    // Set flag that we're ready for confirmation (don't stop polling yet!)
                    enrollmentState.readyForConfirmation = true;
                    // CRITICAL: Keep enrolling flag ON so polling continues
                    // Don't stop polling until user confirms
                    
                    return true;  // Continue polling (waiting for confirm button click)
                }
                
                // If we were in confirmation but status changed, handle it
                if (confirmationCheckStarted && status !== 'ready_for_confirmation') {
                    console.log(`[Frontend] ✓ Status changed from confirmation: ${status}`);
                    confirmationCheckStarted = false;
                }
                
                // Log only when data changes (to reduce console spam)
                if (scan !== lastSeenScan || progress !== enrollmentState.lastKnownProgress) {
                    console.log(`[Frontend] ✓ Poll #${pollAttempts}: status=${status}, scan=${scan}/3, progress=${progress}%, message="${message}"`);
                    enrollmentState.lastKnownScan = scan;
                    enrollmentState.lastKnownProgress = progress;
                    lastSeenScan = scan;
                }
                
                // CRITICAL DEBUG: If stuck at scan 2, log it
                if (scan === 2 && pollAttempts > 20) {
                    console.warn(`[Frontend] ⚠️ STUCK AT SCAN 2/3 after ${pollAttempts} polls - backend might not have received step 3`);
                    console.warn(`[Frontend]   Current state: scan=${scan}, progress=${progress}%, status=${status}`);
                    console.warn(`[Frontend]   Message: "${message}"`);
                }
                
                if (status === 'processing' || status === 'in_progress') {
                    // Update progress bar
                    progressBar.style.width = progress + '%';
                    progressBar.setAttribute('aria-valuenow', progress);
                    
                    // Update progress text with message
                    progressText.textContent = `Scan ${scan}/3 - ${message}`;
                    statusText.textContent = `Scan ${scan}/3 in progress... Please keep your finger on the sensor`;
                    
                    // Add scan detail if new message
                    if (message && !document.querySelector(`[data-message="${message}"]`)) {
                        const detail = document.createElement('small');
                        detail.className = 'd-block text-muted mb-1';
                        detail.setAttribute('data-message', message);
                        detail.innerHTML = `<span style="color: #28a745;">✓</span> ${message}`;
                        scanDetailsList.appendChild(detail);
                        console.log('[Frontend] ✓ Added scan detail:', message);
                        
                        // Auto-scroll scan details to bottom
                        const scanDetailsArea = document.getElementById('scanDetailsArea');
                        if (scanDetailsArea) {
                            scanDetailsArea.scrollTop = scanDetailsArea.scrollHeight;
                        }
                    }
                } else if (status === 'completed') {
                    console.log('[Frontend] ✓ Enrollment completed');
                    progressBar.style.width = '100%';
                    progressBar.setAttribute('aria-valuenow', '100');
                    progressText.textContent = 'Enrollment completed successfully!';
                    statusText.innerHTML = '<i class="fas fa-check-circle text-success"></i> Enrollment completed successfully!';
                    
                    confirmBtn.style.display = 'inline-block';
                    startBtn.disabled = false;
                    enrollmentState.isEnrolling = false;
                    enrollmentState.readyForConfirmation = false;
                    return false;  // Stop polling
                } else if (status === 'failed') {
                    console.log('[Frontend] ✗ Enrollment failed:', data.error);
                    progressBar.style.width = '0%';
                    progressText.textContent = 'Enrollment failed: ' + (data.error || 'Unknown error');
                    statusText.innerHTML = '<i class="fas fa-times-circle text-danger"></i> ' + (data.error || 'Enrollment failed');
                    
                    startBtn.disabled = false;
                    enrollmentState.isEnrolling = false;
                    enrollmentState.readyForConfirmation = false;
                    return false;  // Stop polling
                } else if (status === 'not_found') {
                    if (pollAttempts === 1) {
                        console.log('[Frontend] ⏳ Waiting for enrollment to be created in backend...');
                    }
                }
                return true;  // Continue polling
            })
            .catch(error => {
                maxFailures++;
                if (maxFailures <= 3) {
                    console.warn('[Frontend] ⚠ Poll error (attempt ' + maxFailures + '):', error.message);
                } else if (maxFailures === 4) {
                    console.error('[Frontend] ✗ Multiple poll failures - enrollment may have lost connection');
                    statusText.innerHTML = '<i class="fas fa-exclamation-circle text-danger"></i> Connection lost. Please try again.';
                    startBtn.disabled = false;
                    enrollmentState.isEnrolling = false;
                    enrollmentState.readyForConfirmation = false;
                    return false;  // Stop polling
                }
                return true;  // Continue polling
            });
    };
    
    // CRITICAL FIX: Poll IMMEDIATELY on first call (don't wait 200ms!)
    console.log('[Frontend] ✓ Doing immediate first poll to catch first scan...');
    doPoll();
    
    // Then poll every 100ms for faster updates via Cloudflare tunnel (was 200ms)
    // Cloudflare tunnel is faster and more reliable than MQTT delays
    enrollmentState.pollInterval = setInterval(() => {
        // If in confirmation state, increase poll frequency to every 100ms for faster responsiveness
        const shouldContinue = doPoll();
        if (!shouldContinue && !enrollmentState.readyForConfirmation) {
            clearInterval(enrollmentState.pollInterval);
            enrollmentState.pollInterval = null;
        }
    }, 100);  // Changed from 200ms to 100ms for faster updates via Cloudflare tunnel
}


function confirmAndSaveFingerprint() {
    const enrollmentId = enrollmentState.enrollmentId;
    const courseId = enrollmentState.courseId;
    const confirmBtn = document.getElementById('confirmBiometricRegisterBtn');
    const statusText = document.getElementById('registerStatusText');
    const startBtn = document.getElementById('startBiometricRegisterBtn');
    
    confirmBtn.disabled = true;
    statusText.textContent = 'Saving fingerprint to database...';
    
    console.log('[Frontend] ✓ Confirm button clicked - saving enrollment');
    console.log('[Frontend]   enrollmentId:', enrollmentId);
    console.log('[Frontend]   courseId:', courseId);
    
    // Stop polling immediately when user confirms
    if (enrollmentState.pollInterval) {
        clearInterval(enrollmentState.pollInterval);
        enrollmentState.pollInterval = null;
        console.log('[Frontend] ✓ Stopped polling');
    }
    
    // Stop enrollment flag
    enrollmentState.isEnrolling = false;
    enrollmentState.readyForConfirmation = false;
    
    // Call API to save fingerprint to instructor and courses
    fetch(`${API_BASE_URL}/api/save-enrollment/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            enrollment_id: enrollmentId,
            course_id: courseId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('[Frontend] ✓✓✓ Fingerprint saved successfully!');
            statusText.innerHTML = '<i class="fas fa-check-circle text-success"></i> Fingerprint saved successfully to your profile and courses!';
            confirmBtn.style.display = 'none';
            
            // Show success for 2 seconds then close
            setTimeout(() => {
                try {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('biometricRegistrationModal'));
                    if (modal) {
                        modal.hide();
                    }
                    // Reload after short delay to show updated UI
                    setTimeout(() => {
                        location.reload();
                    }, 500);
                } catch (e) {
                    console.log('Modal close error:', e);
                    location.reload();
                }
            }, 2000);
        } else {
            console.error('[Frontend] ✗ Error saving fingerprint:', data.message);
            statusText.innerHTML = '<i class="fas fa-exclamation-circle text-danger"></i> Error: ' + data.message;
            confirmBtn.disabled = false;
            
            // Re-enable polling in case user wants to try again
            enrollmentState.isEnrolling = true;
            enrollmentState.readyForConfirmation = true;
        }
    })
    .catch(error => {
        console.error('[Frontend] ✗ Network error saving fingerprint:', error);
        statusText.innerHTML = '<i class="fas fa-exclamation-circle text-danger"></i> Error saving fingerprint: ' + error.message;
        confirmBtn.disabled = false;
        
        // Re-enable polling in case user wants to try again
        enrollmentState.isEnrolling = true;
        enrollmentState.readyForConfirmation = true;
    });
}


function startBiometricScan(courseId) {
    const status = document.getElementById('biometricScanStatus');
    const statusText = document.getElementById('scanStatusText');
    const progress = document.getElementById('biometricScanProgress');
    const progressBar = document.getElementById('scanProgressBar');
    const progressText = document.getElementById('scanProgressText');
    
    status.style.display = 'block';
    progress.style.display = 'block';
    
    statusText.textContent = 'Scanning fingerprint...';
    progressBar.style.width = '50%';
    progressText.textContent = 'Comparing with registered fingerprint...';
    
    setTimeout(() => {
        progressBar.style.width = '100%';
        progressText.textContent = 'Scan complete!';
        
        recordBiometricAttendance(courseId);
    }, 15000);  // Increased from 8000ms (8s) to 15000ms (15s) for more stable scanning
}

function recordBiometricAttendance(courseId) {
    const resultDiv = document.getElementById('scanResultsDiv');
    const resultAlert = document.getElementById('scanResultAlert');
    const resultTitle = document.getElementById('scanResultTitle');
    const resultMessage = document.getElementById('scanResultMessage');
    
    resultDiv.style.display = 'block';
    resultAlert.classList.remove('alert-danger', 'alert-warning', 'alert-success', 'alert-info');
    resultAlert.classList.add('alert-success');
    
    resultTitle.textContent = '✓ Attendance Recorded';
    resultMessage.textContent = 'Your attendance has been successfully marked via biometric scan.';
    
    console.log('Attendance recorded for course:', courseId);
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

<style>
.biometric-visual {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% {
        opacity: 1;
    }
    50% {
        opacity: 0.7;
    }
}

.modal-body .nav-tabs .nav-link {
    border-bottom: 2px solid transparent;
    transition: all 0.3s ease;
}

.modal-body .nav-tabs .nav-link:hover {
    border-color: #0d6efd;
    color: #0d6efd;
}

.modal-body .nav-tabs .nav-link.active {
    border-bottom-color: #0d6efd;
}
</style>
