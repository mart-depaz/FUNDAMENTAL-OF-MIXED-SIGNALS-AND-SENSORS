<!-- Notification System - Complete Rebuild -->
{% load tz %}
{% timezone "Asia/Manila" %}

<style>
.notification-item {
    position: relative;
    transition: all 0.2s ease;
    cursor: pointer;
}

.notification-item:hover {
    background-color: #f9fafb;
}

.animate-fade-out {
    animation: fadeOut 0.3s ease-out forwards;
}

@keyframes fadeOut {
    from {
        opacity: 1;
        transform: translateX(0);
    }
    to {
        opacity: 0;
        transform: translateX(100%);
    }
}

.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
</style>

<!-- Action buttons -->
{% if notifications %}
<div class="mb-2 flex justify-between items-center px-3 py-2 border-b border-gray-200 bg-gray-50">
    <span class="text-[10px] font-semibold text-gray-600">
        <i class="fas fa-bell mr-1"></i>{{ notifications|length }} Notifications
    </span>
    <div class="flex items-center gap-2">
        <button id="markAllReadBtn" type="button" onclick="markAllAsRead(); return false;" class="text-[10px] text-indigo-600 hover:text-indigo-800 font-semibold px-2 py-1 rounded hover:bg-indigo-50 transition">
            <i class="fas fa-check-double text-[10px] mr-1"></i> Mark All as Read
        </button>
        <button id="deleteAllBtn" type="button" onclick="showDeleteAllModal(); return false;" class="text-[10px] text-red-600 hover:text-red-800 font-semibold px-2 py-1 rounded hover:bg-red-50 transition">
            <i class="fas fa-trash-alt text-[10px] mr-1"></i> Delete All
        </button>
    </div>
</div>
{% endif %}

<!-- Notifications list -->
<div class="divide-y divide-gray-200">
    {% for notification in notifications %}
    <div class="notification-item flex items-start p-2.5 hover:bg-gray-50 transition duration-150 relative group {% if notification.is_read %}opacity-80{% endif %}" 
         data-notification-id="{{ notification.id }}">
        
        <!-- Unread indicator -->
        {% if not notification.is_read %}
        <div class="absolute top-2.5 left-0 w-0.5 h-full bg-indigo-600 rounded-r"></div>
        {% endif %}
        
        <!-- Avatar -->
        <div class="flex-shrink-0 mr-2.5">
            {% if notification.notification_type == 'student_enrolled' and notification.related_user %}
                {% if notification.related_user.profile_picture %}
                <img src="{{ notification.related_user.profile_picture.url }}" 
                     alt="{{ notification.related_user.full_name }}" 
                     class="w-8 h-8 rounded-full object-cover ring-1 {% if not notification.is_read %}ring-indigo-600{% else %}ring-gray-300{% endif %}"
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div class="w-8 h-8 rounded-full flex items-center justify-center font-bold text-[10px] text-white ring-1 {% if not notification.is_read %}ring-indigo-600{% else %}ring-gray-300{% endif %}" 
                     style="background-color: #10b981; display: none;">
                    {{ notification.related_user.full_name|first|upper }}
                </div>
                {% else %}
                <div class="w-8 h-8 rounded-full flex items-center justify-center font-bold text-[10px] text-white ring-1 {% if not notification.is_read %}ring-indigo-600{% else %}ring-gray-300{% endif %}" 
                     style="background-color: #10b981;">
                    {{ notification.related_user.full_name|first|upper }}
                </div>
                {% endif %}
            {% else %}
                <div class="w-8 h-8 rounded-full flex items-center justify-center ring-1 {% if not notification.is_read %}ring-indigo-600{% else %}ring-gray-300{% endif %}" 
                     style="background-color: {% if notification.notification_type == 'account_approved' or notification.notification_type == 'student_enrolled' %}#10b981{% elif notification.notification_type == 'account_rejected' or notification.notification_type == 'system_alert' %}#ef4444{% else %}#3b82f6{% endif %};">
                    <i class="fas {% if notification.notification_type == 'account_approved' or notification.notification_type == 'student_enrolled' %}fa-check-circle{% elif notification.notification_type == 'account_rejected' or notification.notification_type == 'system_alert' %}fa-exclamation-triangle{% else %}fa-info-circle{% endif %} text-white text-xs"></i>
                </div>
            {% endif %}
        </div>
        
        <!-- Content -->
        <div class="flex-1 min-w-0 pr-16 cursor-pointer notification-content">
            <div class="text-xs font-semibold {% if notification.is_read %}text-gray-400{% else %}text-gray-900{% endif %} truncate">
                {% if notification.notification_type == 'student_enrolled' and notification.related_user %}
                    {{ notification.related_user.full_name }}
                {% else %}
                    {{ notification.title }}
                {% endif %}
            </div>
            <p class="text-[11px] {% if notification.is_read %}text-gray-500{% else %}text-gray-700{% endif %} mt-0.5 line-clamp-2 leading-tight">
                {{ notification.message|default:notification.title }}
            </p>
            <div class="flex items-center gap-1.5 mt-1 text-[9px] {% if notification.is_read %}text-gray-400{% else %}text-gray-500{% endif %}">
                <span>{{ notification.created_at|date:"M d, Y" }}</span>
                <span>â€¢</span>
                <span>{{ notification.created_at|date:"g:i A" }}</span>
            </div>
        </div>
        
        <!-- Delete button -->
        <div class="absolute right-1 top-2 flex-shrink-0 z-10">
            <button type="button" class="deleteNotificationBtn text-gray-300 hover:text-red-600 transition p-0.5 rounded hover:bg-red-50" 
                    data-notification-id="{{ notification.id }}" 
                    title="Delete notification">
                <i class="fas fa-times text-[10px]"></i>
            </button>
        </div>
    </div>
    {% empty %}
    <div class="text-center py-8 text-gray-500">
        <i class="fas fa-bell-slash text-3xl mb-2"></i>
        <p class="text-xs">No notifications</p>
    </div>
    {% endfor %}
</div>

<!-- Delete All Modal -->
<div id="deleteAllModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6">
        <h3 class="text-lg font-bold text-red-600 mb-4">Delete All Notifications</h3>
        <p class="text-gray-700 mb-6">Are you sure you want to delete all notifications? This action cannot be undone.</p>
        <div class="flex justify-end gap-3">
            <button type="button" id="cancelDeleteAllBtn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                Cancel
            </button>
            <button type="button" id="confirmDeleteAllBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                Delete All
            </button>
        </div>
    </div>
</div>

<script>
// Global notification handlers
window.NotificationSystem = {
    csrfToken: function() {
        let token = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
        if (!token) {
            // Try to get from cookie
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'csrftoken') {
                    token = decodeURIComponent(value);
                    break;
                }
            }
        }
        return token || '';
    },

    markAsRead: function(notificationId) {
        console.log("NotificationSystem.markAsRead() - ID:", notificationId);
        const csrfToken = this.csrfToken();
        console.log("CSRF Token obtained:", csrfToken ? "âœ“" : "âœ—");
        const url = `/dashboard/notifications/${notificationId}/read/`;
        console.log("Fetching URL:", url);
        fetch(url, {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            console.log("Mark as read response status:", response.status);
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
        })
        .then(data => {
            console.log("Mark as read response data:", data);
            if (data.success) {
                // Reload notifications
                if (typeof loadNotifications === 'function') {
                    const dropdown = document.getElementById('notificationsDropdown');
                    if (dropdown) {
                        dropdown.dataset.loaded = 'false';
                    }
                    loadNotifications();
                }
                // Update badge
                if (typeof updateNotificationBadge === 'function') {
                    updateNotificationBadge();
                }
            }
        })
        .catch(error => console.error('Error marking notification as read:', error));
    },

    deleteNotification: function(notificationId) {
        console.log("NotificationSystem.deleteNotification() - ID:", notificationId);
        const csrfToken = this.csrfToken();
        const notificationEl = document.querySelector(`[data-notification-id="${notificationId}"]`);
        console.log("Notification element found:", notificationEl ? "âœ“" : "âœ—");
        
        if (notificationEl) {
            console.log("Adding fade-out animation");
            notificationEl.classList.add('animate-fade-out');
            
            setTimeout(() => {
                const url = `/dashboard/notifications/${notificationId}/delete/`;
                console.log("Fetching URL:", url);
                fetch(url, {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => {
                    console.log("Delete response status:", response.status);
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => {
                    console.log("Delete response data:", data);
                    console.log("Delete success:", data.success);
                    if (data.success) {
                        console.log("Notification deleted successfully, reloading notifications");
                        // Reload notifications
                        if (typeof loadNotifications === 'function') {
                            const dropdown = document.getElementById('notificationsDropdown');
                            if (dropdown) {
                                dropdown.dataset.loaded = 'false';
                            }
                            loadNotifications();
                        }
                        // Update badge
                        if (typeof updateNotificationBadge === 'function') {
                            updateNotificationBadge();
                        }
                    } else {
                        console.error('Delete response success is false');
                        notificationEl.classList.remove('animate-fade-out');
                        console.error('Failed to delete notification');
                    }
                })
                .catch(error => {
                    notificationEl.classList.remove('animate-fade-out');
                    console.error('Error deleting notification:', error);
                    console.error('Error details:', error.toString());
                    console.error('Stack trace:', error.stack);
                });
            }, 300);
        } else {
            console.warn(`Notification element not found for ID: ${notificationId}`);
        }
    },

    deleteAll: function() {
        console.log("NotificationSystem.deleteAll() - deleting all notifications");
        const csrfToken = this.csrfToken();
        fetch('/dashboard/notifications/delete-all/', {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Close modal
                document.getElementById('deleteAllModal').classList.add('hidden');
                // Reload notifications
                if (typeof loadNotifications === 'function') {
                    const dropdown = document.getElementById('notificationsDropdown');
                    if (dropdown) {
                        dropdown.dataset.loaded = 'false';
                    }
                    loadNotifications();
                }
                // Update badge
                if (typeof updateNotificationBadge === 'function') {
                    updateNotificationBadge();
                }
            }
        })
        .catch(error => console.error('Error deleting all notifications:', error));
    },

    markAllAsRead: function() {
        console.log("NotificationSystem.markAllAsRead() - marking all as read");
        const csrfToken = this.csrfToken();
        fetch('/dashboard/notifications/mark-all-read/', {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // Reload notifications
                if (typeof loadNotifications === 'function') {
                    const dropdown = document.getElementById('notificationsDropdown');
                    if (dropdown) {
                        dropdown.dataset.loaded = 'false';
                    }
                    loadNotifications();
                }
                // Update badge
                if (typeof updateNotificationBadge === 'function') {
                    updateNotificationBadge();
                }
            }
        })
        .catch(error => console.error('Error marking all notifications as read:', error));
    }
};

// Global functions for backward compatibility and onclick handlers
function markAsRead(notificationId) {
    console.log("markAsRead() called with ID:", notificationId);
    window.NotificationSystem.markAsRead(notificationId);
}

function deleteNotification(notificationId, eventObj) {
    console.log("deleteNotification() called with ID:", notificationId);
    if (eventObj) {
        eventObj.stopPropagation();
        eventObj.preventDefault();
    }
    window.NotificationSystem.deleteNotification(notificationId);
    return false;
}

function markAllAsRead() {
    console.log("markAllAsRead() called");
    window.NotificationSystem.markAllAsRead();
}

function deleteAll() {
    console.log("deleteAll() called - showing modal");
    document.getElementById('deleteAllModal').classList.remove('hidden');
}

function closeDeleteAllModal() {
    console.log("closeDeleteAllModal() called");
    document.getElementById('deleteAllModal').classList.add('hidden');
}

function showDeleteAllModal() {
    console.log("showDeleteAllModal() called");
    deleteAll();
}

function handleNotificationClick(notificationId, redirectUrl) {
    console.log("handleNotificationClick() called with ID:", notificationId, "URL:", redirectUrl);
    // Mark as read
    window.NotificationSystem.markAsRead(notificationId);
    
    // Then redirect if URL is provided
    if (redirectUrl && redirectUrl !== 'null' && redirectUrl !== '' && redirectUrl !== 'None') {
        setTimeout(() => {
            window.location.href = redirectUrl;
        }, 200);
    }
}

// Event listeners - Use event delegation for dynamically loaded content
function attachNotificationListeners() {
    console.log("attachNotificationListeners() called - attaching event handlers");
    
    // Delete individual notifications
    document.querySelectorAll('.deleteNotificationBtn').forEach(btn => {
        if (!btn.hasAttribute('data-listener-attached')) {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const notificationId = this.dataset.notificationId;
                window.NotificationSystem.deleteNotification(notificationId);
                return false;
            });
            btn.setAttribute('data-listener-attached', 'true');
        }
    });

    // Mark as read when clicking notification content
    document.querySelectorAll('.notification-content').forEach(content => {
        if (!content.hasAttribute('data-listener-attached')) {
            content.addEventListener('click', function(e) {
                const notificationItem = this.closest('[data-notification-id]');
                if (notificationItem) {
                    const notificationId = notificationItem.dataset.notificationId;
                    window.NotificationSystem.markAsRead(notificationId);
                }
            });
            content.setAttribute('data-listener-attached', 'true');
        }
    });

    // Modal buttons
    const cancelDeleteAllBtn = document.getElementById('cancelDeleteAllBtn');
    if (cancelDeleteAllBtn && !cancelDeleteAllBtn.hasAttribute('data-listener-attached')) {
        cancelDeleteAllBtn.addEventListener('click', closeDeleteAllModal);
        cancelDeleteAllBtn.setAttribute('data-listener-attached', 'true');
    }

    const confirmDeleteAllBtn = document.getElementById('confirmDeleteAllBtn');
    if (confirmDeleteAllBtn && !confirmDeleteAllBtn.hasAttribute('data-listener-attached')) {
        confirmDeleteAllBtn.addEventListener('click', function() {
            window.NotificationSystem.deleteAll();
        });
        confirmDeleteAllBtn.setAttribute('data-listener-attached', 'true');
    }

    // Close modal when clicking outside
    const modal = document.getElementById('deleteAllModal');
    if (modal && !modal.hasAttribute('data-listener-attached')) {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeDeleteAllModal();
            }
        });
        modal.setAttribute('data-listener-attached', 'true');
    }
}

// Attach listeners on page load
document.addEventListener('DOMContentLoaded', attachNotificationListeners);

// Also provide a function that the topbar can call after loading notifications
window.attachNotificationListeners = attachNotificationListeners;

// ========== DEBUGGING UTILITIES ==========
// Available in console with: window.NotificationDebug.help()
window.NotificationDebug = {
    /**
     * Show all available debug commands
     */
    help: function() {
        console.log(`
ðŸ“‹ NOTIFICATION SYSTEM DEBUG COMMANDS
=====================================

ðŸ”§ Setup & Inspection:
  NotificationDebug.inspect()           - Show current system state
  NotificationDebug.findCSRFToken()     - Find CSRF token
  NotificationDebug.listNotifications() - List all notifications
  NotificationDebug.checkListeners()    - Check event listeners

ðŸ§ª Tests:
  NotificationDebug.testDelete(id)      - Test delete for notification ID
  NotificationDebug.testMarkAsRead(id)  - Test mark as read for notification ID
  NotificationDebug.testReload()        - Test loadNotifications() function
  NotificationDebug.testAPI(id)         - Test raw API call

ðŸ› ï¸ Manual Actions:
  NotificationDebug.deleteNow(id)       - Delete notification immediately (skip animation)
  NotificationDebug.reloadNow()         - Reload notifications immediately
  NotificationDebug.reattachListeners() - Re-attach all event listeners
  NotificationDebug.clearAllLogs()      - Clear console

ðŸ“Š Stats:
  NotificationDebug.stats()             - Show system statistics
        `);
    },

    /**
     * Inspect current system state
     */
    inspect: function() {
        console.group('ðŸ” NOTIFICATION SYSTEM INSPECTION');
        
        console.group('CSRF Token');
        const csrfToken = window.NotificationSystem.csrfToken();
        console.log('Token found:', csrfToken ? 'âœ…' : 'âŒ');
        if (csrfToken) {
            console.log('Token preview:', csrfToken.substring(0, 30) + '...');
        }
        console.groupEnd();
        
        console.group('NotificationSystem Object');
        console.log('Object exists:', window.NotificationSystem ? 'âœ…' : 'âŒ');
        console.log('Methods available:', Object.keys(window.NotificationSystem).length);
        Object.keys(window.NotificationSystem).forEach(key => {
            console.log(`  - ${key}: ${typeof window.NotificationSystem[key]}`);
        });
        console.groupEnd();
        
        console.group('DOM Elements');
        const notifs = document.querySelectorAll('[data-notification-id]');
        console.log('Notification elements:', notifs.length);
        const deleteButtons = document.querySelectorAll('.deleteNotificationBtn');
        console.log('Delete buttons:', deleteButtons.length);
        const dropdown = document.getElementById('notificationsDropdown');
        console.log('Dropdown exists:', dropdown ? 'âœ…' : 'âŒ');
        console.groupEnd();
        
        console.group('Functions');
        console.log('loadNotifications:', typeof window.loadNotifications);
        console.log('updateNotificationBadge:', typeof window.updateNotificationBadge);
        console.log('attachNotificationListeners:', typeof window.attachNotificationListeners);
        console.groupEnd();
        
        console.groupEnd();
    },

    /**
     * Find CSRF token
     */
    findCSRFToken: function() {
        console.group('ðŸ” CSRF Token Lookup');
        
        let token = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
        if (token) {
            console.log('âœ… Found in hidden input field');
            console.log('Token:', token);
            return token;
        }
        
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            const [name, value] = cookie.trim().split('=');
            if (name === 'csrftoken') {
                token = decodeURIComponent(value);
                console.log('âœ… Found in cookies');
                console.log('Token:', token);
                console.groupEnd();
                return token;
            }
        }
        
        console.log('âŒ CSRF token not found!');
        console.log('Available cookies:', document.cookie);
        console.groupEnd();
        return null;
    },

    /**
     * List all notifications in the DOM
     */
    listNotifications: function() {
        console.group('ðŸ“ All Notifications');
        const notifs = document.querySelectorAll('[data-notification-id]');
        console.log('Total:', notifs.length);
        
        notifs.forEach((notif, i) => {
            const id = notif.dataset.notificationId;
            const title = notif.querySelector('.text-xs')?.textContent || 'Unknown';
            const isRead = notif.classList.contains('opacity-50');
            console.log(`[${i+1}] ID: ${id} | Title: ${title} | Read: ${isRead ? 'âœ…' : 'âŒ'}`);
        });
        
        console.groupEnd();
    },

    /**
     * Check if event listeners are attached
     */
    checkListeners: function() {
        console.group('ðŸŽ¯ Event Listeners');
        
        const deleteButtons = document.querySelectorAll('.deleteNotificationBtn');
        console.log('Delete buttons with listeners:');
        
        let attached = 0;
        deleteButtons.forEach((btn, i) => {
            const hasListener = btn.hasAttribute('data-listener-attached');
            const hasAttribute = hasListener ? 'âœ…' : 'âŒ';
            console.log(`  [${i+1}] ID: ${btn.dataset.notificationId} - ${hasAttribute}`);
            if (hasListener) attached++;
        });
        
        console.log(`Total with listeners: ${attached}/${deleteButtons.length}`);
        console.groupEnd();
    },

    /**
     * Test delete API
     */
    testDelete: async function(notificationId) {
        console.group(`ðŸ§ª Testing Delete for Notification ${notificationId}`);
        
        const csrfToken = window.NotificationSystem.csrfToken();
        if (!csrfToken) {
            console.error('âŒ CSRF token not found');
            console.groupEnd();
            return;
        }
        
        const url = `/dashboard/notifications/${notificationId}/delete/`;
        console.log('URL:', url);
        
        try {
            const response = await fetch(url, {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json',
                }
            });
            
            console.log('Response status:', response.status, response.ok ? 'âœ…' : 'âŒ');
            const data = await response.json();
            console.log('Response data:', data);
            
            if (data.success) {
                console.log('âœ… DELETE SUCCESSFUL');
            } else {
                console.log('âŒ Delete failed:', data.message);
            }
        } catch (error) {
            console.error('âŒ Fetch error:', error);
        }
        
        console.groupEnd();
    },

    /**
     * Test mark as read API
     */
    testMarkAsRead: async function(notificationId) {
        console.group(`ðŸ§ª Testing Mark As Read for Notification ${notificationId}`);
        
        const csrfToken = window.NotificationSystem.csrfToken();
        const url = `/dashboard/notifications/${notificationId}/read/`;
        
        try {
            const response = await fetch(url, {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json',
                }
            });
            
            console.log('Response status:', response.status);
            const data = await response.json();
            console.log('Response:', data);
            
            if (data.success) {
                console.log('âœ… MARK AS READ SUCCESSFUL');
            }
        } catch (error) {
            console.error('âŒ Error:', error);
        }
        
        console.groupEnd();
    },

    /**
     * Test if loadNotifications function works
     */
    testReload: function() {
        console.group('ðŸ§ª Testing Reload Function');
        
        if (typeof window.loadNotifications === 'function') {
            console.log('âœ… loadNotifications function exists');
            try {
                window.loadNotifications();
                console.log('âœ… loadNotifications() executed');
            } catch (error) {
                console.error('âŒ Error calling loadNotifications():', error);
            }
        } else {
            console.log('âŒ loadNotifications function not found');
            console.log('Available window functions:', 
                Object.getOwnPropertyNames(window).filter(n => typeof window[n] === 'function').slice(0, 20));
        }
        
        console.groupEnd();
    },

    /**
     * Delete notification immediately without animation
     */
    deleteNow: function(notificationId) {
        console.log(`âš¡ Deleting notification ${notificationId} immediately...`);
        
        const csrfToken = window.NotificationSystem.csrfToken();
        const url = `/dashboard/notifications/${notificationId}/delete/`;
        
        fetch(url, {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json',
            }
        })
        .then(r => r.json())
        .then(d => {
            if (d.success) {
                console.log('âœ… Deleted, reloading...');
                if (typeof window.loadNotifications === 'function') {
                    const dropdown = document.getElementById('notificationsDropdown');
                    if (dropdown) dropdown.dataset.loaded = 'false';
                    window.loadNotifications();
                }
            }
        })
        .catch(e => console.error('Error:', e));
    },

    /**
     * Reload notifications immediately
     */
    reloadNow: function() {
        console.log('ðŸ”„ Reloading notifications...');
        const dropdown = document.getElementById('notificationsDropdown');
        if (dropdown) dropdown.dataset.loaded = 'false';
        if (typeof window.loadNotifications === 'function') {
            window.loadNotifications();
        }
    },

    /**
     * Reattach all event listeners
     */
    reattachListeners: function() {
        console.log('ðŸ”Œ Reattaching event listeners...');
        if (typeof window.attachNotificationListeners === 'function') {
            window.attachNotificationListeners();
            console.log('âœ… Listeners reattached');
        }
    },

    /**
     * Show system statistics
     */
    stats: function() {
        const notifs = document.querySelectorAll('[data-notification-id]');
        const unread = Array.from(notifs).filter(n => !n.classList.contains('opacity-50')).length;
        
        console.table({
            'Total Notifications': notifs.length,
            'Unread': unread,
            'Read': notifs.length - unread,
            'Delete Buttons': document.querySelectorAll('.deleteNotificationBtn').length,
            'Listeners Attached': Array.from(document.querySelectorAll('.deleteNotificationBtn'))
                .filter(b => b.hasAttribute('data-listener-attached')).length
        });
    }
};

// Make help available easily
window.NotificationSystem.help = () => window.NotificationDebug.help();

</script>

{% endtimezone %}
