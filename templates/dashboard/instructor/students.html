{% extends 'dashboard/instructor/teacher.html' %}
{% load dashboard_filters %}
{% block title %}Students Management{% endblock %}
{% block dashboard_content %}
<!-- Notification System -->
{% include 'dashboard/shared/notification_system.html' %}

<style>
    /* Course Card Animations - Match Manage Courses */
    .course-card-wrapper {
        animation: fadeInScale 0.4s ease-out;
        animation-fill-mode: both;
    }
    .course-card-wrapper:nth-child(1) { animation-delay: 0.05s; }
    .course-card-wrapper:nth-child(2) { animation-delay: 0.1s; }
    .course-card-wrapper:nth-child(3) { animation-delay: 0.15s; }
    .course-card-wrapper:nth-child(4) { animation-delay: 0.2s; }
    .course-card-wrapper:nth-child(5) { animation-delay: 0.25s; }
    .course-card-wrapper:nth-child(6) { animation-delay: 0.3s; }
    .course-card-wrapper:nth-child(n+7) { animation-delay: 0.35s; }
    
    @keyframes fadeInScale {
        from {
            opacity: 0;
            transform: scale(0.95) translateY(10px);
        }
        to {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
    }
    
    /* Glow animation for multi-section courses */
    @keyframes glowPulse {
        0%   { box-shadow: 0 0 0px rgba(255,255,255,0.0), 0 0 0px var(--course-color-end, #ffffff00); }
        50%  { box-shadow: 0 0 18px rgba(255,255,255,0.35), 0 0 28px var(--course-color-end, #ffffff55); }
        100% { box-shadow: 0 0 0px rgba(255,255,255,0.0), 0 0 0px var(--course-color-end, #ffffff00); }
    }
    .multi-section-glow::after {
        content: "";
        position: absolute;
        inset: -2px;
        border-radius: 1.25rem; /* match rounded-2xl */
        animation: glowPulse 2.2s ease-in-out infinite;
        pointer-events: none;
    }
    
    /* Twinkling star overlay - REMOVED */
    
    /* Course Card Block Styling - Match Manage Courses */
    .course-card-block {
        position: relative;
        transform-style: preserve-3d;
        background: linear-gradient(135deg, var(--course-color-start, #3C4770) 0%, var(--course-color-end, #447294) 100%);
    }
    .course-card-block:hover {
        transform: translateY(-8px) scale(1.02);
    }
    .course-card-block::before {
        content: '';
        position: absolute;
        inset: -2px;
        border-radius: inherit;
        padding: 2px;
        background: linear-gradient(135deg, rgba(255,255,255,0.3), rgba(255,255,255,0.1));
        -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
        mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
        -webkit-mask-composite: xor;
        mask-composite: exclude;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
    }
    .course-card-block:hover::before {
        opacity: 1;
    }
    
    /* Course Card Title Styling - Match Manage Courses */
    .course-card-title {
        font-size: 0.95rem;
        font-weight: 700;
        color: white;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        word-wrap: break-word;
        overflow-wrap: break-word;
        hyphens: auto;
    }

    /* Transfer Students Modal Styles */
    .transfer-modal-student-item {
        display: flex;
        align-items: center;
        padding: 0.75rem;
        border: 1px solid #e5e7eb;
        border-radius: 0.75rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .transfer-modal-student-item:hover {
        background-color: #f3f4f6;
        border-color: #d1d5db;
    }

    .transfer-modal-student-item.selected {
        background-color: #dbeafe;
        border-color: #3b82f6;
    }

    .transfer-modal-student-item input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
        margin-right: 0.75rem;
    }

    .transfer-modal-student-list {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #e5e7eb;
        border-radius: 0.75rem;
        padding: 0.5rem;
        background: white;
    }

    /* Custom Scrollbar Styling for Transfer Modal */
    .transfer-modal-student-list::-webkit-scrollbar {
        width: 8px;
    }

    .transfer-modal-student-list::-webkit-scrollbar-track {
        background: #f3f4f6;
        border-radius: 0.75rem;
    }

    .transfer-modal-student-list::-webkit-scrollbar-thumb {
        background: #be8199;
        border-radius: 0.75rem;
    }

    .transfer-modal-student-list::-webkit-scrollbar-thumb:hover {
        background: #a1687d;
    }

    /* Student Search Styles */
    .animate-fadeIn {
        animation: fadeInStudent 0.3s ease-in;
    }

    @keyframes fadeInStudent {
        from {
            opacity: 0;
            transform: translateY(-5px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    #student-search-input {
        transition: all 0.3s ease;
    }

    #student-search-input:focus {
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    #clear-search-btn {
        cursor: pointer;
        padding: 0.25rem;
        border-radius: 0.25rem;
    }

    #clear-search-btn:hover {
        background-color: rgba(156, 163, 175, 0.1);
    }

    /* Modal Transitions */
    #enrollmentStatusModal {
        transition: opacity 0.2s ease, visibility 0.2s ease;
        opacity: 0;
        visibility: hidden;
    }
    
    #enrollmentStatusModal:not(.hidden) {
        opacity: 1;
        visibility: visible;
    }
</style>

<div class="p-4 md:p-8 bg-gradient-to-br from-gray-50 via-white to-gray-50 flex-grow rounded-2xl min-h-full" style="background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 50%, #f0f4f8 100%);">
    <!-- Register Button at Top - Only show on first page (course selection) -->
    {% if not selected_course %}
    <div class="mb-6 flex justify-end">
        <button id="registrationToggleBtn" onclick="openRegistrationModal()" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-xl shadow-lg transition flex items-center gap-2 whitespace-nowrap">
            <i class="fas fa-unlock"></i>
            <span id="registrationBtnText">Open Registration</span>
        </button>
    </div>
    {% endif %}
    {% if selected_course %}
    <!-- View Dropped Students and Back to Courses Buttons -->
    <div class="mb-4 flex justify-between items-center gap-3">
        <a href="javascript:void(0)" onclick="showStudentLoadingModal('{% url 'dashboard:students' %}')" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl text-sm font-semibold border border-indigo-700 transition flex items-center gap-2 shadow-md hover:shadow-lg">
            <i class="fas fa-arrow-left mr-2"></i>Back to Courses
        </a>
        <button onclick="window.openDroppedStudentsModal({{ selected_course.id }})" 
                class="px-4 py-2 bg-red-600 text-white rounded-xl text-sm font-semibold border border-red-700 hover:bg-red-700 transition flex items-center gap-2 shadow-md hover:shadow-lg">
            <i class="fas fa-user-slash mr-2"></i>View Dropped Students
            {% if selected_course.dropped_count %}
            <span class="px-2 py-0.5 bg-white text-red-600 text-xs font-bold rounded-full">{{ selected_course.dropped_count }}</span>
            {% endif %}
        </button>
    </div>
    
    <!-- Selected Course Detail -->
    <div class="bg-white rounded-2xl shadow-xl border border-gray-200 mb-6 overflow-hidden">
        <div class="bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 px-6 py-6 flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
            <div>
                <p class="text-xs tracking-widest uppercase text-white/80 font-semibold mb-2">Course Overview</p>

                <h1 class="text-2xl md:text-3xl font-bold text-white drop-shadow flex flex-wrap items-center gap-2 truncate" title="{{ selected_course.code }} • {{ selected_course.name }}">{{ selected_course.code }} <span class="text-white/70 text-2xl">•</span> {{ selected_course.name }}</h1>
                <div class="flex flex-wrap items-center gap-3 text-sm text-white/80 mt-2">
                    <span class="flex items-center gap-1"><i class="fas fa-graduation-cap text-xs"></i>{{ selected_course.program.code }} - {{ selected_course.program.name }}</span>
                    {% if selected_course.enrollment_code %}
                    <div class="flex items-center gap-2 flex-wrap">
                        <span class="flex items-center gap-2">
                            <i class="fas fa-key text-xs"></i>
                            <span>Enrollment Code: <strong>{{ selected_course.enrollment_code }}</strong></span>
                            <button onclick="window.copyEnrollmentCode('{{ selected_course.enrollment_code }}')" 
                                    class="ml-2 px-2 py-1 bg-white/20 hover:bg-white/30 text-white text-xs font-semibold rounded-lg transition border border-white/30 flex items-center gap-1"
                                    title="Copy enrollment code">
                                <i class="fas fa-copy text-xs"></i> Copy
                            </button>
                        </span>
                        <div class="flex items-center gap-2">
                            <label class="text-xs text-white/80 font-semibold">Status:</label>
                            <select id="enrollmentStatusSelect-{{ selected_course.id }}" 
                                    data-previous-value="{{ selected_course.enrollment_status|default:'open' }}"
                                    onfocus="this.dataset.previousValue = this.value"
                                    onchange="window.updateEnrollmentStatus({{ selected_course.id }}, this.value)"
                                    class="px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 bg-white text-gray-900 font-semibold">
                                <option value="open" {% if selected_course.enrollment_status == 'open' or not selected_course.enrollment_status %}selected{% endif %}>Open</option>
                                <option value="closed" {% if selected_course.enrollment_status == 'closed' %}selected{% endif %}>Closed</option>
                            </select>
                        </div>
                    </div>
                    {% endif %}
                </div>
                <div id="selected-course-empty-message" class="hidden text-center py-10 text-gray-500 border border-dashed border-gray-200 rounded-2xl bg-white mt-4">
                    <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-gray-100 flex items-center justify-center">
                        <i class="fas fa-info text-2xl text-gray-400"></i>
                    </div>
                    <p class="text-base font-semibold">No students for this section yet.</p>
                    <p class="text-sm mt-1 text-gray-500">Select another section to continue exploring.</p>
                </div>
            </div>
                <button onclick="window.openTransferStudentsModal()" class="px-4 py-2 bg-white text-indigo-600 rounded-xl text-sm font-semibold shadow-md hover:shadow-lg transition" id="transfer-students-btn" data-current-section-id="{{ selected_course.id }}">
                    <i class="fas fa-exchange-alt mr-2"></i>Reassign Section
                </button>
        </div>
        
        <!-- Section Filter -->
        {% if selected_course_section_options|length > 1 %}
        <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
            <div class="flex items-center gap-4">
                <label for="selected-course-section-filter" class="text-[11px] uppercase tracking-wide text-emerald-700 font-semibold mt-1 block">Section</label>
                <select id="selected-course-section-filter" data-mode="switch" onchange="showSectionLoadingAnimation()"
                        class="flex-1 max-w-xs px-4 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 bg-white text-gray-900 font-semibold">
                    <option value="">Select Section</option>
                    {% for option in selected_course_section_options %}
                    <option value="{{ option.id }}" {% if selected_course.id == option.id %}selected{% endif %}>{{ option.label }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        {% endif %}
        
        <!-- Enrolled Students List -->
        <div class="p-6">
            <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-users mr-2 text-indigo-600"></i> Enrolled Students
                <span class="ml-2 px-2 py-1 bg-indigo-100 text-indigo-700 text-xs font-bold rounded-full">{{ selected_course_enrollments|length }}</span>
            </h2>
            
            <!-- Search Bar for Students -->
            {% if selected_course_enrollments %}
            <div class="mb-4 relative">
                <div class="flex items-center gap-2">
                    <div class="flex-1 relative">
                        <div class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none">
                            <i class="fas fa-search"></i>
                        </div>
                        <input 
                            type="text" 
                            id="student-search-input" 
                            placeholder="Search by student name or ID..."
                            class="w-full pl-10 pr-10 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition"
                        >
                        <button 
                            id="clear-search-btn" 
                            onclick="clearStudentSearch()"
                            class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 transition hidden"
                            title="Clear search"
                        >
                            <i class="fas fa-times text-lg"></i>
                        </button>
                    </div>
                </div>
                <div id="no-search-results" class="mt-4 text-center py-8 text-gray-500 border border-dashed border-gray-200 rounded-2xl bg-white hidden">
                    <div class="w-20 h-20 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-search text-3xl text-gray-400"></i>
                    </div>
                    <p class="text-lg font-semibold">No students found</p>
                    <p class="text-sm mt-1">Try adjusting your search terms</p>
                </div>
            </div>
            {% endif %}
            
            {% if selected_course_enrollments %}
            <div id="selected-course-student-list" class="space-y-3">
                 {% for enrollment in selected_course_enrollments %}
                 {% with display_name=enrollment.student.full_name|default:enrollment.full_name %}
                 <div class="student-card flex items-center justify-between p-4 bg-white border border-gray-200 rounded-xl hover:shadow-md hover:border-indigo-300 transition cursor-pointer group" 
                     data-student-section="{{ enrollment.section_display }}"
                     data-enrollment-id="{{ enrollment.id }}"
                     data-student-id="{{ enrollment.student_id_number }}"
                     data-student-name="{{ display_name }}"
                     onclick="if (!event.target.closest('button') && !event.target.closest('a')) { window.showStudentDetails({{ enrollment.id }}, '{{ display_name|escapejs }}', '{{ enrollment.email|escapejs }}', '{{ enrollment.student_id_number|escapejs }}', '{{ enrollment.section_display|default:'N/A'|escapejs }}', {{ enrollment.year_level }}, '{{ enrollment.enrolled_at|date:'F d, Y g:i A'|escapejs }}', {% if enrollment.student.profile_picture %}'{{ enrollment.student.profile_picture.url }}'{% else %}null{% endif %}); }">
                    
                    <div class="flex items-center gap-4 flex-grow min-w-0">
                        <div class="flex-shrink-0">
                            {% if enrollment.student.profile_picture %}
                            <img src="{{ enrollment.student.profile_picture.url }}?v={{ enrollment.student.id }}" alt="{{ display_name }}" class="w-14 h-14 rounded-full object-cover border-4 border-white shadow-lg">
                            {% else %}
                                <div class="w-14 h-14 rounded-full flex items-center justify-center font-bold text-lg text-white shadow-lg" style="background: linear-gradient(135deg, #3C4770, #447294);">
                                {{ display_name|first|upper }}
                            </div>
                            {% endif %}
                        </div>
                            <div class="flex-grow min-w-0">
                            <div class="flex items-center gap-2 flex-wrap mb-1">
                                <h3 class="text-base font-semibold text-gray-900 truncate">{{ display_name }}</h3>
                            </div>
                                
                                <!-- Registration Status Indicators -->
                                <div class="flex items-center gap-4 mt-2">
                                    <!-- QR Code Registration Status -->
                                    <div class="flex items-center gap-1" title="QR Code Registration">
                                        <i class="fas fa-qrcode text-xs text-gray-600"></i>
                                        {% if enrollment.has_qr %}
                                            <span class="text-xs font-semibold text-green-600 flex items-center gap-0.5">
                                                <i class="fas fa-check-circle"></i> Registered
                                            </span>
                                        {% else %}
                                            <span class="text-xs font-semibold text-red-600 flex items-center gap-0.5">
                                                <i class="fas fa-times-circle"></i> Not Registered
                                            </span>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Biometric Registration Status -->
                                    <div class="flex items-center gap-1" title="Biometric Registration">
                                        <i class="fas fa-fingerprint text-xs text-gray-600"></i>
                                        {% if enrollment.has_biometric %}
                                            <span class="text-xs font-semibold text-green-600 flex items-center gap-0.5">
                                                <i class="fas fa-check-circle"></i> Registered
                                            </span>
                                        {% else %}
                                            <span class="text-xs font-semibold text-red-600 flex items-center gap-0.5">
                                                <i class="fas fa-times-circle"></i> Not Registered
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>
                        </div>
                        <div class="flex items-center gap-2">
                            {% if selected_course.instructor == user %}
                                <button onclick="event.stopPropagation(); window.showDropStudentModal({{ enrollment.id }}, '{{ display_name|escapejs }}')" 
                                    class="px-3 py-1.5 bg-red-50 text-red-700 text-xs font-semibold rounded-lg hover:bg-red-100 transition flex items-center gap-2" 
                                    title="Drop student from course">
                                <i class="fas fa-user-minus text-xs"></i>
                                <span>Drop</span>
                            </button>
                            {% endif %}
                            <div class="text-indigo-500 group-hover:text-indigo-600 transition">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                    </div>
                </div>
                {% endwith %}
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-12 text-gray-500 border border-dashed border-gray-200 rounded-2xl bg-white">
                <div class="w-20 h-20 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-user-slash text-3xl text-gray-400"></i>
                </div>
                <p class="text-lg font-semibold">No students enrolled yet</p>
                <p class="text-sm mt-1">Students will appear here once they enroll in this course</p>
            </div>
            {% endif %}
        </div>
    </div>
    {% else %}
    <div class="bg-gradient-to-r from-rose-400 via-orange-300 to-sky-400 rounded-2xl shadow-2xl mb-6 p-6 md:p-8 relative overflow-hidden">
        <div class="absolute top-0 right-0 w-64 h-64 bg-white opacity-10 rounded-full -mr-32 -mt-32"></div>
        <div class="absolute bottom-0 left-0 w-48 h-48 bg-white opacity-10 rounded-full -ml-24 -mb-24"></div>
        <div class="relative z-10 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold text-white mb-2 drop-shadow-lg flex items-center gap-3">
                    <i class="fas fa-users text-3xl"></i>
                    Students Management
                </h1>
                <p class="text-white/90 text-base font-medium">Select a course to view all enrolled students</p>
            </div>
            <div class="bg-white/20 border border-white/30 rounded-2xl px-6 py-4 text-white text-center shadow-lg">
                <p class="text-xs uppercase tracking-wide text-white/70 font-semibold">Total Courses</p>
                <p class="text-3xl font-bold">{{ instructor_courses|length }}</p>
            </div>
        </div>
    </div>
    {% if instructor_courses %}
    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-5">
        {% for course in instructor_courses %}
        <div class="course-card-wrapper relative {% if course.is_multi or course.sibling_sections and course.sibling_sections|length > 1 %}multi-section-glow{% endif %}" data-course-id="{{ course.id }}">
            <!-- Beautiful Course Card with Enhanced Styling (Same as Manage Courses) -->
            <div class="course-card-block group rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-300 text-center py-8 px-4 min-h-[140px] flex flex-col justify-center items-center relative overflow-hidden border-2 border-white/20 cursor-pointer"
                 {% if course.display_gradient %} data-gradient="{{ course.display_gradient }}" {% endif %}
                 onclick="showStudentCourseLoadingModal('?selected_course={{ course.id }}')"
                 style="{% if not course.display_gradient %}background: linear-gradient(135deg, {{ course.color|default:'#3C4770' }} 0%, {{ course.color|default:'#447294' }} 100%);{% endif %}">
                <!-- Decorative Pattern Overlay -->
                <div class="absolute inset-0 opacity-10">
                    <div class="absolute top-0 right-0 w-20 h-20 bg-white rounded-full -mr-10 -mt-10"></div>
                    <div class="absolute bottom-0 left-0 w-16 h-16 bg-white rounded-full -ml-8 -mb-8"></div>
                </div>
                
                {% if course.is_multi or course.sibling_sections and course.sibling_sections|length > 1 %}
                {% endif %}
                
                <!-- Course Name with Better Typography -->
                <div class="relative z-10 w-full">
                    <h3 class="course-card-title text-white leading-tight px-2 text-center line-clamp-3" title="{{ course.name }}">
                        {{ course.name }}
                    </h3>
                </div>

                <!-- Hover Effect Indicator -->
                <div class="absolute bottom-0 left-0 right-0 h-1 bg-white/30 transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-16 bg-white rounded-2xl shadow-lg border border-gray-200">
        <div class="w-24 h-24 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center">
            <i class="fas fa-book-open text-4xl text-gray-400"></i>
        </div>
        <p class="text-xl font-semibold text-gray-700">No courses yet</p>
        <p class="text-sm text-gray-500 mt-2">Add courses in "Manage Courses" to start managing students</p>
        <a href="{% url 'dashboard:instructor_courses' %}" class="mt-4 inline-block px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition">
            <i class="fas fa-plus mr-2"></i>Go to Manage Courses
        </a>
    </div>
    {% endif %}
    {% endif %}
</div>


<!-- Student Details Modal -->
<div id="studentDetailModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 backdrop-blur-sm hidden z-[100] flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 md:p-8">
        <div class="flex justify-between items-start mb-6">
            <h3 class="text-2xl font-bold flex items-center text-indigo-600">
                <i class="fas fa-user w-6 h-6 mr-2"></i> Student Details
            </h3>
            <button onclick="window.closeStudentDetails()" class="text-gray-400 hover:text-gray-600 transition duration-150 hover:opacity-75">
                <i class="fas fa-times w-6 h-6"></i>
            </button>
        </div>
        <div class="space-y-4">
            <div class="flex justify-center mb-4">
                <div id="modal-profile-pic" class="w-24 h-24 rounded-full border-2 border-gray-200 shadow mb-4 flex items-center justify-center overflow-hidden bg-gradient-to-br from-indigo-600 to-purple-600">
                    <span class="text-3xl font-bold text-white">?</span>
                </div>
            </div>
            <div class="space-y-3">
                <div>
                    <label class="text-xs uppercase tracking-wide text-gray-500 font-semibold">Full Name</label>
                    <p id="modal-full-name" class="text-lg font-semibold text-gray-900 mt-1"></p>
                </div>
                <div>
                    <label class="text-xs uppercase tracking-wide text-gray-500 font-semibold">Email</label>
                    <p id="modal-email" class="text-base text-gray-700 mt-1"></p>
                </div>
                <div>
                    <label class="text-xs uppercase tracking-wide text-gray-500 font-semibold">Student ID</label>
                    <p id="modal-student-id" class="text-base text-gray-700 mt-1"></p>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs uppercase tracking-wide text-gray-500 font-semibold">Section</label>
                        <p id="modal-section" class="text-base text-gray-700 mt-1"></p>
                    </div>
                    <div>
                        <label class="text-xs uppercase tracking-wide text-gray-500 font-semibold">Year Level</label>
                        <p id="modal-year-level" class="text-base text-gray-700 mt-1"></p>
                    </div>
                </div>
                <div>
                    <label class="text-xs uppercase tracking-wide text-gray-500 font-semibold">Enrolled Date</label>
                    <p id="modal-enrolled-date" class="text-base text-gray-700 mt-1"></p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Drop Student Modal -->
<div id="dropStudentModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 backdrop-blur-sm hidden z-[110] flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 md:p-8">
        <div class="flex justify-between items-start mb-6">
            <h3 class="text-2xl font-bold flex items-center text-red-600">
                <i class="fas fa-user-minus w-6 h-6 mr-2"></i> Drop Student
            </h3>
            <button onclick="window.closeDropStudentModal()" class="text-gray-400 hover:text-gray-600 transition duration-150 hover:opacity-75">
                <i class="fas fa-times w-6 h-6"></i>
            </button>
        </div>
        <div class="space-y-4">
            <p class="text-gray-700 font-semibold">Are you sure you want to drop this student from the course?</p>
            <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded">
                <p class="font-semibold text-red-800" id="drop-student-name"></p>
            </div>
            <p class="text-sm text-gray-600">This will move the enrollment to trash. You can restore it within 30 days.</p>
            <input type="hidden" id="drop-enrollment-id">
            <div class="flex justify-end space-x-3 pt-6 border-t border-gray-100">
                <button onclick="window.closeDropStudentModal()" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-150 shadow-sm">
                    Cancel
                </button>
                <button onclick="confirmDropStudent()" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-150 shadow-sm">
                    <i class="fas fa-user-minus mr-2"></i> Drop Student
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Undrop Student Modal -->
<div id="undropStudentModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 backdrop-blur-sm hidden z-[150] flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 md:p-8">
        <div class="flex justify-between items-start mb-6">
            <h3 class="text-2xl font-bold flex items-center text-green-600">
                <i class="fas fa-undo w-6 h-6 mr-2"></i> Restore Student
            </h3>
            <button onclick="window.closeUndropStudentModal()" class="text-gray-400 hover:text-gray-600 transition duration-150 hover:opacity-75">
                <i class="fas fa-times w-6 h-6"></i>
            </button>
        </div>
        <div class="space-y-4">
            <p class="text-gray-700 font-semibold">Are you sure you want to restore this student?</p>
            <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded">
                <p class="font-semibold text-green-800" id="undrop-student-name"></p>
            </div>
            <p class="text-sm text-gray-600">This will re-enroll the student in the course and restore their access.</p>
            <input type="hidden" id="undrop-enrollment-id">
            <div class="flex justify-end space-x-3 pt-6 border-t border-gray-100">
                <button onclick="window.closeUndropStudentModal()" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-150 shadow-sm">
                    Cancel
                </button>
                <button onclick="window.confirmUndropStudent()" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition duration-150 shadow-sm">
                    <i class="fas fa-undo mr-2"></i> Restore
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Permanent Drop Modal -->
<div id="permanentDropModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 backdrop-blur-sm hidden z-[150] flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 md:p-8">
        <div class="flex justify-between items-start mb-6">
            <h3 class="text-2xl font-bold flex items-center text-red-600">
                <i class="fas fa-trash w-6 h-6 mr-2"></i> Permanent Drop
            </h3>
            <button onclick="window.closePermanentDropModal()" class="text-gray-400 hover:text-gray-600 transition duration-150 hover:opacity-75">
                <i class="fas fa-times w-6 h-6"></i>
            </button>
        </div>
        <div class="space-y-4">
            <p class="text-gray-700 font-semibold">Are you sure you want to permanently delete this enrollment?</p>
            <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded">
                <p class="font-semibold text-red-800" id="permanent-drop-student-name"></p>
            </div>
            <p class="text-sm text-red-600 font-semibold">⚠️ WARNING: This action cannot be undone. The enrollment will be permanently deleted.</p>
            <input type="hidden" id="permanent-drop-enrollment-id">
            <div class="flex justify-end space-x-3 pt-6 border-t border-gray-100">
                <button onclick="window.closePermanentDropModal()" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-150 shadow-sm">
                    Cancel
                </button>
                <button onclick="window.confirmPermanentDrop()" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-150 shadow-sm">
                    <i class="fas fa-trash mr-2"></i> Permanent Delete
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Enrollment Status Modal -->
<div id="enrollmentStatusModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 backdrop-blur-sm hidden z-[120] flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 md:p-8">
        <div class="flex justify-between items-start mb-6">
            <h3 class="text-2xl font-bold flex items-center text-yellow-600">
                <i class="fas fa-user-lock w-6 h-6 mr-2"></i> Change Enrollment Status
            </h3>
            <button onclick="closeEnrollmentStatusModal()" class="text-gray-400 hover:text-gray-600 transition duration-150 hover:opacity-75">
                <i class="fas fa-times w-6 h-6"></i>
            </button>
        </div>
        <div class="space-y-4">
            <p class="text-gray-700 font-semibold" id="enrollmentStatusModalMessage">Change enrollment status for this course?</p>
            <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded">
                <p class="text-sm text-yellow-800" id="enrollmentStatusModalAction"></p>
            </div>
            <input type="hidden" id="enrollment-status-course-id">
            <input type="hidden" id="enrollment-status-new-value">
            <div class="flex justify-end space-x-3 pt-6 border-t border-gray-100">
                <button onclick="closeEnrollmentStatusModal()" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-150 shadow-sm">
                    Cancel
                </button>
                <button onclick="confirmEnrollmentStatusChange()" class="px-4 py-2 bg-yellow-600 text-white font-semibold rounded-lg hover:bg-yellow-700 transition duration-150 shadow-sm">
                    <i class="fas fa-check mr-2"></i> Confirm
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Transfer Students Modal (Redesigned) -->
<div id="transferStudentsModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 backdrop-blur-sm hidden z-[120] flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[85vh] overflow-hidden flex flex-col">
        <!-- Header -->
        <div class="flex justify-between items-center p-6 border-b border-gray-200 flex-shrink-0 bg-gradient-to-r from-indigo-600 to-purple-600">
            <h3 class="text-2xl font-bold flex items-center text-white">
                <i class="fas fa-exchange-alt w-6 h-6 mr-3"></i> Reassign Students to Section
            </h3>
            <button onclick="window.closeTransferStudentsModal()" class="text-white hover:text-gray-200 transition duration-150">
                <i class="fas fa-times w-6 h-6"></i>
            </button>
        </div>

        <!-- Content -->
        <div class="flex-1 overflow-hidden flex flex-col p-6 space-y-4">
            <!-- Target Section Selection -->
            <div>
                <label for="transfer-to-section" class="block text-sm font-semibold text-gray-700 mb-3">
                    <i class="fas fa-arrow-right mr-2 text-indigo-600"></i> Select Target Section
                </label>
                <select id="transfer-to-section" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent font-medium" onchange="window.updateTransferUI()">
                    <option value="">Choose a section...</option>
                </select>
            </div>

            <!-- Students List Section -->
            <div class="flex-1 flex flex-col">
                <label class="block text-sm font-semibold text-gray-700 mb-3">
                    <i class="fas fa-users mr-2 text-indigo-600"></i> Select Students to Reassign
                    <span class="ml-2 text-xs text-gray-500">(<span id="transfer-selected-count">0</span> selected)</span>
                </label>
                
                <!-- Search Bar -->
                <div class="mb-3 relative">
                    <div class="relative">
                        <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                        <input type="text" 
                               id="transfer-student-search" 
                               placeholder="Search by name or ID..." 
                               class="w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition duration-150"
                               onkeyup="window.filterTransferStudents(this.value)">
                        <button onclick="document.getElementById('transfer-student-search').value = ''; window.filterTransferStudents('');" 
                                class="absolute right-3 top-2.5 text-gray-400 hover:text-gray-600 transition hidden" 
                                type="button"
                                id="transfer-search-clear-btn">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                
                <div class="transfer-modal-student-list" id="transfer-student-list">
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                        <p>Loading students...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="flex justify-end gap-3 p-6 border-t border-gray-200 flex-shrink-0 bg-gray-50">
            <button onclick="window.closeTransferStudentsModal()" class="px-6 py-2 bg-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-400 transition duration-150 shadow-sm">
                Cancel
            </button>
            <button id="submit-transfer-students-btn" onclick="window.submitTransferStudents()" class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-150 shadow-sm flex items-center gap-2" disabled>
                <i class="fas fa-check"></i> Reassign Now
            </button>
        </div>
    </div>
</div>

<!-- Dropped Students Modal -->
<div id="droppedStudentsModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 backdrop-blur-sm hidden z-[130] flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
        <div class="flex justify-between items-center p-6 border-b border-gray-200 flex-shrink-0">
            <h3 class="text-2xl font-bold flex items-center text-red-600">
                <i class="fas fa-user-slash w-6 h-6 mr-2"></i> Dropped Students
            </h3>
            <button onclick="window.closeDroppedStudentsModal()" class="text-gray-400 hover:text-gray-600 transition duration-150 hover:opacity-75">
                <i class="fas fa-times w-6 h-6"></i>
            </button>
        </div>
        <div id="dropped-students-content" class="flex-1 overflow-y-auto p-6">
            <div class="text-center py-12">
                <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-gray-100 flex items-center justify-center">
                    <i class="fas fa-spinner fa-spin text-2xl text-gray-400"></i>
                </div>
                <p class="text-gray-600">Loading dropped students...</p>
            </div>
        </div>
    </div>
</div>

<script>
// Apply multi-stop gradients from data attribute (matches Manage Courses)
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.course-card-block[data-gradient]').forEach(el => {
        const grad = el.getAttribute('data-gradient');
        if (grad && grad.includes('linear-gradient')) {
            el.style.background = grad;
        }
    });

});

// Format year label function - must be defined before use
window.formatYearLabel = function(yearLevel) {
    const numericValue = parseInt(yearLevel, 10);
    if (isNaN(numericValue)) {
        return yearLevel ? `${yearLevel}` : 'N/A';
    }
    const mod100 = numericValue % 100;
    let suffix = 'th';
    if (mod100 < 11 || mod100 > 13) {
        suffix = {1: 'st', 2: 'nd', 3: 'rd'}[numericValue % 10] || 'th';
    }
    return `${numericValue}${suffix} Year`;
};

window.showStudentDetails = function(enrollmentId, fullName, email, studentId, section, yearLevel, enrolledDate, profilePicUrl) {
    section = (section || 'N/A').toUpperCase();
    // Set all modal fields
    document.getElementById('modal-full-name').textContent = fullName;
    document.getElementById('modal-email').textContent = email;
    document.getElementById('modal-student-id').textContent = studentId;
    document.getElementById('modal-section').textContent = section;
    document.getElementById('modal-year-level').textContent = window.formatYearLabel(yearLevel);
    document.getElementById('modal-enrolled-date').textContent = enrolledDate;
    
    // Set profile picture
    const profilePicDiv = document.getElementById('modal-profile-pic');
    if (profilePicUrl && profilePicUrl !== 'null' && profilePicUrl !== 'None') {
        profilePicDiv.innerHTML = `<img src="${profilePicUrl}" alt="${fullName}" class="w-full h-full object-cover rounded-full">`;
        profilePicDiv.className = 'w-24 h-24 rounded-full border-2 border-gray-200 shadow mb-4 flex items-center justify-center overflow-hidden bg-white';
    } else {
        const initial = fullName.charAt(0).toUpperCase();
        profilePicDiv.innerHTML = `<span class="text-3xl font-bold text-white">${initial}</span>`;
        profilePicDiv.className = 'w-24 h-24 rounded-full border-2 border-gray-200 shadow mb-4 flex items-center justify-center overflow-hidden bg-gradient-to-br from-indigo-600 to-purple-600';
    }
    
    // Show modal
    document.getElementById('studentDetailModal').classList.remove('hidden');
};

window.closeStudentDetails = function() {
    document.getElementById('studentDetailModal').classList.add('hidden');
};

window.showDropStudentModal = function(enrollmentId, studentName) {
    const modal = document.getElementById('dropStudentModal');
    document.getElementById('drop-enrollment-id').value = enrollmentId;
    document.getElementById('drop-student-name').textContent = studentName;
    modal.classList.remove('hidden');
};

window.closeDropStudentModal = function() {
    const modal = document.getElementById('dropStudentModal');
    modal.classList.add('hidden');
    document.getElementById('drop-enrollment-id').value = '';
    document.getElementById('drop-student-name').textContent = '';
};

function confirmDropStudent() {
    const enrollmentId = document.getElementById('drop-enrollment-id').value;
    if (!enrollmentId) {
        window.closeDropStudentModal();
        return;
    }
    
    const studentName = document.getElementById('drop-student-name').textContent;
    window.closeDropStudentModal();
    
    // Show loading animation
    const loadingOverlay = document.createElement('div');
    loadingOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 z-[10000] flex items-center justify-center';
    loadingOverlay.innerHTML = `
        <div class="rainbow-spinner">
            <img src="/static/img/attendance-logo.png" alt="Loading">
        </div>
    `;
    document.body.appendChild(loadingOverlay);
    
    fetch('{% url "dashboard:instructor_drop_enrollment" 0 %}'.replace('0', enrollmentId), {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        loadingOverlay.remove();
        if (data.success) {
            if (typeof showNotification === 'function') {
                showNotification(data.message || `"${studentName}" has been dropped from the course.`, 'success');
            } else {
                alert(data.message || `"${studentName}" has been dropped from the course.`);
            }
            setTimeout(() => location.reload(), 800);
        } else {
            if (typeof showNotification === 'function') {
                showNotification(data.message || 'Error dropping student.', 'error');
            } else {
                alert(data.message || 'Error dropping student.');
            }
        }
    })
    .catch(error => {
        loadingOverlay.remove();
        console.error('Error dropping student:', error);
        if (typeof showNotification === 'function') {
            showNotification('An error occurred while dropping the student.', 'error');
        } else {
            alert('An error occurred while dropping the student.');
        }
    });
}

window.undropStudent = function(enrollmentId, studentName) {
    // Show confirmation modal instead of browser confirm
    const modal = document.getElementById('undropStudentModal');
    if (!modal) {
        // Fallback to browser confirm if modal doesn't exist
        if (!confirm(`Are you sure you want to restore "${studentName}"? This will re-enroll them in the course.`)) {
            return;
        }
    } else {
        document.getElementById('undrop-enrollment-id').value = enrollmentId;
        document.getElementById('undrop-student-name').textContent = studentName;
        modal.classList.remove('hidden');
        return; // Wait for modal confirmation
    }
    
    fetch('{% url "dashboard:instructor_restore_enrollment" 0 %}'.replace('0', enrollmentId), {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        },
        body: JSON.stringify({})
    })
    .then(response => response.json().catch(() => {
        throw new Error('Unable to restore student at the moment.');
    }))
    .then(data => {
        if (!data.success) {
            throw new Error(data.message || 'Error restoring student.');
        }
        if (typeof showNotification === 'function') {
            showNotification(data.message || `"${studentName}" has been restored to the course.`, 'success');
        } else {
            alert(data.message || `"${studentName}" has been restored to the course.`);
        }
        setTimeout(() => location.reload(), 800);
    })
    .catch(error => {
        console.error('Error restoring student:', error);
        if (typeof showNotification === 'function') {
            showNotification(error.message || 'An error occurred while restoring the student.', 'error');
        } else {
            alert(error.message || 'An error occurred while restoring the student.');
        }
    });
}

window.closeUndropStudentModal = function() {
    const modal = document.getElementById('undropStudentModal');
    if (modal) {
        modal.classList.add('hidden');
        document.getElementById('undrop-enrollment-id').value = '';
        document.getElementById('undrop-student-name').textContent = '';
    }
};

window.confirmUndropStudent = function() {
    const enrollmentId = document.getElementById('undrop-enrollment-id').value;
    if (!enrollmentId) {
        window.closeUndropStudentModal();
        return;
    }
    
    const studentName = document.getElementById('undrop-student-name').textContent;
    window.closeUndropStudentModal();
    
    // Call the actual undrop function
    window.undropStudentDirect(enrollmentId, studentName);
};

window.undropStudentDirect = function(enrollmentId, studentName) {
    // Show loading animation
    const loadingOverlay = document.createElement('div');
    loadingOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 z-[10000] flex items-center justify-center';
    loadingOverlay.innerHTML = `
        <div class="rainbow-spinner">
            <img src="/static/img/attendance-logo.png" alt="Loading">
        </div>
    `;
    document.body.appendChild(loadingOverlay);
    
    fetch('{% url "dashboard:instructor_restore_enrollment" 0 %}'.replace('0', enrollmentId), {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        },
        body: JSON.stringify({})
    })
    .then(response => response.json().catch(() => {
        throw new Error('Unable to restore student at the moment.');
    }))
    .then(data => {
        loadingOverlay.remove();
        if (!data.success) {
            throw new Error(data.message || 'Error restoring student.');
        }
        if (typeof showNotification === 'function') {
            showNotification(data.message || `"${studentName}" has been restored to the course.`, 'success');
        } else {
            alert(data.message || `"${studentName}" has been restored to the course.`);
        }
        setTimeout(() => location.reload(), 800);
    })
    .catch(error => {
        loadingOverlay.remove();
        console.error('Error restoring student:', error);
        if (typeof showNotification === 'function') {
            showNotification(error.message || 'An error occurred while restoring the student.', 'error');
        } else {
            alert(error.message || 'An error occurred while restoring the student.');
        }
    });
};

// Dropped Students Modal Functions
let currentDroppedCourseId = null;
let currentPermanentDropEnrollmentId = null;

window.openDroppedStudentsModal = function(courseId) {
    currentDroppedCourseId = courseId;
    const modal = document.getElementById('droppedStudentsModal');
    const content = document.getElementById('dropped-students-content');
    
    if (!modal || !content) {
        console.error('Dropped students modal not found');
        return;
    }
    
    modal.classList.remove('hidden');
    content.innerHTML = `
        <div class="text-center py-12">
            <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-gray-100 flex items-center justify-center">
                <i class="fas fa-spinner fa-spin text-2xl text-gray-400"></i>
            </div>
            <p class="text-gray-600">Loading dropped students...</p>
        </div>
    `;
    
    // Fetch dropped students for this course
    fetch(`{% url 'dashboard:instructor_get_dropped_students' %}?course_id=${courseId}`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.dropped_students && data.dropped_students.length > 0) {
                let html = '<div class="space-y-3 max-h-96 overflow-y-auto">';
                data.dropped_students.forEach(enrollment => {
                    const profilePic = enrollment.profile_picture ? 
                        `<img src="${enrollment.profile_picture}?v=${enrollment.student_id}" alt="${enrollment.full_name}" class="w-12 h-12 rounded-full object-cover border-2 border-white shadow">` :
                        `<div class="w-12 h-12 rounded-full flex items-center justify-center font-bold text-sm text-white shadow" style="background: linear-gradient(135deg, #3C4770, #447294);">${enrollment.full_name.charAt(0).toUpperCase()}</div>`;
                    
                    html += `
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200 hover:bg-gray-100 transition">
                            <div class="flex items-center gap-3 flex-grow">
                                <div class="flex-shrink-0">${profilePic}</div>
                                <div class="flex-grow min-w-0">
                                    <div class="flex items-center gap-2 flex-wrap">
                                        <h4 class="text-sm font-semibold text-gray-900">${enrollment.full_name}</h4>
                                        ${enrollment.section && enrollment.section !== 'N/A' ? `<span class="px-2 py-0.5 text-[10px] font-semibold rounded-full bg-emerald-50 text-emerald-600 border border-emerald-100">Sec ${enrollment.section}</span>` : ''}
                                        <span class="px-2 py-0.5 text-[10px] font-semibold rounded-full bg-indigo-50 text-indigo-600 border border-indigo-100">${enrollment.year_level || 'N/A'}</span>
                                    </div>
                                    <div class="flex items-center gap-3 text-xs text-gray-600 mt-1">
                                        <span><i class="fas fa-id-card"></i> ${enrollment.student_id_number}</span>
                                        <span><i class="fas fa-envelope"></i> ${enrollment.email}</span>
                                    </div>
                                    <div class="flex items-center gap-2 text-xs text-gray-500 mt-1">
                                        <span><i class="fas fa-clock"></i> Dropped: ${enrollment.dropped_date}</span>
                                        ${enrollment.days_left !== null ? `<span class="px-2 py-0.5 bg-yellow-50 text-yellow-700 rounded-full border border-yellow-200"><i class="fas fa-hourglass-half"></i> ${enrollment.days_left} days left</span>` : ''}
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="window.undropStudent(${enrollment.id}, '${enrollment.full_name.replace(/'/g, "\\'")}')" 
                                        class="px-4 py-2 bg-green-600 text-white text-xs font-semibold rounded-lg hover:bg-green-700 transition duration-150 shadow-sm flex items-center gap-2">
                                    <i class="fas fa-undo"></i>
                                    <span>Undrop</span>
                                </button>
                                <button onclick="window.showPermanentDropModal(${enrollment.id}, '${enrollment.full_name.replace(/'/g, "\\'")}')" 
                                        class="px-4 py-2 bg-red-600 text-white text-xs font-semibold rounded-lg hover:bg-red-700 transition duration-150 shadow-sm flex items-center gap-2">
                                    <i class="fas fa-trash"></i>
                                    <span>Permanent Drop</span>
                                </button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                content.innerHTML = html;
            } else {
                content.innerHTML = `
                    <div class="text-center py-12">
                        <div class="w-20 h-20 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-user-slash text-3xl text-gray-400"></i>
                        </div>
                        <p class="text-lg font-semibold text-gray-700">No dropped students</p>
                        <p class="text-sm text-gray-500 mt-1">No students have been dropped from this course.</p>
                    </div>
                `;
            }
        } else {
            content.innerHTML = `
                <div class="text-center py-12">
                    <p class="text-red-600">Error loading dropped students: ${data.message || 'Unknown error'}</p>
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Error fetching dropped students:', error);
        content.innerHTML = `
            <div class="text-center py-12">
                <p class="text-red-600">An error occurred while loading dropped students.</p>
            </div>
        `;
    });
}

window.closeDroppedStudentsModal = function() {
    const modal = document.getElementById('droppedStudentsModal');
    if (modal) {
        modal.classList.add('hidden');
    }
    currentDroppedCourseId = null;
}

window.showPermanentDropModal = function(enrollmentId, studentName) {
    currentPermanentDropEnrollmentId = enrollmentId;
    const modal = document.getElementById('permanentDropModal');
    const nameElement = document.getElementById('permanent-drop-student-name');
    
    if (modal && nameElement) {
        nameElement.textContent = `Are you sure you want to permanently delete this enrollment?`;
        const warningElement = modal.querySelector('.bg-red-50 p');
        if (warningElement) {
            warningElement.textContent = `Student: ${studentName}`;
        }
        modal.classList.remove('hidden');
    }
};

window.closePermanentDropModal = function() {
    const modal = document.getElementById('permanentDropModal');
    if (modal) {
        modal.classList.add('hidden');
    }
    currentPermanentDropEnrollmentId = null;
};

window.confirmPermanentDrop = function() {
    if (!currentPermanentDropEnrollmentId) {
        alert('No enrollment selected');
        return;
    }
    
    // Show loading animation
    const loadingOverlay = document.createElement('div');
    loadingOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 z-[10000] flex items-center justify-center';
    loadingOverlay.innerHTML = `
        <div class="rainbow-spinner">
            <img src="/static/img/attendance-logo.png" alt="Loading">
        </div>
    `;
    document.body.appendChild(loadingOverlay);
    
    fetch('{% url "dashboard:instructor_permanent_delete_enrollment" 0 %}'.replace('0', currentPermanentDropEnrollmentId), {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        loadingOverlay.remove();
        window.closePermanentDropModal();
        if (data.success) {
            if (typeof showNotification === 'function') {
                showNotification(data.message || 'Student permanently dropped.', 'success');
            } else {
                alert(data.message || 'Student permanently dropped.');
            }
            // Refresh the dropped students list
            if (currentDroppedCourseId) {
                window.openDroppedStudentsModal(currentDroppedCourseId);
            } else {
                setTimeout(() => location.reload(), 800);
            }
        } else {
            if (typeof showNotification === 'function') {
                showNotification(data.message || 'Error dropping student.', 'error');
            } else {
                alert(data.message || 'Error dropping student.');
            }
        }
    })
    .catch(error => {
        loadingOverlay.remove();
        console.error('Error:', error);
        if (typeof showNotification === 'function') {
            showNotification('An error occurred. Please try again.', 'error');
        } else {
            alert('An error occurred. Please try again.');
        }
    });
};

window.copyEnrollmentCode = function(code) {
    if (!code || code === 'Not generated' || code === '') {
        if (typeof showNotification === 'function') {
            showNotification('Enrollment code not available', 'error');
        } else {
            alert('Enrollment code not available');
        }
        return;
    }
    
    navigator.clipboard.writeText(code).then(() => {
        if (typeof showNotification === 'function') {
            showNotification('Enrollment code copied to clipboard!', 'success');
        } else {
            alert('Enrollment code copied to clipboard!');
        }
    }).catch(err => {
        console.error('Failed to copy:', err);
        if (typeof showNotification === 'function') {
            showNotification('Failed to copy code. Please copy manually: ' + code, 'error');
        } else {
            alert('Failed to copy code. Please copy manually: ' + code);
        }
    });
};

let enrollmentStatusModalCourseId = null;
let enrollmentStatusModalNewValue = null;

window.updateEnrollmentStatus = function(courseId, newStatus) {
    const selectElement = document.getElementById(`enrollmentStatusSelect-${courseId}`);
    const previousValue = selectElement.dataset.previousValue || 'open';
    
    if (newStatus === previousValue) {
        return; // No change
    }
    
    enrollmentStatusModalCourseId = courseId;
    enrollmentStatusModalNewValue = newStatus;
    
    // Show confirmation modal (matching manage courses style)
    const courseName = document.querySelector(`[data-course-id="${courseId}"] h3`)?.textContent || 'Course';
    const currentStatusText = previousValue === 'open' ? 'Open' : 'Closed';
    const newStatusText = newStatus === 'open' ? 'Open' : 'Closed';
    
    document.getElementById('enrollmentStatusModalMessage').textContent = `Change enrollment status for this course?`;
    document.getElementById('enrollmentStatusModalAction').textContent = `${courseName}\nCurrent: ${currentStatusText} → New: ${newStatusText}`;
    document.getElementById('enrollment-status-course-id').value = courseId;
    document.getElementById('enrollment-status-new-value').value = newStatus;
    document.getElementById('enrollmentStatusModal').classList.remove('hidden');
};

function closeEnrollmentStatusModal() {
    const modal = document.getElementById('enrollmentStatusModal');
    if (modal) {
        modal.classList.add('hidden');
    }
    // Revert select to previous value
    if (enrollmentStatusModalCourseId) {
        const selectElement = document.getElementById(`enrollmentStatusSelect-${enrollmentStatusModalCourseId}`);
        if (selectElement) {
            selectElement.value = selectElement.dataset.previousValue || 'open';
        }
    }
    enrollmentStatusModalCourseId = null;
    enrollmentStatusModalNewValue = null;
}

function confirmEnrollmentStatusChange() {
    const courseId = document.getElementById('enrollment-status-course-id').value;
    const newStatus = document.getElementById('enrollment-status-new-value').value;
    
    if (!courseId || !newStatus) {
        closeEnrollmentStatusModal();
        return;
    }
    
    closeEnrollmentStatusModal();
    
    // Show loading animation
    const loadingOverlay = document.createElement('div');
    loadingOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 z-[10000] flex items-center justify-center';
    loadingOverlay.innerHTML = `
        <div class="rainbow-spinner">
            <img src="/static/img/attendance-logo.png" alt="Loading">
        </div>
    `;
    document.body.appendChild(loadingOverlay);
    
    fetch(`{% url 'dashboard:instructor_update_enrollment_status' 0 %}`.replace('0', courseId), {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            'status': newStatus
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (typeof showNotification === 'function') {
                showNotification(data.message || 'Enrollment status updated successfully.', 'success');
            } else {
                alert(data.message || 'Enrollment status updated successfully.');
            }
            // Update the select element's previous value
            const selectElement = document.getElementById(`enrollmentStatusSelect-${courseId}`);
            if (selectElement) {
                selectElement.dataset.previousValue = newStatus;
            }
            setTimeout(() => location.reload(), 800);
        } else {
            // Remove loading overlay on error
            loadingOverlay.remove();
            if (typeof showNotification === 'function') {
                showNotification(data.message || 'Error updating enrollment status.', 'error');
            } else {
                alert(data.message || 'Error updating enrollment status.');
            }
            // Revert select to previous value on error
            const selectElement = document.getElementById(`enrollmentStatusSelect-${courseId}`);
            if (selectElement) {
                selectElement.value = selectElement.dataset.previousValue || 'open';
            }
        }
    })
    .catch(error => {
        console.error('Error updating enrollment status:', error);
        // Remove loading overlay on error
        loadingOverlay.remove();
        if (typeof showNotification === 'function') {
            showNotification('An error occurred while updating enrollment status.', 'error');
        } else {
            alert('An error occurred while updating enrollment status.');
        }
        // Revert select to previous value on error
        const selectElement = document.getElementById(`enrollmentStatusSelect-${courseId}`);
        if (selectElement) {
            selectElement.value = selectElement.dataset.previousValue || 'open';
        }
    });
}

document.getElementById('studentDetailModal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        window.closeStudentDetails();
    }
});

document.getElementById('droppedStudentsModal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        window.closeDroppedStudentsModal();
    }
});

document.getElementById('permanentDropModal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        window.closePermanentDropModal();
    }
});

const sectionFilterControl = document.getElementById('selected-course-section-filter');
const selectedCourseList = document.getElementById('selected-course-student-list');
const emptyState = document.getElementById('selected-course-empty-message');

if (sectionFilterControl) {
    sectionFilterControl.addEventListener('change', function() {
        const mode = this.dataset.mode || '';
        const value = this.value || '';
        if (mode === 'switch' && value) {
            // Navigate to the selected section's course id
            const params = new URLSearchParams(window.location.search);
            params.set('selected_course', value);
            window.location.href = window.location.pathname + '?' + params.toString();
            return;
        }
        // Fallback to in-list filtering (when not in overview switch mode)
        if (selectedCourseList) {
            const targetSection = value;
            let visibleCount = 0;
            selectedCourseList.querySelectorAll('.student-card').forEach(card => {
                const cardSection = (card.getAttribute('data-student-section') || '').toUpperCase();
                if (!targetSection || cardSection === targetSection.toUpperCase()) {
                    card.classList.remove('hidden');
                    visibleCount += 1;
                } else {
                    card.classList.add('hidden');
                }
            });
            if (emptyState) {
                emptyState.classList.toggle('hidden', visibleCount !== 0);
            }
        }
    });
    // Do not auto-filter on load in switch mode
    if (sectionFilterControl.dataset.mode !== 'switch' && selectedCourseList) {
        sectionFilterControl.dispatchEvent(new Event('change'));
    }
}

// Defer QR Scanner function binding until partial is loaded
document.addEventListener('DOMContentLoaded', function() {
    if (typeof window.openQRScanner === 'undefined') {
        // If not exposed from partial, create a proxy that waits for it
        window.openQRScanner = function(courseId, studentId) {
            setTimeout(function() {
                if (typeof window.openQRScanner === 'function') {
                    window.openQRScanner(courseId, studentId);
                } else {
                    alert('QR Scanner not ready. Please try again.');
                }
            }, 100);
        };
    }
});
</script>

<!-- Registration Modal - Simple Open/Close -->
<div id="registrationModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 backdrop-blur-sm hidden z-[129] flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl p-8 flex flex-col">
        <div class="flex justify-between items-start mb-6">
            <div>
                <h3 class="text-2xl font-bold text-gray-900">Attendance Registration</h3>
                <p class="text-sm text-gray-600 mt-1">Students can register their attendance methods from their enrolled courses</p>
            </div>
            <button onclick="closeRegistrationModal()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times w-6 h-6"></i>
            </button>
        </div>

        <!-- Confirmation Section -->
        <div id="confirmationSection" class="mb-6">
            <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded-lg mb-4">
                <h4 class="font-semibold text-gray-900 mb-2 flex items-center gap-2">
                    <i class="fas fa-info-circle text-yellow-600"></i>Enable Registration for Your Courses
                </h4>
                <p class="text-sm text-gray-700 mb-3">
                    Do you want to enable attendance registration (QR Code and Fingerprint) for all courses you are handling?
                </p>
                <p class="text-xs text-gray-600">
                    Once enabled, your students will be able to register their attendance methods from their enrolled course pages.
                </p>
            </div>
            
            <div class="flex gap-3">
                <button onclick="confirmEnableRegistration()" class="flex-1 px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition flex items-center justify-center gap-2">
                    <i class="fas fa-check"></i> Yes, Enable Registration
                </button>
            </div>
        </div>
        
        <!-- Info Section (shown after confirmation) -->
        <div id="infoSection" class="space-y-4 mb-6 hidden">
            <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded">
                <h4 class="font-semibold text-green-900 mb-1 flex items-center gap-2">
                    <i class="fas fa-check-circle text-green-600"></i>Registration Enabled
                </h4>
                <p class="text-sm text-green-700">Students can now register their attendance methods in their enrolled courses</p>
            </div>
            
            <div class="border-l-4 border-blue-500 bg-blue-50 p-4 rounded">
                <h4 class="font-semibold text-gray-900 mb-1 flex items-center gap-2">
                    <i class="fas fa-qrcode text-blue-600"></i>QR Code Registration
                </h4>
                <p class="text-sm text-gray-700">Students can register their ID QR code for attendance tracking</p>
            </div>
            
            <div class="border-l-4 border-purple-500 bg-purple-50 p-4 rounded">
                <h4 class="font-semibold text-gray-900 mb-1 flex items-center gap-2">
                    <i class="fas fa-fingerprint text-purple-600"></i>Fingerprint Registration
                </h4>
                <p class="text-sm text-gray-700">Students can register their fingerprint for biometric attendance tracking</p>
            </div>
            
            <div class="flex justify-end">
                <button onclick="disableRegistration()" class="px-6 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition flex items-center gap-2">
                    <i class="fas fa-lock-open mr-2"></i>Disable Registration
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Registration Modal Functions
let registrationEnabled = false;

function loadRegistrationStatus() {
    // Load the current registration status from backend
    fetch('{% url "dashboard:check_course_registration_status" %}', {
        method: 'GET',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            registrationEnabled = data.registration_enabled;
            updateRegistrationButton();
        }
    })
    .catch(error => {
        console.error('Error loading registration status:', error);
    });
}

function openRegistrationModal(courseId, studentId = null) {
    // Always load fresh status when opening modal
    loadRegistrationStatus();
    
    document.getElementById('registrationModal').style.display = 'flex';
    
    // If already enabled, show info section; otherwise show confirmation
    if (registrationEnabled) {
        document.getElementById('confirmationSection').classList.add('hidden');
        document.getElementById('infoSection').classList.remove('hidden');
    } else {
        document.getElementById('confirmationSection').classList.remove('hidden');
        document.getElementById('infoSection').classList.add('hidden');
    }
}

function confirmEnableRegistration() {
    // Send request to enable registration for all courses handled by instructor
    fetch('{% url "dashboard:enable_course_registration" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            registrationEnabled = true;
            updateRegistrationButton();
            // Show info section
            document.getElementById('confirmationSection').classList.add('hidden');
            document.getElementById('infoSection').classList.remove('hidden');
        } else {
            alert('Error: ' + (data.message || 'Failed to enable registration'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while enabling registration');
    });
}

function disableRegistration() {
    if (!confirm('Are you sure you want to disable registration for all your courses?')) {
        return;
    }
    
    // Send request to disable registration
    fetch('{% url "dashboard:disable_course_registration" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            registrationEnabled = false;
            updateRegistrationButton();
            closeRegistrationModal();
        } else {
            alert('Error: ' + (data.message || 'Failed to disable registration'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while disabling registration');
    });
}

function updateRegistrationButton() {
    const btn = document.getElementById('registrationToggleBtn');
    const text = document.getElementById('registrationBtnText');
    
    if (registrationEnabled) {
        btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
        btn.classList.add('bg-green-600', 'hover:bg-green-700');
        text.textContent = 'Close Registration';
        btn.querySelector('i').className = 'fas fa-lock';
    } else {
        btn.classList.remove('bg-green-600', 'hover:bg-green-700');
        btn.classList.add('bg-blue-600', 'hover:bg-blue-700');
        text.textContent = 'Open Registration';
        btn.querySelector('i').className = 'fas fa-unlock';
    }
}

function closeRegistrationModal() {
    document.getElementById('registrationModal').style.display = 'none';
    // Do NOT change registrationEnabled state when closing - just close the modal
}

// Load registration status on page load
document.addEventListener('DOMContentLoaded', function() {
    loadRegistrationStatus();
    
    const registrationModal = document.getElementById('registrationModal');
    if (registrationModal) {
        registrationModal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeRegistrationModal();
            }
        });
    }
});
</script>

<!-- Minimal QR Scanner (proven working code) -->
{% include 'dashboard/partials/qr_scanner_basic.html' %}

<!-- Fingerprint Scanner Modal -->
<div id="fingerprintScannerModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 backdrop-blur-sm hidden z-[130] flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] p-6 md:p-8 flex flex-col overflow-hidden">
        <div class="flex justify-between items-start mb-4">
            <h3 class="text-2xl font-bold text-blue-600">
                <i class="fas fa-fingerprint mr-2"></i>Fingerprint Scanner
            </h3>
            <button onclick="closeFingerprintScanner()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times w-6 h-6"></i>
            </button>
        </div>

        <div class="flex-1 overflow-y-auto space-y-4">
            <!-- Fingerprint Icon -->
            <div class="text-center py-12">
                <div class="w-32 h-32 mx-auto mb-4 rounded-full bg-blue-100 flex items-center justify-center animate-pulse">
                    <i class="fas fa-fingerprint text-6xl text-blue-600"></i>
                </div>
                <div id="fingerprintScannerOutput" class="text-lg font-semibold text-gray-700 mb-2">
                    Ready to scan fingerprint
                </div>
                <p class="text-sm text-gray-600">Place the student's finger on the fingerprint scanner</p>
            </div>

            <!-- Student Information -->
            <div class="bg-gray-50 rounded-lg p-4 space-y-3 border border-gray-200">
                <div>
                    <label class="text-sm font-medium text-gray-700">Student ID:</label>
                    <input id="fingerprintStudentIdInput" type="text" placeholder="Enter or scan Student ID" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-700">Fingerprint Data:</label>
                    <div id="fingerprintDataDisplay" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-lg bg-white text-sm text-gray-600 min-h-10 flex items-center">
                        <span class="text-gray-400">Waiting for fingerprint...</span>
                    </div>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-700">Fingerprint Template (Base64):</label>
                    <textarea id="fingerprintTemplateInput" placeholder="Fingerprint template will appear here" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-xs font-mono" rows="4"></textarea>
                </div>
            </div>

            <!-- Test Mode Note -->
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-sm text-yellow-800">
                <i class="fas fa-info-circle mr-2"></i>
                <strong>Note:</strong> In test mode, you can manually enter fingerprint template data or use a compatible biometric device.
            </div>
        </div>

        <!-- Buttons -->
        <div class="flex justify-end gap-3 pt-4 border-t border-gray-200 mt-4">
            <button onclick="closeFingerprintScanner()" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition">
                Cancel
            </button>
            <button id="fingerprintRegisterBtn" onclick="submitFingerprintData()" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition opacity-50 cursor-not-allowed" disabled>
                Register Fingerprint
            </button>
        </div>
    </div>
</div>

<script>
// Fingerprint Scanner Functions
let fingerprintScannerActive = false;
let fingerprintCourseId = null;
let fingerprintStudentId = null;

function openFingerprintScanner(courseId, studentId) {
    console.log('openFingerprintScanner called:', { courseId, studentId });
    const modal = document.getElementById('fingerprintScannerModal');
    if (!modal) {
        console.error('Modal #fingerprintScannerModal not found!');
        alert('Fingerprint Scanner modal not found. Please refresh the page.');
        return;
    }
    
    modal.style.display = 'flex';
    fingerprintCourseId = courseId;
    fingerprintStudentId = studentId || '';
    
    document.getElementById('fingerprintStudentIdInput').value = studentId || '';
    document.getElementById('fingerprintTemplateInput').value = '';
    document.getElementById('fingerprintDataDisplay').innerHTML = '<span class="text-gray-400">Waiting for fingerprint...</span>';
    document.getElementById('fingerprintScannerOutput').textContent = 'Ready to scan fingerprint';
    
    updateFingerprintRegisterButton();
    fingerprintScannerActive = true;
}

function closeFingerprintScanner() {
    document.getElementById('fingerprintScannerModal').style.display = 'none';
    fingerprintScannerActive = false;
    fingerprintCourseId = null;
    fingerprintStudentId = null;
}

function updateFingerprintRegisterButton() {
    const studentId = document.getElementById('fingerprintStudentIdInput').value.trim();
    const template = document.getElementById('fingerprintTemplateInput').value.trim();
    const btn = document.getElementById('fingerprintRegisterBtn');
    
    if (studentId && template) {
        btn.disabled = false;
        btn.style.opacity = '1';
        btn.style.cursor = 'pointer';
    } else {
        btn.disabled = true;
        btn.style.opacity = '0.5';
        btn.style.cursor = 'not-allowed';
    }
}

function submitFingerprintData() {
    const studentId = document.getElementById('fingerprintStudentIdInput').value.trim();
    const template = document.getElementById('fingerprintTemplateInput').value.trim();
    
    if (!studentId || !template) {
        alert('Please enter both Student ID and Fingerprint Template');
        return;
    }
    
    // Send registration request
    fetch('/api/register-fingerprint/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
        },
        body: JSON.stringify({
            course_id: fingerprintCourseId,
            student_id: studentId,
            fingerprint_template: template
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccessPopup('Fingerprint Registered Successfully');
            closeFingerprintScanner();
            // Reload page after 2 seconds
            setTimeout(() => location.reload(), 2000);
        } else {
            alert('Error: ' + (data.message || 'Failed to register fingerprint'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while registering fingerprint');
    });
}

// Update button when inputs change
document.addEventListener('DOMContentLoaded', function() {
    const studentIdInput = document.getElementById('fingerprintStudentIdInput');
    const templateInput = document.getElementById('fingerprintTemplateInput');
    
    if (studentIdInput) {
        studentIdInput.addEventListener('input', updateFingerprintRegisterButton);
    }
    if (templateInput) {
        templateInput.addEventListener('input', updateFingerprintRegisterButton);
    }
    
    // Close modal on background click
    const modal = document.getElementById('fingerprintScannerModal');
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeFingerprintScanner();
            }
        });
    }
});

// Make functions globally available
window.openFingerprintScanner = openFingerprintScanner;
window.closeFingerprintScanner = closeFingerprintScanner;
window.submitFingerprintData = submitFingerprintData;

// ============ REASSIGN STUDENTS TO OTHER SECTIONS ============

function openTransferStudentsModal() {
    const courseId = new URLSearchParams(window.location.search).get('selected_course');
    if (!courseId) {
        alert('Please select a course first');
        return;
    }
    
    document.getElementById('transferStudentsModal').style.display = 'flex';
    document.getElementById('transfer-to-section').value = '';
    document.getElementById('transfer-selected-count').textContent = '0';
    
    // Load sections
    loadTransferSections(courseId);
    
    // Load students for this course from the server
    loadTransferStudentsFromServer(courseId);
}

function closeTransferStudentsModal() {
    console.log('closeTransferStudentsModal called');
    const modal = document.getElementById('transferStudentsModal');
    if (modal) {
        modal.style.display = 'none';
    }
    // Clear selections
    document.querySelectorAll('#transfer-student-list input[type="checkbox"]').forEach(cb => cb.checked = false);
    document.getElementById('transfer-to-section').value = '';
    document.getElementById('transfer-selected-count').textContent = '0';
    updateTransferUI();
}

// Add click outside modal to close
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('transferStudentsModal');
    if (modal) {
        modal.addEventListener('click', function(e) {
            // Close if clicking on the background (not the modal content)
            if (e.target === this) {
                closeTransferStudentsModal();
            }
        });
    }
});

function loadTransferStudentsFromServer(courseId) {
    const studentList = document.getElementById('transfer-student-list');
    
    // Show loading state
    studentList.innerHTML = '<div class="text-center py-8 text-gray-500"><i class="fas fa-spinner fa-spin text-2xl mb-2"></i><p>Loading students...</p></div>';
    
    console.log('[TRANSFER] Loading students from server for course:', courseId);
    
    // Fetch students from server
    fetch(`/dashboard/api/get-course-enrollments/?course_id=${courseId}`)
        .then(response => {
            console.log('[TRANSFER] Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('[TRANSFER] Received data:', data);
            
            if (data.success && data.enrollments && data.enrollments.length > 0) {
                let html = '';
                data.enrollments.forEach(enrollment => {
                    const initials = enrollment.full_name.split(' ').map(n => n[0]).join('').toUpperCase();
                    const profilePic = enrollment.profile_picture;
                    
                    html += `
                        <div class="transfer-modal-student-item" data-student-id="${enrollment.student_id_number}" data-student-name="${enrollment.full_name}" onclick="this.querySelector('input[type=checkbox]').click()">
                            <input type="checkbox" data-enrollment-id="${enrollment.id}" onchange="window.updateTransferUI()">
                            <div class="flex-shrink-0 mr-3">
                                ${profilePic ? 
                                    `<img src="${profilePic}" alt="${enrollment.full_name}" class="w-10 h-10 rounded-full object-cover">` :
                                    `<div class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-white bg-gradient-to-br from-indigo-500 to-purple-600">${initials}</div>`
                                }
                            </div>
                            <div class="flex-1">
                                <p class="font-semibold text-gray-900">${enrollment.full_name}</p>
                                <p class="text-xs text-gray-500">${enrollment.student_id_number}</p>
                            </div>
                        </div>
                    `;
                });
                
                studentList.innerHTML = html;
                console.log('[TRANSFER] Loaded ' + data.enrollments.length + ' students');
            } else if (data.success && data.enrollments) {
                studentList.innerHTML = '<div class="text-center py-8 text-gray-500"><p>No students enrolled in this course</p></div>';
                console.log('[TRANSFER] No enrollments found');
            } else {
                studentList.innerHTML = '<div class="text-center py-8 text-red-500"><p>Error: ' + (data.message || 'Failed to load students') + '</p></div>';
                console.error('[TRANSFER] Error:', data.message);
            }
        })
        .catch(error => {
            console.error('[TRANSFER] Fetch error:', error);
            studentList.innerHTML = '<div class="text-center py-8 text-red-500"><p>Error loading students: ' + error.message + '</p></div>';
        });
}

function filterTransferStudents(searchTerm) {
    const studentList = document.getElementById('transfer-student-list');
    const items = studentList.querySelectorAll('.transfer-modal-student-item');
    const searchLower = searchTerm.toLowerCase().trim();
    const clearBtn = document.getElementById('transfer-search-clear-btn');

    // Show/hide clear button based on input
    if (searchTerm.length > 0) {
        clearBtn.classList.remove('hidden');
    } else {
        clearBtn.classList.add('hidden');
    }

    let visibleCount = 0;
    let hiddenCount = 0;
    
    items.forEach(item => {
        const studentName = item.getAttribute('data-student-name') || '';
        const studentId = item.getAttribute('data-student-id') || '';
        const fullText = (studentName + ' ' + studentId).toLowerCase();
        
        if (fullText.includes(searchLower)) {
            item.style.display = 'flex';
            item.classList.add('animate-fadeIn');
            visibleCount++;
        } else {
            item.style.display = 'none';
            hiddenCount++;
        }
    });
    
    // Show "no results" message if all items are hidden
    if (visibleCount === 0 && items.length > 0) {
        if (!document.getElementById('transfer-no-results')) {
            const noResultsDiv = document.createElement('div');
            noResultsDiv.id = 'transfer-no-results';
            noResultsDiv.className = 'text-center py-8 text-gray-500';
            noResultsDiv.innerHTML = '<i class="fas fa-search text-2xl mb-2 block opacity-50"></i><p>No students match your search</p>';
            studentList.appendChild(noResultsDiv);
        }
    } else {
        const noResultsDiv = document.getElementById('transfer-no-results');
        if (noResultsDiv) {
            noResultsDiv.remove();
        }
    }
    
    console.log('[SEARCH] Filter result: ' + visibleCount + ' shown, ' + hiddenCount + ' hidden');
}

function loadTransferSections(courseId) {
    const sectionSelect = document.getElementById('transfer-to-section');
    const transferBtn = document.getElementById('transfer-students-btn');
    const currentSectionId = transferBtn ? parseInt(transferBtn.getAttribute('data-current-section-id')) : null;
    
    fetch(`/dashboard/api/get-course-sections/?course_id=${courseId}`)
        .then(response => response.json())
        .then(data => {
            if (data.sections) {
                sectionSelect.innerHTML = '<option value="">Choose a section...</option>';
                data.sections.forEach(section => {
                    // Exclude the current section from the dropdown
                    if (section.id !== currentSectionId) {
                        const option = document.createElement('option');
                        option.value = section.id;
                        option.textContent = `Section ${section.section}`;
                        sectionSelect.appendChild(option);
                    }
                });
            }
        })
        .catch(error => console.error('Error fetching sections:', error));
}

function updateTransferUI() {
    const checkboxes = document.querySelectorAll('#transfer-student-list input[type="checkbox"]:checked');
    const selectedCount = checkboxes.length;
    const sectionSelect = document.getElementById('transfer-to-section').value;
    const submitBtn = document.getElementById('submit-transfer-students-btn');
    
    document.getElementById('transfer-selected-count').textContent = selectedCount;
    
    // Enable button only if students and section are selected
    submitBtn.disabled = !(selectedCount > 0 && sectionSelect);
    
    // Update item styling
    document.querySelectorAll('#transfer-student-list .transfer-modal-student-item').forEach(item => {
        if (item.querySelector('input[type="checkbox"]:checked')) {
            item.classList.add('selected');
        } else {
            item.classList.remove('selected');
        }
    });
}

function getTransferSelectedStudents() {
    const checkboxes = document.querySelectorAll('#transfer-student-list input[type="checkbox"]:checked');
    return Array.from(checkboxes).map(cb => cb.getAttribute('data-enrollment-id'));
}

function submitTransferStudents() {
    console.log('submitTransferStudents called');
    
    const enrollmentIds = getTransferSelectedStudents();
    const targetSectionId = document.getElementById('transfer-to-section').value;
    
    console.log('Enrollment IDs:', enrollmentIds);
    console.log('Target Section ID:', targetSectionId);
    
    if (enrollmentIds.length === 0 || !targetSectionId) {
        alert('Please select students and a target section');
        return;
    }
    
    const btn = document.getElementById('submit-transfer-students-btn');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Reassigning...';
    
    const payload = {
        enrollment_ids: enrollmentIds,
        target_course_id: targetSectionId
    };
    
    console.log('Sending payload:', JSON.stringify(payload));
    
    fetch('/dashboard/api/move-students-to-section/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(payload)
    })
    .then(response => {
        console.log('Response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        btn.disabled = false;
        btn.innerHTML = originalText;
        
        if (data.success && data.moved_count > 0) {
            alert(`Successfully reassigned ${data.moved_count} student(s) to the new section!`);
            closeTransferStudentsModal();
            setTimeout(() => location.reload(), 1500);
        } else if (data.success && data.moved_count === 0) {
            alert('No students were reassigned. ' + (data.message || ''));
        } else {
            const errorMsg = data.message || 'Failed to reassign students';
            console.error('Transfer error:', data);
            alert('Error: ' + errorMsg);
        }
    })
    .catch(error => {
        console.error('Fetch error:', error);
        btn.disabled = false;
        btn.innerHTML = originalText;
        alert('Error: ' + (error.message || 'An error occurred while reassigning students'));
    });
}

// Make functions globally available
window.openTransferStudentsModal = openTransferStudentsModal;
window.closeTransferStudentsModal = closeTransferStudentsModal;
window.updateTransferUI = updateTransferUI;
window.submitTransferStudents = submitTransferStudents;
window.filterTransferStudents = filterTransferStudents;

// Remove old functions that are no longer needed
window.toggleMoveStudentsMode = function() { };
window.updateMoveStudentsUI = function() { };
window.openMoveStudentsModal = function() { };
window.closeMoveStudentsModal = function() { };
window.submitMoveStudents = function() { };

// ============ STUDENT SEARCH FUNCTIONALITY ============

function initStudentSearch() {
    const searchInput = document.getElementById('student-search-input');
    const clearBtn = document.getElementById('clear-search-btn');
    
    if (!searchInput) return;
    
    // Real-time search as user types
    searchInput.addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase().trim();
        
        // Show/hide clear button
        if (searchTerm) {
            clearBtn.classList.remove('hidden');
        } else {
            clearBtn.classList.add('hidden');
        }
        
        filterStudents(searchTerm);
    });
    
    // Allow clearing with Escape key
    searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            clearStudentSearch();
        }
    });
}

function filterStudents(searchTerm) {
    const studentCards = document.querySelectorAll('#selected-course-student-list .student-card');
    const noResultsDiv = document.getElementById('no-search-results');
    let visibleCount = 0;
    
    studentCards.forEach(card => {
        // Get data from data attributes for more reliable searching
        const studentName = (card.dataset.studentName || '').toLowerCase();
        const studentId = (card.dataset.studentId || '').toLowerCase();
        
        // Also get all text content as fallback
        const allText = card.textContent.toLowerCase();
        
        // Check if search term matches student name, ID, or any text in the card
        const matches = studentName.includes(searchTerm) || 
                       studentId.includes(searchTerm) || 
                       allText.includes(searchTerm);
        
        if (searchTerm === '' || matches) {
            card.style.display = '';
            card.classList.add('animate-fadeIn');
            visibleCount++;
        } else {
            card.style.display = 'none';
        }
    });
    
    // Show no results message if needed
    if (searchTerm && visibleCount === 0) {
        noResultsDiv.classList.remove('hidden');
        document.getElementById('selected-course-student-list').style.display = 'none';
    } else {
        noResultsDiv.classList.add('hidden');
        document.getElementById('selected-course-student-list').style.display = '';
    }
}

function clearStudentSearch() {
    const searchInput = document.getElementById('student-search-input');
    const clearBtn = document.getElementById('clear-search-btn');
    
    searchInput.value = '';
    clearBtn.classList.add('hidden');
    filterStudents('');
    searchInput.focus();
}

// Initialize search when page loads
document.addEventListener('DOMContentLoaded', function() {
    initStudentSearch();
});

// Make search functions globally available
window.filterStudents = filterStudents;
window.clearStudentSearch = clearStudentSearch;

// Add loading modal for course cards in students page
function showStudentCourseLoadingModal(url) {
    console.log('[STUDENTS] Loading modal shown for course selection');
    
    // Show loading overlay
    const loadingOverlay = document.createElement('div');
    loadingOverlay.id = 'student-course-loading-overlay';
    loadingOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 z-[10000] flex items-center justify-center';
    loadingOverlay.innerHTML = `
        <div class="rainbow-spinner">
            <img src="/static/img/attendance-logo.png" alt="Loading">
        </div>
    `;
    document.body.appendChild(loadingOverlay);
    
    // Navigate after short delay
    setTimeout(() => {
        window.location.href = url;
    }, 300);
}

// Make loading function globally available
window.showStudentCourseLoadingModal = showStudentCourseLoadingModal;

function showStudentLoadingModal(url) {
    const loadingOverlay = document.createElement('div');
    loadingOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 z-[10000] flex items-center justify-center';
    loadingOverlay.innerHTML = `
        <div class="rainbow-spinner">
            <img src="/static/img/attendance-logo.png" alt="Loading">
        </div>
    `;
    document.body.appendChild(loadingOverlay);
    setTimeout(() => {
        window.location.href = url;
    }, 300);
}

window.showStudentLoadingModal = showStudentLoadingModal;

// Section filter loading animation
function showSectionLoadingAnimation() {
    const loadingOverlay = document.createElement('div');
    loadingOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 z-[10000] flex items-center justify-center';
    loadingOverlay.innerHTML = `
        <div class="rainbow-spinner">
            <img src="/static/img/attendance-logo.png" alt="Loading">
        </div>
    `;
    document.body.appendChild(loadingOverlay);
}

window.showSectionLoadingAnimation = showSectionLoadingAnimation;
</script>

{% endblock %}

