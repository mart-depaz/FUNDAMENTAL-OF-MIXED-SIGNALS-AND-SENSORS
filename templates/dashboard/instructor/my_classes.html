{% extends 'dashboard/instructor/teacher.html' %}
{% block dashboard_content %}
<style>
    /* QR Code Image Styling - Ensure Perfect Display */
    .qr-code-image {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        background: white !important;
        object-fit: contain !important;
        image-rendering: -webkit-optimize-contrast !important;
        image-rendering: crisp-edges !important;
        image-rendering: pixelated !important;
        -ms-interpolation-mode: nearest-neighbor !important;
        min-width: 160px !important;
        min-height: 160px !important;
        max-width: 170px !important;
        max-height: 170px !important;
        width: 100% !important;
        height: 100% !important;
    }
    
    /* QR Code Container - Fixed Size */
    .qr-code-container {
        width: 180px !important;
        height: 180px !important;
        min-width: 180px !important;
        min-height: 180px !important;
        max-width: 180px !important;
        max-height: 180px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        background: white !important;
        position: relative !important;
        overflow: hidden !important;
    }
    
    /* Prevent QR code from disappearing */
    img.qr-code-image[src] {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
    }
    
    /* Ensure container always shows QR code */
    .qr-code-container img {
        position: absolute !important;
        top: 50% !important;
        left: 50% !important;
        transform: translate(-50%, -50%) !important;
    }
</style>

<div class="max-w-7xl mx-auto space-y-6">
    <div class="bg-white rounded-2xl shadow p-4 border border-gray-100">
        <div class="flex items-center justify-between">
            <h2 class="text-xl font-bold text-gray-900">My Classes</h2>
            <a href="{% url 'dashboard:weekly_timetable' %}" class="text-xs text-indigo-600 font-semibold hover:underline">Go to Timetable</a>
        </div>
        <p class="text-sm text-gray-600 mt-1">Monitor today's classes and quickly jump to a course.</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-5" style="align-items: start;">
        <div class="bg-white rounded-2xl shadow p-4 border border-gray-100 flex flex-col" style="position: relative; top: 0;">      
            <h3 class="text-sm font-semibold text-gray-800 mb-3 flex-shrink-0">Quick Pick</h3>
            <div class="space-y-2 overflow-y-auto" style="height: calc(5 * 4.5rem); max-height: calc(5 * 4.5rem);">
                {% if schedule_entries %}
                    {% for e in schedule_entries %}
                          <a href="{% if e.status == 'finished' or e.status == 'ended' %}{% url 'dashboard:instructor_attendance_reports' %}?course={{ e.course_id }}&section={{ e.section }}&date={% if e.start_dt %}{{ e.start_dt|date:'Y-m-d' }}{% else %}{{ e.date_label }}{% endif %}{% else %}?course={{ e.course_id }}&schedule={{ e.schedule_id }}{% endif %}" 
                       class="quick-pick-item flex items-center justify-between p-3 rounded-xl border transition border-gray-200 no-underline hover:no-underline flex-shrink-0 {% if focus_course_next_entry and focus_course_next_entry.schedule_id == e.schedule_id %}border-indigo-500 bg-indigo-50 shadow-md{% else %}hover:border-indigo-300 hover:bg-indigo-50/40{% endif %}"
                       data-course-id="{{ e.course_id }}"
                       data-schedule-id="{{ e.schedule_id }}">
                        <div class="min-w-0">
                            {% if e.section %}
                            <p class="mb-1">
                                <span class="px-2 py-0.5 rounded-full font-bold text-[10px] text-white" style="background-color: {{ e.color }};">Section {{ e.section }}</span>
                            </p>
                            {% endif %}
                            <p class="text-sm font-semibold text-gray-900 truncate">{{ e.code }} • {{ e.name }}</p>
                            <p class="text-[11px] text-gray-600 uppercase tracking-wide mt-0.5 truncate">{{ e.date_label }} • {{ e.time_label }}</p>
                        </div>
                        {% if e.status == 'live' %}
                            <span class="ml-3 flex-shrink-0 px-2 py-0.5 rounded-full text-[10px] font-bold bg-green-100 text-green-700 uppercase">Live</span>
                        {% elif e.status == 'starting_today' %}
                            <span class="ml-3 flex-shrink-0 px-2 py-0.5 rounded-full text-[10px] font-bold bg-blue-100 text-blue-700 uppercase">Starting Today</span>
                        {% elif e.status == 'tomorrow' %}
                            <span class="ml-3 flex-shrink-0 px-2 py-0.5 rounded-full text-[10px] font-bold bg-orange-100 text-orange-700 uppercase">Tomorrow</span>
                        {% elif e.status == 'upcoming' %}
                            <span class="ml-3 flex-shrink-0 px-2 py-0.5 rounded-full text-[10px] font-bold bg-yellow-100 text-yellow-700 uppercase">Upcoming</span>
                        {% elif e.status == 'soon' %}
                            <span class="ml-3 flex-shrink-0 px-2 py-0.5 rounded-full text-[10px] font-bold bg-purple-100 text-purple-700 uppercase">Soon</span>
                        {% elif e.status == 'ongoing' %}
                            <span class="ml-3 flex-shrink-0 px-2 py-0.5 rounded-full text-[10px] font-bold bg-indigo-100 text-indigo-700 uppercase">Ongoing</span>
                        {% else %}
                            <span class="ml-3 flex-shrink-0 px-2 py-0.5 rounded-full text-[10px] font-bold bg-gray-100 text-gray-600 uppercase">Finished</span>
                        {% endif %}
                    </a>
                    {% endfor %}
                {% else %}
                    <p class="text-xs text-gray-500">No active schedules yet.</p>
                {% endif %}
            </div>
        </div>
        
        <div class="lg:col-span-2 bg-white rounded-2xl shadow p-4 border border-gray-100 flex flex-col">
            <div class="flex items-center justify-between mb-3 flex-shrink-0">
                <h3 class="text-sm font-semibold text-gray-800">Monitoring</h3>
                <div class="flex items-center gap-2">
                    {% if focus_course %}
                    <span class="px-2 py-1 rounded-lg text-xs font-semibold text-white" style="background-color: {{ focus_course.color|default:'#3C4770' }};">
                        Section {{ focus_course.section|default:'—' }}
                    </span>
                    <a href="{% url 'dashboard:instructor_courses' %}?edit_course={{ focus_course.id }}" 
                       class="px-3 py-1.5 bg-amber-600 text-white text-xs font-semibold rounded-lg hover:bg-amber-700 transition duration-150 shadow-sm flex items-center gap-1">
                        <i class="fas fa-edit text-xs"></i> Edit
                    </a>
                    {% endif %}
                </div>
            </div>
                <div class="space-y-3 flex-1 overflow-y-auto" style="min-height: 0;">
                {% if focus_course %}
                <!-- Attendance Control Dropdown -->
                <div class="flex items-center gap-2 mb-2">
                    <label class="text-xs font-semibold text-gray-700">Attendance Control{% if focus_course_next_entry and focus_course_next_entry.day_label %}: {{ focus_course_next_entry.day_label }}{% endif %}:</label>
                    <select id="attendance-control" 
                            data-course-id="{{ focus_course.id }}"
                            data-schedule-id="{% if focus_course_next_entry and focus_course_next_entry.schedule_id %}{{ focus_course_next_entry.schedule_id }}{% endif %}"
                            data-day-label="{% if focus_course_next_entry and focus_course_next_entry.day_label %}{{ focus_course_next_entry.day_label }}{% endif %}"
                            class="px-3 py-1.5 text-xs border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        {% if focus_course_next_entry and focus_course_next_entry.day_schedule_status %}
                            <option value="closed" {% if focus_course_next_entry.day_schedule_status == 'closed' or not focus_course_next_entry.day_schedule_status %}selected{% endif %}>Closed Attendance</option>
                            <option value="open" {% if focus_course_next_entry.day_schedule_status == 'open' %}selected{% endif %}>Open Attendance</option>
                            <option value="postponed" {% if focus_course_next_entry.day_schedule_status == 'postponed' %}selected{% endif %}>Postponed</option>
                        {% else %}
                            <option value="closed" {% if focus_course.attendance_status == 'closed' or not focus_course.attendance_status %}selected{% endif %}>Closed Attendance</option>
                            <option value="open" {% if focus_course.attendance_status == 'open' %}selected{% endif %}>Open Attendance</option>
                            <option value="postponed" {% if focus_course.attendance_status == 'postponed' %}selected{% endif %}>Postponed</option>
                        {% endif %}
                    </select>
                    <div class="ml-2 flex items-end gap-2">
                        <div id="active-window-display" class="text-xs font-semibold text-indigo-600 min-w-12 text-center hidden">
                            <div class="text-sm font-bold"><span id="window-time">—</span> mins</div>
                        </div>
                        <div>
                            <label class="text-xs text-gray-600 block">Present window (min)</label>
                            <input id="sidebarPresentDuration" type="number" min="1" step="1" class="w-16 px-2 py-1 text-xs border border-gray-300 rounded-lg" placeholder="e.g. 20" value="{% if focus_course_next_entry and focus_course_next_entry.attendance_present_duration %}{{ focus_course_next_entry.attendance_present_duration }}{% elif focus_course.attendance_present_duration %}{{ focus_course.attendance_present_duration }}{% endif %}">
                        </div>
                        <div class="flex items-center gap-2">
                            <button id="confirm-present-duration" type="button" class="px-3 py-1.5 bg-indigo-600 text-white text-xs font-semibold rounded-lg hover:bg-indigo-700 transition duration-150 shadow-sm">Confirm</button>
                            <button id="reset-present-duration" type="button" onclick="instructorResetPresentWindow(event)" class="px-3 py-1.5 bg-gray-200 text-gray-700 text-xs font-semibold rounded-lg hover:bg-gray-300 transition duration-150 shadow-sm">Reset</button>
                        </div>
                    </div>
                </div>
                
                <div class="p-3 rounded-xl border border-gray-200" style="background-color: {{ focus_course.color|default:'#3C4770' }};">
                    <div class="flex items-center justify-between gap-3">
                        <p class="text-xs text-white font-semibold">Room: {{ focus_course.room|default:'TBA' }}</p>
                        {% if focus_course_next_entry %}
                        <p class="text-[11px] text-white font-semibold whitespace-nowrap">{{ focus_course_next_entry.date_label }}</p>
                        {% endif %}
                    </div>
                    <div class="flex items-center justify-between gap-3">
                        <p class="text-xs text-white font-semibold">Semester: {{ focus_course.semester|default:'—' }} • SY: {{ focus_course.school_year|default:'—' }}</p>
                        {% if focus_course_next_entry %}
                        <p class="text-[11px] text-white font-semibold whitespace-nowrap">{{ focus_course_next_entry.time_label }}</p>
                        {% endif %}
                    </div>
                </div>
                
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div class="p-4 rounded-xl border border-gray-200">
                        <p class="text-xs font-semibold text-gray-600 uppercase tracking-wider mb-1">STUDENT SCANNED</p>
                        <p id="student-scanned-count" class="text-2xl font-bold text-gray-900">{{ today_attendance_count|default:0 }}</p>
                        <p class="text-xs text-gray-500 mt-1">Students attended today</p>
                    </div>
                    <div class="p-4 rounded-xl border border-gray-200">
                        <p class="text-xs font-semibold text-gray-600 uppercase tracking-wider mb-1">Total Enrolled</p>
                        <p class="text-2xl font-bold text-gray-900">{{ enrolled_students|length|default:0 }}</p>
                        <p class="text-xs text-gray-500 mt-1">Students enrolled</p>
                    </div>
                </div>                <div class="p-3 bg-blue-50 rounded-lg border border-blue-200">
                    {% comment %} Determine effective attendance status: prefer schedule/day-specific status when available {% endcomment %}
                    {% with current_attendance=focus_course_next_entry.day_schedule_status|default:focus_course.attendance_status %}
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-camera text-blue-600"></i>
                            <span class="text-xs font-semibold text-gray-700">Scan Student ID</span>
                        </div>
                        {% if focus_course and current_attendance == 'open' %}
                            <button 
                                data-course-id="{{ focus_course.id }}" 
                                data-course-code="{{ focus_course.code|escapejs }}" 
                                data-course-name="{{ focus_course.name|escapejs }}" 
                                data-section="{{ focus_course.section }}"
                                data-schedule-id="{% if focus_course_next_entry and focus_course_next_entry.schedule_id %}{{ focus_course_next_entry.schedule_id }}{% endif %}"
                                class="open-instructor-scanner px-3 py-1.5 bg-blue-600 text-white text-xs font-semibold rounded-lg hover:bg-blue-700 transition duration-150 shadow-sm flex items-center gap-1">
                                <i class="fas fa-camera text-xs"></i> Scan
                            </button>
                        {% else %}
                            <button disabled class="px-3 py-1.5 bg-gray-400 text-white text-xs font-semibold rounded-lg cursor-not-allowed shadow-sm flex items-center gap-1 opacity-60">
                                <i class="fas fa-lock text-xs"></i> Scan
                            </button>
                        {% endif %}
                    </div>
                    {% if focus_course and current_attendance == 'open' %}
                        <p class="text-[10px] text-gray-600 text-center">Open camera to scan student school ID for attendance</p>
                    {% else %}
                        <p class="text-[10px] text-yellow-600 text-center font-semibold">⚠️ Attendance is currently CLOSED. Open it to enable scanning.</p>
                    {% endif %}
                    {% endwith %}
                </div>
                
                <!-- Students list removed per instructor request -->
                {% else %}
                <p class="text-xs text-gray-500">Select a course on the left to begin monitoring.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

            <!-- Present Window Confirmation Modal -->
            <div id="presentWindowModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden z-[115] flex items-center justify-center p-4">
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 md:p-8">
                    <div class="flex justify-between items-start mb-6">
                        <h3 class="text-2xl font-bold flex items-center text-indigo-600">
                            <i class="fas fa-hourglass-half w-6 h-6 mr-2"></i> Confirm Present Window
                        </h3>
                        <button id="present-window-cancel" class="text-gray-400 hover:text-gray-600 transition duration-150 hover:opacity-75">
                            <i class="fas fa-times w-6 h-6"></i>
                        </button>
                    </div>
                    <div class="space-y-4">
                        <p class="text-gray-700 font-semibold">Set the present window for this class?</p>
                        <div class="p-4 bg-indigo-50 border-l-4 border-indigo-500 rounded">
                            <p class="font-semibold text-indigo-800">Present window: <span id="present-window-minutes">—</span> minutes</p>
                            <p class="text-xs text-gray-600 mt-2">Students who scan after the window ends will be marked late by the system.</p>
                        </div>
                        <input type="hidden" id="present-window-course-id">
                        <input type="hidden" id="present-window-schedule-id">
                        <input type="hidden" id="present-window-minutes-input">
                        <div class="flex justify-end space-x-3 pt-6 border-t border-gray-100">
                            <button id="present-window-cancel-2" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-150 shadow-sm">Cancel</button>
                            <button id="present-window-confirm-btn" class="px-4 py-2 text-white font-semibold rounded-lg transition duration-150 shadow-sm" style="background-color:#4f46e5;">Confirm</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reset Present Window Confirmation Modal -->
            <div id="resetPresentModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden z-[116] flex items-center justify-center p-4">
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 md:p-8">
                    <div class="flex justify-between items-start mb-6">
                        <h3 class="text-2xl font-bold flex items-center text-red-600">
                            <i class="fas fa-trash-alt w-6 h-6 mr-2"></i> Reset Present Window
                        </h3>
                        <button id="reset-present-cancel" class="text-gray-400 hover:text-gray-600 transition duration-150 hover:opacity-75">
                            <i class="fas fa-times w-6 h-6"></i>
                        </button>
                    </div>
                    <div class="space-y-4">
                        <p class="text-gray-700 font-semibold">Are you sure you want to reset the present window for this schedule? This will remove the countdown for students.</p>
                        <input type="hidden" id="reset-present-course-id">
                        <input type="hidden" id="reset-present-schedule-id">
                        <div class="flex justify-end space-x-3 pt-6 border-t border-gray-100">
                            <button id="reset-present-cancel-2" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-150 shadow-sm">Cancel</button>
                            <button id="reset-present-confirm-btn" onclick="instructorResetPresentWindowConfirm(event)" class="px-4 py-2 text-white font-semibold rounded-lg transition duration-150 shadow-sm" style="background-color:#dc2626;">Reset</button>
                        </div>
                    </div>
                </div>
            </div>

<!-- QR Code View Modal -->
<div id="qrCodeModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 backdrop-blur-sm hidden z-[120] flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6 md:p-8">
        <div class="flex justify-between items-start mb-6">
            <h3 class="text-2xl font-bold flex items-center text-purple-600">
                <i class="fas fa-qrcode w-6 h-6 mr-2"></i> QR Code
            </h3>
            <button onclick="closeQRCodeModal()" class="text-gray-400 hover:text-gray-600 transition duration-150 hover:opacity-75">
                <i class="fas fa-times w-6 h-6"></i>
            </button>
        </div>
        <div class="space-y-4">
            <div id="qrCodeModalCourseInfo" class="text-center mb-4">
                <p class="text-lg font-semibold text-gray-900" id="qrCodeModalCourseName"></p>
                <p class="text-sm text-gray-600" id="qrCodeModalCourseCode"></p>
            </div>
            <div class="flex justify-center">
                <div class="w-80 h-80 flex items-center justify-center bg-white border-4 border-purple-200 rounded-lg p-4 shadow-lg" style="min-width: 320px; min-height: 320px;">
                    <img id="qrCodeModalImage" 
                         src="" 
                         alt="QR Code" 
                         style="width: 100%; height: 100%; max-width: 300px; max-height: 300px; min-width: 300px; min-height: 300px; display: block !important; visibility: visible !important; opacity: 1 !important; object-fit: contain; background: white !important; image-rendering: crisp-edges;"
                         loading="eager">
                </div>
            </div>
            <p class="text-sm text-gray-600 text-center">Students can scan this QR code to mark attendance</p>
            <div class="flex justify-end pt-4 border-t border-gray-100">
                <button onclick="closeQRCodeModal()" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-150 shadow-sm">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Instructor School ID Scanner Modal -->
<div id="instructorSchoolIDScannerModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 backdrop-blur-sm hidden z-[120] flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 md:p-8 flex flex-col max-h-[90vh]">
        <div class="flex justify-between items-start mb-4 flex-shrink-0">
            <div>
                <h3 class="text-2xl font-bold flex items-center text-blue-600">
                    <i class="fas fa-camera w-6 h-6 mr-2"></i> Scan Student ID
                </h3>
                <p class="text-sm text-gray-600 mt-1" id="scanner-course-title"></p>
                <p class="text-xs text-gray-500" id="scanner-section-title"></p>
            </div>
            <button onclick="closeInstructorSchoolIDScanner()" class="text-gray-400 hover:text-gray-600 transition duration-150 hover:opacity-75">
                <i class="fas fa-times w-6 h-6"></i>
            </button>
        </div>
        
        <div class="flex-1 overflow-y-auto mb-4">
            <div id="instructor-scanner-container" class="w-full bg-gray-100 rounded-lg mb-4 min-h-[300px] flex items-center justify-center">
                <p class="text-gray-500 text-sm">Loading camera...</p>
            </div>
            
            <div class="space-y-2">
                <h4 class="text-sm font-semibold text-gray-700">Recently Scanned</h4>
                <div id="scanned-students-list" class="space-y-2 max-h-[200px] overflow-y-auto">
                    <p class="text-xs text-gray-500 text-center py-2">No students scanned yet</p>
                </div>
            </div>
        </div>
        
        <input type="hidden" id="scanner-course-id">
        <input type="hidden" id="scanner-schedule-id">
        
        <div class="flex justify-end pt-4 border-t border-gray-100 flex-shrink-0">
            <button onclick="closeInstructorSchoolIDScanner()" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-150 shadow-sm">
                Close
            </button>
        </div>
    </div>
</div>

<!-- Students List Modal -->
<div id="studentsListModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 backdrop-blur-sm hidden z-[120] flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[85vh] overflow-hidden flex flex-col">
        <div class="flex justify-between items-start p-6 border-b border-gray-200 flex-shrink-0">
            <h3 class="text-2xl font-bold flex items-center text-indigo-600">
                <i class="fas fa-users w-6 h-6 mr-2"></i> Students List
            </h3>
            <button onclick="closeStudentsListModal()" class="text-gray-400 hover:text-gray-600 transition duration-150 hover:opacity-75">
                <i class="fas fa-times w-6 h-6"></i>
            </button>
        </div>
        <div class="p-6 overflow-y-auto flex-1">
            <div class="space-y-2">
                {% if attendance_records %}
                    {% for record in attendance_records %}
                    <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg border border-green-200 hover:bg-green-100 transition duration-150">
                        <div class="flex items-center gap-3 min-w-0 flex-1">
                            <span class="text-xs font-bold text-gray-700 flex-shrink-0">{{ forloop.counter }}.</span>
                            {% if record.student.profile_picture %}
                            <img src="{{ record.student.profile_picture.url }}?v={{ record.student.id }}" 
                                 alt="{{ record.student.full_name|default:record.student.username }}" 
                                 class="w-10 h-10 rounded-full object-cover border-2 border-white flex-shrink-0 shadow-sm">
                            {% else %}
                            <div class="w-10 h-10 rounded-full flex items-center justify-center text-white text-sm font-bold flex-shrink-0 shadow-sm" 
                                 style="background: linear-gradient(135deg, #3C4770 0%, #447294 100%);">
                                {{ record.student.full_name|first|upper|default:record.student.username|first|upper }}
                            </div>
                            {% endif %}
                            <div class="min-w-0 flex-1">
                                <p class="text-sm font-semibold text-gray-900">{{ record.student.full_name|default:record.student.username }}</p>
                                <p class="text-xs text-gray-500">{{ record.attendance_time|time:"g:i A" }}</p>
                            </div>
                        </div>
                        <span class="ml-2 px-3 py-1.5 rounded-full text-xs font-semibold flex-shrink-0 {% if record.status == 'late' %}bg-yellow-100 text-yellow-700{% elif record.status == 'absent' %}bg-red-100 text-red-700{% else %}bg-green-100 text-green-700{% endif %}">
                            {{ record.get_status_display }}
                        </span>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-sm text-gray-500 text-center py-8">No students have attended yet.</p>
                {% endif %}
            </div>
        </div>
        <div class="flex justify-end p-6 border-t border-gray-200 flex-shrink-0">
            <button onclick="closeStudentsListModal()" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-150 shadow-sm">
                Close
            </button>
        </div>
    </div>
</div>

<!-- Attendance Status Change Modal -->
<div id="attendanceStatusModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 backdrop-blur-sm hidden z-[110] flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 md:p-8">
        <div class="flex justify-between items-start mb-6">
            <h3 id="attendance-modal-title-color" class="text-2xl font-bold flex items-center text-indigo-600">
                <i class="fas fa-clock w-6 h-6 mr-2"></i> Change Attendance Status
            </h3>
            <button data-close-attendance-modal class="text-gray-400 hover:text-gray-600 transition duration-150 hover:opacity-75">
                <i class="fas fa-times w-6 h-6"></i>
            </button>
        </div>
        <div class="space-y-4">
            <p class="text-gray-700 font-semibold">Are you sure you want to change the attendance status?</p>
            <div id="attendance-status-box" class="bg-indigo-50 border-l-4 border-indigo-500 p-4 rounded">
                <p class="font-semibold text-indigo-800" id="attendance-status-message"></p>
            </div>
            <input type="hidden" id="attendance-status-course-id">
            <input type="hidden" id="attendance-status-value">
            <input type="hidden" id="attendance-status-schedule-id">
            <input type="hidden" id="attendance-status-day">
            <div class="flex justify-end space-x-3 pt-6 border-t border-gray-100">
                <button data-close-attendance-modal class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-150 shadow-sm">
                    Cancel
                </button>
                <button id="attendance-confirm-btn" class="px-4 py-2 text-white font-semibold rounded-lg transition duration-150 shadow-sm" style="background-color: #4f46e5;">
                    <i class="fas fa-check mr-2"></i> Confirm
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Fallback for Html5Qrcode library with retry
(function loadHtml5Qrcode() {
    if (typeof Html5Qrcode === 'undefined') {
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js';
        script.onerror = function() {
            console.warn('Html5Qrcode CDN failed to load. Scanner functionality may be limited.');
            // Try fallback CDN
            const fallbackScript = document.createElement('script');
            fallbackScript.src = 'https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js';
            fallbackScript.onerror = function() {
                console.error('Both Html5Qrcode CDN sources failed. Scanning will not work.');
            };
            document.head.appendChild(fallbackScript);
        };
        document.head.appendChild(script);
    }
})();
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
<script>
let previousAttendanceStatus = null;
let attendanceStatusSelectElement = null;

// QR Code Image Handling Functions
function handleQRCodeLoad(img, courseId) {
    // Ensure image is always visible and STAYS visible
    if (img) {
        img.style.display = 'block';
        img.style.visibility = 'visible';
        img.style.opacity = '1';
        img.style.background = 'white';
        img.classList.add('qr-code-loaded');
        img.dataset.loaded = 'true';
        img.dataset.stable = 'true';  // Mark as stable - don't reload
        img.dataset.retryCount = '0';
        img.dataset.error = 'false';
        img.dataset.lastLoadTime = Date.now().toString();
        
        // Force browser to show image and prevent it from being replaced
        img.removeAttribute('hidden');
        
        // Set explicit styles to prevent any CSS from hiding it
        var currentStyle = img.getAttribute('style') || '';
        if (!currentStyle.includes('display: block')) {
            img.style.cssText += '; display: block !important; visibility: visible !important; opacity: 1 !important; background: white !important;';
        }
        
        console.log('QR code image loaded successfully for course ' + courseId + ', size:', img.naturalWidth, 'x', img.naturalHeight);
        
        // Verify image actually loaded (has dimensions and is visible)
        setTimeout(function() {
            if (img && img.complete && img.naturalHeight > 0 && img.naturalWidth > 0) {
                // Image successfully loaded - mark as stable and prevent reloads
                img.dataset.stable = 'true';
                img.dataset.loaded = 'true';
                console.log('QR code image stable and visible for course ' + courseId + ' - will not reload');
            } else if (img && (img.naturalWidth === 0 || img.naturalHeight === 0)) {
                // Only retry if image hasn't been marked as stable
                if (img.dataset.stable !== 'true') {
                    console.warn('QR code image loaded but has zero dimensions, retrying...');
                    retryQRCodeLoad(img, courseId);
                }
            }
        }, 200);
    }
}

function handleQRCodeError(img, courseId) {
    if (!img) return;
    
    // Don't retry if image is already marked as stable/loaded
    if (img.dataset.stable === 'true' && img.dataset.loaded === 'true') {
        console.log('QR code image is stable, ignoring error for course ' + courseId);
        return;
    }
    
    var retryCount = parseInt(img.dataset.retryCount || '0');
    console.error('QR code failed to load for course ' + courseId + ', retry count:', retryCount);
    
    // Mark as error but keep visible
    img.dataset.error = 'true';
    img.style.display = 'block';
    img.style.visibility = 'visible';
    img.style.opacity = '1';
    img.style.background = 'white';
    
    if (retryCount < 5) {  // Reduced retry count - don't retry too many times
        img.dataset.retryCount = (retryCount + 1).toString();
        var delay = Math.min(3000, 1000 * (retryCount + 1));  // Max 3 seconds delay
        setTimeout(function() {
            if (img && img.parentNode && img.dataset.stable !== 'true') {
                retryQRCodeLoad(img, courseId);
            }
        }, delay);
    } else {
        console.error('QR code failed to load after 5 retries for course ' + courseId);
        // Keep the image element visible - don't replace with text
        img.style.display = 'block';
        img.style.visibility = 'visible';
        img.style.opacity = '0.8';
        img.style.background = 'white';
        // Continue retrying but less frequently
        setTimeout(function() {
            if (img && img.parentNode && img.dataset.stable !== 'true' && img.dataset.loaded !== 'true') {
                img.dataset.retryCount = '0';  // Reset retry count
                retryQRCodeLoad(img, courseId);
            }
        }, 30000);  // Retry after 30 seconds
    }
}

function retryQRCodeLoad(img, courseId) {
    if (!img || !img.parentNode) return;
    
    // Don't retry if image is already stable/loaded
    if (img.dataset.stable === 'true' && img.dataset.loaded === 'true') {
        console.log('QR code image is stable, skipping retry for course ' + courseId);
        return;
    }
    
    // Use the stored URL from data attribute if available
    var baseUrl = img.dataset.url || '{% url "dashboard:instructor_qr_code" 0 %}'.replace('/0/', '/' + courseId + '/');
    var retryCount = parseInt(img.dataset.retryCount || '0') + 1;
    
    // Add cache-busting parameters with current date/day (session-based QR codes change daily)
    var now = new Date();
    var dateStr = now.getFullYear() + String(now.getMonth() + 1).padStart(2, '0') + String(now.getDate()).padStart(2, '0');
    var dayStr = now.getDay();  // 0=Sunday, 6=Saturday
    var newUrl = baseUrl + '?v=' + courseId + dateStr + dayStr;
    
    console.log('Retrying QR code load for course ' + courseId + ', attempt ' + retryCount + ', URL:', newUrl);
    
    // Only reload if image is not already loaded
    if (img.complete && img.naturalHeight > 0 && img.naturalWidth > 0) {
        console.log('QR code image already loaded, not retrying for course ' + courseId);
        img.dataset.loaded = 'true';
        img.dataset.stable = 'true';
        return;
    }
    
    // Force reload by setting src to empty first (but keep visible)
    img.style.opacity = '0.7';  // Show loading state
    var oldSrc = img.src;
    img.src = '';
    img.dataset.loaded = 'false';
    img.dataset.retryCount = retryCount.toString();
    
    // Use a small delay to ensure browser processes the src change
    setTimeout(function() {
        if (img && img.parentNode && img.dataset.stable !== 'true') {
            img.src = newUrl;
            img.style.opacity = '1';  // Restore opacity
        } else if (oldSrc && img.dataset.stable !== 'true') {
            // Restore old src if we shouldn't reload
            img.src = oldSrc;
            img.style.opacity = '1';
        }
    }, 300);  // Slightly longer delay for better browser processing
}

function showQRCodePlaceholder(img, courseId) {
    // DON'T replace image with text/SVG - keep the image element and retry
    // This prevents the QR code from being replaced with text
    if (img && img.parentNode) {
        // Keep the image visible and keep retrying - don't replace with text
        img.style.display = 'block';
        img.style.visibility = 'visible';
        img.style.opacity = '0.8';
        img.style.background = 'white';
        console.log('QR code placeholder requested for course ' + courseId + ', but keeping image element for retry');
        // Don't replace with SVG/text - just keep the image element and retry
    }
}

// Monitor QR code images to ensure they stay loaded (but don't reload unnecessarily)
(function() {
    var checkInterval = null;
    var isChecking = false;
    var loadedImages = new Set();  // Track successfully loaded images
    
    function checkQRCodeImages() {
        if (isChecking) return;  // Prevent concurrent checks
        isChecking = true;
        
        var qrCodeImages = document.querySelectorAll('.qr-code-image');
        qrCodeImages.forEach(function(img) {
            if (!img) return;
            
            var courseId = img.dataset.courseId;
            if (!courseId) return;
            
            var imgKey = courseId + '_' + img.src;
            
            // If image is already loaded and stable, don't touch it
            if (loadedImages.has(imgKey) && img.dataset.loaded === 'true' && !img.dataset.error) {
                // Just ensure visibility - don't reload
                img.style.display = 'block';
                img.style.visibility = 'visible';
                img.style.opacity = '1';
                img.style.background = 'white';
                return;  // Skip this image - it's already loaded
            }
            
            // Check if image is still visible and loaded
            var isVisible = img.offsetWidth > 0 && img.offsetHeight > 0 && 
                           img.naturalWidth > 0 && img.naturalHeight > 0 &&
                           window.getComputedStyle(img).display !== 'none' &&
                           window.getComputedStyle(img).visibility !== 'hidden' &&
                           window.getComputedStyle(img).opacity !== '0';
            
            // Check if image actually loaded (has valid data)
            var hasValidData = img.complete && img.naturalHeight !== 0 && !img.dataset.error;
            
            if (isVisible && hasValidData) {
                // Image is loaded successfully - mark it and don't reload
                img.style.display = 'block';
                img.style.visibility = 'visible';
                img.style.opacity = '1';
                img.style.background = 'white';
                img.dataset.loaded = 'true';
                img.dataset.error = 'false';
                loadedImages.add(imgKey);  // Mark as successfully loaded
            } else if (!isVisible || !hasValidData) {
                // Only retry if image is not loaded yet (not if it was already loaded)
                if (img.dataset.loaded !== 'true') {
                    if (img.dataset.loaded === 'true') {
                        console.warn('QR code image became invisible/invalid for course ' + courseId + ', refreshing...');
                        img.dataset.error = 'false';  // Reset error flag
                        loadedImages.delete(imgKey);  // Remove from loaded set
                    }
                    retryQRCodeLoad(img, courseId);
                }
            }
        });
        
        isChecking = false;
    }
    
    // Check less frequently - only every 60 seconds (reduced from 10 seconds)
    checkInterval = setInterval(checkQRCodeImages, 60000);
    
    // Also check when page becomes visible again (but only if images aren't loaded)
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
            // Only check if there are unloaded images
            var hasUnloaded = false;
            document.querySelectorAll('.qr-code-image').forEach(function(img) {
                if (img.dataset.loaded !== 'true') {
                    hasUnloaded = true;
                }
            });
            if (hasUnloaded) {
                setTimeout(checkQRCodeImages, 500);
            }
        }
    });
    
    // Initial check after page load (only once, not multiple times)
    setTimeout(checkQRCodeImages, 2000);
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
        if (checkInterval) {
            clearInterval(checkInterval);
        }
    });
})();

function handleAttendanceControlChange(event, courseId, selectElement, scheduleId, dayLabel) {
    if (!selectElement) {
        console.error('Select element not provided');
        return;
    }
    
    // Get the previous value (stored on focus)
    const previousValue = selectElement.dataset.previousValue || selectElement.value;
    
    // Get the new value that was selected (the select has already changed)
    const newValue = selectElement.value;
    
    // If the value didn't actually change, do nothing
    if (previousValue === newValue) {
        return;
    }
    
    // Find the indices
    const previousIndex = Array.from(selectElement.options).findIndex(opt => opt.value === previousValue);
    const newIndex = Array.from(selectElement.options).findIndex(opt => opt.value === newValue);
    
    // Revert to previous value immediately (we'll set it back after confirmation)
    if (previousIndex !== -1) {
        selectElement.selectedIndex = previousIndex;
    }
    
    // Store references
    attendanceStatusSelectElement = selectElement;
    if (newIndex !== -1) {
        selectElement.dataset.pendingIndex = newIndex;
    }
    selectElement.dataset.previousIndex = previousIndex;
    
    // Show the modal
    showAttendanceStatusModal(courseId, newValue, selectElement, previousIndex, scheduleId, dayLabel);
}

// Global helper to get CSRF token (uses existing getCookie if present, falls back to DOM)
if (typeof window._getCSRF === 'undefined') {
    window._getCSRF = function() {
        try {
            if (typeof getCookie === 'function') {
                const c = getCookie('csrftoken');
                if (c) return c;
            }
        } catch (e) {}
        const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfInput && csrfInput.value) return csrfInput.value;
        const meta = document.querySelector('meta[name="csrf-token"]');
        if (meta && meta.content) return meta.content;
        return '';
    };
}

// ========== Present window countdown (client-side) ==========
// Keeps a live countdown display when teacher sets the present window.
window.presentCountdownTimers = window.presentCountdownTimers || {};

function getPresentKey(courseId, scheduleId) {
    return `present_window_expiry_${courseId}_${scheduleId || 'none'}`;
}

function startPresentCountdown(minutes, courseId, scheduleId) {
    try {
        if (!courseId) return;
        const key = getPresentKey(courseId, scheduleId);
        const expiry = Date.now() + (minutes * 60 * 1000);
        // persist expiry to localStorage to survive reloads/tabs
        localStorage.setItem(key, String(expiry));
        // create/update timer
        createOrUpdateTimer(key, expiry);
    } catch (e) {
        console.error('startPresentCountdown error', e);
    }
}

function stopPresentCountdownForKey(key) {
    try {
        const t = window.presentCountdownTimers[key];
        if (t) {
            if (t.interval) clearInterval(t.interval);
            if (t.timeout) clearTimeout(t.timeout);
        }
        delete window.presentCountdownTimers[key];
        localStorage.removeItem(key);
    } catch (e) {
        console.error('stopPresentCountdownForKey error', e);
    }
}

function createOrUpdateTimer(key, expiry) {
    // clear existing
    if (window.presentCountdownTimers[key]) {
        if (window.presentCountdownTimers[key].interval) clearInterval(window.presentCountdownTimers[key].interval);
        if (window.presentCountdownTimers[key].timeout) clearTimeout(window.presentCountdownTimers[key].timeout);
    }

    const updateFn = function() {
        const now = Date.now();
        const remaining = expiry - now;
        const displayEl = document.getElementById('window-time');
        if (!displayEl) return;
        if (remaining <= 0) {
            displayEl.textContent = '00:00';
            // show ended state once
            if (!window.presentCountdownTimers[key]?.ended) {
                window.presentCountdownTimers[key] = window.presentCountdownTimers[key] || {};
                window.presentCountdownTimers[key].ended = true;
                // Notify teacher
                if (typeof showNotification === 'function') {
                    showNotification('Present window ended — students who scan now will be marked late.', 'error');
                }
                // Optionally mark badge/UI - change active display style
                const activeDisplay = document.getElementById('active-window-display');
                if (activeDisplay) activeDisplay.classList.add('opacity-60');
            }
            // stop timer and remove persisted key
            stopPresentCountdownForKey(key);
            return;
        }
        const secs = Math.floor(remaining / 1000);
        const mm = String(Math.floor(secs / 60)).padStart(2, '0');
        const ss = String(secs % 60).padStart(2, '0');
        displayEl.textContent = `${mm}:${ss}`;
    };

    // run immediately then align to real-world seconds to avoid drift
    updateFn();
    // compute ms until next full second
    const msToNextSecond = 1000 - (Date.now() % 1000) || 1000;
    const timeout = setTimeout(() => {
        // first aligned tick
        updateFn();
        // then run every full second
        const interval = setInterval(updateFn, 1000);
        window.presentCountdownTimers[key] = { interval: interval, timeout: null, expiry: expiry, ended: false };
    }, msToNextSecond);
    // store timeout so we can clear it if needed
    window.presentCountdownTimers[key] = { interval: null, timeout: timeout, expiry: expiry, ended: false };
}

// Resume any active countdowns saved in localStorage on load
function resumePresentCountdownFromStorage() {
    try {
        // only resume for the currently focused course (avoid flooding UI)
        const attendanceControl = document.getElementById('attendance-control');
        if (!attendanceControl) return;
        // use raw data attributes so the key is unique per schedule
        const courseId = attendanceControl.getAttribute('data-course-id') || '';
        const scheduleId = attendanceControl.getAttribute('data-schedule-id') || 'none';
        const key = getPresentKey(courseId, scheduleId);
        const expiryStr = localStorage.getItem(key);
        if (expiryStr) {
            const expiry = parseInt(expiryStr, 10);
            if (!isNaN(expiry) && expiry > Date.now()) {
                createOrUpdateTimer(key, expiry);
                const activeDisplay = document.getElementById('active-window-display');
                if (activeDisplay) activeDisplay.classList.remove('hidden');
            } else {
                // expired - clean up
                localStorage.removeItem(key);
            }
        }
    } catch (e) {
        console.error('resumePresentCountdownFromStorage error', e);
    }
}

// Listen for storage changes from other tabs/windows to sync countdowns
window.addEventListener('storage', function(e) {
    try {
        if (!e.key) return;
        if (!e.key.startsWith('present_window_expiry_')) return;
        // If set, start/update timer; if removed, stop timer
        if (e.newValue) {
            const expiry = parseInt(e.newValue, 10);
            if (!isNaN(expiry) && expiry > Date.now()) {
                createOrUpdateTimer(e.key, expiry);
                const activeDisplay = document.getElementById('active-window-display');
                if (activeDisplay) activeDisplay.classList.remove('hidden');
            }
        } else {
            // removed
            if (window.presentCountdownTimers[e.key]) {
                stopPresentCountdownForKey(e.key);
            }
        }
    } catch (err) {
        console.error('storage event handler error', err);
    }
});


function showAttendanceStatusModal(courseId, status, selectElement, previousIndex, scheduleId, dayLabel) {
    console.log('showAttendanceStatusModal called', { courseId, status, previousIndex, scheduleId, dayLabel });
    
    if (!selectElement) {
        console.error('Select element not provided');
        return;
    }
    
    // Store the previous index for restoration
    if (previousIndex !== undefined) {
        selectElement.dataset.previousIndex = previousIndex;
    } else {
        const currentIndex = selectElement.selectedIndex;
        selectElement.dataset.previousIndex = currentIndex;
    }
    
    // Store the pending new index
    const pendingIndex = Array.from(selectElement.options).findIndex(opt => opt.value === status);
    if (pendingIndex !== -1) {
        selectElement.dataset.pendingIndex = pendingIndex;
    }
    
    const statusLabels = {
        'postponed': 'Postponed',
        'closed': 'Closed Attendance',
        'open': 'Open Attendance',
        'stopped': 'Stop Attendance'
    };
    
    const statusColors = {
        // Map status -> tailwind classes + hex colors so we can apply inline styles if classes are overridden
        'postponed': {
            bg: 'bg-yellow-50', border: 'border-yellow-500', text: 'text-yellow-800', btn: 'bg-yellow-500 hover:bg-yellow-600',
            bgHex: '#FFFBEB', borderHex: '#F59E0B', textHex: '#92400E', btnHex: '#F59E0B'
        },
        'closed': {
            bg: 'bg-red-50', border: 'border-red-500', text: 'text-red-800', btn: 'bg-red-600 hover:bg-red-700',
            bgHex: '#FFF1F2', borderHex: '#EF4444', textHex: '#7F1D1D', btnHex: '#DC2626'
        },
        'open': {
            bg: 'bg-green-50', border: 'border-green-500', text: 'text-green-800', btn: 'bg-green-600 hover:bg-green-700',
            bgHex: '#ECFDF5', borderHex: '#22C55E', textHex: '#14532D', btnHex: '#16A34A'
        },
        'stopped': {
            bg: 'bg-gray-50', border: 'border-gray-300', text: 'text-gray-800', btn: 'bg-gray-600 hover:bg-gray-700',
            bgHex: '#F9FAFB', borderHex: '#D1D5DB', textHex: '#374151', btnHex: '#4B5563'
        }
    };
    
    const colors = statusColors[status] || statusColors['closed'];
    
    const modal = document.getElementById('attendanceStatusModal');
    if (!modal) {
        console.error('Attendance status modal not found');
        return;
    }
    
    const titleColor = document.getElementById('attendance-modal-title-color');
    const statusBox = document.getElementById('attendance-status-box');
    const confirmBtn = document.getElementById('attendance-confirm-btn');
    
    if (!titleColor || !statusBox || !confirmBtn) {
        console.error('Modal elements not found');
        return;
    }
    
    document.getElementById('attendance-status-course-id').value = courseId;
    document.getElementById('attendance-status-value').value = status;
    if (scheduleId) {
        document.getElementById('attendance-status-schedule-id').value = scheduleId;
    } else {
        document.getElementById('attendance-status-schedule-id').value = '';
    }
    if (dayLabel) {
        document.getElementById('attendance-status-day').value = dayLabel;
    } else {
        document.getElementById('attendance-status-day').value = '';
    }
    const dayText = dayLabel ? ` for ${dayLabel}` : '';
    document.getElementById('attendance-status-message').textContent = `Change attendance status to "${statusLabels[status]}"${dayText}?`;
    
    // Update colors based on status
    titleColor.className = `text-2xl font-bold flex items-center ${colors.text}`;
    statusBox.className = `p-4 rounded border-l-4 ${colors.bg} ${colors.border}`;
    document.getElementById('attendance-status-message').className = `font-semibold ${colors.text}`;
    confirmBtn.className = `px-4 py-2 text-white font-semibold rounded-lg transition duration-150 shadow-sm ${colors.btn}`;
    // Remove any existing inline background color (from template) and apply inline hex colors as a stronger override
    try {
        confirmBtn.removeAttribute('style');
    } catch (e) {}
    try {
        if (colors.bgHex && statusBox) statusBox.style.backgroundColor = colors.bgHex;
        if (colors.borderHex && statusBox) statusBox.style.borderLeftColor = colors.borderHex;
        if (colors.textHex && titleColor) titleColor.style.color = colors.textHex;
        if (colors.btnHex && confirmBtn) confirmBtn.style.backgroundColor = colors.btnHex;
        // tint the icon inside title
        try { const ic = titleColor.querySelector('i'); if (ic && colors.textHex) ic.style.color = colors.textHex; } catch(e) {}
    } catch (e) { console.warn('Failed to apply inline modal colors', e); }
    
    console.log('About to show modal - removing hidden class');
    modal.classList.remove('hidden');
    console.log('Modal shown. Modal classes:', modal.className);
}

function closeAttendanceStatusModal() {
    const modal = document.getElementById('attendanceStatusModal');
    modal.classList.add('hidden');
    // Reset select to previous value
    if (attendanceStatusSelectElement && attendanceStatusSelectElement.dataset.previousIndex !== undefined) {
        const prevIndex = parseInt(attendanceStatusSelectElement.dataset.previousIndex);
        attendanceStatusSelectElement.selectedIndex = prevIndex;
        delete attendanceStatusSelectElement.dataset.previousIndex;
    }
    previousAttendanceStatus = null;
    attendanceStatusSelectElement = null;
}

function copyQRCode(code) {
    if (!code || code === 'Not generated' || code === '') {
        if (typeof showNotification === 'function') {
            showNotification('QR code not available', 'error');
        } else {
            alert('QR code not available');
        }
        return;
    }
    
    navigator.clipboard.writeText(code).then(() => {
        if (typeof showNotification === 'function') {
            showNotification('QR code copied to clipboard!', 'success');
        } else {
            alert('QR code copied to clipboard!');
        }
    }).catch(err => {
        console.error('Failed to copy:', err);
        if (typeof showNotification === 'function') {
            showNotification('Failed to copy QR code. Please copy manually: ' + code, 'error');
        } else {
            alert('Failed to copy QR code. Please copy manually: ' + code);
        }
    });
}

function confirmAttendanceStatusChange() {
    const courseId = document.getElementById('attendance-status-course-id').value;
    const status = document.getElementById('attendance-status-value').value;
    const scheduleId = document.getElementById('attendance-status-schedule-id').value;
    const day = document.getElementById('attendance-status-day').value;
    
    if (!courseId || !status) {
        closeAttendanceStatusModal();
        return;
    }
    
    // Update the select to the new value (since user confirmed)
    if (attendanceStatusSelectElement && attendanceStatusSelectElement.dataset.pendingIndex !== undefined) {
        const pendingIndex = parseInt(attendanceStatusSelectElement.dataset.pendingIndex);
        attendanceStatusSelectElement.selectedIndex = pendingIndex;
        attendanceStatusSelectElement.dataset.previousIndex = pendingIndex;
        delete attendanceStatusSelectElement.dataset.pendingIndex;
    }
    
    closeAttendanceStatusModal();
    
    // Build request body with optional day/schedule_id
    const requestBody = { status: status };
    if (scheduleId) {
        requestBody.schedule_id = scheduleId;
    }
    if (day) {
        // Convert day label to short form (e.g., 'Monday' -> 'Mon')
        const dayMap = {
            'Monday': 'Mon', 'Tuesday': 'Tue', 'Wednesday': 'Wed', 'Thursday': 'Thu',
            'Friday': 'Fri', 'Saturday': 'Sat', 'Sunday': 'Sun'
        };
        requestBody.day = dayMap[day] || day;
    }
    // Include present_duration if opening attendance
    try {
        if (status === 'open') {
            const sidebarInput = document.getElementById('sidebarPresentDuration');
            if (sidebarInput && sidebarInput.value) {
                const pd = parseInt(sidebarInput.value, 10);
                if (!isNaN(pd) && pd > 0) requestBody.present_duration = pd;
            }
        }
    } catch (e) {
        console.error('Error reading present duration input:', e);
    }
    
    // Helper to get CSRF token from cookie or page (works even if template csrf token is not present)
    function _getCSRF() {
        try {
            if (typeof getCookie === 'function') {
                const c = getCookie('csrftoken');
                if (c) return c;
            }
        } catch (e) {}
        // Fallback to hidden input token or meta tag
        const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfInput && csrfInput.value) return csrfInput.value;
        const meta = document.querySelector('meta[name="csrf-token"]');
        if (meta && meta.content) return meta.content;
        return '{{ csrf_token }}';
    }

    // Load Html5Qrcode with fallback attempts (CDN -> unpkg -> local static)
    function loadHtml5QrcodeWithFallback() {
        return new Promise((resolve, reject) => {
            if (window.Html5Qrcode) return resolve(window.Html5Qrcode);
            const urls = [
                'https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js',
                'https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js',
                '/static/js/html5-qrcode.min.js'
            ];
            let tried = 0;
            function tryNext() {
                if (tried >= urls.length) return reject(new Error('All loaders failed'));
                const s = document.createElement('script');
                s.src = urls[tried++];
                s.async = true;
                s.onload = () => {
                    if (window.Html5Qrcode) return resolve(window.Html5Qrcode);
                    // some bundles may attach differently; still resolve if present
                    if (window.Html5Qrcode || window.Html5QrcodeScanType) return resolve(window.Html5Qrcode || window);
                    // otherwise try next
                    tryNext();
                };
                s.onerror = () => {
                    // try next CDN/fallback
                    tryNext();
                };
                document.head.appendChild(s);
            }
            tryNext();
        });
    }

    // Debug: log payload, CSRF token and request URL to help diagnose persistence issues
    try {
        const debugUrl = '{% url "dashboard:instructor_update_attendance_status" 0 %}'.replace('0', courseId);
        console.log('Attendance status POST ->', debugUrl, requestBody, 'CSRF:', _getCSRF());

        fetch(debugUrl, {
            method: 'POST',
            headers: {
                'X-CSRFToken': _getCSRF(),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestBody)
        })
        .then(response => {
            // Log raw response status for debugging
            console.log('Attendance status response status:', response.status, response.statusText);
            return response.json();
        })
        .then(data => {
            console.log('Attendance status response JSON:', data);
            if (data.success) {
                if (typeof showNotification === 'function') {
                    showNotification(data.message || 'Attendance status updated successfully!', 'success');
                }
                // Log server-confirmed status for debugging
                if (data.updated_status) {
                    console.log('Server confirmed new status:', data.updated_status);
                }
                // If server reports attendance opened, enable Scan button immediately (UX fallback)
                try {
                    if (data.updated_status === 'open') {
                        // enable scan elements for this course/schedule before reload
                        try { enableScanForCourse(courseId, requestBody.schedule_id || ''); } catch (e) { console.warn('enableScanForCourse failed', e); }

                        // Update the small helper message in the Scan block so the UI reflects 'open' immediately
                        try {
                            const p3Blocks = Array.from(document.querySelectorAll('.p-3'));
                            for (const b of p3Blocks) {
                                if (b.textContent && b.textContent.includes('Scan Student ID')) {
                                    // find the message paragraph (the small info/warning paragraph)
                                    const msg = b.querySelector('p.text-[10px]');
                                    if (msg) {
                                        msg.textContent = 'Open camera to scan student school ID for attendance';
                                        msg.className = 'text-[10px] text-gray-600 text-center';
                                    }
                                    break;
                                }
                            }
                        } catch (e) { console.warn('Failed to update Scan block message', e); }
                    }
                } catch (e) { console.warn('Error while attempting to enable scan button', e); }
                // Reload after a short delay to show updated status
                setTimeout(() => location.reload(), 500);
            } else {
                if (typeof showNotification === 'function') {
                    showNotification(data.message || 'Error updating attendance status.', 'error');
                }
                // Reset select on error
                if (attendanceStatusSelectElement && attendanceStatusSelectElement.dataset.previousIndex !== undefined) {
                    const prevIndex = parseInt(attendanceStatusSelectElement.dataset.previousIndex);
                    attendanceStatusSelectElement.selectedIndex = prevIndex;
                }
            }
        })
        .catch(err => {
            console.error('Network error while updating attendance status:', err);
            if (typeof showNotification === 'function') {
                showNotification('Network error while updating attendance status', 'error');
            }
            if (attendanceStatusSelectElement && attendanceStatusSelectElement.dataset.previousIndex !== undefined) {
                const prevIndex = parseInt(attendanceStatusSelectElement.dataset.previousIndex);
                attendanceStatusSelectElement.selectedIndex = prevIndex;
            }
        });
    } catch (dbgErr) {
        console.error('Debug wrapper error:', dbgErr);
    }
}

// Instructor School ID Scanner
let instructorSchoolIDScanner = null;

window.openInstructorSchoolIDScanner = function(courseId, courseCode, courseName, section, scheduleId) {
    console.log('openInstructorSchoolIDScanner invoked', { courseId: courseId, courseCode: courseCode, courseName: courseName, section: section, scheduleId: scheduleId });
    const modal = document.getElementById('instructorSchoolIDScannerModal');
    if (!modal) {
        console.error('Instructor School ID Scanner modal not found');
        alert('Scanner modal not found. Please refresh the page.');
        return;
    }
    
    // Normalize courseId: extract numeric part from composite keys like "73_F_20251212"
    let normalizedCourseId = courseId;
    if (courseId && typeof courseId === 'string' && courseId.includes('_')) {
        normalizedCourseId = parseInt(courseId.split('_')[0]);
    }
    
    // Normalize scheduleId: extract numeric part from composite keys like "73_F_20251212"
    let normalizedScheduleId = scheduleId;
    if (scheduleId && typeof scheduleId === 'string' && scheduleId.includes('_')) {
        normalizedScheduleId = parseInt(scheduleId.split('_')[0]);
    }
    
    // Set modal title
    document.getElementById('scanner-course-title').textContent = `${courseCode} - ${courseName}`;
    document.getElementById('scanner-section-title').textContent = `Section: ${section || 'N/A'}`;
    document.getElementById('scanner-course-id').value = normalizedCourseId;
    document.getElementById('scanner-schedule-id').value = normalizedScheduleId || '';
    
    // Show modal
    modal.classList.remove('hidden');
    
    // Start scanner after modal is visible
    setTimeout(() => {
        startInstructorSchoolIDScanner(normalizedCourseId, section);
    }, 100);
};

window.closeInstructorSchoolIDScanner = function() {
    const modal = document.getElementById('instructorSchoolIDScannerModal');
    if (modal) {
        modal.classList.add('hidden');
    }
    
    // Stop scanner
    if (instructorSchoolIDScanner) {
        instructorSchoolIDScanner.stop().catch(err => console.log('Scanner already stopped'));
        instructorSchoolIDScanner = null;
    }
};

window.startInstructorSchoolIDScanner = async function(courseId, section) {
    // Ensure html5-qrcode is available; attempt to load with fallback if missing
    if (typeof Html5Qrcode === 'undefined') {
        loadHtml5QrcodeWithFallback().then(() => {
            // retry starting after library loads
            startInstructorSchoolIDScanner(courseId, section);
        }).catch(err => {
            console.error('Failed to load Html5Qrcode:', err);
            alert('QR Code scanner library not available. Please refresh the page.');
        });
        return;
    }
    
    const scannerContainer = document.getElementById('instructor-scanner-container');
    if (!scannerContainer) {
        console.error('Scanner container not found');
        return;
    }
    
    // Clear previous scanner if exists - await its stop to avoid race conditions
    if (instructorSchoolIDScanner) {
        try {
            await instructorSchoolIDScanner.stop();
            console.log('Previous scanner stopped (awaited)');
        } catch (err) {
            console.log('Previous scanner stop() threw:', err);
        }
        instructorSchoolIDScanner = null;
        scannerContainer.innerHTML = '';
    }
    
    // Create scanner element
    scannerContainer.innerHTML = '<div id="instructor-qr-scanner" style="width:100%;"></div>';
    
    instructorSchoolIDScanner = new Html5Qrcode('instructor-qr-scanner');
    
    const qrCodeConfig = {
        fps: 20,
        qrbox: { width: 300, height: 300 },
        rememberLastUsedCamera: true,
        supportedScanTypes: [Html5QrcodeScanType.CAMERA, Html5QrcodeScanType.CAMERA_AND_FILE],
        disableFlip: false,
        aspectRatio: 1.0
    };
    
    instructorSchoolIDScanner.start(
        { facingMode: 'environment' },
        qrCodeConfig,
        onInstructorSchoolIDScanned,
        onInstructorScanError
    ).catch(err => {
        console.error('Failed to start scanner:', err);
        alert('Unable to start camera. Please check permissions.');
        closeInstructorSchoolIDScanner();
    });
};

window.onInstructorSchoolIDScanned = async function(decodedText, decodedResult) {
    const courseId = document.getElementById('scanner-course-id').value;
    const scheduleId = document.getElementById('scanner-schedule-id').value;
    
    if (!courseId) {
        console.error('Course ID not found');
        return;
    }
    
    // Stop scanner while processing and await stop to ensure camera resources are released
    if (instructorSchoolIDScanner) {
        try {
            await instructorSchoolIDScanner.stop();
            console.log('Scanner stopped for processing (awaited)');
        } catch (err) {
            console.log('Error stopping scanner before processing:', err);
        }
        instructorSchoolIDScanner = null;
    }
    
    // Send scanned school ID to backend to create/update attendance record
    const scheduleIdVal = document.getElementById('scanner-schedule-id').value || null;
    const courseIdVal = document.getElementById('scanner-course-id').value;
    
    fetch('{% url "dashboard:instructor_scan_student_school_id" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
        },
        body: JSON.stringify({
            school_id: decodedText.trim(),
            course_id: parseInt(courseIdVal),
            schedule_id: scheduleIdVal || null
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const scanned = data.scanned_value ? ` [${data.scanned_value}]` : '';
            const status = data.status || 'present';
            const msg = `${data.student_name} marked ${status === 'late' ? 'late' : 'present'}${scanned}`;
            const notifType = status === 'late' ? 'warning' : 'success';
            showScannerNotification(`✓ ${msg}`, notifType);
            // Play sound: success for present, error for late
            try { if (status === 'late') playScanErrorSound(); else playScanSuccessSound(); } catch(e) { console.debug('audio fail', e); }
            updateScannedStudentsList();

            // store last scanned student's DB id for quick Early/Late actions
            if (data.student_pk) {
                window.lastScannedStudentPk = data.student_pk;
                console.log('Last scanned student pk set to', window.lastScannedStudentPk);
            } else {
                window.lastScannedStudentPk = null;
            }

            // Resume scanner shortly to allow next student
            setTimeout(() => {
                startInstructorSchoolIDScanner(courseId, document.getElementById('scanner-section-title').textContent);
            }, 800);
        } else {
            showScannerNotification(`✗ ${data.message}`, 'error');
            // Play error sound
            try { playScanErrorSound(); } catch(e) { console.debug('audio fail', e); }

            // Resume scanner to allow retry
            setTimeout(() => {
                startInstructorSchoolIDScanner(courseId, document.getElementById('scanner-section-title').textContent);
            }, 1400);
        }
    })
    .catch(err => {
        console.error('Error scanning QR code:', err);
        showScannerNotification('Error: Could not process scan', 'error');

        setTimeout(() => {
            startInstructorSchoolIDScanner(courseId, document.getElementById('scanner-section-title').textContent);
        }, 1400);
    });
};

window.onInstructorScanError = function(error) {
    // Ignore QR code scanner errors (it logs them internally)
};

// Global storage for last scanned student info
window.lastScannedStudentPk = null;
window.lastScannedCourseId = null;
window.lastScannedScheduleId = null;

// Audio feedback using Web Audio API (no external files required)
function playScanSuccessSound() {
    try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        // Classic barcode beep: two quick 1200 Hz beeps (40ms each, 60ms gap)
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'sine';
        o.frequency.value = 1200; // Barcode scanner pitch
        o.connect(g);
        g.connect(ctx.destination);
        
        // First beep
        g.gain.setValueAtTime(0.3, ctx.currentTime);
        o.start(ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.04);
        o.stop(ctx.currentTime + 0.04);
        
        // Second beep (after 100ms total from start)
        g.gain.setValueAtTime(0.3, ctx.currentTime + 0.1);
        o.start(ctx.currentTime + 0.1);
        g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.14);
        o.stop(ctx.currentTime + 0.14);
    } catch (e) { console.debug('Audio not supported', e); }
}

function playScanErrorSound() {
    try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        // Error buzzer: low pitch (500Hz) longer tone with quick fade
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'sawtooth';
        o.frequency.value = 500; // Lower barcode-like tone for error
        o.connect(g);
        g.connect(ctx.destination);
        g.gain.setValueAtTime(0.25, ctx.currentTime);
        o.start(ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
        o.stop(ctx.currentTime + 0.2);
    } catch (e) { console.debug('Audio not supported', e); }
}

// UX helper: enable/insert a Scan button for a course/schedule (used immediately after opening attendance)
function enableScanForCourse(courseId, scheduleId) {
    try {
        // Extract numeric course ID if it contains composite key like "73_F_20251212"
        let numericCourseId = courseId;
        if (courseId && courseId.includes('_')) {
            numericCourseId = courseId.split('_')[0];
        }
        
        // If an enabled scanner already exists for this course, nothing to do
        const existing = document.querySelector(`.open-instructor-scanner[data-course-id="${courseId}"]`);
        if (existing) return existing;

        // Find a disabled 'Scan' button on the page (fallback: match disabled buttons containing 'Scan')
        const disabledCandidates = Array.from(document.querySelectorAll('button[disabled]'))
            .filter(b => b.textContent && b.textContent.trim().toLowerCase().includes('scan'));

        let targetBtn = disabledCandidates.length ? disabledCandidates[0] : null;
        if (!targetBtn) {
            // Try to find any element that looks like the Scan area and insert near it
            targetBtn = document.querySelector('.p-3.bg-blue-50') || document.querySelector('.p-3');
            if (!targetBtn) return null;
        } else {
            targetBtn = targetBtn.parentElement || targetBtn;
        }

        // Create new Scan button
        const newBtn = document.createElement('button');
        newBtn.setAttribute('data-course-id', numericCourseId);
        if (scheduleId) newBtn.setAttribute('data-schedule-id', scheduleId);
        newBtn.className = 'open-instructor-scanner px-3 py-1.5 bg-blue-600 text-white text-xs font-semibold rounded-lg hover:bg-blue-700 transition duration-150 shadow-sm flex items-center gap-1';
        newBtn.innerHTML = '<i class="fas fa-camera text-xs"></i> Scan';

        // Attach click handler to open scanner (pass minimal info; openInstructorSchoolIDScanner tolerates missing names)
        newBtn.addEventListener('click', function(e) {
            e.preventDefault();
            window.openInstructorSchoolIDScanner(numericCourseId, '', '', '', scheduleId);
        });

        // Replace disabled button node if we found a direct disabled button, otherwise append into the target container
        const firstDisabled = document.querySelector('button[disabled]');
        if (firstDisabled && firstDisabled.textContent && firstDisabled.textContent.trim().toLowerCase().includes('scan')) {
            firstDisabled.parentElement.replaceChild(newBtn, firstDisabled);
        } else if (targetBtn instanceof HTMLElement && targetBtn.classList && targetBtn.classList.contains('p-3')) {
            // try to find the right place inside this block (the header flex)
            const header = targetBtn.querySelector('.flex.items-center.justify-between');
            if (header) {
                // remove any existing disabled scan button inside header
                const dis = header.querySelector('button[disabled]');
                if (dis) header.replaceChild(newBtn, dis);
                else header.appendChild(newBtn);
            } else {
                targetBtn.appendChild(newBtn);
            }
        } else if (targetBtn instanceof HTMLElement) {
            targetBtn.appendChild(newBtn);
        }
        return newBtn;
    } catch (e) {
        console.error('enableScanForCourse error', e);
        return null;
    }
}

window.showScannerNotification = function(message, type) {
    const notification = document.createElement('div');
    let cls = 'bg-red-500 text-white';
    if (type === 'success') cls = 'bg-green-500 text-white';
    else if (type === 'warning') cls = 'bg-yellow-300 text-black';
    notification.className = `px-4 py-3 rounded-lg font-semibold text-sm fixed top-4 right-4 z-[999] ${cls}`;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        try { notification.remove(); } catch (e) {}
    }, 3000);
};

window.updateScannedStudentsList = function() {
    const courseId = document.getElementById('scanner-course-id').value;
    const scheduleId = document.getElementById('scanner-schedule-id').value;
    
    // Fetch updated scanned students for this course/schedule
    const params = new URLSearchParams();
    params.append('course_id', courseId);
    if (scheduleId) params.append('schedule_id', scheduleId);
    
    fetch(`{% url 'dashboard:instructor_get_scanned_students' %}?${params}`)
        .then(response => response.json())
        .then(data => {
            const list = document.getElementById('scanned-students-list');
            if (list && data.students) {
                list.innerHTML = data.students.map(student => {
                    const status = student.status || 'present';
                    const bg = status === 'late' ? 'bg-yellow-50 border-yellow-200' : (status === 'absent' ? 'bg-red-50 border-red-200' : 'bg-green-50 border-green-200');
                    const timeLabel = student.time || 'N/A';
                    return `
                    <div class="flex items-center justify-between p-2 ${bg} rounded-lg border">
                        <span class="text-sm font-semibold text-gray-900">${student.name} <span class="text-xs text-gray-500">${status === 'late' ? '(Late)' : ''}</span></span>
                        <span class="text-xs text-gray-500">${timeLabel}</span>
                    </div>`;
                }).join('');
            }
            // Update scanned count display if provided
            if (typeof data.count !== 'undefined') {
                const countEl = document.getElementById('student-scanned-count');
                if (countEl) countEl.textContent = data.count;
            }
        })
        .catch(err => console.log('Could not update scanned students list'));
};

// QR Code Modal Functions
window.showQRCodeModal = function(courseId, courseCode, courseName, scheduleDay) {
    try {
        const modal = document.getElementById('qrCodeModal');
        if (!modal) {
            console.error('QR Code modal not found');
            alert('QR Code modal not found. Please refresh the page.');
            return;
        }
        
        const modalImage = document.getElementById('qrCodeModalImage');
        const modalCourseName = document.getElementById('qrCodeModalCourseName');
        const modalCourseCode = document.getElementById('qrCodeModalCourseCode');
        
        if (!modalImage || !modalCourseName || !modalCourseCode) {
            console.error('QR Code modal elements not found');
            alert('QR Code modal elements not found. Please refresh the page.');
            return;
        }
        
        // Set course info
        modalCourseName.textContent = courseName;
        modalCourseCode.textContent = courseCode;
        
        // Get QR code URL - use the same URL as the small image, preserving the day parameter
        const smallImage = document.getElementById(`qr-code-img-${courseId}`);
        let qrCodeUrl = '';
        if (smallImage && smallImage.dataset.url) {
            qrCodeUrl = smallImage.dataset.url;
        } else {
            qrCodeUrl = `/dashboard/instructor/courses/${courseId}/qr-code/`;
        }
        
        // Get the day from parameter or from the small image's data attribute
        let dayParam = scheduleDay || '';
        if (!dayParam && smallImage && smallImage.dataset.scheduleDay) {
            dayParam = smallImage.dataset.scheduleDay;
        }
        
        // Build URL with day parameter if available
        if (dayParam) {
            // Remove existing day parameter if present
            qrCodeUrl = qrCodeUrl.split('&day=')[0].split('?day=')[0];
            // Add day parameter
            const separator = qrCodeUrl.includes('?') ? '&' : '?';
            qrCodeUrl += `${separator}day=${encodeURIComponent(dayParam)}`;
        }
        
        // Add cache-busting parameter (but don't include timestamp to keep QR stable)
        const separator = qrCodeUrl.includes('?') ? '&' : '?';
        qrCodeUrl += `${separator}v=${courseId}&modal=true`;
        
        // Set image source
        modalImage.src = qrCodeUrl;
        modalImage.alt = `QR Code for ${courseCode} - ${courseName}${dayParam ? ' (' + dayParam + ')' : ''}`;
        
        // Show modal
        modal.classList.remove('hidden');
        console.log('QR Code modal opened for course:', courseId, 'day:', dayParam || 'all days');
    } catch (error) {
        console.error('Error opening QR Code modal:', error);
        alert('Error opening QR Code modal. Please try again.');
    }
};

window.closeQRCodeModal = function() {
    try {
        const modal = document.getElementById('qrCodeModal');
        if (modal) {
            modal.classList.add('hidden');
        }
    } catch (error) {
        console.error('Error closing QR Code modal:', error);
    }
};

// Students List Modal Functions
window.showStudentsListModal = function() {
    try {
        const modal = document.getElementById('studentsListModal');
        if (modal) {
            modal.classList.remove('hidden');
        }
    } catch (error) {
        console.error('Error opening Students List modal:', error);
    }
};

window.closeStudentsListModal = function() {
    try {
        const modal = document.getElementById('studentsListModal');
        if (modal) {
            modal.classList.add('hidden');
        }
    } catch (error) {
        console.error('Error closing Students List modal:', error);
    }
};

// Quick Pick Active State Management
(function() {
    // Get the current schedule ID from URL (not just course ID)
    const urlParams = new URLSearchParams(window.location.search);
    const currentScheduleId = urlParams.get('schedule');
    const currentCourseId = urlParams.get('course');
    
    // Set active state on page load based on specific schedule ID
    if (currentScheduleId) {
        const quickPickItems = document.querySelectorAll('.quick-pick-item');
        quickPickItems.forEach(item => {
            const scheduleId = item.getAttribute('data-schedule-id');
            if (scheduleId === currentScheduleId) {
                item.classList.add('border-indigo-500', 'bg-indigo-50', 'shadow-md');
                item.classList.remove('hover:border-indigo-300', 'hover:bg-indigo-50/40');
            } else {
                // Remove active state from other items
                item.classList.remove('border-indigo-500', 'bg-indigo-50', 'shadow-md');
                item.classList.add('hover:border-indigo-300', 'hover:bg-indigo-50/40');
            }
        });
    } else if (currentCourseId) {
        // Fallback: if no schedule ID, highlight first matching course (for backward compatibility)
        const quickPickItems = document.querySelectorAll('.quick-pick-item');
        let firstFound = false;
        quickPickItems.forEach(item => {
            const courseId = item.getAttribute('data-course-id');
            if (courseId === currentCourseId && !firstFound) {
                item.classList.add('border-indigo-500', 'bg-indigo-50', 'shadow-md');
                item.classList.remove('hover:border-indigo-300', 'hover:bg-indigo-50/40');
                firstFound = true;
            } else {
                item.classList.remove('border-indigo-500', 'bg-indigo-50', 'shadow-md');
                item.classList.add('hover:border-indigo-300', 'hover:bg-indigo-50/40');
            }
        });
    }
    
    // Add click handlers to maintain active state
    document.querySelectorAll('.quick-pick-item').forEach(item => {
        item.addEventListener('click', function(e) {
            // Remove active state from all items
            document.querySelectorAll('.quick-pick-item').forEach(i => {
                i.classList.remove('border-indigo-500', 'bg-indigo-50', 'shadow-md');
                i.classList.add('hover:border-indigo-300', 'hover:bg-indigo-50/40');
            });
            
            // Add active state to clicked item only
            this.classList.add('border-indigo-500', 'bg-indigo-50', 'shadow-md');
            this.classList.remove('hover:border-indigo-300', 'hover:bg-indigo-50/40');
        });
    });
})();

// Attach event listeners to replace inline onclick/onchange handlers (ensures functions are available)
document.addEventListener('DOMContentLoaded', function() {
    try {
        // Initialize active present window display if value exists
        const inputVal = document.getElementById('sidebarPresentDuration')?.value;
        if (inputVal && inputVal > 0) {
            const activeDisplay = document.getElementById('active-window-display');
            const windowTime = document.getElementById('window-time');
            if (activeDisplay && windowTime) {
                windowTime.textContent = inputVal;
                activeDisplay.classList.remove('hidden');
            }
        }
        
        // Attach listener to attendance control select
        const attendanceControl = document.getElementById('attendance-control');
        if (attendanceControl) {
            console.log('[ATTENDANCE] Found attendance control select');
            
            // Store previous value early on pointerdown (covers mouse/touch) and focus (keyboard)
            attendanceControl.addEventListener('pointerdown', function() {
                try { this.dataset.previousValue = this.value; } catch(e) {}
            });
            // also capture mousedown/touchstart for older browsers
            attendanceControl.addEventListener('mousedown', function() { try { this.dataset.previousValue = this.value; } catch(e) {} });
            attendanceControl.addEventListener('touchstart', function() { try { this.dataset.previousValue = this.value; } catch(e) {} });
            attendanceControl.addEventListener('focus', function() {
                this.dataset.previousValue = this.value;
                console.log('[ATTENDANCE] Focus - stored previous value:', this.value);
            });
            
            // Handle change event and delegate rendering to showAttendanceStatusModal (ensures colors apply)
            attendanceControl.addEventListener('change', function(event) {
                console.log('[ATTENDANCE] Change event fired');
                let courseId = this.getAttribute('data-course-id');
                const scheduleId = this.getAttribute('data-schedule-id');
                const dayLabel = this.getAttribute('data-day-label');
                const newValue = this.value;
                const previousValue = this.dataset.previousValue || '';

                // Extract numeric course ID if it contains composite key like "73_F_20251212"
                if (courseId && courseId.includes('_')) {
                    courseId = courseId.split('_')[0];
                }

                // If value didn't actually change, do nothing
                if (previousValue === newValue) {
                    console.log('[ATTENDANCE] Value unchanged, skipping');
                    return;
                }

                // compute previousIndex for the select (used to restore on cancel)
                const previousIndex = Array.from(this.options).findIndex(opt => opt.value === previousValue);

                // Use the shared modal renderer so colors/styles are applied consistently
                try {
                    showAttendanceStatusModal(courseId, newValue, this, previousIndex, scheduleId, dayLabel);
                } catch (e) {
                    console.error('[ATTENDANCE] showAttendanceStatusModal failed', e);
                }
            });
        } else {
            console.warn('[ATTENDANCE] attendance-control select not found');
        }
        
        // Attach listener to close modal buttons
        const closeModalButtons = document.querySelectorAll('[data-close-attendance-modal]');
        closeModalButtons.forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                const modal = document.getElementById('attendanceStatusModal');
                if (modal) {
                    console.log('[ATTENDANCE] Closing modal');
                    modal.classList.add('hidden');
                }
            });
        });
        
        // Attach listener to confirm button
        const confirmBtn = document.getElementById('attendance-confirm-btn');
        if (confirmBtn) {
            confirmBtn.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('[ATTENDANCE] Confirm button clicked');
                confirmAttendanceStatusChange();
            });
        }
        
        // Attach listener to scanner buttons
        document.querySelectorAll('.open-instructor-scanner').forEach(function(btn) {
            if (btn.dataset.listenerAttached === 'true') return;
            btn.addEventListener('click', function(e) {
                let courseId = btn.getAttribute('data-course-id');
                const courseCode = btn.getAttribute('data-course-code');
                const courseName = btn.getAttribute('data-course-name');
                const section = btn.getAttribute('data-section');
                const scannerScheduleId = btn.getAttribute('data-schedule-id');
                
                // Extract numeric course ID if it contains composite key like "73_F_20251212"
                if (courseId && courseId.includes('_')) {
                    courseId = courseId.split('_')[0];
                }
                
                // Store course/schedule IDs globally for Early/Late buttons
                window.lastScannedCourseId = courseId;
                window.lastScannedScheduleId = scannerScheduleId;
                
                if (typeof window.openInstructorSchoolIDScanner === 'function') {
                    window.openInstructorSchoolIDScanner(courseId, courseCode, courseName, section, scannerScheduleId);
                } else {
                    console.warn('openInstructorSchoolIDScanner not defined yet');
                }
            });
            btn.dataset.listenerAttached = 'true';
        });
        
        // Attach listener to Present Duration confirm button — show modal instead of prompt
        const confirmPresentBtn = document.getElementById('confirm-present-duration');
        if (confirmPresentBtn) {
            confirmPresentBtn.addEventListener('click', function(e) {
                e.preventDefault();
                const inputVal = document.getElementById('sidebarPresentDuration')?.value;
                if (!inputVal || inputVal < 1) {
                    alert('Please enter a valid present window duration (minimum 1 minute)');
                    return;
                }
                // Ensure attendance is OPEN before showing modal
                const currentControl = document.getElementById('attendance-control');
                const currentStatus = currentControl ? currentControl.value : null;
                if (currentStatus !== 'open') {
                    const msg = 'Cannot set present window because attendance is not OPEN. Please open attendance first.';
                    if (typeof showNotification === 'function') showNotification(msg, 'error'); else alert(msg);
                    return;
                }

                // Populate modal and show
                const modal = document.getElementById('presentWindowModal');
                if (!modal) {
                    alert(`Set present window to ${inputVal} minutes?`);
                    return;
                }
                document.getElementById('present-window-minutes').textContent = inputVal;
                const courseId = document.getElementById('attendance-control')?.getAttribute('data-course-id') || '';
                const scheduleId = document.getElementById('attendance-control')?.getAttribute('data-schedule-id') || '';
                document.getElementById('present-window-course-id').value = courseId;
                document.getElementById('present-window-schedule-id').value = scheduleId;
                document.getElementById('present-window-minutes-input').value = inputVal;
                modal.classList.remove('hidden');

                // cancel buttons
                document.getElementById('present-window-cancel')?.addEventListener('click', function() { modal.classList.add('hidden'); });
                document.getElementById('present-window-cancel-2')?.addEventListener('click', function() { modal.classList.add('hidden'); });

                // confirm handler (idempotent attach)
                const presentConfirmBtn = document.getElementById('present-window-confirm-btn');
                if (presentConfirmBtn && !presentConfirmBtn.dataset.attached) {
                    presentConfirmBtn.addEventListener('click', function(ev) {
                        ev.preventDefault();
                        const courseId = document.getElementById('present-window-course-id').value;
                        const scheduleId = document.getElementById('present-window-schedule-id').value || null;
                        const inputVal = parseInt(document.getElementById('present-window-minutes-input').value, 10);
                        const modal = document.getElementById('presentWindowModal');
                        if (!courseId) { alert('Course information not available.'); return; }
                        fetch('{% url "dashboard:instructor_update_attendance_status" 0 %}'.replace('0', courseId), {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
                            },
                            body: JSON.stringify({ status: 'open', present_duration: inputVal, schedule_id: scheduleId || null })
                        }).then(r => r.json()).then(data => {
                            if (data.success) {
                                const activeDisplay = document.getElementById('active-window-display'); if (activeDisplay) activeDisplay.classList.remove('hidden');
                                if (typeof showNotification === 'function') showNotification('Present window updated to ' + inputVal + ' minutes', 'success');
                                try {
                                    // Keep full course/schedule identifiers to ensure schedule-specific keys
                                    const keyCourseId = courseId;
                                    const keyScheduleId = scheduleId || 'none';
                                    // Prefer server-provided expiry to ensure instructor/student timers are identical
                                    if (data.present_expiry_ms) {
                                        try {
                                            const expiry = parseInt(data.present_expiry_ms, 10);
                                            const key = getPresentKey(keyCourseId, keyScheduleId);
                                            if (!isNaN(expiry)) {
                                                localStorage.setItem(key, String(expiry));
                                                createOrUpdateTimer(key, expiry);
                                                const activeDisplay = document.getElementById('active-window-display'); if (activeDisplay) activeDisplay.classList.remove('hidden');
                                            } else {
                                                // fallback to client-side minutes if server value malformed
                                                startPresentCountdown(parseInt(inputVal, 10), keyCourseId, keyScheduleId);
                                            }
                                        } catch (e) {
                                            console.warn('Failed to apply server expiry, falling back to local start:', e);
                                            startPresentCountdown(parseInt(inputVal, 10), keyCourseId, keyScheduleId);
                                        }
                                    } else {
                                        // No server expiry returned — fall back to client-side computed expiry
                                        startPresentCountdown(parseInt(inputVal, 10), keyCourseId, keyScheduleId);
                                    }
                                } catch (e) { console.warn('Failed to start present window countdown:', e); }
                                if (modal) modal.classList.add('hidden');
                            } else {
                                if (typeof showNotification === 'function') showNotification(data.message || 'Error updating present window', 'error'); else alert(data.message || 'Error updating present window');
                            }
                        }).catch(err => { console.error('Error updating present window:', err); if (typeof showNotification === 'function') showNotification('Error updating present window', 'error'); else alert('Error updating present window'); });
                    });
                    presentConfirmBtn.dataset.attached = 'true';
                }
                // Attach Reset handler for present window
                const resetBtn = document.getElementById('reset-present-duration');
                if (resetBtn && !resetBtn.dataset.attached) {
                    resetBtn.addEventListener('click', function(ev) {
                        ev.preventDefault();
                        const attendanceControl = document.getElementById('attendance-control');
                        if (!attendanceControl) return alert('Attendance control not found');
                        const courseId = attendanceControl.getAttribute('data-course-id') || '';
                        const scheduleId = attendanceControl.getAttribute('data-schedule-id') || 'none';
                        if (!courseId) return alert('Course information not available');
                        // populate and show reset modal
                        const modal = document.getElementById('resetPresentModal');
                        if (!modal) {
                            // fallback to confirm if modal missing
                            if (!confirm('Reset present window for this schedule?')) return;
                            const key = getPresentKey(courseId, scheduleId);
                            fetch('{% url "dashboard:instructor_update_attendance_status" 0 %}'.replace('0', courseId), {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
                                },
                                body: JSON.stringify({ status: 'open', present_duration: 0, schedule_id: scheduleId || null })
                            }).then(r => r.json()).then(data => {
                                if (data.success) {
                                    stopPresentCountdownForKey(key);
                                    // Ensure any other keys for this course are also removed so students' tabs reset
                                    try {
                                        for (let i = localStorage.length - 1; i >= 0; i--) {
                                            const k = localStorage.key(i);
                                            if (k && k.startsWith(`present_window_expiry_${courseId}_`)) {
                                                localStorage.removeItem(k);
                                            }
                                        }
                                    } catch (e) { console.warn('localStorage cleanup failed', e); }
                                    const activeDisplay = document.getElementById('active-window-display'); if (activeDisplay) activeDisplay.classList.add('hidden');
                                    if (typeof showNotification === 'function') showNotification('Present window reset for this schedule', 'success');
                                } else {
                                    if (typeof showNotification === 'function') showNotification(data.message || 'Error resetting present window', 'error'); else alert(data.message || 'Error resetting present window');
                                }
                            }).catch(err => { console.error('Error resetting present window:', err); if (typeof showNotification === 'function') showNotification('Error resetting present window', 'error'); else alert('Error resetting present window'); });
                            return;
                        }
                        document.getElementById('reset-present-course-id').value = courseId;
                        document.getElementById('reset-present-schedule-id').value = scheduleId;
                        modal.classList.remove('hidden');
                    });
                    resetBtn.dataset.attached = 'true';
                }
                // Wire reset modal confirm/cancel handlers (idempotent)
                const resetConfirm = document.getElementById('reset-present-confirm-btn');
                if (resetConfirm && !resetConfirm.dataset.attached) {
                    resetConfirm.addEventListener('click', function(ev) {
                        ev.preventDefault();
                        const courseId = document.getElementById('reset-present-course-id').value;
                        const scheduleId = document.getElementById('reset-present-schedule-id').value || 'none';
                        if (!courseId) return alert('Course information missing');
                        const key = getPresentKey(courseId, scheduleId);
                        fetch('{% url "dashboard:instructor_update_attendance_status" 0 %}'.replace('0', courseId), {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
                            },
                            body: JSON.stringify({ status: 'open', present_duration: 0, schedule_id: scheduleId || null })
                        }).then(r => r.json()).then(data => {
                    if (data.success) {
                        stopPresentCountdownForKey(key);
                        try {
                            for (let i = localStorage.length - 1; i >= 0; i--) {
                                const k = localStorage.key(i);
                                if (k && k.startsWith(`present_window_expiry_${courseId}_`)) {
                                    localStorage.removeItem(k);
                                }
                            }
                        } catch (e) { console.warn('localStorage cleanup failed', e); }
                        const activeDisplay = document.getElementById('active-window-display'); if (activeDisplay) activeDisplay.classList.add('hidden');
                        if (typeof showNotification === 'function') showNotification('Present window reset for this schedule', 'success');
                        const modal = document.getElementById('resetPresentModal'); if (modal) modal.classList.add('hidden');
                    } else {
                        if (typeof showNotification === 'function') showNotification(data.message || 'Error resetting present window', 'error'); else alert(data.message || 'Error resetting present window');
                    }
                }).catch(err => { console.error('Error resetting present window:', err); if (typeof showNotification === 'function') showNotification('Error resetting present window', 'error'); else alert('Error resetting present window'); });
                    });
                    resetConfirm.dataset.attached = 'true';
                }
                // cancel buttons for reset modal
                document.getElementById('reset-present-cancel')?.addEventListener('click', function() { document.getElementById('resetPresentModal')?.classList.add('hidden'); });
                document.getElementById('reset-present-cancel-2')?.addEventListener('click', function() { document.getElementById('resetPresentModal')?.classList.add('hidden'); });
            });
        }
    } catch (err) {
        console.error('[ATTENDANCE] Error in DOMContentLoaded:', err);
    }
        // Resume any present-window countdown previously set in another tab or earlier on this page
        try { resumePresentCountdownFromStorage(); } catch(e) { console.warn('Could not resume present countdown', e); }
});
</script>

<script>
// Fallback top-level attachment for Reset present window handlers to ensure instructor Reset works
document.addEventListener('DOMContentLoaded', function() {
    try {
        const resetBtn = document.getElementById('reset-present-duration');
        if (resetBtn && !resetBtn.dataset.bound) {
            resetBtn.addEventListener('click', function(ev) {
                ev.preventDefault();
                const attendanceControl = document.getElementById('attendance-control');
                if (!attendanceControl) return alert('Attendance control not found');
                const courseId = attendanceControl.getAttribute('data-course-id') || '';
                const scheduleId = attendanceControl.getAttribute('data-schedule-id') || 'none';
                if (!courseId) return alert('Course information not available');
                const modal = document.getElementById('resetPresentModal');
                if (!modal) {
                    if (!confirm('Reset present window for this schedule?')) return;
                    const key = getPresentKey(courseId, scheduleId);
                    fetch('{% url "dashboard:instructor_update_attendance_status" 0 %}'.replace('0', courseId), {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
                        },
                        body: JSON.stringify({ status: 'open', present_duration: 0, schedule_id: scheduleId || null })
                    }).then(r => r.json()).then(data => {
                        if (data.success) {
                            stopPresentCountdownForKey(key);
                            const activeDisplay = document.getElementById('active-window-display'); if (activeDisplay) activeDisplay.classList.add('hidden');
                            if (typeof showNotification === 'function') showNotification('Present window reset for this schedule', 'success');
                        } else {
                            if (typeof showNotification === 'function') showNotification(data.message || 'Error resetting present window', 'error'); else alert(data.message || 'Error resetting present window');
                        }
                    }).catch(err => { console.error('Error resetting present window:', err); if (typeof showNotification === 'function') showNotification('Error resetting present window', 'error'); else alert('Error resetting present window'); });
                    return;
                }
                document.getElementById('reset-present-course-id').value = courseId;
                document.getElementById('reset-present-schedule-id').value = scheduleId;
                modal.classList.remove('hidden');
            });
            resetBtn.dataset.bound = 'true';
        }

        const resetConfirm = document.getElementById('reset-present-confirm-btn');
        if (resetConfirm && !resetConfirm.dataset.bound) {
            resetConfirm.addEventListener('click', function(ev) {
                ev.preventDefault();
                const courseId = document.getElementById('reset-present-course-id').value;
                const scheduleId = document.getElementById('reset-present-schedule-id').value || 'none';
                if (!courseId) return alert('Course information missing');
                const key = getPresentKey(courseId, scheduleId);
                fetch('{% url "dashboard:instructor_update_attendance_status" 0 %}'.replace('0', courseId), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
                    },
                    body: JSON.stringify({ status: 'open', present_duration: 0, schedule_id: scheduleId || null })
                }).then(r => r.json()).then(data => {
                    if (data.success) {
                        stopPresentCountdownForKey(key);
                        const activeDisplay = document.getElementById('active-window-display'); if (activeDisplay) activeDisplay.classList.add('hidden');
                        if (typeof showNotification === 'function') showNotification('Present window reset for this schedule', 'success');
                        const modal = document.getElementById('resetPresentModal'); if (modal) modal.classList.add('hidden');
                    } else {
                        if (typeof showNotification === 'function') showNotification(data.message || 'Error resetting present window', 'error'); else alert(data.message || 'Error resetting present window');
                    }
                }).catch(err => { console.error('Error resetting present window:', err); if (typeof showNotification === 'function') showNotification('Error resetting present window', 'error'); else alert('Error resetting present window'); });
            });
            resetConfirm.dataset.bound = 'true';
        }
        // Ensure reset modal cancel/X buttons always hide the modal
        try {
            const resetCancel = document.getElementById('reset-present-cancel');
            if (resetCancel && !resetCancel.dataset.bound) {
                resetCancel.addEventListener('click', function(ev) {
                    ev.preventDefault();
                    const modal = document.getElementById('resetPresentModal'); if (modal) modal.classList.add('hidden');
                });
                resetCancel.dataset.bound = 'true';
            }
            const resetCancel2 = document.getElementById('reset-present-cancel-2');
            if (resetCancel2 && !resetCancel2.dataset.bound) {
                resetCancel2.addEventListener('click', function(ev) {
                    ev.preventDefault();
                    const modal = document.getElementById('resetPresentModal'); if (modal) modal.classList.add('hidden');
                });
                resetCancel2.dataset.bound = 'true';
            }
        } catch (e) { console.warn('Failed to attach reset modal cancel handlers', e); }

        // Ensure present window modal cancel/X buttons always hide the modal
        try {
            const presentCancel = document.getElementById('present-window-cancel');
            if (presentCancel && !presentCancel.dataset.bound) {
                presentCancel.addEventListener('click', function(ev) {
                    ev.preventDefault();
                    const modal = document.getElementById('presentWindowModal'); if (modal) modal.classList.add('hidden');
                });
                presentCancel.dataset.bound = 'true';
            }
            const presentCancel2 = document.getElementById('present-window-cancel-2');
            if (presentCancel2 && !presentCancel2.dataset.bound) {
                presentCancel2.addEventListener('click', function(ev) {
                    ev.preventDefault();
                    const modal = document.getElementById('presentWindowModal'); if (modal) modal.classList.add('hidden');
                });
                presentCancel2.dataset.bound = 'true';
            }
        } catch (e) { console.warn('Failed to attach present window modal cancel handlers', e); }
    } catch (e) { console.warn('Reset attach fallback failed', e); }
});
</script>
{% endblock %}

<script>
// Inline handlers used by Reset buttons to guarantee click handling
function instructorResetPresentWindow(e) {
    try {
        e && e.preventDefault();
        // Determine course/schedule with multiple fallbacks so reset works even if inputs are missing
        const attendanceControl = document.getElementById('attendance-control');
        let courseId = attendanceControl?.getAttribute('data-course-id') || '';
        let scheduleId = attendanceControl?.getAttribute('data-schedule-id') || '';
        // fallback to hidden inputs if present
        if (!courseId) courseId = document.getElementById('reset-present-course-id')?.value || '';
        if (!scheduleId) scheduleId = document.getElementById('reset-present-schedule-id')?.value || '';
        // final fallback: template-provided focus_course id
        if (!courseId) courseId = '{{ focus_course.id }}' || '';
        if (!scheduleId) scheduleId = scheduleId || 'none';
        // show modal if available
        const modal = document.getElementById('resetPresentModal');
        if (modal) {
            try { document.getElementById('reset-present-course-id').value = courseId; } catch(e) {}
            try { document.getElementById('reset-present-schedule-id').value = scheduleId; } catch(e) {}
            modal.classList.remove('hidden');
            return;
        }
        // Quick fallback: perform reset immediately
        if (!confirm('Reset present window for this schedule?')) return;
        const key = getPresentKey(courseId, scheduleId);
        fetch('{% url "dashboard:instructor_update_attendance_status" 0 %}'.replace('0', courseId), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ status: 'open', present_duration: 0, schedule_id: scheduleId || null })
        }).then(r => r.json()).then(data => {
            if (data.success) {
                stopPresentCountdownForKey(key);
                try {
                    for (let i = localStorage.length - 1; i >= 0; i--) {
                        const k = localStorage.key(i);
                        if (k && k.startsWith(`present_window_expiry_${courseId}_`)) localStorage.removeItem(k);
                    }
                } catch (e) { console.warn('localStorage cleanup failed', e); }
                const activeDisplay = document.getElementById('active-window-display'); if (activeDisplay) activeDisplay.classList.add('hidden');
                if (typeof showNotification === 'function') showNotification('Present window reset for this schedule', 'success');
            } else {
                if (typeof showNotification === 'function') showNotification(data.message || 'Error resetting present window', 'error'); else alert(data.message || 'Error resetting present window');
            }
        }).catch(err => { console.error('Error resetting present window:', err); if (typeof showNotification === 'function') showNotification('Error resetting present window', 'error'); else alert('Error resetting present window'); });
    } catch (err) { console.error('instructorResetPresentWindow error', err); }
}

function instructorResetPresentWindowConfirm(e) {
    try {
        e && e.preventDefault();
        // Accept course/schedule from hidden inputs or fall back to template value so confirm works even if initial setup missing
        let courseId = document.getElementById('reset-present-course-id')?.value || '';
        let scheduleId = document.getElementById('reset-present-schedule-id')?.value || '';
        if (!courseId) courseId = '{{ focus_course.id }}' || '';
        if (!scheduleId) scheduleId = 'none';
        const key = getPresentKey(courseId, scheduleId);
        fetch('{% url "dashboard:instructor_update_attendance_status" 0 %}'.replace('0', courseId), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ status: 'open', present_duration: 0, schedule_id: scheduleId || null })
        }).then(r => r.json()).then(data => {
            if (data.success) {
                stopPresentCountdownForKey(key);
                try {
                    for (let i = localStorage.length - 1; i >= 0; i--) {
                        const k = localStorage.key(i);
                        if (k && k.startsWith(`present_window_expiry_${courseId}_`)) localStorage.removeItem(k);
                    }
                } catch (e) { console.warn('localStorage cleanup failed', e); }
                const activeDisplay = document.getElementById('active-window-display'); if (activeDisplay) activeDisplay.classList.add('hidden');
                if (typeof showNotification === 'function') showNotification('Present window reset for this schedule', 'success');
                const modal = document.getElementById('resetPresentModal'); if (modal) modal.classList.add('hidden');
            } else {
                if (typeof showNotification === 'function') showNotification(data.message || 'Error resetting present window', 'error'); else alert(data.message || 'Error resetting present window');
            }
        }).catch(err => { console.error('Error resetting present window:', err); if (typeof showNotification === 'function') showNotification('Error resetting present window', 'error'); else alert('Error resetting present window'); });
    } catch (err) { console.error('instructorResetPresentWindowConfirm error', err); }
}
</script>

