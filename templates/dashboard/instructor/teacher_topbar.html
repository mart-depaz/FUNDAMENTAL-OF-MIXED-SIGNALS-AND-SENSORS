<!-- templates/dashboard/instructor/teacher_topbar.html -->
{% load static %}
<!-- Instructor mobile CSS (apply compact header/toggle rules on small screens <= 600px to match admin/student) -->
<link rel="stylesheet" href="{% static 'css/instructor_mobile.css' %}" media="(max-width: 600px)">
<style>
    .topbar-brand { text-decoration: none; }
    .topbar-brand:hover .topbar-brand-text { text-decoration: underline; }
    
    /* Mobile hamburger menu toggle (hidden on large screens) */
    .mobile-sidebar-toggle { display: none; }

    /* Small/mobile responsive rules to match admin/student topbar */
    @media (max-width: 600px) {
        .mobile-sidebar-toggle {
            display: inline-flex !important;
            align-items: center;
            justify-content: center;
            width: 2.75rem; /* 44px */
            height: 2.75rem;
            min-width: 2.75rem;
            background: rgba(255, 255, 255, 0.08);
            border: none;
            cursor: pointer;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
            color: white;
            font-size: 1.125rem; /* 18px */
            flex-shrink: 0;
        }
        .mobile-sidebar-toggle:hover { background: rgba(255,255,255,0.15); }
        
        /* Ensure notification container does not affect header layout on instructor mobile */
        #notification-container {
            display: flex !important;
            visibility: visible !important;
            height: auto !important;
            margin: 0 !important;
            overflow: visible !important;
        }
        #notification-container * {
            visibility: visible !important;
        }

        /* Keep mobile toggle visually fixed and above other elements */
        .mobile-sidebar-toggle,
        #mobile-sidebar-toggle {
            position: relative !important;
            z-index: 100000 !important;
            outline: none !important;
            transform: none !important;
            margin: 0 !important;
        }

        /* Prevent focus/active states from changing layout */
        .mobile-sidebar-toggle:focus,
        .mobile-sidebar-toggle:active,
        #mobile-sidebar-toggle:focus,
        #mobile-sidebar-toggle:active {
            outline: none !important;
            box-shadow: none !important;
        }

        /* Simplify header layout - flexbox instead of grid */
        #teacher-top-bar .max-w-full > .flex {
            display: flex !important;
            align-items: center !important;
            justify-content: space-between !important;
            gap: 0.5rem !important;
            width: 100% !important;
            height: 56px !important;
            padding: 0 !important;
        }

        /* Hide brand text on mobile */
        #teacher-top-bar .topbar-brand-text { display: none !important; }
        
        /* Logo sizing */
        #teacher-top-bar .topbar-brand span:first-child { 
            height: 28px !important; 
            width: 28px !important; 
            min-width: 28px !important;
            flex-shrink: 0 !important;
        }
        #teacher-top-bar .topbar-brand img { 
            height: 24px !important; 
            width: 24px !important; 
        }

        /* School name - center */
        #teacher-top-bar .flex-1 { 
            text-align: center !important; 
            min-width: 0 !important; 
            max-width: 100% !important;
            overflow: hidden !important; 
            text-overflow: ellipsis !important; 
            white-space: nowrap !important;
            font-size: 0.7rem !important;
            flex: 1 !important;
        }

        /* Profile section - right side */
        #teacher-top-bar .flex.items-center.space-x-2.sm\\:space-x-3 {
            display: flex !important;
            align-items: center !important;
            gap: 0.3rem !important;
            flex-shrink: 0 !important;
        }

        /* Profile button - show name and avatar */
        #teacher-top-bar .flex.items-center.space-x-2.sm\\:space-x-3 button {
            padding: 0.3rem 0.4rem !important;
            font-size: 0.6rem !important;
            gap: 0.2rem !important;
            white-space: nowrap !important;
            display: flex !important;
            align-items: center !important;
            background: rgba(255, 255, 255, 0.1) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            border-radius: 0.5rem !important;
            cursor: pointer !important;
            color: white !important;
            max-width: 100px !important;
        }

        /* Show profile name text - OVERRIDE the 600px hide */
        #teacher-top-bar .flex.items-center.space-x-2.sm\\:space-x-3 button span:first-child {
            display: inline-block !important;
            font-size: 0.6rem !important;
            max-width: 70px !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            white-space: nowrap !important;
        }

        /* Profile avatar */
        #teacher-top-bar #topbar-profile-picture,
        #teacher-top-bar #topbar-profile-placeholder {
            width: 28px !important;
            height: 28px !important;
            flex-shrink: 0 !important;
        }

        /* Hide chevron icon */
        #teacher-top-bar .flex.items-center.space-x-2.sm\\:space-x-3 button i.fa-chevron-down {
            display: none !important;
        }

        /* Profile dropdown - positioned absolutely below button */
        #teacher-top-bar .relative {
            position: relative !important;
        }

        #teacher-top-bar #profile-dropdown {
            position: absolute !important;
            right: 0 !important;
            top: 100% !important;
            max-width: 140px !important;
            z-index: 9999 !important;
            width: max-content !important;
            background: white !important;
            border: 1px solid #e5e7eb !important;
            border-radius: 0.375rem !important;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1) !important;
            margin-top: 0.25rem !important;
        }

        #teacher-top-bar #profile-dropdown a,
        #teacher-top-bar #profile-dropdown button {
            display: block !important;
            width: 100% !important;
            text-align: left !important;
            padding: 0.5rem 0.75rem !important;
            font-size: 0.7rem !important;
            border: none !important;
            background: white !important;
            cursor: pointer !important;
            color: #1f2937 !important;
            transition: background 0.15s !important;
        }

        #teacher-top-bar #profile-dropdown a:hover,
        #teacher-top-bar #profile-dropdown button:hover {
            background: #f3f4f6 !important;
        }

        /* Topbar fixed positioning */
        #teacher-top-bar {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            z-index: 99990 !important;
            height: 56px !important;
        }
    }

    /* ========================================
       ULTRA SMALL MOBILE PORTRAIT (320px - 479px)
       ======================================== */
    @media (max-width: 479px) {
        /* Simplify header layout - flexbox instead of grid */
        #teacher-top-bar .max-w-full > .flex {
            display: flex !important;
            align-items: center !important;
            justify-content: space-between !important;
            gap: 0.5rem !important;
            width: 100% !important;
            height: 56px !important;
            padding: 0 !important;
        }

        /* Hide brand text on mobile */
        #teacher-top-bar .topbar-brand-text { display: none !important; }
        
        /* Logo sizing */
        #teacher-top-bar .topbar-brand span:first-child { 
            height: 28px !important; 
            width: 28px !important; 
            min-width: 28px !important;
            flex-shrink: 0 !important;
        }
        #teacher-top-bar .topbar-brand img { 
            height: 24px !important; 
            width: 24px !important; 
        }

        /* School name - center */
        #teacher-top-bar .flex-1 { 
            text-align: center !important; 
            min-width: 0 !important; 
            max-width: 100% !important;
            overflow: hidden !important; 
            text-overflow: ellipsis !important; 
            white-space: nowrap !important;
            font-size: 0.7rem !important;
            flex: 1 !important;
        }

        /* Profile section - right side */
        #teacher-top-bar .flex.items-center.space-x-2.sm\\:space-x-3 {
            display: flex !important;
            align-items: center !important;
            gap: 0.3rem !important;
            flex-shrink: 0 !important;
        }

        /* Profile button - show name and avatar */
        #teacher-top-bar .flex.items-center.space-x-2.sm\\:space-x-3 button {
            padding: 0.3rem 0.4rem !important;
            font-size: 0.6rem !important;
            gap: 0.2rem !important;
            white-space: nowrap !important;
            display: flex !important;
            align-items: center !important;
            background: rgba(255, 255, 255, 0.1) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            border-radius: 0.5rem !important;
            cursor: pointer !important;
            color: white !important;
            max-width: 100px !important;
        }

        /* Show profile name text on small screens */
        #teacher-top-bar .flex.items-center.space-x-2.sm\\:space-x-3 button span:first-child {
            display: inline-block !important;
            font-size: 0.6rem !important;
            max-width: 70px !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            white-space: nowrap !important;
        }

        /* Profile avatar */
        #teacher-top-bar #topbar-profile-picture,
        #teacher-top-bar #topbar-profile-placeholder {
            width: 28px !important;
            height: 28px !important;
            flex-shrink: 0 !important;
        }

        /* Hide chevron icon */
        #teacher-top-bar .flex.items-center.space-x-2.sm\\:space-x-3 button i.fa-chevron-down {
            display: none !important;
        }

        /* Profile dropdown - positioned absolutely below button */
        #teacher-top-bar .relative {
            position: relative !important;
        }

        #teacher-top-bar #profile-dropdown {
            position: absolute !important;
            right: 0 !important;
            top: 100% !important;
            max-width: 140px !important;
            z-index: 9999 !important;
            width: max-content !important;
            background: white !important;
            border: 1px solid #e5e7eb !important;
            border-radius: 0.375rem !important;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1) !important;
            margin-top: 0.25rem !important;
        }

        #teacher-top-bar #profile-dropdown a,
        #teacher-top-bar #profile-dropdown button {
            display: block !important;
            width: 100% !important;
            text-align: left !important;
            padding: 0.5rem 0.75rem !important;
            font-size: 0.7rem !important;
            border: none !important;
            background: white !important;
            cursor: pointer !important;
            color: #1f2937 !important;
            transition: background 0.15s !important;
        }

        #teacher-top-bar #profile-dropdown a:hover,
        #teacher-top-bar #profile-dropdown button:hover {
            background: #f3f4f6 !important;
        }

        /* Topbar fixed positioning */
        #teacher-top-bar {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            z-index: 99990 !important;
            height: 56px !important;
        }
    }
</style>
<!-- Global Notification System removed for instructor mobile (â‰¤600px) to prevent sidebar position shifts - matches admin dashboard -->
<header id="teacher-top-bar" class="fixed top-0 left-0 right-0 z-50 w-full shadow-md" style="background: linear-gradient(90deg, #3C4770 0%, #447294 100%); box-shadow: 0 2px 10px rgba(60, 71, 112, 0.3);">
    <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
            <!-- Mobile sidebar toggle button (matches admin/student markup) -->
            <button id="mobile-sidebar-toggle" type="button" class="mobile-sidebar-toggle lg:hidden" title="Toggle Menu" aria-label="Open menu">
                <i class="fas fa-bars"></i>
            </button>
            
            <!-- Left Section: Attendance System Branding -->
            <div class="flex items-center">
                <a href="{% url 'dashboard:teacher_dashboard' %}" data-dashboard-action="true" class="topbar-brand text-xl sm:text-2xl font-bold text-white select-none flex items-center hover:opacity-90 transition duration-150 cursor-pointer space-x-3">
                    <span class="inline-flex items-center justify-center h-11 w-11 sm:h-13 sm:w-13 rounded-full bg-white/10 border border-white/30 shadow-md overflow-hidden">
                        <img src="{% static 'img/attendance-logo.png' %}" alt="Attendance System logo" class="h-10 w-10 sm:h-12 sm:w-12 object-contain">
                    </span>
                    <span class="topbar-brand-text">Attendance System</span>
                </a>
            </div>
            
            <!-- Center Section: School Name -->
            {% if user.school_name %}
            <div class="flex-1 flex justify-center items-center space-x-2">
                <span class="text-sm text-white font-medium truncate max-w-xs sm:max-w-md">
                    {{ user.school_name }}
                </span>
            </div>
            {% else %}
            <div class="flex-1"></div>
            {% endif %}

            <!-- Right Section: Action Icons -->
            <div class="flex items-center space-x-2 sm:space-x-3">
                <!-- User Profile Avatar/Dropdown -->
                <div class="relative">
                    <button onclick="toggleProfileDropdown()" class="flex items-center justify-center space-x-2 p-1.5 bg-white/20 rounded-full transition duration-150 hover:bg-white/30 hover:shadow-md" title="User Profile">
                        <span class="text-white text-sm font-medium">{{ user.full_name|default:user.username }}</span>
                        {% if user.profile_picture %}
                        <img id="topbar-profile-picture" src="{{ user.profile_picture.url }}?v={{ user.id }}" alt="Profile" class="h-8 w-8 rounded-full object-cover border-2 border-white flex-shrink-0">
                        {% else %}
                        <div id="topbar-profile-placeholder" class="h-8 w-8 rounded-full flex items-center justify-center text-white font-bold text-sm flex-shrink-0" style="background: rgba(190, 129, 153, 0.3);">
                            {{ user.full_name|first|upper|default:"T" }}
                        </div>
                        {% endif %}
                        <i class="fas fa-chevron-down text-white text-xs flex-shrink-0"></i>
                    </button>
                    
                    <!-- Dropdown Menu -->
                    <div id="profile-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg py-1 z-50 border border-gray-200">
                        <a href="#" id="profile-dropdown-link" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center transition-colors">
                            <i class="fas fa-user mr-2 w-4"></i> Profile
                        </a>
                        <a href="javascript:void(0)" data-logout-url="{% url 'logout' %}" onclick="showLogoutLoadingModal(this.dataset.logoutUrl)" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center transition-colors cursor-pointer">
                            <i class="fas fa-sign-out-alt mr-2 w-4"></i> Logout
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>

<script>
// Ensure toggleSidebar exists for instructor pages and also toggles the overlay
window.toggleSidebar = function() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebar-overlay');
    if (!sidebar) return;
    // Toggle the open class and also set inline styles as a fallback for CSS ordering issues
    const opened = sidebar.classList.toggle('open');
    try { console.debug('toggleSidebar clicked, opened=', opened); } catch (e) {}
    // show/hide overlay when sidebar opens/closes
    if (overlay) {
        if (opened) {
            overlay.classList.remove('hidden');
            // ensure overlay is visible even if utility classes conflict
            overlay.style.display = 'block';
            overlay.style.pointerEvents = 'auto';
            // fallback: ensure sidebar transform is visible
            sidebar.style.transform = 'translateX(0)';
        } else {
            overlay.classList.add('hidden');
            overlay.style.display = 'none';
            overlay.style.pointerEvents = 'none';
            sidebar.style.transform = 'translateX(-100%)';
        }
    }
};

// Attach click handlers to any toggle buttons in case inline onclick is not present or overridden
document.addEventListener('DOMContentLoaded', function() {
    // Bind mobile toggle buttons
    const toggles = document.querySelectorAll('.mobile-sidebar-toggle');
    toggles.forEach(btn => {
        // Add a safe bound handler and log clicks
        btn.addEventListener('click', function(e) {
            try { console.debug('mobile toggle clicked'); } catch (er) {}
            e.preventDefault();
            window.toggleSidebar();
        });
    });


    // Clicking the overlay should close the sidebar
    const overlay = document.getElementById('sidebar-overlay');
    if (overlay) {
        overlay.addEventListener('click', function() {
            const sidebar = document.getElementById('sidebar');
            if (sidebar && sidebar.classList.contains('open')) {
                sidebar.classList.remove('open');
                overlay.classList.add('hidden');
            }
        });
    }
});
</script>

<style>
/* Mobile: position main under fixed header for instructor pages */
@media (max-width: 600px) {
    :root { --teacher-header-offset: 56px; }
    /* Make header independent by using body padding instead of absolutely positioning main
       This ensures pages without a specific #main-content id still flow correctly below header */
    body {
        padding-top: var(--teacher-header-offset) !important;
    }
    aside#sidebar {
        top: var(--teacher-header-offset) !important;
        height: calc(100vh - var(--teacher-header-offset)) !important;
    }
    /* Prevent wrapper spacing from pushing content down */
    #instructor-page-wrapper { padding-top: 0 !important; min-height: auto !important; }
}
</style>

<script>
function adjustTeacherHeaderOffset() {
    try {
        const header = document.getElementById('teacher-top-bar');
        const notif = document.getElementById('notification-container');
        let extra = 0;
        if (notif) {
            const r = notif.getBoundingClientRect(); if (r.height > 0) extra = Math.ceil(r.height) + 8;
        }
        const h = header ? Math.ceil(header.getBoundingClientRect().height) : 64;
        const offset = h + extra;
        try { document.documentElement.style.setProperty('--teacher-header-offset', offset + 'px'); } catch(e) {}

        if (window.innerWidth <= 600) {
            const aside = document.getElementById('sidebar');
            if (aside) {
                aside.style.top = 'var(--teacher-header-offset)';
                aside.style.height = 'calc(100vh - var(--teacher-header-offset))';
            }
        }
    } catch (e) { console.error('adjustTeacherHeaderOffset', e); }
}

// Re-calculate header offset on every tab/page change to keep sidebar stable
function observeHeaderChanges() {
    try {
        // Use MutationObserver to watch for DOM changes during AJAX/SPA navigation
        const observer = new MutationObserver(function(mutations) {
            // Only recalculate if the page structure changed
            for (let mutation of mutations) {
                if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                    setTimeout(adjustTeacherHeaderOffset, 50);
                    break;
                }
            }
        });

        // Watch the entire body for structural changes
        observer.observe(document.body, {
            childList: true,
            subtree: true,
            attributeFilter: ['class', 'style']
        });

        // Listen for popstate (back/forward navigation)
        window.addEventListener('popstate', adjustTeacherHeaderOffset);

        // Listen for custom SPA navigation events
        document.addEventListener('page:changed', adjustTeacherHeaderOffset);
        document.addEventListener('ajax:complete', adjustTeacherHeaderOffset);
        
        // Also watch for DOMContentLoaded on dynamically loaded content
        document.addEventListener('turbo:load', adjustTeacherHeaderOffset);
        
    } catch (e) {
        console.error('observeHeaderChanges', e);
    }
}

window.addEventListener('load', function() {
    adjustTeacherHeaderOffset();
    observeHeaderChanges();
});
window.addEventListener('resize', adjustTeacherHeaderOffset);
document.addEventListener('DOMContentLoaded', function() {
    adjustTeacherHeaderOffset();
    observeHeaderChanges();
});
</script>

<script>
// Extra attach: ensure the fixed toggle element (by id) always calls the sidebar toggle and provides visual feedback.
document.addEventListener('DOMContentLoaded', function(){
    try{
        const btn = document.getElementById('mobile-sidebar-toggle');
        if(!btn){ console.log('mobile-sidebar-toggle not found'); return; }
        // avoid double-binding
        if(btn.__toggleBound) return; btn.__toggleBound = true;

        function doToggle(e){
            try{ console.log('mobile-sidebar-toggle activated'); }catch(e){}
            if(e){ try{ e.preventDefault(); }catch(_){} }
            // visual tap feedback
            btn.style.transition = 'transform 120ms ease'; btn.style.transform = 'scale(0.96)';
            setTimeout(()=>{ btn.style.transform = ''; }, 120);

            if(typeof window.toggleSidebar === 'function'){
                try{ window.toggleSidebar(); return; }catch(err){ console.error('toggleSidebar threw', err); }
            }

            // fallback manual toggle
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            if(sidebar){
                const opened = !sidebar.classList.contains('open');
                if(opened){ sidebar.classList.add('open'); sidebar.style.transform='translateX(0)'; }
                else { sidebar.classList.remove('open'); sidebar.style.transform='translateX(-100%)'; }
            }
            if(overlay){
                if(sidebar && sidebar.classList.contains('open')){ overlay.classList.remove('hidden'); overlay.style.display='block'; overlay.style.pointerEvents='auto'; }
                else { overlay.classList.add('hidden'); overlay.style.display='none'; overlay.style.pointerEvents='none'; }
            }
        }

        btn.addEventListener('click', doToggle, {passive:false});
        btn.addEventListener('touchstart', function(e){ try{ e.preventDefault(); }catch(_){}; doToggle(e); }, {passive:false});
    }catch(e){ console.error('error binding mobile toggle', e); }
});
</script>

<script>
function toggleProfileDropdown() {
    const dropdown = document.getElementById('profile-dropdown');
    if (dropdown) {
        dropdown.classList.toggle('hidden');
    }
}

// Handle profile link click - opens modal when clicking "Profile" in dropdown
document.addEventListener('DOMContentLoaded', function() {
    const profileLink = document.getElementById('profile-dropdown-link');
    if (profileLink) {
        profileLink.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            // Close dropdown
            const dropdown = document.getElementById('profile-dropdown');
            if (dropdown) {
                dropdown.classList.add('hidden');
            }
            
            // Open profile modal
            setTimeout(function() {
                if (typeof window.openProfileModal === 'function') {
                    window.openProfileModal();
                    return;
                }
                if (typeof openProfileModal === 'function') {
                    openProfileModal();
                    return;
                }
                const modal = document.getElementById('profile-modal');
                if (modal) {
                    modal.classList.remove('hidden');
                    if (typeof window.cancelProfileEdit === 'function') {
                        window.cancelProfileEdit();
                    } else if (typeof cancelProfileEdit === 'function') {
                        cancelProfileEdit();
                    }
                }
            }, 100);
        });
    }
});

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
    const dropdown = document.getElementById('profile-dropdown');
    if (!dropdown) return;
    
    const button = event.target.closest('button[onclick="toggleProfileDropdown()"]');
    const dropdownElement = event.target.closest('#profile-dropdown');
    const profileLink = event.target.closest('#profile-dropdown-link');
    
    if (profileLink) {
        return;
    }
    
    if (button) {
        return;
    }
    
    if (!dropdownElement && !dropdown.classList.contains('hidden')) {
        dropdown.classList.add('hidden');
    }
});

// Toggle notifications dropdown
// Close notifications dropdown
function closeNotificationsDropdown() {
    const dropdown = document.getElementById('notificationsDropdown');
    if (dropdown) {
        dropdown.classList.add('hidden');
    }
}

// Load notifications via AJAX
function loadNotifications() {
    const content = document.getElementById('notificationsContent');
    if (!content) return;
    
    content.innerHTML = '<div class="text-center py-8"><i class="fas fa-spinner fa-spin text-3xl text-gray-400"></i><p class="mt-4 text-sm text-gray-600">Loading notifications...</p></div>';
    
    fetch('{% url "dashboard:instructor_notifications" %}')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.text();
        })
        .then(html => {
            // Use simpler approach - create temporary container
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            
            // Find the notifications container
            let notificationsContainer = tempDiv.querySelector('.divide-y');
            let deleteAllBtn = tempDiv.querySelector('button[onclick*="showDeleteAllModal"]');
            let deleteModal = tempDiv.querySelector('#deleteAllModal');
            
            if (!notificationsContainer) {
                // Try alternative selectors
                notificationsContainer = tempDiv.querySelector('div > div.divide-y');
            }
            if (!notificationsContainer) {
                notificationsContainer = tempDiv.querySelector('div.divide-y');
            }
            
            if (notificationsContainer) {
                // Build full content
                let fullContent = '';
                
                // Add delete all button if exists
                if (deleteAllBtn) {
                    const deleteAllContainer = deleteAllBtn.closest('div.mb-2');
                    if (deleteAllContainer) {
                        fullContent += deleteAllContainer.outerHTML;
                    }
                }
                
                // Add notifications
                fullContent += notificationsContainer.outerHTML;
                
                content.innerHTML = fullContent;
                
                // Re-attach event listeners for dynamically loaded content
                if (typeof attachNotificationListeners === 'function') {
                    attachNotificationListeners();
                }
                
                // Add delete modal if it doesn't exist
                if (deleteModal && !document.getElementById('deleteAllModal')) {
                    document.body.appendChild(deleteModal.cloneNode(true));
                }
            } else {
                // Check for "No notifications" message
                const noNotifications = tempDiv.querySelector('.text-center');
                if (noNotifications && noNotifications.textContent.includes('No notifications')) {
                    content.innerHTML = noNotifications.outerHTML;
                } else {
                    // Fallback: use all content if substantial
                    const allContent = tempDiv.innerHTML;
                    if (allContent && allContent.trim().length > 50) {
                        content.innerHTML = allContent;
                    } else {
                        content.innerHTML = '<div class="text-center py-8 text-gray-500"><i class="fas fa-bell-slash text-3xl mb-2"></i><p class="text-xs">No notifications</p></div>';
                    }
                }
                // Re-attach event listeners for dynamically loaded content
                if (typeof attachNotificationListeners === 'function') {
                    attachNotificationListeners();
                }
            }
            
            const dropdown = document.getElementById('notificationsDropdown');
            if (dropdown) {
                dropdown.dataset.loaded = 'true';
            }
        })
        .catch(error => {
            console.error('Error loading notifications:', error);
            // Try a simpler approach - just fetch and display the HTML directly
            fetch('{% url "dashboard:instructor_notifications" %}')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.text();
                })
                .then(html => {
                    // Create a temporary container to parse the HTML
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = html;
                    
                    // Try to find the notifications container
                    let notificationsDiv = tempDiv.querySelector('.divide-y');
                    if (!notificationsDiv) {
                        notificationsDiv = tempDiv.querySelector('div');
                    }
                    
                    if (notificationsDiv) {
                        // Get the delete all button if it exists
                        const deleteAllBtn = tempDiv.querySelector('button[onclick*="showDeleteAllModal"]');
                        let fullContent = '';
                        
                        if (deleteAllBtn) {
                            const deleteAllContainer = deleteAllBtn.closest('div.mb-2');
                            if (deleteAllContainer) {
                                fullContent += deleteAllContainer.outerHTML;
                            }
                        }
                        
                        fullContent += notificationsDiv.outerHTML;
                        content.innerHTML = fullContent;
                        
                        // Re-attach event listeners for dynamically loaded content
                        if (typeof attachNotificationListeners === 'function') {
                            attachNotificationListeners();
                        }
                    } else {
                        content.innerHTML = '<div class="text-center py-8 text-gray-500"><i class="fas fa-bell-slash text-3xl mb-2"></i><p class="text-xs">No notifications</p></div>';
                    }
                })
                .catch(() => {
                    content.innerHTML = '<div class="text-center py-8 text-red-500"><i class="fas fa-exclamation-circle text-3xl mb-2"></i><p class="text-xs">Error loading notifications</p><p class="text-[10px] text-gray-500 mt-2">Please refresh the page</p></div>';
                });
        });
}

// Mark notification as read
function markAsRead(notificationId) {
    fetch('{% url "dashboard:mark_notification_read" 0 %}'.replace('0', notificationId), {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken') || '{{ csrf_token }}',
            'Content-Type': 'application/json'
        }
    }).then(() => {
        // Store that notification was read in localStorage for cross-page persistence
        localStorage.setItem('notification_read_' + notificationId, 'true');
        
        // Reload notifications
        const dropdown = document.getElementById('notificationsDropdown');
        if (dropdown) {
            dropdown.dataset.loaded = 'false';
        }
        loadNotifications();
        // Update badge without reload - this will persist across pages
        updateNotificationBadge();
    }).catch(error => {
        console.error('Error marking notification as read:', error);
    });
}

// Helper function to get CSRF token from cookies
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Update notification badge count - works across all pages
function updateNotificationBadge() {
    const dropdown = document.getElementById('notificationsDropdown');
    // Don't update badge if dropdown is currently open (user is viewing notifications)
    if (dropdown && !dropdown.classList.contains('hidden')) {
        return;
    }
    
    // Check if user has manually hidden the badge by clicking the bell (global state)
    if (localStorage.getItem('notifications_badge_hidden') === 'true') {
        // Hide badge on all pages if user clicked the bell
        const badge = document.querySelector('.notification-badge-count');
        const dot = document.querySelector('.notification-badge-dot');
        if (badge && dot) {
            badge.style.display = 'none';
            dot.style.display = 'none';
        }
        return;
    }
    
    fetch('{% url "dashboard:instructor_notifications" %}')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.text();
        })
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // Find all notification items
            const notifications = doc.querySelectorAll('.notification-item');
            let unreadCount = 0;
            
            notifications.forEach(n => {
                // Check if notification is unread (doesn't have opacity-80 class which indicates read)
                if (!n.classList.contains('opacity-80')) {
                    unreadCount++;
                }
            });
            
            const badge = document.querySelector('.notification-badge-count');
            const dot = document.querySelector('.notification-badge-dot');
            
            if (badge && dot) {
                if (unreadCount > 0) {
                    badge.textContent = unreadCount > 9 ? '9+' : unreadCount.toString();
                    badge.style.display = 'flex';
                    dot.style.display = 'block';
                    // Store badge state globally
                    localStorage.setItem('notification_badge_count', unreadCount.toString());
                } else {
                    badge.style.display = 'none';
                    dot.style.display = 'none';
                    localStorage.setItem('notification_badge_count', '0');
                }
            }
        })
        .catch(error => {
            console.error('Error updating badge:', error);
            // On error, restore from localStorage if available
            const badge = document.querySelector('.notification-badge-count');
            const dot = document.querySelector('.notification-badge-dot');
            const storedCount = localStorage.getItem('notification_badge_count');
            if (badge && dot && storedCount && storedCount !== '0' && localStorage.getItem('notifications_badge_hidden') !== 'true') {
                badge.textContent = parseInt(storedCount) > 9 ? '9+' : storedCount;
                badge.style.display = 'flex';
                dot.style.display = 'block';
            }
        });
}

// Store notification state in localStorage for persistence
function saveNotificationState() {
    const badge = document.querySelector('.notification-badge-count');
    const dot = document.querySelector('.notification-badge-dot');
    if (badge && dot) {
        const isVisible = badge.style.display !== 'none' && dot.style.display !== 'none';
        localStorage.setItem('notification_badge_visible', isVisible ? 'true' : 'false');
        localStorage.setItem('notification_badge_count', badge.textContent || '0');
    }
}

// Restore notification state from localStorage (deprecated - we'll use updateNotificationBadge instead)
function restoreNotificationState() {
    // Don't restore from localStorage - always fetch fresh data
    // This function is kept for compatibility but doesn't do anything
}

// Hide badge when dropdown is opened - GLOBAL STATE (affects all pages)
function toggleNotificationsDropdown() {
    const dropdown = document.getElementById('notificationsDropdown');
    if (!dropdown) return;
    
    const isHidden = dropdown.classList.contains('hidden');
    if (isHidden) {
        // Add animation
        dropdown.classList.add('animate-slide-down');
        dropdown.classList.remove('hidden');
        // Load notifications if not loaded
        if (dropdown.dataset.loaded !== 'true') {
            loadNotifications();
        }
        // Don't hide badge when opening - let it update based on actual unread count
        // Badge will automatically hide when all notifications are read
    } else {
        dropdown.classList.remove('animate-slide-down');
        dropdown.classList.add('hidden');
        // When closing, check if there are still unread notifications
        // If yes, show badge again; if no, keep it hidden
        setTimeout(() => {
            // Reset the hidden flag so badge can update naturally
            localStorage.removeItem('notifications_badge_hidden');
            updateNotificationBadge();
        }, 100);
    }
}

// Initialize on page load - check global badge state
document.addEventListener('DOMContentLoaded', function() {
    // Check if badge was manually hidden by user (global state)
    const badgeHidden = localStorage.getItem('notifications_badge_hidden') === 'true';
    
    if (badgeHidden) {
        // Hide badge on all pages if user clicked the bell
        const badge = document.querySelector('.notification-badge-count');
        const dot = document.querySelector('.notification-badge-dot');
        if (badge && dot) {
            badge.style.display = 'none';
            dot.style.display = 'none';
        }
    } else {
        // Update badge immediately on page load
        updateNotificationBadge();
        // Update badge periodically (only if not manually hidden)
        setInterval(() => {
            if (localStorage.getItem('notifications_badge_hidden') !== 'true') {
                updateNotificationBadge();
            }
        }, 30000); // Every 30 seconds
    }
    
    // Listen for storage events to sync badge across tabs
    window.addEventListener('storage', function(e) {
        if (e.key === 'notifications_badge_hidden') {
            const badge = document.querySelector('.notification-badge-count');
            const dot = document.querySelector('.notification-badge-dot');
            if (badge && dot) {
                if (e.newValue === 'true') {
                    badge.style.display = 'none';
                    dot.style.display = 'none';
                } else {
                    updateNotificationBadge();
                }
            }
        }
    });
});

// Add CSS for animations
const style = document.createElement('style');
style.textContent = `
    @keyframes slide-down {
        from {
            transform: translateY(-10px) scale(0.95);
            opacity: 0;
        }
        to {
            transform: translateY(0) scale(1);
            opacity: 1;
        }
    }
    .animate-slide-down {
        animation: slide-down 0.3s ease-out;
    }
`;
document.head.appendChild(style);
</script>

<script>
// Re-run header offset when tabs or content change (client-side tab switches)
(function(){
    // Observe main content for changes and re-adjust header offset
    function safeAdjust(){ try{ if(typeof adjustTeacherHeaderOffset==='function') adjustTeacherHeaderOffset(); }catch(e){} }

    const targets = [document.getElementById('main-content'), document.getElementById('instructor-page-wrapper'), document.body];
    let target = targets.find(t=>!!t) || document.body;

    try{
        const obs = new MutationObserver(function(){ safeAdjust(); });
        obs.observe(target, { childList: true, subtree: true, attributes: true });
        // Also listen for common tab / nav clicks and re-run after short delay
        document.addEventListener('click', function(e){
            const el = e.target.closest('.nav-link, [data-toggle="tab"], .tab-link, .tabs a');
            if(el) setTimeout(safeAdjust, 120);
        }, {capture:true});

        // Also listen for history navigation and common SPA events (htmx, turbolinks, pjax)
        window.addEventListener('popstate', safeAdjust);
        document.addEventListener('turbolinks:load', safeAdjust);
        document.addEventListener('pjax:end', safeAdjust);
        document.addEventListener('htmx:afterSwap', safeAdjust);
    }catch(e){ console.error('observer bind failed', e); }

    // also call once on load to ensure correct offset
    document.addEventListener('DOMContentLoaded', function(){ setTimeout(safeAdjust, 80); });
})();

// Add loading effect to dashboard action links
document.addEventListener('DOMContentLoaded', function() {
    console.log('[TOPBAR] Initializing loading effects for topbar links');
    
    // Find all links with data-dashboard-action attribute or links in the topbar
    const topbarLinks = document.querySelectorAll('a[data-dashboard-action="true"]');
    
    topbarLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            const href = this.getAttribute('href');
            
            // Only show loading if it's a valid link
            if (href && href !== '#' && href !== window.location.pathname) {
                // Show loading overlay
                const loadingOverlay = document.createElement('div');
                loadingOverlay.id = 'topbar-loading-overlay';
                loadingOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 z-[10000] flex items-center justify-center';
                loadingOverlay.innerHTML = `
                    <div class="rainbow-spinner">
                        <img src="/static/img/attendance-logo.png" alt="Loading">
                    </div>
                `;
                document.body.appendChild(loadingOverlay);
                console.log('[TOPBAR] Loading overlay shown for:', href);
            }
        });
    });

    // Logout loading animation
    function showLogoutLoadingModal(url) {
        const loadingOverlay = document.createElement('div');
        loadingOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 z-[10000] flex items-center justify-center';
        loadingOverlay.innerHTML = `
            <div class="rainbow-spinner">
                <img src="/static/img/attendance-logo.png" alt="Loading">
            </div>
        `;
        document.body.appendChild(loadingOverlay);
        setTimeout(() => {
            window.location.href = url;
        }, 300);
    }

    window.showLogoutLoadingModal = showLogoutLoadingModal;
});
</script>


