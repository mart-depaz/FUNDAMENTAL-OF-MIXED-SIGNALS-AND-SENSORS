
<!-- templates/dashboard/instructor_program_courses.html -->
{% extends 'partials/base.html' %}
{% block title %}Instructor Dashboard - Manage Courses{% endblock %}
{% block navigation %}
<!-- Override default navigation - no top bar for instructor -->
{% endblock %}
{% block content %}
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
{% include 'dashboard/shared/notification_system.html' %}
<style>
    body { 
        font-family: 'Inter', sans-serif; 
        background: linear-gradient(135deg, #fff5f7 0%, #ffe0d4 40%, #dbe9ff 100%);
    }
    
    /* Smooth scrollbar styling */
    ::-webkit-scrollbar {
        width: 10px;
    }
    
    ::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #3C4770, #447294);
        border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg, #447294, #3C4770);
    }
    .school-year-folder {
        display: block;
    }
    .year-folder {
        display: block;
    }
    .semester-folder {
        display: block;
    }
    .semester-folder[style*="display: none"] {
        display: none !important;
    }
    @keyframes fadeInSlide {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    .course-row {
        opacity: 1;
        transform: translateY(0);
    }
    
    /* Course Card Animations */
    .course-card-wrapper {
        animation: fadeInScale 0.4s ease-out;
        animation-fill-mode: both;
    }
    
    .course-card-wrapper:nth-child(1) { animation-delay: 0.05s; }
    .course-card-wrapper:nth-child(2) { animation-delay: 0.1s; }
    .course-card-wrapper:nth-child(3) { animation-delay: 0.15s; }
    .course-card-wrapper:nth-child(4) { animation-delay: 0.2s; }
    .course-card-wrapper:nth-child(5) { animation-delay: 0.25s; }
    .course-card-wrapper:nth-child(6) { animation-delay: 0.3s; }
    .course-card-wrapper:nth-child(n+7) { animation-delay: 0.35s; }
    
    @keyframes fadeInScale {
        from {
            opacity: 0;
            transform: scale(0.95) translateY(10px);
        }
        to {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
    }
    
    /* Glow animation for multi-section courses */
    @keyframes glowPulse {
        0%   { box-shadow: 0 0 0px rgba(255,255,255,0.0), 0 0 0px var(--course-color-end, #ffffff00); }
        50%  { box-shadow: 0 0 18px rgba(255,255,255,0.35), 0 0 28px var(--course-color-end, #ffffff55); }
        100% { box-shadow: 0 0 0px rgba(255,255,255,0.0), 0 0 0px var(--course-color-end, #ffffff00); }
    }
    .multi-section-glow::after {
        content: "";
        position: absolute;
        inset: -2px;
        border-radius: 1.25rem; /* match rounded-2xl */
        animation: glowPulse 2.2s ease-in-out infinite;
        pointer-events: none;
    }
    
    /* Twinkling star overlay (replacing previous background animation) */
    @keyframes twinkle {
        0%, 45%, 55%, 100% {
            opacity: 0.1;
            transform: scale(0.9);
        }
        50% {
            opacity: 1.0;
            transform: scale(1.1);
        }
    }
    .multi-stars-field {
        position: absolute;
        inset: 0;
        pointer-events: none;
        overflow: hidden;
        border-radius: 1rem; /* close to rounded-2xl */
        mix-blend-mode: screen;
    }
    .star-dot {
        position: absolute;
        background-color: #ffffff;
        border-radius: 50%;
        box-shadow: 0 0 5px #a0c3ff, 0 0 10px #ffffff;
        animation: twinkle linear infinite;
    }
    
    /* Course Card Block Styling - Enhanced */
    .course-card-block {
        position: relative;
        transform-style: preserve-3d;
        background: linear-gradient(135deg, var(--course-color-start, #3C4770) 0%, var(--course-color-end, #447294) 100%);
    }
    
    .course-card-block:hover {
        transform: translateY(-8px) scale(1.02);
    }
    
    /* Add subtle glow effect on hover */
    .course-card-block::before {
        content: '';
        position: absolute;
        inset: -2px;
        border-radius: inherit;
        padding: 2px;
        background: linear-gradient(135deg, rgba(255,255,255,0.3), rgba(255,255,255,0.1));
        -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
        mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
        -webkit-mask-composite: xor;
        mask-composite: exclude;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .course-card-block:hover::before {
        opacity: 1;
    }
    
    /* Action Buttons Styling */
    .course-actions {
        animation: slideDown 0.2s ease-out;
    }
    
    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Action buttons are hidden by default */
    .course-actions {
        opacity: 0 !important;
        pointer-events: none !important;
        transform: translateY(8px) !important;
        transition: opacity 0.2s ease-out, transform 0.2s ease-out !important;
    }
    
    /* Show action buttons when card is hovered (via JavaScript class) */
    .course-card-wrapper.card-hovered .course-actions,
    .course-actions:hover,
    .course-actions:focus-within {
        opacity: 1 !important;
        pointer-events: auto !important;
        transform: translateY(0) !important;
        transition: opacity 0.2s ease-in, transform 0.2s ease-in !important;
    }
    
    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    .line-clamp-3 {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    .modal-scroll-area {
        max-height: min(85vh, calc(100vh - 3rem));
        overflow-y: auto;
        padding-right: 0.75rem;
        scrollbar-gutter: stable;
        scrollbar-width: thin;
        scrollbar-color: rgba(99,102,241,0.7) rgba(243,244,246,0.8);
    }
    #courseModal .modal-scroll-area {
        max-height: min(90vh, calc(100vh - 3rem));
    }
    .modal-scroll-area::-webkit-scrollbar {
        width: 8px;
    }
    .modal-scroll-area::-webkit-scrollbar-track {
        background: rgba(243, 244, 246, 0.85);
        border-radius: 999px;
    }
    .modal-scroll-area::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #8b5cf6, #6366f1);
        border-radius: 999px;
        border: 2px solid rgba(243, 244, 246, 0.95);
    }
    .modal-scroll-area::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg, #7c3aed, #4f46e5);
    }
    .course-card-title {
        font-size: clamp(0.95rem, 2.2vw, 1.1rem);
        font-weight: 700;
        text-shadow: 2px 2px 10px rgba(0,0,0,0.25);
    }
    .program-title {
        font-size: clamp(0.95rem, 2vw, 1.4rem);
        line-height: 1.25;
        width: 100%;
        /* Hard cap visible characters to 50 */
        max-width: 50ch;
        display: block;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .program-subtitle {
        font-size: clamp(0.75rem, 1.5vw, 0.95rem);
        line-height: 1.3;
        word-break: break-word;
        text-wrap: balance;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .program-code-label {
        font-size: clamp(0.65rem, 1.4vw, 0.85rem);
        letter-spacing: 0.2em;
        text-transform: uppercase;
        word-break: break-word;
        display: block;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .form-section-card {
        position: relative;
        border-radius: 1.25rem;
        overflow: hidden;
        box-shadow: 0 15px 35px -25px rgba(15, 23, 42, 0.6);
    }
    .form-section-card::after {
        content: '';
        position: absolute;
        inset: 0;
        pointer-events: none;
        background: radial-gradient(circle at top right, rgba(255,255,255,0.35), transparent 45%);
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    .form-section-card:hover::after {
        opacity: 0.5;
    }
    .color-select-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 0.5rem;
    }
    .color-select-tile {
        border: 1px solid #e5e7eb;
        border-radius: 0.9rem;
        padding: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.6rem;
        background: #fff;
        transition: all 0.2s ease;
        cursor: pointer;
    }
    .color-select-tile:hover {
        box-shadow: 0 6px 14px -8px rgba(15, 23, 42, 0.5);
        transform: translateY(-1px);
    }
    .color-select-tile.active {
        border-color: #6366f1;
        box-shadow: 0 10px 20px -12px rgba(79,70,229,0.55);
    }
    .color-select-circle {
        width: 32px;
        height: 32px;
        border-radius: 999px;
        border: 2px solid rgba(255,255,255,0.9);
        box-shadow: 0 6px 10px rgba(15, 23, 42, 0.25);
        flex-shrink: 0;
    }
    .color-select-label {
        font-size: 0.75rem;
        font-weight: 600;
        color: #374151;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    /* Modal Animations */
#courseModal, #courseDetailModal, #deleteCourseModal, #deleteDayScheduleModal, #enrollmentStatusModal, #qrCodeModal {
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
}

#courseModal:not(.hidden), #courseDetailModal:not(.hidden), 
#deleteCourseModal:not(.hidden), #deleteDayScheduleModal:not(.hidden), #enrollmentStatusModal:not(.hidden), #qrCodeModal:not(.hidden) {
    opacity: 1;
    visibility: visible;
}

#courseModal > div, #courseDetailModal > div, 
#deleteCourseModal > div, #deleteDayScheduleModal > div, #enrollmentStatusModal > div, #qrCodeModal > div {
    transform: scale(0.95) translateY(-20px);
    opacity: 0;
    transition: transform 0.3s ease, opacity 0.3s ease;
}

#courseModal:not(.hidden) > div, #courseDetailModal:not(.hidden) > div,
#deleteCourseModal:not(.hidden) > div, #deleteDayScheduleModal:not(.hidden) > div, #enrollmentStatusModal:not(.hidden) > div, #qrCodeModal:not(.hidden) > div {
    transform: scale(1) translateY(0);
    opacity: 1;
}
    
    /* Day Schedules Container Animation */
    #daySchedulesContainer {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.4s ease, opacity 0.3s ease;
        opacity: 0;
    }
    
    #daySchedulesContainer:not(.hidden) {
        max-height: 2000px;
        opacity: 1;
    }
    
    /* Default Schedule Section Animation */
    #defaultScheduleSection, #defaultAttendanceSection {
        transition: opacity 0.3s ease, transform 0.3s ease;
    }
    
    #defaultScheduleSection.hidden, #defaultAttendanceSection.hidden {
        opacity: 0;
        transform: translateY(-10px);
    }
    
    /* Smooth transitions for buttons */
    button {
        transition: all 0.2s ease;
    }
    
    button:hover {
        transform: translateY(-1px);
    }
    
    button:active {
        transform: translateY(0);
    }
</style>

<div id="current-user-meta" data-user-id="{{ user.id }}" class="hidden"></div>

<!-- Teacher Top Bar -->
{% include 'dashboard/instructor/teacher_topbar.html' %}

<div class="min-h-screen bg-gray-100 flex flex-col lg:flex-row">
    <!-- Sidebar -->
    {% include 'dashboard/instructor/teacher_sidebar.html' %}

    <main id="main-content" class="flex-grow p-4 lg:p-6 lg:ml-64 mt-16 overflow-y-auto" style="height: calc(100vh - 64px); overscroll-behavior: contain; background: #f4f5fb;">
        <div class="max-w-7xl mx-auto">
            <!-- Beautiful Header Section -->
            <div class="bg-gradient-to-r from-rose-400 via-orange-300 to-sky-400 rounded-2xl shadow-2xl mb-6 p-6 md:p-8 relative overflow-hidden">
                <!-- Decorative Background Elements -->
                <div class="absolute top-0 right-0 w-64 h-64 bg-white opacity-10 rounded-full -mr-32 -mt-32"></div>
                <div class="absolute bottom-0 left-0 w-48 h-48 bg-white opacity-10 rounded-full -ml-24 -mb-24"></div>
                
                <div class="relative z-10">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                        <div class="flex items-center gap-4 min-w-0 flex-1">
                            {% if program.icon %}
                            <div class="w-16 h-16 rounded-full border-4 border-white shadow-lg overflow-hidden bg-white/10">
                                <img src="{{ program.icon.url }}" alt="{{ program.code }}" class="w-full h-full object-cover">
                            </div>
                            {% else %}
                            <div class="w-16 h-16 rounded-full border-4 border-white shadow-lg flex items-center justify-center bg-white/10">
                                <i class="fas fa-graduation-cap text-2xl text-white"></i>
                            </div>
                            {% endif %}
                            <div class="min-w-0">
                                <h1 class="program-title font-bold text-white drop-shadow-lg" title="{{ program.name }}">
                                    {{ program.name }}
                                </h1>
                                <p class="program-code-label text-white/80 font-semibold mt-1">{{ program.code }}</p>
                                {% if program.department %}
                                <div class="program-subtitle text-white/85 font-medium flex items-center gap-2 mt-2">
                                    {% if department and department.icon %}
                            <div class="w-8 h-8 rounded-full border-2 border-white/70 shadow overflow-hidden bg-white/10 flex-shrink-0 flex items-center justify-center">
                                        <img src="{{ department.icon.url }}" alt="{{ department.name }}" class="w-full h-full object-cover">
                                    </div>
                                    {% else %}
                                    <div class="w-8 h-8 rounded-full border-2 border-white/60 shadow flex items-center justify-center bg-white/10 text-xs">
                                        <i class="fas fa-building text-white"></i>
                                    </div>
                                    {% endif %}
                            <span class="leading-none">{{ program.department }}</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="flex items-center gap-3 shrink-0">
                            <div class="bg-white/25 backdrop-blur-md rounded-xl px-5 py-3 border border-white/40 shadow-lg text-center">
                                <p class="text-[11px] uppercase tracking-wide text-white/80 font-semibold">Total Courses</p>
                                <p class="text-2xl font-bold text-white mt-1">{{ grouped_courses|length }}</p>
                            </div>
                            <button onclick="openAddCourseModal()" class="px-4 py-2.5 bg-white text-indigo-600 text-sm font-semibold rounded-xl shadow-lg hover:shadow-xl transition-all duration-200 flex items-center gap-2">
                                <i class="fas fa-plus text-sm"></i>
                                <span class="tracking-wide">Add New Course</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-4 mb-6">
                <div class="flex items-center justify-between">
                    <p class="text-sm font-semibold tracking-[0.3em] uppercase text-gray-500">Courses</p>
                </div>
                <div class="w-full h-0.5 bg-gradient-to-r from-transparent via-gray-400 to-transparent mt-3 rounded-full"></div>
            </div>
            
            <!-- Courses Organized by School Year -> Year Level -> Semester (Folder Structure) -->
            {% if courses_by_school_year %}
            <div class="space-y-3">
                {% for school_year_key, school_year_data in courses_by_school_year.items %}
                <div class="bg-white rounded-lg shadow-md overflow-hidden border border-gray-200">
                    <!-- School Year Header (Collapsible) - Clickable Row with Delete Button -->
                    <div class="bg-gradient-to-r from-purple-50 to-pink-50 px-3 py-2 border-b border-gray-200">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center cursor-pointer hover:from-purple-100 hover:to-pink-100 transition-all w-full" onclick="toggleSchoolYearFolder('school-year-{{ forloop.counter }}')" style="pointer-events: auto;">
                                <h3 class="text-base font-bold text-gray-900 flex items-center w-full" style="pointer-events: none;">
                                    <i id="school-year-icon-{{ forloop.counter }}" class="fas fa-chevron-down text-xs mr-2 text-gray-600 transition-transform duration-300" style="transform: rotate(-90deg); pointer-events: none;"></i>
                                    <i class="fas fa-calendar-alt mr-2 text-purple-600 text-sm" style="pointer-events: none;"></i>
                                    <span style="pointer-events: none;">{{ school_year_key }}</span>
                                </h3>
                            </div>
                            <!-- Archive and Delete School Year Buttons -->
                            <div class="flex items-center gap-2 ml-2">
                                <button onclick="event.stopPropagation(); archiveSchoolYearFolder('{{ school_year_key }}')" 
                                        class="px-3 py-1.5 bg-purple-50 text-purple-700 text-xs font-semibold rounded-lg hover:bg-purple-100 transition flex items-center gap-2" 
                                        title="Archive all courses in this school year">
                                    <i class="fas fa-archive text-xs"></i>
                                    <span>Archive</span>
                                </button>
                                <button onclick="event.stopPropagation(); deleteSchoolYearFolder('{{ school_year_key }}')" 
                                        class="px-3 py-1.5 bg-red-50 text-red-700 text-xs font-semibold rounded-lg hover:bg-red-100 transition flex items-center gap-2" 
                                        title="Delete all courses in this school year">
                                    <i class="fas fa-trash text-xs"></i>
                                    <span>Delete</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Year Levels within School Year -->
                    <div id="school-year-{{ forloop.counter }}" class="school-year-folder" style="display: none;">
                        <div class="space-y-3 p-2">
                            {% for year_key, year_data in school_year_data.items %}
                            <div class="bg-gray-50 rounded-lg border border-gray-200">
                                <!-- Year Level Header (Collapsible) - Clickable Row -->
                                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 px-3 py-2 border-b border-gray-200">
                                    <div class="flex items-center cursor-pointer hover:from-blue-100 hover:to-indigo-100 transition-all w-full" onclick="toggleYearFolder('year-{{ forloop.parentloop.counter }}-{{ forloop.counter }}')" style="pointer-events: auto;">
                                        <h4 class="text-sm font-bold text-gray-900 flex items-center w-full" style="pointer-events: none;">
                                            <i id="year-icon-{{ forloop.parentloop.counter }}-{{ forloop.counter }}" class="fas fa-chevron-down text-xs mr-2 text-gray-600 transition-transform duration-300" style="transform: rotate(-90deg); pointer-events: none;"></i>
                                            <i class="fas fa-graduation-cap mr-2 text-blue-600 text-xs" style="pointer-events: none;"></i>
                                            <span style="pointer-events: none;">{{ year_key }}</span>
                                        </h4>
                                    </div>
                                </div>
                                
                                <!-- Semesters within Year Level -->
                                <div id="year-{{ forloop.parentloop.counter }}-{{ forloop.counter }}" class="year-folder" style="display: none;">
                                    <div class="space-y-2 p-2">
                                        {% for semester_key, courses_list in year_data.semesters.items %}
                                        <!-- Semester Header (Collapsible) with Delete Button -->
                                        <div class="mb-2">
                                            <div class="flex items-center justify-between bg-gradient-to-r from-green-50 to-emerald-50 px-3 py-2 rounded-lg border border-green-200">
                                                <div class="flex items-center cursor-pointer hover:bg-green-100 transition-all rounded-lg flex-1" onclick="toggleSemesterFolder('semester-{{ forloop.parentloop.parentloop.counter }}-{{ forloop.parentloop.counter }}-{{ forloop.counter }}')">
                                                    <h5 class="text-xs font-bold text-gray-800 flex items-center w-full">
                                                        <i id="semester-icon-{{ forloop.parentloop.parentloop.counter }}-{{ forloop.parentloop.counter }}-{{ forloop.counter }}" class="fas fa-chevron-down text-xs mr-2 text-gray-600 transition-transform duration-300"></i>
                                                        <i class="fas fa-calendar mr-2 text-green-600 text-xs"></i>
                                                        <span>{% if semester_key == '1st' %}1st Semester{% elif semester_key == '2nd' %}2nd Semester{% elif semester_key == 'summer' %}Summer{% else %}{{ semester_key }}{% endif %}</span>
                                                    </h5>
                                                </div>
                                                <!-- Archive and Delete Semester Buttons -->
                                                <div class="flex items-center gap-1 ml-2">
                                                    <button onclick="event.stopPropagation(); archiveSemesterFolder('{{ forloop.parentloop.parentloop.counter }}-{{ forloop.parentloop.counter }}', '{{ semester_key }}', '{{ year_key }}', '{{ school_year_key }}')" 
                                                            class="px-2 py-1 bg-purple-50 text-purple-700 text-xs font-semibold rounded-lg hover:bg-purple-100 transition flex items-center gap-1" 
                                                            title="Archive all courses in this semester">
                                                        <i class="fas fa-archive text-xs"></i>
                                                        <span>Archive</span>
                                                    </button>
                                                    <button onclick="event.stopPropagation(); deleteSemesterFolder('{{ forloop.parentloop.parentloop.counter }}-{{ forloop.parentloop.counter }}', '{{ semester_key }}', '{{ year_key }}', '{{ school_year_key }}')" 
                                                            class="px-2 py-1 bg-red-50 text-red-700 text-xs font-semibold rounded-lg hover:bg-red-100 transition flex items-center gap-1" 
                                                            title="Delete all courses in this semester">
                                                        <i class="fas fa-trash text-xs"></i>
                                                        <span>Delete</span>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Course Containers for this Semester (Multi-section grouped as one) -->
                                        <div id="semester-{{ forloop.parentloop.parentloop.counter }}-{{ forloop.parentloop.counter }}-{{ forloop.counter }}" class="semester-folder ml-4 pl-2 border-l-2 border-green-200" style="display: none;">
                                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 p-2">
                                                {% for course in courses_list %}
                                                <div class="course-card-wrapper relative {% if course.sibling_sections and course.sibling_sections|length > 1 %}multi-section-glow{% endif %}" data-course-id="{{ course.id }}">
                                                    <div class="bg-white rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-300 overflow-hidden border border-gray-100 group">
                                                        <!-- Course Card Block (Same as Students Sidebar) -->
                                                        <div class="relative h-32 flex items-center justify-center overflow-hidden course-card-block"
                                                             {% if course.display_gradient %} data-gradient="{{ course.display_gradient }}" {% endif %}
                                                             style="{% if not course.display_gradient %}background: linear-gradient(135deg, {{ course.color|default:'#3C4770' }} 0%, {{ course.color|default:'#447294' }} 100%);{% endif %}">
                                                            <div class="absolute inset-0 opacity-10">
                                                                <div class="absolute top-0 right-0 w-24 h-24 bg-white rounded-full -mr-12 -mt-12"></div>
                                                                <div class="absolute bottom-0 left-0 w-20 h-20 bg-white rounded-full -ml-10 -mb-10"></div>
                                                            </div>
                                                            {% if course.sibling_sections and course.sibling_sections|length > 1 %}
                                                            <div class="multi-stars-field" data-star-count="60"></div>
                                                            {% endif %}
                                                            <div class="relative z-10 text-center px-4">
                                                                <h3 class="text-lg font-bold text-white mb-1 leading-tight" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">
                                                                    {{ course.name }}
                                                                </h3>
                                                                <p class="text-sm text-white/90 font-medium">{{ course.code }}</p>
                                                            </div>
                                                        </div>
                                                        <!-- Action Buttons -->
                                                        <div class="p-3 bg-white">
                                                            <div class="flex gap-1 flex-wrap">
                                                                <button type="button" data-action="view-course" data-course-id="{{ course.id }}" class="flex-1 px-2 py-1.5 bg-blue-50 text-blue-700 text-xs font-semibold rounded-lg hover:bg-blue-100 transition">
                                                                    <i class="fas fa-eye"></i> View
                                                                </button>
                                                                <button type="button" data-action="edit-course" data-course-id="{{ course.id }}" class="flex-1 px-2 py-1.5 bg-amber-50 text-amber-700 text-xs font-semibold rounded-lg hover:bg-amber-100 transition">
                                                                    <i class="fas fa-edit"></i> Edit
                                                                </button>
                                                                <button type="button" data-action="archive-course" data-course-id="{{ course.id }}" data-course-code="{{ course.code|escapejs }}" data-course-name="{{ course.name|escapejs }}" class="flex-1 px-2 py-1.5 bg-purple-50 text-purple-700 text-xs font-semibold rounded-lg hover:bg-purple-100 transition" onclick="event.stopPropagation(); archiveCourse({{ course.id }}, '{{ course.code|escapejs }}', '{{ course.name|escapejs }}');">
                                                                    <i class="fas fa-archive"></i> Archive
                                                                </button>
                                                                <button type="button" data-action="delete-course" data-course-id="{{ course.id }}" data-course-code="{{ course.code|escapejs }}" data-course-name="{{ course.name|escapejs }}" class="flex-1 px-2 py-1.5 bg-red-50 text-red-700 text-xs font-semibold rounded-lg hover:bg-red-100 transition">
                                                                    <i class="fas fa-trash"></i> Delete
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <!-- Fallback: Grid Layout if folder structure not available -->
            {% elif courses %}
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-5">
                {% for course in grouped_courses %}
                <div class="course-card-wrapper relative {% if course.sibling_sections and course.sibling_sections|length > 1 %}multi-section-glow{% endif %}" data-course-id="{{ course.id }}">
                    <!-- Beautiful Course Card with Enhanced Styling -->
                    <div class="course-card-block group rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-300 text-center py-8 px-4 min-h-[140px] flex flex-col justify-center items-center relative overflow-hidden border-2 border-white/20"
                         data-gradient="{{ course.display_gradient }}">
                        <!-- Decorative Pattern Overlay -->
                        <div class="absolute inset-0 opacity-10">
                            <div class="absolute top-0 right-0 w-20 h-20 bg-white rounded-full -mr-10 -mt-10"></div>
                            <div class="absolute bottom-0 left-0 w-16 h-16 bg-white rounded-full -ml-8 -mb-8"></div>
                        </div>
                        
                        {% if course.sibling_sections and course.sibling_sections|length > 1 %}
                        <!-- Twinkling star overlay -->
                        <div class="multi-stars-field" data-star-count="60"></div>
                        {% endif %}
                        
                        <!-- Course Name with Better Typography -->
                        <div class="relative z-10 w-full">
                            <h3 class="course-card-title text-white leading-tight px-2 text-center line-clamp-3" title="{{ course.name }}">
                                {{ course.name }}
                            </h3>
                        </div>

                        <!-- Hover Effect Indicator -->
                        <div class="absolute bottom-0 left-0 right-0 h-1 bg-white/30 transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></div>
                    </div>
                    
                    {% if course.sibling_sections and course.sibling_sections|length > 1 %}
                    <!-- Multiple sections badge -->
                    <div class="absolute -top-2 -right-2">
                        <div class="bg-yellow-400 text-yellow-900 text-[10px] font-extrabold px-2 py-1 rounded-full shadow-md ring-2 ring-white/60">
                            MULTI-SECTION
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if course.instructor == user %}
                    <div class="absolute top-full left-0 right-0 pt-2 pointer-events-none">
                        <div id="course-actions-{{ course.id }}" class="course-actions bg-white rounded-2xl shadow-xl border border-gray-200 p-3 z-20 flex flex-col gap-2 focus-within:opacity-100 focus-within:pointer-events-auto">
                            <button type="button" data-action="view-course" data-course-id="{{ course.id }}" class="w-full px-3 py-2.5 bg-blue-50 text-blue-700 text-xs font-semibold rounded-xl hover:bg-blue-100 transition flex items-center justify-center gap-2">
                                <i class="fas fa-eye text-sm"></i>
                                <span>View</span>
                            </button>
                            <button type="button" data-action="edit-course" data-course-id="{{ course.id }}" class="w-full px-3 py-2.5 bg-amber-50 text-amber-700 text-xs font-semibold rounded-xl hover:bg-amber-100 transition flex items-center justify-center gap-2">
                                <i class="fas fa-edit text-sm"></i>
                                <span>Edit</span>
                            </button>
                            <button type="button" data-action="delete-course" data-course-id="{{ course.id }}" data-course-code="{{ course.code|escapejs }}" data-course-name="{{ course.name|escapejs }}" class="w-full px-3 py-2.5 bg-red-50 text-red-700 text-xs font-semibold rounded-xl hover:bg-red-100 transition flex items-center justify-center gap-2">
                                <i class="fas fa-trash text-sm"></i>
                                <span>Delete</span>
                            </button>
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% else %}
            <!-- Beautiful Empty State -->
            <div class="bg-white rounded-2xl shadow-xl p-16 text-center border-2 border-dashed border-gray-300">
                <div class="max-w-md mx-auto">
                    <div class="w-24 h-24 mx-auto mb-6 bg-gradient-to-br from-indigo-100 to-purple-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-book-open text-5xl text-indigo-500"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-2">No courses yet</h3>
                    <p class="text-gray-600 mb-6">Start building your course catalog by adding your first course</p>
                    <button onclick="openAddCourseModal()" class="inline-flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-semibold rounded-xl hover:from-indigo-700 hover:to-purple-700 transition-all duration-200 shadow-lg hover:shadow-xl transform hover:scale-105">
                        <i class="fas fa-plus"></i>
                        <span>Add Your First Course</span>
                    </button>
                </div>
            </div>
            {% endif %}
        </div>
    </main>
</div>

<!-- Add/Edit Course Modal - Simplified version for instructors -->
<div id="courseModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
        <div class="modal-scroll-area">
            <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center">
                <div class="flex items-center gap-4">
                <h2 class="text-2xl font-bold text-gray-900" id="modalTitle">Add New Course</h2>
                    <!-- Edit-mode Section Switcher -->
                    <div id="editSectionSwitcher" class="hidden">
                        <label for="editSectionSelect" class="sr-only">Section</label>
                        <select id="editSectionSelect" class="px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 bg-white">
                            <!-- options injected in edit mode -->
                        </select>
                    </div>
                    <!-- Edit-mode: Add another section (shown when only one/no section exists) -->
                    <a href="#" id="editAddSectionLink" class="hidden text-blue-600 hover:text-blue-800 text-sm font-medium transition duration-150 cursor-pointer hover:font-semibold">
                        + Add another section
                    </a>
                </div>
                <div class="flex items-center gap-4">
                    <!-- Delete current section (visible in edit mode only) -->
                    <button type="button" id="deleteSectionBtn" class="hidden px-3 py-2 bg-red-50 text-red-700 text-xs font-semibold rounded-xl hover:bg-red-100 transition flex items-center gap-2">
                        <i class="fas fa-trash"></i>
                        <span>Delete this section</span>
                    </button>
                    <a href="#" id="toggleOtherProgramsBtn" onclick="toggleOtherPrograms(); return false;" class="text-blue-600 hover:text-blue-800 text-sm font-medium transition duration-150 cursor-pointer hover:font-semibold hidden" title="Add course to other departments/programs">
                        Add course to other program
                    </a>
                    <button onclick="closeCourseModal(true)" class="text-gray-400 hover:text-gray-600 transition-transform duration-200 hover:rotate-90" title="Close and clear saved data">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
            </div>
            <form id="courseForm" class="p-6 space-y-6" novalidate>
                {% csrf_token %}
                <input type="hidden" name="program" id="program" value="{{ program.id }}">
                <input type="hidden" name="course_id" id="course_id" value="">
                
                <!-- Auto-filled Program & Department Info (Default - shown when not adding to other programs) -->
                <div id="defaultProgramInfo" class="bg-indigo-50 border-l-4 border-indigo-500 p-4 rounded-lg mb-0 form-section-card">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-indigo-800 mb-1">
                                <i class="fas fa-info-circle mr-2"></i>Program & Department (Auto-filled)
                            </p>
                            <p class="text-sm text-indigo-700">
                                <strong>Program:</strong> {{ program.code }} - {{ program.name }}
                                {% if program.department %}
                                <br><strong>Department:</strong> {{ program.department }}
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- Department & Program Selection (Hidden by default - shown when adding to other programs) -->
                <div id="otherProgramsSection" class="hidden bg-blue-50 border-l-4 border-blue-500 p-4 rounded-lg mb-0 form-section-card">
                    <h3 class="text-sm font-semibold text-blue-800 mb-3 flex items-center">
                        <i class="fas fa-building mr-2"></i>Select Department & Program
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="department" class="block text-sm font-medium text-blue-900 mb-2">Department <span class="text-red-500">*</span></label>
                            <select id="department" class="w-full px-4 py-2.5 border border-blue-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white" onchange="loadProgramsByDepartment()">
                                <option value="">Select Department</option>
                            </select>
                            <p class="text-xs text-blue-700 mt-2">Departments are loaded from your school. Choose one to see its programs.</p>
                        </div>
                        <div>
                            <label for="program_select" class="block text-sm font-medium text-blue-900 mb-2">Program <span class="text-red-500">*</span></label>
                            <select id="program_select" class="w-full px-4 py-2.5 border border-blue-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white" disabled>
                                <option value="">Select Department First</option>
                            </select>
                            <p class="text-xs text-blue-700 mt-2">After selecting a program, all course details below will be saved under that program.</p>
                        </div>
                    </div>
                    <div class="mt-4 text-xs text-blue-800 bg-white/60 rounded-xl p-3 border border-blue-100">
                        <p class="font-semibold">Tip:</p>
                        <p class="mt-1">Use this mode when you need to add a course for another department/program that is still part of your school.</p>
                    </div>
                </div>
                
                <!-- Course Information -->
                <div class="bg-white p-5 rounded-xl border border-gray-200 form-section-card">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                        <i class="fas fa-book text-indigo-500"></i>
                        <span>Course Information</span>
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="code" class="block text-sm font-medium text-gray-700 mb-2">Course Code <span class="text-red-500">*</span></label>
                            <input type="text" name="code" id="code" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white" placeholder="e.g., IT 101 / MATH 2A">
                        </div>
                        <div>
                            <label for="name" class="block text-sm font-medium text-gray-700 mb-2">Course Name <span class="text-red-500">*</span></label>
                            <input type="text" name="name" id="name" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white" placeholder="e.g., Introduction to Information Technology">
                        </div>
                    </div>
                </div>

                <!-- Academic Details -->
                <div class="bg-white p-5 rounded-xl border border-gray-200 form-section-card">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                        <i class="fas fa-graduation-cap text-emerald-500"></i>
                        <span>Academic Details</span>
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label for="year_level" class="block text-sm font-medium text-gray-700 mb-2">Year Level <span class="text-red-500">*</span></label>
                            <select name="year_level" id="year_level" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 bg-white">
                                <option value="">Select year level</option>
                                <option value="1">1st Year</option>
                                <option value="2">2nd Year</option>
                                <option value="3">3rd Year</option>
                                <option value="4">4th Year</option>
                                <option value="5">5th Year</option>
                            </select>
                        </div>
                        <div>
                            <label for="semester" class="block text-sm font-medium text-gray-700 mb-2">Semester <span class="text-red-500">*</span></label>
                            <select name="semester" id="semester" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 bg-white">
                                <option value="">Select semester</option>
                                {% for value, label in unique_semesters %}
                                <option value="{{ value }}">{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label for="school_year" class="block text-sm font-medium text-gray-700 mb-2">School Year</label>
                            <select name="school_year" id="school_year" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 bg-white">
                                <option value="">Select school year</option>
                                {% for year in school_year_options %}
                                <option value="{{ year }}" {% if current_school_year == year %}selected{% endif %}>{{ year }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label for="section" class="block text-sm font-medium text-gray-700 mb-2">Section</label>
                            <input type="text" name="section" id="section" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 bg-white" placeholder="e.g., A1, BSIT-A" maxlength="20">
                            <p class="text-xs text-gray-500 mt-1">Automatically converts to uppercase.</p>
                        </div>
                    </div>
                    
                </div>

                <!-- Schedule & Location -->
                <div class="bg-gradient-to-br from-white via-indigo-50/60 to-white border border-indigo-100 rounded-2xl p-5 shadow-sm form-section-card">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
                                <span class="inline-flex items-center justify-center w-9 h-9 rounded-full bg-indigo-100 text-indigo-600">
                                    <i class="fas fa-clock"></i>
                                </span>
                                Schedule & Location
                            </h3>
                            <p class="text-sm text-gray-500 mt-1">Set the primary time, room, and meeting days for this course. Toggle per-day schedules when needed.</p>
                        </div>
                        <span class="inline-flex items-center gap-2 text-[12px] uppercase tracking-wide font-semibold text-indigo-700 bg-indigo-100/80 px-3 py-1 rounded-full">
                            <i class="fas fa-bolt text-[10px]"></i> Live synced
                        </span>
                    </div>

                    <div class="mt-5">
                        <div class="rounded-2xl border border-indigo-100 bg-white px-4 py-3 shadow-sm">
                            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                                <div class="flex items-start gap-3">
                                    <div class="w-10 h-10 rounded-xl bg-indigo-50 text-indigo-600 flex items-center justify-center">
                                        <i class="fas fa-random"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm font-semibold text-gray-800">Set different schedule for each day</p>
                                        <p class="text-xs text-gray-500">Keep this off for one consistent schedule. Turn it on to specify unique times per day.</p>
                                    </div>
                                </div>
                    <div class="flex items-center">
                                    <input type="checkbox" id="enable_day_schedules" class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500 mr-2">
                                    <label for="enable_day_schedules" class="text-sm font-medium text-gray-700 cursor-pointer">Enable per-day setup</label>
                                </div>
                            </div>
                    </div>
                </div>
                
                <!-- Default Schedule (when same for all days) -->
                    <div id="defaultScheduleSection" class="mt-6 space-y-5">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="p-4 bg-white rounded-xl border border-gray-200 shadow-sm">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Start Time <span class="text-red-500">*</span></label>
                                <input type="time" name="start_time" id="start_time" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white">
                        </div>
                            <div class="p-4 bg-white rounded-xl border border-gray-200 shadow-sm">
                            <label class="block text-sm font-medium text-gray-700 mb-2">End Time <span class="text-red-500">*</span></label>
                                <input type="time" name="end_time" id="end_time" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white">
                        </div>
                    </div>
                        <div class="p-4 bg-white rounded-xl border border-gray-200 shadow-sm">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Room/Location</label>
                            <input type="text" name="room" id="room" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white" placeholder="e.g., Bldg A, Rm 302">
                    </div>
                        <div class="p-4 bg-white rounded-xl border border-gray-200 shadow-sm">
                            <label class="block text-sm font-medium text-gray-700 mb-3">Class Days <span class="text-red-500">*</span></label>
                            <div class="flex gap-3 flex-wrap p-3 bg-white border border-gray-100 rounded-2xl justify-center">
                                <button type="button" data-day="Mon" class="day-button-multi flex items-center justify-center w-12 h-12 rounded-full border-2 border-gray-300 bg-white text-gray-700 hover:bg-indigo-50 hover:border-indigo-400 transition-all text-xs font-semibold">
                                <input type="checkbox" name="day_checkbox" value="Mon" class="day-checkbox hidden">
                                <span>Mon</span>
                            </button>
                                <button type="button" data-day="Tue" class="day-button-multi flex items-center justify-center w-12 h-12 rounded-full border-2 border-gray-300 bg-white text-gray-700 hover:bg-indigo-50 hover:border-indigo-400 transition-all text-xs font-semibold">
                                <input type="checkbox" name="day_checkbox" value="Tue" class="day-checkbox hidden">
                                <span>Tue</span>
                            </button>
                                <button type="button" data-day="Wed" class="day-button-multi flex items-center justify-center w-12 h-12 rounded-full border-2 border-gray-300 bg-white text-gray-700 hover:bg-indigo-50 hover:border-indigo-400 transition-all text-xs font-semibold">
                                <input type="checkbox" name="day_checkbox" value="Wed" class="day-checkbox hidden">
                                <span>Wed</span>
                            </button>
                                <button type="button" data-day="Thu" class="day-button-multi flex items-center justify-center w-12 h-12 rounded-full border-2 border-gray-300 bg-white text-gray-700 hover:bg-indigo-50 hover:border-indigo-400 transition-all text-xs font-semibold">
                                <input type="checkbox" name="day_checkbox" value="Thu" class="day-checkbox hidden">
                                <span>Thu</span>
                            </button>
                                <button type="button" data-day="Fri" class="day-button-multi flex items-center justify-center w-12 h-12 rounded-full border-2 border-gray-300 bg-white text-gray-700 hover:bg-indigo-50 hover:border-indigo-400 transition-all text-xs font-semibold">
                                <input type="checkbox" name="day_checkbox" value="Fri" class="day-checkbox hidden">
                                <span>Fri</span>
                            </button>
                                <button type="button" data-day="Sat" class="day-button-multi flex items-center justify-center w-12 h-12 rounded-full border-2 border-gray-300 bg-white text-gray-700 hover:bg-indigo-50 hover:border-indigo-400 transition-all text-xs font-semibold">
                                <input type="checkbox" name="day_checkbox" value="Sat" class="day-checkbox hidden">
                                <span>Sat</span>
                            </button>
                                <button type="button" data-day="Sun" class="day-button-multi flex items-center justify-center w-12 h-12 rounded-full border-2 border-gray-300 bg-white text-gray-700 hover:bg-indigo-50 hover:border-indigo-400 transition-all text-xs font-semibold">
                                <input type="checkbox" name="day_checkbox" value="Sun" class="day-checkbox hidden">
                                <span>Sun</span>
                            </button>
                        </div>
                        <input type="hidden" name="days" id="days" required>
                    </div>
                </div>
                
                <!-- Day-Specific Schedule (when different for each day) -->
                    <div id="daySchedulesContainer" class="hidden mt-6 space-y-5">
                        <div class="p-4 bg-white rounded-xl border border-gray-200 shadow-sm">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select Day <span class="text-red-500">*</span></label>
                            <div class="flex gap-3 flex-wrap p-3 bg-white border border-gray-100 rounded-2xl justify-center">
                                <button type="button" data-day="Mon" class="day-button-single flex items-center justify-center w-12 h-12 rounded-full border-2 border-gray-300 bg-white text-gray-700 hover:bg-indigo-50 hover:border-indigo-400 transition-all text-xs font-semibold">
                                <input type="radio" name="day_radio" value="Mon" class="day-radio hidden">
                                <span>Mon</span>
                            </button>
                                <button type="button" data-day="Tue" class="day-button-single flex items-center justify-center w-12 h-12 rounded-full border-2 border-gray-300 bg-white text-gray-700 hover:bg-indigo-50 hover:border-indigo-400 transition-all text-xs font-semibold">
                                <input type="radio" name="day_radio" value="Tue" class="day-radio hidden">
                                <span>Tue</span>
                            </button>
                                <button type="button" data-day="Wed" class="day-button-single flex items-center justify-center w-12 h-12 rounded-full border-2 border-gray-300 bg-white text-gray-700 hover:bg-indigo-50 hover:border-indigo-400 transition-all text-xs font-semibold">
                                <input type="radio" name="day_radio" value="Wed" class="day-radio hidden">
                                <span>Wed</span>
                            </button>
                                <button type="button" data-day="Thu" class="day-button-single flex items-center justify-center w-12 h-12 rounded-full border-2 border-gray-300 bg-white text-gray-700 hover:bg-indigo-50 hover:border-indigo-400 transition-all text-xs font-semibold">
                                <input type="radio" name="day_radio" value="Thu" class="day-radio hidden">
                                <span>Thu</span>
                            </button>
                                <button type="button" data-day="Fri" class="day-button-single flex items-center justify-center w-12 h-12 rounded-full border-2 border-gray-300 bg-white text-gray-700 hover:bg-indigo-50 hover:border-indigo-400 transition-all text-xs font-semibold">
                                <input type="radio" name="day_radio" value="Fri" class="day-radio hidden">
                                <span>Fri</span>
                            </button>
                                <button type="button" data-day="Sat" class="day-button-single flex items-center justify-center w-12 h-12 rounded-full border-2 border-gray-300 bg-white text-gray-700 hover:bg-indigo-50 hover:border-indigo-400 transition-all text-xs font-semibold">
                                <input type="radio" name="day_radio" value="Sat" class="day-radio hidden">
                                <span>Sat</span>
                            </button>
                                <button type="button" data-day="Sun" class="day-button-single flex items-center justify-center w-12 h-12 rounded-full border-2 border-gray-300 bg-white text-gray-700 hover:bg-indigo-50 hover:border-indigo-400 transition-all text-xs font-semibold">
                                <input type="radio" name="day_radio" value="Sun" class="day-radio hidden">
                                <span>Sun</span>
                            </button>
                        </div>
                    </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="p-4 bg-white rounded-xl border border-gray-200 shadow-sm">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Start Time <span class="text-red-500">*</span></label>
                                <input type="time" id="day_start_time" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white">
                        </div>
                            <div class="p-4 bg-white rounded-xl border border-gray-200 shadow-sm">
                            <label class="block text-sm font-medium text-gray-700 mb-2">End Time <span class="text-red-500">*</span></label>
                                <input type="time" id="day_end_time" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white">
                        </div>
                    </div>
                        <div class="p-4 bg-white rounded-xl border border-gray-200 shadow-sm">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Room/Location</label>
                            <input type="text" id="day_room" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white" placeholder="e.g., Bldg A, Rm 302">
                    </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        </div>
                        <div class="p-4 bg-white rounded-xl border border-gray-200 shadow-sm">
                            <button type="button" id="addDayScheduleBtn" onclick="addDaySchedule()" class="w-full px-4 py-2 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 transition-all">
                            <i class="fas fa-plus mr-2"></i> Add Day Schedule
                        </button>
                    </div>
                        <div class="bg-white rounded-2xl border border-gray-200 overflow-hidden shadow-sm">
                        <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200 text-sm">
                                    <thead class="bg-gray-50 text-gray-600 uppercase tracking-wide text-xs">
                                        <tr>
                                            <th class="px-3 py-2 text-left">Day</th>
                                            <th class="px-3 py-2 text-left">Start Time</th>
                                            <th class="px-3 py-2 text-left">End Time</th>
                                            <th class="px-3 py-2 text-left">Room</th>
                                            <th class="px-3 py-2 text-center">Action</th>
                                    </tr>
                                </thead>
                                    <tbody id="dayScheduleList" class="bg-white divide-y divide-gray-100">
                                    <!-- Added day schedules will appear here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            
                <!-- Attendance Window (legacy container kept for JS hooks; now merged above) -->
                <div id="defaultAttendanceSection" class="hidden"></div>
            
            <!-- Instructor & Display Section -->
                <div class="bg-orange-50 p-5 rounded-xl border border-orange-200 form-section-card">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-chalkboard-teacher mr-2" style="color: #F97316;"></i>
                    Instructor & Display
                </h3>
                <div class="w-full">
                    <div class="max-w-2xl">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Course Color (for timetable)</label>
                        <div class="flex items-center space-x-3">
                            <input type="color" name="color" id="color" value="#3C4770" class="w-20 h-12 border-2 border-gray-300 rounded-lg cursor-pointer bg-white shadow-sm hover:shadow-md transition-shadow">
                            <input type="text" id="color_text" value="#3C4770" class="flex-1 px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 bg-white" placeholder="#3C4770" readonly>
                            <button type="button" onclick="assignRandomColor()" class="px-4 py-2.5 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition text-sm font-medium">
                                <i class="fas fa-random mr-1"></i> Random
                            </button>
                        </div>
                        <div class="mt-4">
                            <p class="text-xs uppercase tracking-wide text-gray-600 font-semibold mb-2 flex items-center gap-2">
                                <i class="fas fa-palette text-sm text-orange-500"></i>
                                Popular Palettes
                            </p>
                            <div id="color-palette-grid" class="color-select-grid"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="courseModalFooter" class="flex items-center justify-between pt-4 border-t">
                <a href="#" id="saveAndAddSectionBtn" class="text-blue-600 hover:text-blue-800 text-sm font-medium transition duration-150 cursor-pointer hover:font-semibold">
                    Save & add sched to other sections
                </a>
                <div class="flex items-center space-x-3">
                <button type="button" onclick="closeCourseModal(true)" class="px-5 py-2.5 bg-gray-200 text-gray-700 font-semibold rounded-xl hover:bg-gray-300 transition duration-150 shadow-sm">
                    Cancel
                </button>
                <button type="submit" id="submitButton" class="px-6 py-2.5 text-white font-semibold rounded-xl transition duration-150 shadow-md hover:shadow-lg" style="background-color: #3C4770;" onmouseover="this.style.backgroundColor='#447294';" onmouseout="this.style.backgroundColor='#3C4770';">
                    <i class="fas fa-save mr-2"></i> <span id="submitButtonText">Save Course</span>
                </button>
                </div>
            </div>
        </form>
    </div>
    </div>
</div>

<!-- Course Detail Modal -->
<div id="courseDetailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-[120] flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[85vh] overflow-hidden">
        <div class="modal-scroll-area">
            <div class="sticky top-0 bg-white border-b border-gray-200 px-5 py-3 flex justify-between items-center">
                <h2 class="text-xl font-bold text-gray-900">Course Details</h2>
                <button onclick="closeCourseDetailModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <div id="courseDetailContent" class="p-4">
                <!-- Content will be loaded dynamically -->
            </div>
        </div>
    </div>
</div>

<!-- Delete Day Schedule Modal -->
<div id="deleteDayScheduleModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 backdrop-blur-sm hidden z-[110] flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 md:p-8">
        <div class="flex justify-between items-start mb-6">
            <h3 class="text-2xl font-bold flex items-center text-red-600">
                <i class="fas fa-exclamation-triangle w-6 h-6 mr-2"></i> Remove Day Schedule
            </h3>
            <button onclick="closeDeleteDayScheduleModal()" class="text-gray-400 hover:text-gray-600 transition duration-150 hover:opacity-75">
                <i class="fas fa-times w-6 h-6"></i>
            </button>
        </div>
        <div class="space-y-4">
            <p class="text-gray-700 font-semibold">Are you sure you want to remove this day schedule?</p>
            <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded">
                <p class="font-semibold text-red-800" id="delete-day-schedule-info"></p>
            </div>
            <p class="text-sm text-gray-600">This will remove the schedule for this day. You can add it again later if needed.</p>
            <input type="hidden" id="delete-day-schedule-day">
            <div class="flex justify-end space-x-3 pt-6 border-t border-gray-100">
                <button onclick="closeDeleteDayScheduleModal()" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-150 shadow-sm">
                    Cancel
                </button>
                <button onclick="confirmDeleteDaySchedule()" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-150 shadow-sm">
                    <i class="fas fa-trash mr-2"></i> Remove
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Section Modal -->
<div id="deleteSectionModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 backdrop-blur-sm hidden z-[120] flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 md:p-8">
        <div class="flex justify-between items-start mb-6">
            <h3 class="text-2xl font-bold flex items-center text-red-600">
                <i class="fas fa-exclamation-triangle w-6 h-6 mr-2"></i> Delete Section
            </h3>
            <button onclick="closeDeleteSectionModal()" class="text-gray-400 hover:text-gray-600 transition duration-150 hover:opacity-75">
                <i class="fas fa-times w-6 h-6"></i>
            </button>
        </div>
        <div class="space-y-4">
            <p class="text-gray-700 font-semibold">Are you sure you want to delete this SPECIFIC section only?</p>
            <p class="text-gray-600 text-sm">This will remove ONLY this section and its schedules. Other sections (1A, 1B, etc.) of this course will remain intact and unaffected. This action cannot be undone.</p>
            <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded">
                <p class="font-semibold text-red-800" id="delete-section-info"></p>
            </div>
            <div class="flex justify-end space-x-3 pt-6 border-t border-gray-100">
                <button onclick="closeDeleteSectionModal()" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-150 shadow-sm">
                    Cancel
                </button>
                <button onclick="confirmDeleteSection()" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-150 shadow-sm">
                    <i class="fas fa-trash mr-2"></i> Delete
                </button>
            </div>
        </div>
    </div>
    <input type="hidden" id="delete-section-course-id" value="">
</div>

<!-- Archive Course Modal -->
<div id="archiveCourseModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 backdrop-blur-sm hidden z-[110] flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 md:p-8">
        <div class="flex justify-between items-start mb-6">
            <h3 class="text-2xl font-bold flex items-center text-purple-600">
                <i class="fas fa-archive w-6 h-6 mr-2"></i> Archive Course
            </h3>
            <button onclick="closeArchiveCourseModal()" class="text-gray-400 hover:text-gray-600 transition duration-150 hover:opacity-75">
                <i class="fas fa-times w-6 h-6"></i>
            </button>
        </div>
        <div class="space-y-4">
            <p class="text-gray-700 font-semibold">Are you sure you want to archive this course?</p>
            <div class="bg-purple-50 border-l-4 border-purple-500 p-4 rounded">
                <p class="font-semibold text-purple-800" id="archive-course-name"></p>
            </div>
            <p class="text-sm text-gray-600">This course will be moved to Archive for storage. It will not be automatically deleted.</p>
            <input type="hidden" id="archive-course-id">
            <div class="flex justify-end space-x-3 pt-6 border-t border-gray-100">
                <button onclick="closeArchiveCourseModal()" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-150 shadow-sm">
                    Cancel
                </button>
                <button onclick="confirmArchiveCourse()" class="px-4 py-2 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 transition duration-150 shadow-sm">
                    <i class="fas fa-archive mr-2"></i> Archive
                </button>
            </div>
        </div>
    </div>
</div>

<!-- QR Code View Modal -->
<div id="qrCodeModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 backdrop-blur-sm hidden z-[130] flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6 md:p-8">
        <div class="flex justify-between items-start mb-6">
            <h3 class="text-2xl font-bold flex items-center text-purple-600">
                <i class="fas fa-qrcode w-6 h-6 mr-2"></i> QR Code
            </h3>
            <button onclick="closeQRCodeModal()" class="text-gray-400 hover:text-gray-600 transition duration-150 hover:opacity-75">
                <i class="fas fa-times w-6 h-6"></i>
            </button>
        </div>
        <div class="space-y-4">
            <div id="qrCodeModalCourseInfo" class="text-center mb-4">
                <p class="text-lg font-semibold text-gray-900" id="qrCodeModalCourseName"></p>
                <p class="text-sm text-gray-600" id="qrCodeModalCourseCode"></p>
            </div>
            <div class="flex justify-center">
                <div class="w-80 h-80 flex items-center justify-center bg-white border-4 border-purple-200 rounded-lg p-4 shadow-lg" style="min-width: 320px; min-height: 320px;">
                    <img id="qrCodeModalImage" 
                         src="" 
                         alt="QR Code" 
                         style="width: 100%; height: 100%; max-width: 300px; max-height: 300px; min-width: 300px; min-height: 300px; display: block !important; visibility: visible !important; opacity: 1 !important; object-fit: contain; background: white !important; image-rendering: crisp-edges;"
                         loading="eager">
                </div>
            </div>
            <p class="text-sm text-gray-600 text-center">Students can scan this QR code to mark attendance</p>
            <div class="flex justify-end pt-4 border-t border-gray-100">
                <button onclick="closeQRCodeModal()" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-150 shadow-sm">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Enrollment Status Modal -->
<div id="enrollmentStatusModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 backdrop-blur-sm hidden z-[120] flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 md:p-8">
        <div class="flex justify-between items-start mb-6">
            <h3 class="text-2xl font-bold flex items-center text-yellow-600">
                <i class="fas fa-user-lock w-6 h-6 mr-2"></i> Change Enrollment Status
            </h3>
            <button onclick="closeEnrollmentStatusModal()" class="text-gray-400 hover:text-gray-600 transition duration-150 hover:opacity-75">
                <i class="fas fa-times w-6 h-6"></i>
            </button>
        </div>
        <div class="space-y-4">
            <p class="text-gray-700 font-semibold" id="enrollmentStatusModalMessage"></p>
            <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded">
                <p class="text-sm text-yellow-800" id="enrollmentStatusModalAction"></p>
            </div>
            <div class="flex justify-end space-x-3 pt-6 border-t border-gray-100">
                <button onclick="closeEnrollmentStatusModal()" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-150 shadow-sm">
                    Cancel
                </button>
                <button onclick="confirmEnrollmentStatusChange()" class="px-4 py-2 bg-yellow-600 text-white font-semibold rounded-lg hover:bg-yellow-700 transition duration-150 shadow-sm">
                    <i class="fas fa-check mr-2"></i> Confirm
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Course Modal -->
<div id="deleteCourseModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 backdrop-blur-sm hidden z-[110] flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 md:p-8">
        <div class="flex justify-between items-start mb-6">
            <h3 class="text-2xl font-bold flex items-center text-red-600">
                <i class="fas fa-exclamation-triangle w-6 h-6 mr-2"></i> Delete Course
            </h3>
            <button onclick="closeDeleteCourseModal()" class="text-gray-400 hover:text-gray-600 transition duration-150 hover:opacity-75">
                <i class="fas fa-times w-6 h-6"></i>
            </button>
        </div>
        <div class="space-y-4">
            <p class="text-gray-700 font-semibold">Are you sure you want to delete this course?</p>
            <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded">
                <p class="font-semibold text-red-800" id="delete-course-name"></p>
            </div>
            <p class="text-sm text-red-600 font-medium"> This will delete ALL sections of this course, including all enrollments.</p>
            <p class="text-sm text-gray-600">This action cannot be undone.</p>
            <input type="hidden" id="delete-course-id">
            <div class="flex justify-end space-x-3 pt-6 border-t border-gray-100">
                <button onclick="closeDeleteCourseModal()" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-150 shadow-sm">
                    Cancel
                </button>
                <button onclick="confirmDeleteCourse()" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-150 shadow-sm">
                    <i class="fas fa-trash mr-2"></i> Delete
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Archive School Year Modal -->
<div id="archiveSchoolYearModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 backdrop-blur-sm hidden z-[110] flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 md:p-8">
        <div class="flex justify-between items-start mb-6">
            <h3 class="text-2xl font-bold flex items-center text-purple-600">
                <i class="fas fa-archive w-6 h-6 mr-2"></i> Archive School Year
            </h3>
            <button onclick="closeArchiveSchoolYearModal()" class="text-gray-400 hover:text-gray-600 transition duration-150 hover:opacity-75">
                <i class="fas fa-times w-6 h-6"></i>
            </button>
        </div>
        <div class="space-y-4">
            <p class="text-gray-700 font-semibold">Are you sure you want to archive ALL courses in this school year?</p>
            <div class="bg-purple-50 border-l-4 border-purple-500 p-4 rounded">
                <p class="font-semibold text-purple-800" id="archive-school-year-name"></p>
            </div>
            <p class="text-sm text-gray-600">All courses will be moved to Archive for storage. They will not be automatically deleted.</p>
            <input type="hidden" id="archive-school-year-key">
            <div class="flex justify-end space-x-3 pt-6 border-t border-gray-100">
                <button onclick="closeArchiveSchoolYearModal()" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-150 shadow-sm">
                    Cancel
                </button>
                <button onclick="confirmArchiveSchoolYear()" class="px-4 py-2 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 transition duration-150 shadow-sm">
                    <i class="fas fa-archive mr-2"></i> Archive
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Archive Semester Modal -->
<div id="archiveSemesterModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 backdrop-blur-sm hidden z-[110] flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 md:p-8">
        <div class="flex justify-between items-start mb-6">
            <h3 class="text-2xl font-bold flex items-center text-purple-600">
                <i class="fas fa-archive w-6 h-6 mr-2"></i> Archive Semester
            </h3>
            <button onclick="closeArchiveSemesterModal()" class="text-gray-400 hover:text-gray-600 transition duration-150 hover:opacity-75">
                <i class="fas fa-times w-6 h-6"></i>
            </button>
        </div>
        <div class="space-y-4">
            <p class="text-gray-700 font-semibold">Are you sure you want to archive ALL courses in this semester?</p>
            <div class="bg-purple-50 border-l-4 border-purple-500 p-4 rounded">
                <p class="font-semibold text-purple-800" id="archive-semester-name"></p>
            </div>
            <p class="text-sm text-gray-600">All courses will be moved to Archive for storage. They will not be automatically deleted.</p>
            <input type="hidden" id="archive-semester-year-index">
            <input type="hidden" id="archive-semester-key">
            <input type="hidden" id="archive-semester-year-key">
            <input type="hidden" id="archive-semester-school-year-key">
            <div class="flex justify-end space-x-3 pt-6 border-t border-gray-100">
                <button onclick="closeArchiveSemesterModal()" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-150 shadow-sm">
                    Cancel
                </button>
                <button onclick="confirmArchiveSemester()" class="px-4 py-2 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 transition duration-150 shadow-sm">
                    <i class="fas fa-archive mr-2"></i> Archive
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete School Year Modal -->
<div id="deleteSchoolYearModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 backdrop-blur-sm hidden z-[110] flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 md:p-8">
        <div class="flex justify-between items-start mb-6">
            <h3 class="text-2xl font-bold flex items-center text-red-600">
                <i class="fas fa-exclamation-triangle w-6 h-6 mr-2"></i> Delete School Year
            </h3>
            <button onclick="closeDeleteSchoolYearModal()" class="text-gray-400 hover:text-gray-600 transition duration-150 hover:opacity-75">
                <i class="fas fa-times w-6 h-6"></i>
            </button>
        </div>
        <div class="space-y-4">
            <p class="text-gray-700 font-semibold">Are you sure you want to delete ALL courses in this school year?</p>
            <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded">
                <p class="font-semibold text-red-800" id="delete-school-year-name"></p>
            </div>
            <p class="text-sm text-gray-600">This will move all courses to trash. They will be permanently deleted after 30 days.</p>
            <input type="hidden" id="delete-school-year-key">
            <div class="flex justify-end space-x-3 pt-6 border-t border-gray-100">
                <button onclick="closeDeleteSchoolYearModal()" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-150 shadow-sm">
                    Cancel
                </button>
                <button onclick="confirmDeleteSchoolYear()" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-150 shadow-sm">
                    <i class="fas fa-trash mr-2"></i> Delete
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Semester Modal -->
<div id="deleteSemesterModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 backdrop-blur-sm hidden z-[110] flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 md:p-8">
        <div class="flex justify-between items-start mb-6">
            <h3 class="text-2xl font-bold flex items-center text-red-600">
                <i class="fas fa-exclamation-triangle w-6 h-6 mr-2"></i> Delete Semester
            </h3>
            <button onclick="closeDeleteSemesterModal()" class="text-gray-400 hover:text-gray-600 transition duration-150 hover:opacity-75">
                <i class="fas fa-times w-6 h-6"></i>
            </button>
        </div>
        <div class="space-y-4">
            <p class="text-gray-700 font-semibold">Are you sure you want to delete ALL courses in this semester?</p>
            <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded">
                <p class="font-semibold text-red-800" id="delete-semester-name"></p>
            </div>
            <p class="text-sm text-gray-600">This will move all courses to trash. They will be permanently deleted after 30 days.</p>
            <input type="hidden" id="delete-semester-year-index">
            <input type="hidden" id="delete-semester-key">
            <input type="hidden" id="delete-semester-year-key">
            <input type="hidden" id="delete-semester-school-year-key">
            <div class="flex justify-end space-x-3 pt-6 border-t border-gray-100">
                <button onclick="closeDeleteSemesterModal()" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-150 shadow-sm">
                    Cancel
                </button>
                <button onclick="confirmDeleteSemester()" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-150 shadow-sm">
                    <i class="fas fa-trash mr-2"></i> Delete
                </button>
            </div>
        </div>
    </div>
</div>

<script>
const currentUserMeta = document.getElementById('current-user-meta');
const currentUserId = currentUserMeta ? Number(currentUserMeta.dataset.userId || 0) : 0;

// Handle hover on course cards - only show action buttons when hovering the card itself
document.addEventListener('DOMContentLoaded', function() {
    const courseCards = document.querySelectorAll('.course-card-block.group');
    courseCards.forEach(card => {
        const wrapper = card.closest('.course-card-wrapper');
        if (!wrapper) return;
        
        let hideTimeout = null;
        
        const clearHideTimeout = function() {
            if (hideTimeout) {
                clearTimeout(hideTimeout);
                hideTimeout = null;
            }
        };
        
        const scheduleHide = function() {
            clearHideTimeout();
            // Wait 0.5 seconds before starting fade out
            hideTimeout = setTimeout(function() {
                wrapper.classList.remove('card-hovered');
                hideTimeout = null;
            }, 500);
        };
        
        // Add hover class when mouse enters the card
        card.addEventListener('mouseenter', function() {
            clearHideTimeout();
            wrapper.classList.add('card-hovered');
        });
        
        // Remove hover class when mouse leaves the card (with delay)
        card.addEventListener('mouseleave', function(e) {
            // Check if we're moving to the action buttons
            const relatedTarget = e.relatedTarget;
            if (relatedTarget && (wrapper.contains(relatedTarget) || wrapper.querySelector('.course-actions')?.contains(relatedTarget))) {
                return; // Don't hide if moving to action buttons
            }
            scheduleHide();
        });
        
        // Also handle mouseleave on the wrapper to hide buttons when leaving the entire area (with delay)
        wrapper.addEventListener('mouseleave', function(e) {
            const relatedTarget = e.relatedTarget;
            if (!relatedTarget || !wrapper.contains(relatedTarget)) {
                scheduleHide();
            }
        });
        
        // Keep buttons visible when hovering the action buttons themselves
        const actionButtons = wrapper.querySelector('.course-actions');
        if (actionButtons) {
            actionButtons.addEventListener('mouseenter', function() {
                clearHideTimeout();
                wrapper.classList.add('card-hovered');
            });
            actionButtons.addEventListener('mouseleave', function(e) {
                const relatedTarget = e.relatedTarget;
                if (!relatedTarget || !wrapper.contains(relatedTarget)) {
                    scheduleHide();
                }
            });
        }
    });
});

document.addEventListener('click', (event) => {
    const actionButton = event.target.closest('[data-action]');
    if (!actionButton) {
        return;
    }
    
    const actionType = actionButton.dataset.action;
    if (!actionType) {
        return;
    }
    
    const courseId = actionButton.dataset.courseId;
    if (!courseId) {
        return;
    }
    
    event.stopPropagation();
    
    if (actionType === 'view-course') {
        viewCourseDetails(courseId);
        return;
    }
    
    if (actionType === 'edit-course') {
        editCourse(courseId);
        return;
    }
    
    if (actionType === 'archive-course') {
        archiveCourse(
            courseId,
            actionButton.dataset.courseCode || '',
            actionButton.dataset.courseName || ''
        );
    }
    
    if (actionType === 'delete-course') {
        // For course container delete button, only delete the specific course ID
        // This ensures only one section is deleted, not all sections
        openDeleteCourseModal(
            courseId,
            actionButton.dataset.courseCode || '',
            actionButton.dataset.courseName || ''
        );
    }
});
// Toggle year folder (removed duplicate - using the one below)

// Filter courses by section and semester
function filterYearCourses(year) {
    const sectionFilter = document.getElementById('section-filter-' + year);
    const schoolYearFilter = document.getElementById('school-year-filter-' + year);
    
    // Ensure filters exist
    if (!sectionFilter || !schoolYearFilter) {
        console.warn(`Filters not found for year ${year}`);
        return;
    }
    
    const sectionValue = sectionFilter.value || '';
    const schoolYearValue = schoolYearFilter.value || '';
    
    // Save filter values to localStorage (with debounce)
    saveFilterStateDebounced(year, sectionValue, schoolYearValue);
    
    // Also save immediately to ensure persistence
    saveFilterState(year, sectionValue, schoolYearValue);
    
    const rows = document.querySelectorAll(`tr.course-row[data-year="${year}"]`);
    
    rows.forEach(row => {
        const section = row.getAttribute('data-section');
        const schoolYear = row.getAttribute('data-school-year');
        let show = true;
        
        if (sectionValue && section !== sectionValue) show = false;
        if (schoolYearValue && schoolYear !== schoolYearValue) show = false;
        
        row.style.display = show ? '' : 'none';
    });
}

// Save filter state to localStorage
function saveFilterState(year, section, schoolYear) {
    try {
        const filterKey = `instructor_course_filters_${year}`;
        const filterState = {
            section: section || '',
            schoolYear: schoolYear || ''
        };
        localStorage.setItem(filterKey, JSON.stringify(filterState));
    } catch (e) {
        console.error('Error saving filter state:', e);
    }
}

// Restore filter state from localStorage
function restoreFilterState(year) {
    try {
        const filterKey = `instructor_course_filters_${year}`;
        const savedState = localStorage.getItem(filterKey);
        if (savedState) {
            const filterState = JSON.parse(savedState);
            const sectionFilter = document.getElementById('section-filter-' + year);
            const schoolYearFilter = document.getElementById('school-year-filter-' + year);
            
            // Restore section filter
            if (sectionFilter && filterState.section) {
                sectionFilter.value = filterState.section;
                // Trigger change event to ensure filter is applied
                sectionFilter.dispatchEvent(new Event('change', { bubbles: true }));
            }
            
            // Restore school year filter
            if (schoolYearFilter && filterState.schoolYear) {
                schoolYearFilter.value = filterState.schoolYear;
                // Trigger change event to ensure filter is applied
                schoolYearFilter.dispatchEvent(new Event('change', { bubbles: true }));
            }
            
            // Apply the filters after restoring (with a small delay to ensure DOM is ready)
            if (filterState.section || filterState.schoolYear) {
                setTimeout(() => {
                    filterYearCourses(year);
                }, 150);
            }
        }
    } catch (e) {
        console.error('Error restoring filter state:', e);
    }
}

// Save filter state immediately when changed (with debounce to avoid too many saves)
let filterSaveTimeout = {};
function saveFilterStateDebounced(year, section, schoolYear) {
    // Clear existing timeout for this year
    if (filterSaveTimeout[year]) {
        clearTimeout(filterSaveTimeout[year]);
    }
    
    // Save after a short delay
    filterSaveTimeout[year] = setTimeout(() => {
        saveFilterState(year, section, schoolYear);
    }, 100);
}

// Auto-save functionality
const AUTO_SAVE_KEY = 'course_form_autosave';
const AUTO_SAVE_DAY_SCHEDULES_KEY = 'course_form_day_schedules_autosave';

function saveFormData() {
    const form = document.getElementById('courseForm');
    if (!form) return;
    
    const courseId = document.getElementById('course_id')?.value || '';
    // Don't save if editing existing course
    if (courseId) return;
    
    const formData = {
        code: document.getElementById('code')?.value || '',
        name: document.getElementById('name')?.value || '',
        year_level: document.getElementById('year_level')?.value || '',
        section: document.getElementById('section')?.value || '',
        semester: document.getElementById('semester')?.value || '',
        school_year: document.getElementById('school_year')?.value || '',
        room: document.getElementById('room')?.value || '',
        days: document.getElementById('days')?.value || '',
        start_time: document.getElementById('start_time')?.value || '',
        end_time: document.getElementById('end_time')?.value || '',
        color: document.getElementById('color')?.value || '#3C4770',
        enable_day_schedules: document.getElementById('enable_day_schedules')?.checked || false,
        course_id: ''
    };
    
    localStorage.setItem(AUTO_SAVE_KEY, JSON.stringify(formData));
    localStorage.setItem(AUTO_SAVE_DAY_SCHEDULES_KEY, JSON.stringify(addedDaySchedules));
}

function loadFormData() {
    const savedData = localStorage.getItem(AUTO_SAVE_KEY);
    const savedDaySchedules = localStorage.getItem(AUTO_SAVE_DAY_SCHEDULES_KEY);
    
    if (!savedData) return false;
    
    try {
        const formData = JSON.parse(savedData);
        
        // Only restore if it's a new course (no course_id)
        if (!formData.course_id) {
            if (document.getElementById('code')) document.getElementById('code').value = formData.code || '';
            if (document.getElementById('name')) document.getElementById('name').value = formData.name || '';
            if (document.getElementById('year_level')) document.getElementById('year_level').value = formData.year_level || '';
            if (document.getElementById('section')) document.getElementById('section').value = formData.section || '';
            if (document.getElementById('semester')) document.getElementById('semester').value = formData.semester || '';
            if (document.getElementById('school_year')) document.getElementById('school_year').value = formData.school_year || '';
            if (document.getElementById('room')) document.getElementById('room').value = formData.room || '';
            if (document.getElementById('days')) document.getElementById('days').value = formData.days || '';
            if (document.getElementById('start_time')) document.getElementById('start_time').value = formData.start_time || '';
            if (document.getElementById('end_time')) document.getElementById('end_time').value = formData.end_time || '';
            setCourseColor(formData.color || '#3C4770');
            
            // Restore day schedules checkbox
            if (document.getElementById('enable_day_schedules')) {
                document.getElementById('enable_day_schedules').checked = formData.enable_day_schedules || false;
                if (formData.enable_day_schedules) {
                    const container = document.getElementById('daySchedulesContainer');
                    const defaultSection = document.getElementById('defaultScheduleSection');
                    if (container) container.classList.remove('hidden');
                    if (defaultSection) defaultSection.classList.add('hidden');
                }
            }
            
            // Restore day schedules
            if (savedDaySchedules) {
                try {
                    addedDaySchedules = JSON.parse(savedDaySchedules);
                    updateDayScheduleList();
                } catch (e) {
                    console.error('Error restoring day schedules:', e);
                }
            }
            
            // Restore day checkboxes
            if (formData.days) {
                const daysArray = formData.days.split(',');
                daysArray.forEach(day => {
                    const checkbox = document.querySelector(`input.day-checkbox[value="${day.trim()}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }
            
            return true;
        }
    } catch (e) {
        console.error('Error loading saved form data:', e);
    }
    
    return false;
}

function clearFormData() {
    localStorage.removeItem(AUTO_SAVE_KEY);
    localStorage.removeItem(AUTO_SAVE_DAY_SCHEDULES_KEY);
}

// Store departments and programs data
let departmentsData = [];
let programsByDepartment = {};
let isOtherProgramsMode = false;

// Toggle between default program and other programs mode
function toggleOtherPrograms() {
    isOtherProgramsMode = !isOtherProgramsMode;
    const defaultInfo = document.getElementById('defaultProgramInfo');
    const otherSection = document.getElementById('otherProgramsSection');
    const toggleBtn = document.getElementById('toggleOtherProgramsBtn');
    
    if (isOtherProgramsMode) {
        // Show other programs section, hide default
        defaultInfo.classList.add('hidden');
        otherSection.classList.remove('hidden');
        toggleBtn.textContent = 'Use default program';
        // Keep blue color for clickability
        
        // Load departments if not already loaded
        if (departmentsData.length === 0) {
            loadDepartmentsAndPrograms();
        }
    } else {
        // Show default, hide other programs section
        defaultInfo.classList.remove('hidden');
        otherSection.classList.add('hidden');
        toggleBtn.textContent = 'Add course to other program';
        toggleBtn.classList.remove('text-gray-600', 'hover:text-gray-800');
        toggleBtn.classList.add('text-blue-600', 'hover:text-blue-800');
        
        // Reset to default program
        document.getElementById('program').value = '{{ program.id }}';
        document.getElementById('department').value = '';
        document.getElementById('program_select').value = '';
        document.getElementById('program_select').disabled = true;
    }
}

// Load departments and programs from backend
function loadDepartmentsAndPrograms() {
    console.log('Loading departments and programs...');
    const departmentSelect = document.getElementById('department');
    if (!departmentSelect) {
        console.error('Department select element not found');
        return;
    }
    
    // Show loading state
    departmentSelect.innerHTML = '<option value="">Loading departments...</option>';
    departmentSelect.disabled = true;
    
    fetch('{% url "dashboard:instructor_add_course" %}')
        .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Received data:', data);
            if (data.success) {
                departmentsData = data.departments || [];
                programsByDepartment = data.programs_by_department || {};
                
                console.log('Departments loaded:', departmentsData.length);
                console.log('Programs by department:', Object.keys(programsByDepartment).length, 'departments');
                
                // Populate department dropdown
                departmentSelect.innerHTML = '<option value="">Select Department</option>';
                
                if (departmentsData.length === 0) {
                    departmentSelect.innerHTML = '<option value="">No departments found</option>';
                    console.warn('No departments found in response');
                    if (typeof showNotification === 'function') {
                        showNotification('No departments found. Please contact the administrator.', 'warning');
                    }
                } else {
                    departmentsData.forEach(dept => {
                        const option = document.createElement('option');
                        option.value = dept.name;
                        option.textContent = dept.code ? `${dept.code} - ${dept.name}` : dept.name;
                        departmentSelect.appendChild(option);
                    });
                    console.log('Department dropdown populated with', departmentsData.length, 'departments');
                }
                
                departmentSelect.disabled = false;
            } else {
                console.error('Backend returned success: false', data);
                departmentSelect.innerHTML = '<option value="">Error loading departments</option>';
                if (typeof showNotification === 'function') {
                    showNotification(data.message || 'Failed to load departments. Please refresh the page.', 'error');
                }
            }
        })
        .catch(error => {
            console.error('Error loading departments:', error);
            departmentSelect.innerHTML = '<option value="">Error loading departments</option>';
            if (typeof showNotification === 'function') {
                showNotification('Failed to load departments. Please refresh the page.', 'error');
            } else {
                alert('Failed to load departments. Please check the console for details.');
            }
        });
}

// Load programs when department is selected
function loadProgramsByDepartment() {
    const departmentSelect = document.getElementById('department');
    const programSelect = document.getElementById('program_select');
    const selectedDept = departmentSelect.value;
    
    programSelect.innerHTML = '<option value="">Select Program</option>';
    programSelect.disabled = true;
    
    if (!selectedDept) {
        return;
    }
    
    // Get programs for selected department
    const programs = programsByDepartment[selectedDept] || [];
    
    if (programs.length === 0) {
        programSelect.innerHTML = '<option value="">No programs found</option>';
        return;
    }
    
    // Populate program dropdown
    programs.forEach(prog => {
        const option = document.createElement('option');
        option.value = prog.id;
        option.textContent = `${prog.code} - ${prog.name}`;
        programSelect.appendChild(option);
    });
    
    programSelect.disabled = false;
    
    // Update hidden program field when program is selected
    programSelect.onchange = function() {
        document.getElementById('program').value = this.value || '{{ program.id }}';
    };
}

// Course Modal Functions
// Make function globally accessible
window.openAddCourseModal = function() {
    try {
        const modal = document.getElementById('courseModal');
        if (!modal) {
            console.error('Course modal not found');
            if (typeof showNotification === 'function') {
                showNotification('Error: Course modal not found. Please refresh the page.', 'error');
            } else {
                alert('Error: Course modal not found. Please refresh the page.');
            }
            return;
        }
        
        modal.classList.remove('hidden');
        
        const modalTitle = document.getElementById('modalTitle');
        if (modalTitle) {
            modalTitle.textContent = 'Add New Course';
        }
        // In add mode: hide delete button, show "save & add another section"
        const deleteBtn = document.getElementById('deleteSectionBtn');
        if (deleteBtn) deleteBtn.classList.add('hidden');
        const saveAndAddLink = document.getElementById('saveAndAddSectionBtn');
        if (saveAndAddLink) saveAndAddLink.classList.remove('hidden');
        // Footer alignment for add mode: left link + right buttons
        const footer = document.getElementById('courseModalFooter');
        if (footer) {
            footer.classList.remove('justify-end');
            footer.classList.add('justify-between');
        }
        // Hide edit switcher in add mode
        const switcher = document.getElementById('editSectionSwitcher');
        const switcherSelect = document.getElementById('editSectionSelect');
        if (switcher) switcher.classList.add('hidden');
        if (switcherSelect) switcherSelect.innerHTML = '';
        
        const courseIdField = document.getElementById('course_id');
        if (courseIdField) {
            courseIdField.value = '';
        }
        
        const programField = document.getElementById('program');
        if (programField) {
            programField.value = '{{ program.id }}';
        }
        
        // Reset to default program mode
        if (typeof isOtherProgramsMode !== 'undefined') {
            isOtherProgramsMode = false;
        }
        const defaultInfo = document.getElementById('defaultProgramInfo');
        const otherSection = document.getElementById('otherProgramsSection');
        const toggleBtn = document.getElementById('toggleOtherProgramsBtn');
        if (defaultInfo) defaultInfo.classList.remove('hidden');
        if (otherSection) otherSection.classList.add('hidden');
        if (toggleBtn) {
            toggleBtn.classList.remove('hidden'); // Show for add mode
            toggleBtn.textContent = 'Add course to other program';
            toggleBtn.classList.remove('text-gray-600', 'hover:text-gray-800');
            toggleBtn.classList.add('text-blue-600', 'hover:text-blue-800');
        }
        
        // Reset department and program selects
        const departmentSelect = document.getElementById('department');
        const programSelect = document.getElementById('program_select');
        if (departmentSelect) departmentSelect.value = '';
        if (programSelect) {
            programSelect.value = '';
            programSelect.disabled = true;
        }
        
        // Try to restore saved data
        let restored = false;
        if (typeof loadFormData === 'function') {
            restored = loadFormData();
        }
        
        const sectionField = document.getElementById('section');
        if (sectionField) {
            sectionField.value = '';
        }
        
        // Reset firstSectionColor when opening modal for a new course
        if (typeof firstSectionColor !== 'undefined') {
            firstSectionColor = null;
        }
        
        if (!restored) {
            // No saved data, reset form
            const courseForm = document.getElementById('courseForm');
            if (courseForm) {
                courseForm.reset();
            }
            
            if (programField) {
                programField.value = '{{ program.id }}';
            }
            
            if (sectionField) {
                sectionField.value = '';
            }
            
            // Reset day schedules
            if (typeof addedDaySchedules !== 'undefined') {
                addedDaySchedules = [];
            }
            if (typeof updateDayScheduleList === 'function') {
                updateDayScheduleList();
            }
            const enableDaySchedules = document.getElementById('enable_day_schedules');
            if (enableDaySchedules) {
                enableDaySchedules.checked = false;
            }
            const container = document.getElementById('daySchedulesContainer');
            const defaultSection = document.getElementById('defaultScheduleSection');
            const defaultAttendanceSection = document.getElementById('defaultAttendanceSection');
            if (container) container.classList.add('hidden');
            if (defaultSection) defaultSection.classList.remove('hidden');
            if (defaultAttendanceSection) defaultAttendanceSection.classList.remove('hidden');
        }
        
        // Setup auto-save listeners
        if (typeof setupAutoSave === 'function') {
            setupAutoSave();
        }
    } catch (error) {
        console.error('Error opening add course modal:', error);
        if (typeof showNotification === 'function') {
            showNotification('Error opening course form. Please refresh the page and try again.', 'error');
        } else {
            alert('Error opening course form. Please refresh the page and try again.');
        }
    }
}

function closeCourseModal(clearSaved = false) {
    const modal = document.getElementById('courseModal');
    if (!modal) return;
    
        modal.classList.add('hidden');
    
    // Clear saved data if explicitly cancelled
    if (clearSaved) {
        clearFormData();
        document.getElementById('courseForm').reset();
        
        // Reset day schedules
        addedDaySchedules = [];
        updateDayScheduleList();
        const enableDaySchedules = document.getElementById('enable_day_schedules');
        if (enableDaySchedules) {
            enableDaySchedules.checked = false;
        }
        const container = document.getElementById('daySchedulesContainer');
        const defaultSection = document.getElementById('defaultScheduleSection');
        const defaultAttendanceSection = document.getElementById('defaultAttendanceSection');
        if (container) container.classList.add('hidden');
        if (defaultSection) defaultSection.classList.remove('hidden');
        if (defaultAttendanceSection) defaultAttendanceSection.classList.remove('hidden');
    }
}

function closeCourseFormIfOpen(clearSaved = false) {
    const courseModal = document.getElementById('courseModal');
    if (courseModal && !courseModal.classList.contains('hidden')) {
        closeCourseModal(clearSaved);
    }
}

function setupAutoSave() {
    const form = document.getElementById('courseForm');
    if (!form) return;
    
    // Add auto-save listeners to all form inputs
    const inputs = form.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
        // Remove existing listeners by cloning (if not already done)
        if (!input.hasAttribute('data-autosave-attached')) {
            input.setAttribute('data-autosave-attached', 'true');
            input.addEventListener('input', saveFormData);
            input.addEventListener('change', saveFormData);
        }
    });
    
    // Auto-save when day schedules checkbox changes (override existing listener)
    const enableDaySchedules = document.getElementById('enable_day_schedules');
    if (enableDaySchedules) {
        // Remove old listener if exists
        const newCheckbox = enableDaySchedules.cloneNode(true);
        enableDaySchedules.parentNode.replaceChild(newCheckbox, enableDaySchedules);
        
        // Re-attach with auto-save
        newCheckbox.addEventListener('change', function() {
            saveFormData();
            // Animate the day schedules container
            const container = document.getElementById('daySchedulesContainer');
            const defaultSection = document.getElementById('defaultScheduleSection');
            const defaultAttendanceSection = document.getElementById('defaultAttendanceSection');
            
            if (this.checked) {
                container.classList.remove('hidden');
                defaultSection.classList.add('hidden');
                if (defaultAttendanceSection) defaultAttendanceSection.classList.add('hidden');
                addedDaySchedules = [];
                updateDayScheduleList();
            } else {
                container.classList.add('hidden');
                defaultSection.classList.remove('hidden');
                if (defaultAttendanceSection) defaultAttendanceSection.classList.remove('hidden');
                addedDaySchedules = [];
                updateDayScheduleList();
            }
        });
    }
}

// Store added day schedules
let addedDaySchedules = [];
// Track which day is being edited (original day key)
let currentEditingDay = null;

// Update days hidden field from checkboxes or added schedules
function updateDaysFromCheckboxes() {
    const enableDaySchedules = document.getElementById('enable_day_schedules');
    if (enableDaySchedules && enableDaySchedules.checked) {
        // Use added day schedules
        const days = addedDaySchedules.map(s => s.day).join(',');
        document.getElementById('days').value = days;
    } else {
        // Use checkboxes
        const checkboxes = document.querySelectorAll('.day-checkbox:checked');
        const days = Array.from(checkboxes).map(cb => cb.value).join(',');
        document.getElementById('days').value = days;
    }
}

// Add day schedule to the list
function addDaySchedule() {
    const selectedDay = document.querySelector('.day-radio:checked');
    if (!selectedDay) {
        if (typeof showNotification === 'function') {
            showNotification('Please select a day first', 'warning');
        } else {
            alert('Please select a day first');
        }
        return;
    }
    
    const day = selectedDay.value;
    const startTime = document.getElementById('day_start_time').value;
    const endTime = document.getElementById('day_end_time').value;
    const room = document.getElementById('day_room').value;
    
    if (!startTime || !endTime) {
        if (typeof showNotification === 'function') {
            showNotification('Please set start and end time', 'warning');
        } else {
            alert('Please set start and end time');
        }
        return;
    }
    
    // If we are editing an existing day and the day was changed, move/update instead of creating duplicate
    let isUpdate = false;
    const newEntry = { day, startTime, endTime, room };
    if (currentEditingDay && currentEditingDay !== day) {
        const originalIndex = addedDaySchedules.findIndex(s => s.day === currentEditingDay);
        const targetIndex = addedDaySchedules.findIndex(s => s.day === day);
        if (originalIndex !== -1) {
            if (targetIndex !== -1 && targetIndex !== originalIndex) {
                // Replace target with new values and remove original to avoid duplicates
                addedDaySchedules[targetIndex] = newEntry;
                addedDaySchedules.splice(originalIndex, 1);
            } else {
                // Simply update original entry's day and values
                addedDaySchedules[originalIndex] = newEntry;
            }
            isUpdate = true;
            if (typeof showNotification === 'function') {
                showNotification('Day schedule updated successfully!', 'success');
            }
        } else {
            // Fallback if original not found, behave like normal add/update
            const existingIndex = addedDaySchedules.findIndex(s => s.day === day);
    if (existingIndex !== -1) {
                addedDaySchedules[existingIndex] = newEntry;
        isUpdate = true;
        if (typeof showNotification === 'function') {
            showNotification('Day schedule updated successfully!', 'success');
        }
    } else {
                addedDaySchedules.push(newEntry);
        if (typeof showNotification === 'function') {
            showNotification('Day schedule added successfully!', 'success');
                }
            }
        }
    } else {
        // Normal path: update if existing, otherwise add new
        const existingIndex = addedDaySchedules.findIndex(s => s.day === day);
        if (existingIndex !== -1) {
            addedDaySchedules[existingIndex] = newEntry;
            isUpdate = true;
            if (typeof showNotification === 'function') {
                showNotification('Day schedule updated successfully!', 'success');
            }
        } else {
            addedDaySchedules.push(newEntry);
            if (typeof showNotification === 'function') {
                showNotification('Day schedule added successfully!', 'success');
            }
        }
    }
    
    updateDayScheduleList();
    
    // Auto-save day schedules
    saveFormData();
    
    // Clear editing state after operation
    currentEditingDay = null;
    // Clear inputs and reset radio (only if it was a new addition, not an update)
    if (!isUpdate) {
        document.getElementById('day_start_time').value = '';
        document.getElementById('day_end_time').value = '';
        document.getElementById('day_room').value = '';
        selectedDay.checked = false;
        updateDayRadioButtons();
    }
}

// Remove day schedule - open confirmation modal
function removeDaySchedule(day) {
    console.log('removeDaySchedule called with day:', day);
    console.log('Current addedDaySchedules:', addedDaySchedules);
    
    // Handle both day codes and full day names
    const dayMap = {
        'Mon': 'Mon', 'Monday': 'Mon',
        'Tue': 'Tue', 'Tuesday': 'Tue',
        'Wed': 'Wed', 'Wednesday': 'Wed',
        'Thu': 'Thu', 'Thursday': 'Thu',
        'Fri': 'Fri', 'Friday': 'Fri',
        'Sat': 'Sat', 'Saturday': 'Sat',
        'Sun': 'Sun', 'Sunday': 'Sun'
    };
    
    const dayCode = dayMap[day] || day;
    const schedule = addedDaySchedules.find(s => s.day === dayCode || s.day === day);
    
    if (!schedule) {
        console.error('Schedule not found for day:', day, 'dayCode:', dayCode);
        if (typeof showNotification === 'function') {
            showNotification('Day schedule not found. Please try again.', 'error');
        } else {
            alert('Day schedule not found. Please try again.');
        }
        return;
    }
    
    const dayNames = {
        'Mon': 'Monday',
        'Tue': 'Tuesday',
        'Wed': 'Wednesday',
        'Thu': 'Thursday',
        'Fri': 'Friday',
        'Sat': 'Saturday',
        'Sun': 'Sunday'
    };
    
    const displayDay = dayNames[dayCode] || dayCode;
    document.getElementById('delete-day-schedule-day').value = dayCode;
    document.getElementById('delete-day-schedule-info').textContent = `${displayDay}: ${schedule.startTime} - ${schedule.endTime}${schedule.room ? ' in ' + schedule.room : ''}`;
    const modal = document.getElementById('deleteDayScheduleModal');
    modal.classList.remove('hidden');
}

// Close delete day schedule modal
function closeDeleteDayScheduleModal() {
    const modal = document.getElementById('deleteDayScheduleModal');
    setTimeout(() => {
        modal.classList.add('hidden');
    }, 150);
}

// Confirm delete day schedule
function confirmDeleteDaySchedule() {
    const day = document.getElementById('delete-day-schedule-day').value;
    console.log('confirmDeleteDaySchedule - removing day:', day);
    console.log('Before removal - addedDaySchedules:', addedDaySchedules);
    
    // Handle both day codes and full day names
    const dayMap = {
        'Mon': 'Mon', 'Monday': 'Mon',
        'Tue': 'Tue', 'Tuesday': 'Tue',
        'Wed': 'Wed', 'Wednesday': 'Wed',
        'Thu': 'Thu', 'Thursday': 'Thu',
        'Fri': 'Fri', 'Friday': 'Fri',
        'Sat': 'Sat', 'Saturday': 'Sat',
        'Sun': 'Sun', 'Sunday': 'Sun'
    };
    
    const dayCode = dayMap[day] || day;
    
    // Remove schedule matching either the day code or the original day value
    const beforeCount = addedDaySchedules.length;
    addedDaySchedules = addedDaySchedules.filter(s => s.day !== dayCode && s.day !== day);
    const afterCount = addedDaySchedules.length;
    
    console.log('After removal - addedDaySchedules:', addedDaySchedules);
    console.log('Removed count:', beforeCount - afterCount);
    
    if (beforeCount === afterCount) {
        console.error('No schedule was removed!');
        if (typeof showNotification === 'function') {
            showNotification('Failed to remove day schedule. Please try again.', 'error');
        } else {
            alert('Failed to remove day schedule. Please try again.');
        }
        return;
    }
    
    updateDayScheduleList();
    updateDaysFromCheckboxes();
    closeDeleteDayScheduleModal();
    
    // Auto-save after removing day schedule
    saveFormData();
    
    if (typeof showNotification === 'function') {
        showNotification('Day schedule removed successfully!', 'success');
    }
    
    // If we deleted the day we were editing, clear editing state
    if (currentEditingDay === day) {
        currentEditingDay = null;
    }
}

// Load a day schedule into the form fields for editing
function loadDayScheduleToForm(schedule) {
    // Helper to convert 12-hour to 24-hour for HTML time inputs
    const convertTo24Hour = (time12) => {
        if (!time12) return '';
        // If already in 24-hour format (HH:MM), return as is
        if (/^\d{2}:\d{2}$/.test(time12)) return time12;
        // If in 12-hour format, convert
        const timeParts = time12.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);
        if (timeParts) {
            let hours = parseInt(timeParts[1]);
            const minutes = timeParts[2];
            if (timeParts[3].toUpperCase() === 'PM' && hours !== 12) hours += 12;
            if (timeParts[3].toUpperCase() === 'AM' && hours === 12) hours = 0;
            return `${hours.toString().padStart(2, '0')}:${minutes}`;
        }
        return time12.substring(0, 5);
    };
    
    // Track which day we are editing (original day key)
    currentEditingDay = schedule.day;
    // Select the day radio button
    const dayRadio = document.querySelector(`input.day-radio[value="${schedule.day}"]`);
    if (dayRadio) {
        dayRadio.checked = true;
        updateDayRadioButtons();
    }
    
    // Load times into form fields
    document.getElementById('day_start_time').value = convertTo24Hour(schedule.startTime);
    document.getElementById('day_end_time').value = convertTo24Hour(schedule.endTime);
    document.getElementById('day_room').value = schedule.room || '';
    
    // Scroll to the form section
    const formSection = document.getElementById('daySchedulesContainer');
    if (formSection) {
        formSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}

// Update the day schedule list display
function updateDayScheduleList() {
    const tbody = document.getElementById('dayScheduleList');
    const dayNames = {
        'Mon': 'Monday',
        'Tue': 'Tuesday',
        'Wed': 'Wednesday',
        'Thu': 'Thursday',
        'Fri': 'Friday',
        'Sat': 'Saturday',
        'Sun': 'Sunday'
    };
    
    tbody.innerHTML = '';
    
    if (addedDaySchedules.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                No day schedules added yet. Select a day, set time, and click "Add Day Schedule".
            </td>
        `;
        tbody.appendChild(row);
    } else {
        // Helper function to convert 24-hour to 12-hour format for display
        const formatTimeDisplay = (time24) => {
            if (!time24) return 'Not set';
            // If already in 12-hour format, return as is
            if (time24.includes('AM') || time24.includes('PM')) return time24;
            // Convert from 24-hour (HH:MM) to 12-hour (HH:MM AM/PM)
            const [hours, minutes] = time24.split(':').map(Number);
            const period = hours >= 12 ? 'PM' : 'AM';
            const hour12 = hours % 12 || 12;
            return `${hour12}:${minutes.toString().padStart(2, '0')} ${period.toLowerCase()}`;
        };
        
        // Sort schedules by day order
        const dayOrder = { 'Mon': 1, 'Tue': 2, 'Wed': 3, 'Thu': 4, 'Fri': 5, 'Sat': 6, 'Sun': 7 };
        const sortedSchedules = [...addedDaySchedules].sort((a, b) => (dayOrder[a.day] || 99) - (dayOrder[b.day] || 99));
        
        sortedSchedules.forEach(schedule => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-blue-50 transition-colors cursor-pointer';
            row.setAttribute('data-day', schedule.day);
            row.setAttribute('data-schedule', JSON.stringify(schedule));
            row.title = 'Click to edit this day schedule';
            
            row.innerHTML = `
                <td class="px-3 py-1.5 whitespace-nowrap">
                    <div class="flex items-center gap-2">
                        <div class="flex items-center justify-center w-8 h-8 rounded-full bg-blue-600 text-white text-xs font-semibold flex-shrink-0">
                            ${schedule.day}
                        </div>
                        <span class="text-xs font-medium text-gray-900">${dayNames[schedule.day]}</span>
                    </div>
                </td>
                <td class="px-3 py-1.5 whitespace-nowrap text-xs text-gray-900 font-medium">
                    ${formatTimeDisplay(schedule.startTime)}
                </td>
                <td class="px-3 py-1.5 whitespace-nowrap text-xs text-gray-900 font-medium">
                    ${formatTimeDisplay(schedule.endTime)}
                </td>
                <td class="px-3 py-1.5 whitespace-nowrap text-xs text-gray-700">
                    <span class="flex items-center">
                        <i class="fas fa-map-marker-alt mr-1 text-gray-400 text-xs"></i>
                        ${schedule.room && schedule.room.trim() ? schedule.room : 'Not specified'}
                    </span>
                </td>
                <td class="px-3 py-1.5 whitespace-nowrap text-center">
                    <button type="button" data-day="${schedule.day}" class="remove-day-schedule-btn px-2 py-1 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-150 shadow-sm hover:shadow-md text-xs font-semibold" title="Remove this day schedule" onclick="event.stopPropagation(); removeDaySchedule('${schedule.day}');">
                        <i class="fas fa-trash mr-1"></i> Remove
                    </button>
                </td>
            `;
            
            // Add click handler to load schedule into form
            row.addEventListener('click', function(e) {
                if (e.target.closest('.remove-day-schedule-btn')) return; // Don't trigger on remove button
                loadDayScheduleToForm(schedule);
            });
            
            tbody.appendChild(row);
        });
    }
    
    updateDaysFromCheckboxes();
}

// Update day radio button appearance
function updateDayRadioButtons() {
    document.querySelectorAll('.day-button-single').forEach(button => {
        const radio = button.querySelector('.day-radio');
        if (radio && radio.checked) {
            button.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
            button.classList.remove('bg-white', 'text-gray-700', 'border-gray-300');
        } else {
            button.classList.remove('bg-blue-600', 'text-white', 'border-blue-600');
            button.classList.add('bg-white', 'text-gray-700', 'border-gray-300');
        }
    });
}

// Initialize day buttons
document.addEventListener('DOMContentLoaded', function() {
    // Add event delegation for remove day schedule buttons (once, at page load)
    document.addEventListener('click', function(e) {
        const removeBtn = e.target.closest('.remove-day-schedule-btn');
        if (removeBtn) {
            e.preventDefault();
            e.stopPropagation();
            const day = removeBtn.getAttribute('data-day');
            if (day) {
                removeDaySchedule(day);
            }
        }
    });
    
    // Add event delegation for editing day schedule inputs
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('edit-day-schedule-input')) {
            const day = e.target.getAttribute('data-day');
            const field = e.target.getAttribute('data-field');
            const value = e.target.value;
            
            const schedule = addedDaySchedules.find(s => s.day === day);
            if (schedule) {
                schedule[field] = value;
                console.log(`Updated ${field} for ${day}:`, value);
            }
        }
    });
    
    // Handle multi-select day button clicks (for default schedule)
    const dayButtonsMulti = document.querySelectorAll('.day-button-multi');
    dayButtonsMulti.forEach(button => {
        button.addEventListener('click', function() {
            const checkbox = this.querySelector('.day-checkbox');
            const isChecked = checkbox.checked;
            
            checkbox.checked = !isChecked;
            
            if (checkbox.checked) {
                this.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
                this.classList.remove('bg-white', 'text-gray-700', 'border-gray-300');
            } else {
                this.classList.remove('bg-blue-600', 'text-white', 'border-blue-600');
                this.classList.add('bg-white', 'text-gray-700', 'border-gray-300');
            }
            
            updateDaysFromCheckboxes();
        });
    });
    
    // Handle single-select day button clicks (for different schedules)
    const dayButtonsSingle = document.querySelectorAll('.day-button-single');
    dayButtonsSingle.forEach(button => {
        button.addEventListener('click', function() {
            const radio = this.querySelector('.day-radio');
            document.querySelectorAll('.day-radio').forEach(r => r.checked = false);
            radio.checked = true;
            updateDayRadioButtons();
        });
    });
    
    // Toggle day-specific schedules (this will be overridden by setupAutoSave, but kept for initial setup)
    const enableDaySchedules = document.getElementById('enable_day_schedules');
    if (enableDaySchedules && !enableDaySchedules.hasAttribute('data-listener-attached')) {
        enableDaySchedules.setAttribute('data-listener-attached', 'true');
        enableDaySchedules.addEventListener('change', function() {
            saveFormData();
            const container = document.getElementById('daySchedulesContainer');
            const defaultSection = document.getElementById('defaultScheduleSection');
            const defaultAttendanceSection = document.getElementById('defaultAttendanceSection');
            if (this.checked) {
                container.classList.remove('hidden');
                defaultSection.classList.add('hidden');
                if (defaultAttendanceSection) defaultAttendanceSection.classList.add('hidden');
                addedDaySchedules = [];
                updateDayScheduleList();
            } else {
                container.classList.add('hidden');
                defaultSection.classList.remove('hidden');
                if (defaultAttendanceSection) defaultAttendanceSection.classList.remove('hidden');
                addedDaySchedules = [];
                updateDayScheduleList();
            }
        });
    }
    
    // Sync color picker with text field
    const colorPicker = document.getElementById('color');
    const colorText = document.getElementById('color_text');
    if (colorPicker && colorText) {
        colorPicker.addEventListener('input', function() {
        colorText.value = this.value.toUpperCase();
        highlightColorSwatch(this.value);
        });
    }
    
    updateDayScheduleList();
    
    // Flow flag for saving and continuing for another section
    let saveForAnotherSection = false;
    // Store the first section's color to use for all subsequent sections
    let firstSectionColor = null;
    
    // Handle "Save & add sched to other sections" click
    const saveAndAddSectionBtn = document.getElementById('saveAndAddSectionBtn');
    if (saveAndAddSectionBtn) {
        saveAndAddSectionBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            // Ensure section is provided for this flow
            const sectionInput = document.getElementById('section');
            if (!sectionInput || !sectionInput.value.trim()) {
                if (typeof showNotification === 'function') {
                    showNotification('Please enter a Section before saving for other sections.', 'error');
                } else {
                    alert('Please enter a Section before saving for other sections.');
                }
                return;
            }
            saveForAnotherSection = true;
            // Trigger the same submit logic
            const courseForm = document.getElementById('courseForm');
            if (courseForm) {
                courseForm.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
            }
        });
    }
    
    // Handle form submission
    const courseForm = document.getElementById('courseForm');
    if (courseForm) {
        courseForm.addEventListener('submit', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('Form submission triggered');
            
            // Skip HTML5 validation - we'll do custom validation
            // if (!this.checkValidity()) {
            //     console.log('Form validation failed');
            //     this.reportValidity();
            //     return;
            // }
            
            console.log('Form validation passed (skipped HTML5 validation)');
            
            const formData = new FormData(this);
            const courseId = formData.get('course_id');
            
            // If in "other programs" mode, validate and use selected program
            if (isOtherProgramsMode) {
                const departmentSelect = document.getElementById('department');
                const programSelect = document.getElementById('program_select');
                
                if (!departmentSelect.value || !programSelect.value) {
                    if (typeof showNotification === 'function') {
                        showNotification('Please select both Department and Program.', 'error');
                    } else {
                        alert('Please select both Department and Program.');
                    }
                    return;
                }
                
                // Use selected program from dropdown
                formData.set('program', programSelect.value);
            }
            
            // Show loading state first (before any validation that might return early)
            const submitButton = document.getElementById('submitButton');
            const originalText = submitButton ? submitButton.innerHTML : '';
            if (submitButton) {
                submitButton.disabled = true;
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Saving...';
            }
            
            // Check if day schedules are enabled
            const enableDaySchedules = document.getElementById('enable_day_schedules');
            if (enableDaySchedules && enableDaySchedules.checked) {
                console.log('Day schedules enabled, checking addedDaySchedules:', addedDaySchedules);
                // When day schedules are enabled, use them
                if (!addedDaySchedules || addedDaySchedules.length === 0) {
                    console.error('No day schedules added');
                    if (typeof showNotification === 'function') {
                        showNotification('Please add at least one day schedule.', 'error');
                    } else {
                        alert('Please add at least one day schedule.');
                    }
                    // Restore button
                    if (submitButton) {
                        submitButton.disabled = false;
                        submitButton.innerHTML = originalText;
                    }
                    return;
                }
                
                // Set days from day schedules (ensure it's a comma-separated string)
                const daysFromSchedules = addedDaySchedules.map(s => s.day).join(',');
                if (!daysFromSchedules || daysFromSchedules.trim() === '') {
                    console.error('Days from schedules is empty');
                    if (typeof showNotification === 'function') {
                        showNotification('Please add at least one day schedule.', 'error');
                    } else {
                        alert('Please add at least one day schedule.');
                    }
                    // Restore button
                    if (submitButton) {
                        submitButton.disabled = false;
                        submitButton.innerHTML = originalText;
                    }
                    return;
                }
                formData.set('days', daysFromSchedules);
                
                // Set default start_time and end_time from first schedule (required by backend)
                if (addedDaySchedules.length > 0) {
                    const firstSchedule = addedDaySchedules[0];
                    console.log('First schedule:', firstSchedule);
                    if (!firstSchedule.startTime || !firstSchedule.endTime) {
                        console.error('First schedule missing times:', firstSchedule);
                        if (typeof showNotification === 'function') {
                            showNotification('Please set start and end times for all day schedules.', 'error');
                        } else {
                            alert('Please set start and end times for all day schedules.');
                        }
                        // Restore button
                        if (submitButton) {
                            submitButton.disabled = false;
                            submitButton.innerHTML = originalText;
                        }
                        return;
                    }
                    // Times from time inputs are already in HH:MM format (24-hour)
                    formData.set('start_time', firstSchedule.startTime);
                    formData.set('end_time', firstSchedule.endTime);
                    console.log('Set start_time:', firstSchedule.startTime, 'end_time:', firstSchedule.endTime);
                }
                
                // Add day schedules
                formData.append('day_schedules', JSON.stringify(addedDaySchedules));
                console.log('Day schedules being sent:', addedDaySchedules);
                console.log('Day schedules JSON:', JSON.stringify(addedDaySchedules));
                console.log('Days from schedules:', daysFromSchedules);
                console.log('Start time from first schedule:', addedDaySchedules[0]?.startTime);
                console.log('End time from first schedule:', addedDaySchedules[0]?.endTime);
            } else {
                // When using default schedule, validate days field
                updateDaysFromCheckboxes();
                const daysValue = document.getElementById('days').value;
                if (!daysValue || daysValue.trim() === '') {
                    if (typeof showNotification === 'function') {
                        showNotification('Please select at least one day for the course.', 'error');
                    } else {
                        alert('Please select at least one day for the course.');
                    }
                    // Restore button
                    if (submitButton) {
                        submitButton.disabled = false;
                        submitButton.innerHTML = originalText;
                    }
                    return;
                }
            }
            
            // Check if day schedules are enabled (reuse the variable already declared above)
            const isDaySchedulesMode = enableDaySchedules && enableDaySchedules.checked;
            
            // Ensure all required fields are present
            // Section is optional - students will fill it during enrollment
            const requiredFields = ['code', 'name', 'program', 'year_level', 'school_year'];
            
            // Only require days/start_time/end_time if NOT using day schedules
            if (!isDaySchedulesMode) {
                requiredFields.push('days', 'start_time', 'end_time');
            }
            
            const missingFields = [];
            const fieldValues = {};
            for (const field of requiredFields) {
                const value = formData.get(field);
                fieldValues[field] = value;
                if (!value || (typeof value === 'string' && value.trim() === '')) {
                    missingFields.push(field);
                }
            }
            
            // If using day schedules, validate that schedules are present
            if (isDaySchedulesMode) {
                const daySchedulesValue = formData.get('day_schedules');
                if (!daySchedulesValue) {
                    missingFields.push('day_schedules');
                } else {
                    try {
                        const schedules = JSON.parse(daySchedulesValue);
                        if (!schedules || schedules.length === 0) {
                            missingFields.push('day_schedules');
                        }
                    } catch (e) {
                        missingFields.push('day_schedules');
                    }
                }
            }
            
            console.log('All field values before submission:', fieldValues);
            console.log('Missing fields:', missingFields);
            console.log('Day schedules mode:', isDaySchedulesMode);
            
            if (missingFields.length > 0) {
                console.error('Missing required fields:', missingFields);
                console.error('Field values:', fieldValues);
                let errorMessage = 'Please fill in all required fields: ' + missingFields.join(', ');
                if (isDaySchedulesMode && missingFields.includes('day_schedules')) {
                    errorMessage = 'Please add at least one day schedule.';
                }
                if (typeof showNotification === 'function') {
                    showNotification(errorMessage, 'error');
                } else {
                    alert(errorMessage);
                }
                // Restore button
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalText;
                }
                return;
            }
            
            const url = courseId ? 
                '{% url "dashboard:instructor_update_course" 0 %}'.replace('0', courseId) :
                '{% url "dashboard:instructor_add_course" %}';
            
            console.log('Submitting to URL:', url);
            console.log('Course ID:', courseId);
            
            // Get CSRF token from form or cookie
            let csrfToken = '{{ csrf_token }}';
            const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
            if (csrfInput) {
                csrfToken = csrfInput.value;
                console.log('CSRF token from form input');
            } else {
                // Fallback: get from cookie
                const name = 'csrftoken';
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    const [key, value] = cookie.trim().split('=');
                    if (key === name) {
                        csrfToken = value;
                        console.log('CSRF token from cookie');
                        break;
                    }
                }
            }
            
            console.log('FormData entries:');
            for (let pair of formData.entries()) {
                console.log(pair[0] + ': ' + pair[1]);
            }
            
            fetch(url, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => {
                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);
                if (!response.ok) {
                    return response.text().then(text => {
                        console.error('Response error text:', text);
                        console.error('Response status:', response.status);
                        // Try to parse as JSON if possible
                        try {
                            const errorData = JSON.parse(text);
                            throw new Error(errorData.message || 'Network response was not ok: ' + response.status);
                        } catch (e) {
                            if (e.message) throw e;
                            throw new Error('Network response was not ok: ' + response.status + '. ' + text.substring(0, 200));
                        }
                    });
                }
                return response.json().catch(e => {
                    console.error('Error parsing JSON response:', e);
                    return response.text().then(text => {
                        console.error('Response text:', text);
                        throw new Error('Invalid JSON response from server: ' + text.substring(0, 200));
                    });
                });
            })
            .then(data => {
                console.log('Response data:', data);
                if (data && data.success) {
                    // Store the first section's color if this is the first section
                    const colorInput = document.getElementById('color');
                    if (colorInput && firstSectionColor === null) {
                        firstSectionColor = colorInput.value || '#3C4770';
                    }
                    
                    // If saving to continue adding schedules for other sections
                    // Check if saveForAnotherSection is explicitly true (only set by the button click)
                    if (saveForAnotherSection === true) {
                        // Keep modal open, reset only section + schedule/attendance/display
                        try {
                            resetFieldsForNextSection();
                            if (typeof showNotification === 'function') {
                                showNotification('Saved. Now add schedule for another section.', 'success');
                            } else {
                                alert('Saved. Now add schedule for another section.');
                            }
                        } finally {
                            saveForAnotherSection = false;
                            // Restore submit button
                            if (submitButton) {
                                submitButton.disabled = false;
                                submitButton.innerHTML = originalText;
                            }
                        }
                    } else {
                        // Normal flow: clear, close, and refresh list
                    // Clear saved form data on successful save
                    clearFormData();
                    
                    // Reset firstSectionColor when closing modal (all sections are done)
                    firstSectionColor = null;
                    
                    // Signal that a course was added - this will trigger timetable refresh
                    try {
                        localStorage.setItem('course_added', Date.now().toString());
                        // Also trigger storage event for same-tab listening
                        window.dispatchEvent(new StorageEvent('storage', {
                            key: 'course_added',
                            newValue: Date.now().toString()
                        }));
                    } catch (e) {
                        console.warn('Could not save course_added flag:', e);
                    }
                    
                    if (typeof showNotification === 'function') {
                        showNotification(data.message || 'Course saved successfully!', 'success');
                    } else {
                        alert(data.message || 'Course saved successfully!');
                    }
                    closeCourseModal(true);
                    // Save folder state before reload
                    saveFolderState();
                    // Reload the current page to show the new course in the list
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                    }
                } else {
                    console.error('Save failed:', data);
                    const errorMsg = (data && data.message) ? data.message : 'Error saving course. Please check the console for details.';
                    if (typeof showNotification === 'function') {
                        showNotification(errorMsg, 'error');
                    } else {
                        alert(errorMsg);
                    }
                    // Restore button
                    if (submitButton) {
                        submitButton.disabled = false;
                        submitButton.innerHTML = originalText;
                    }
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                console.error('Error name:', error.name);
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);
                const errorMsg = error.message || 'An error occurred while saving the course. Please check the console for details.';
                if (typeof showNotification === 'function') {
                    showNotification(errorMsg, 'error');
                } else {
                    alert(errorMsg);
                }
                // Restore button
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalText;
                }
            });
        });
    } else {
        console.error('Course form not found!');
    }
});

document.addEventListener('DOMContentLoaded', function() {
    const courseSectionField = document.getElementById('section');
    if (courseSectionField) {
        courseSectionField.addEventListener('input', function(e) {
            e.target.value = e.target.value.toUpperCase();
        });
    }
    // Apply multi-stop gradients from data attribute to avoid inline CSS parsing issues
    document.querySelectorAll('.course-card-block[data-gradient]').forEach(el => {
        const grad = el.getAttribute('data-gradient');
        if (grad && grad.includes('linear-gradient')) {
            el.style.background = grad;
        }
    });
    
    // Generate twinkling stars for multi-section course cards
    (function initStars() {
        const STAR_COUNT_DEFAULT = 60;
        const EDGE_BIAS_CHANCE = 0.7; // 70% near edges
        const EDGE_ZONE = 0.12; // 12% of width/height
        
        function createStar(container) {
            const rect = container.getBoundingClientRect();
            const width = rect.width || container.clientWidth || 200;
            const height = rect.height || container.clientHeight || 140;
            
            const star = document.createElement('div');
            star.className = 'star-dot';
            
            // Size: 1px to 4px
            const size = Math.random() * 3 + 1;
            star.style.width = `${size}px`;
            star.style.height = `${size}px`;
            
            // Edge-biased position
            let x, y;
            if (Math.random() < EDGE_BIAS_CHANCE) {
                // Choose axis: 0 vertical edges, 1 horizontal edges
                if (Math.floor(Math.random() * 2) === 0) {
                    // Top or bottom band
                    const band = Math.random() < 0.5 ? EDGE_ZONE : (1 - EDGE_ZONE);
                    y = band * height + (Math.random() - 0.5) * EDGE_ZONE * height;
                    y = Math.max(0, Math.min(height, y));
                    x = Math.random() * width;
                } else {
                    // Left or right band
                    const band = Math.random() < 0.5 ? EDGE_ZONE : (1 - EDGE_ZONE);
                    x = band * width + (Math.random() - 0.5) * EDGE_ZONE * width;
                    x = Math.max(0, Math.min(width, x));
                    y = Math.random() * height;
                }
            } else {
                // Uniform placement
                x = Math.random() * width;
                y = Math.random() * height;
            }
            star.style.left = `${x}px`;
            star.style.top = `${y}px`;
            
            // Duration: 2s to 6s
            const duration = Math.random() * 4 + 2;
            star.style.animationDuration = `${duration}s`;
            // Negative delay to desync
            const delay = Math.random() * duration * -1;
            star.style.animationDelay = `${delay}s`;
            
            container.appendChild(star);
        }
        
        document.querySelectorAll('.multi-stars-field').forEach(field => {
            const countAttr = parseInt(field.getAttribute('data-star-count') || `${STAR_COUNT_DEFAULT}`, 10);
            const count = isNaN(countAttr) ? STAR_COUNT_DEFAULT : Math.max(20, Math.min(150, countAttr));
            for (let i = 0; i < count; i++) {
                createStar(field);
            }
        });
    })();
});

function resetFieldsForNextSection() {
    try {
        // Section
        const sectionField = document.getElementById('section');
        if (sectionField) sectionField.value = '';
        
        // Default schedule fields
        const startTimeInput = document.getElementById('start_time');
        const endTimeInput = document.getElementById('end_time');
        const roomInput = document.getElementById('room');
        const daysHidden = document.getElementById('days');
        if (startTimeInput) startTimeInput.value = '';
        if (endTimeInput) endTimeInput.value = '';
        if (roomInput) roomInput.value = '';
        if (daysHidden) daysHidden.value = '';
        
        // Unselect multi-day buttons
        document.querySelectorAll('.day-button-multi').forEach(btn => {
            btn.classList.remove('bg-blue-600', 'text-white', 'border-blue-600');
            btn.classList.add('bg-white', 'text-gray-700', 'border-gray-300');
            const cb = btn.querySelector('.day-checkbox');
            if (cb) cb.checked = false;
        });
        
        // Attendance window
        const attStart = document.getElementById('attendance_start');
        const attEnd = document.getElementById('attendance_end');
        if (attStart) attStart.value = '';
        if (attEnd) attEnd.value = '';
        
        // Per-day schedules (clear and hide)
        const enableDay = document.getElementById('enable_day_schedules');
        const dayContainer = document.getElementById('daySchedulesContainer');
        const defaultSection = document.getElementById('defaultScheduleSection');
        const defaultAttendance = document.getElementById('defaultAttendanceSection');
        if (enableDay) enableDay.checked = false;
        if (dayContainer) dayContainer.classList.add('hidden');
        if (defaultSection) defaultSection.classList.remove('hidden');
        if (defaultAttendance) defaultAttendance.classList.remove('hidden');
        if (typeof addedDaySchedules !== 'undefined') {
            addedDaySchedules = [];
        }
        if (typeof updateDayScheduleList === 'function') {
            updateDayScheduleList();
        }
        
        // Instructor & Display (preserve first section's color for subsequent sections)
        // Use the stored first section color if available, otherwise use default
        const colorToUse = (typeof firstSectionColor !== 'undefined' && firstSectionColor !== null) ? firstSectionColor : '#3C4770';
        if (typeof setCourseColor === 'function') {
            setCourseColor(colorToUse);
        } else {
            const colorInput = document.getElementById('color');
            const colorText = document.getElementById('color_text');
            if (colorInput) colorInput.value = colorToUse;
            if (colorText) colorText.value = colorToUse;
        }
        if (typeof highlightColorSwatch === 'function') {
            highlightColorSwatch(colorToUse);
        }
        
        // Keep Course Information and Academic Details intact
    } catch (e) {
        console.error('Error resetting fields for next section:', e);
    }
}
function formatOrdinalYear(value) {
    const numericValue = parseInt(value, 10);
    if (isNaN(numericValue)) {
        return value || 'N/A';
    }
    const mod100 = numericValue % 100;
    let suffix = 'th';
    if (mod100 < 11 || mod100 > 13) {
        suffix = {1: 'st', 2: 'nd', 3: 'rd'}[numericValue % 10] || 'th';
    }
    return `${numericValue}${suffix} Year`;
}

function deleteCurrentSection(courseId) {
    try {
        // Ensure courseId is a number
        const courseIdNum = parseInt(courseId, 10);
        if (isNaN(courseIdNum) || courseIdNum <= 0) {
            console.error('Invalid course ID provided:', courseId);
            if (typeof showNotification === 'function') {
                showNotification('Invalid course ID. Cannot delete section.', 'error');
            } else {
                alert('Invalid course ID. Cannot delete section.');
            }
            return;
        }
        
        console.log('=== DELETING SPECIFIC SECTION ONLY ===');
        console.log('Course ID to delete:', courseIdNum);
        console.log('This will ONLY delete this specific section ID, NOT other sections.');
        console.log('Backend will verify sibling sections remain intact.');
        
        if (!confirm('Delete this SPECIFIC section only? Other sections of this course will remain intact. This action cannot be undone.')) {
            return;
        }
        
        const url = '{% url "dashboard:instructor_delete_course" 0 %}'.replace('0', courseIdNum.toString());
        console.log('Delete URL (specific section only):', url);
        
        // CSRF
        let csrfToken = '{{ csrf_token }}';
        const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfInput) csrfToken = csrfInput.value;
        
        fetch(url, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken },
        }).then(resp => {
            console.log('Delete response status:', resp.status);
            return resp.json();
        })
        .then(data => {
            console.log('Delete response data:', data);
            if (data && data.success) {
                if (typeof showNotification === 'function') {
                    showNotification(data.message || 'Section deleted successfully. Other sections remain intact.', 'success');
                }
                // Save folder UI state then reload
                if (typeof saveFolderState === 'function') saveFolderState();
                closeCourseModal(true);
                setTimeout(() => window.location.reload(), 600);
            } else {
                const msg = (data && data.message) ? data.message : 'Failed to delete section.';
                console.error('Delete failed:', msg);
                if (typeof showNotification === 'function') {
                    showNotification(msg, 'error');
                } else {
                    alert(msg);
                }
            }
        }).catch(err => {
            console.error('Delete request error:', err);
            if (typeof showNotification === 'function') {
                showNotification('Error deleting section. Please try again.', 'error');
            } else {
                alert('Error deleting section. Please try again.');
            }
        });
    } catch (e) {
        console.error('deleteCurrentSection error:', e);
        if (typeof showNotification === 'function') {
            showNotification('An error occurred while deleting the section.', 'error');
        } else {
            alert('An error occurred while deleting the section.');
        }
    }
}

function openDeleteSectionModal(courseId) {
    try {
        // Ensure courseId is a valid number
        const courseIdNum = parseInt(courseId, 10);
        if (isNaN(courseIdNum) || courseIdNum <= 0) {
            console.error('Invalid course ID provided to delete modal:', courseId);
            if (typeof showNotification === 'function') {
                showNotification('Invalid course ID. Cannot open delete modal.', 'error');
            }
            return;
        }
        
        console.log('Opening delete section modal for SPECIFIC course ID:', courseIdNum);
        console.log('This will ONLY delete this specific section, not other sections.');
        
        const modal = document.getElementById('deleteSectionModal');
        const idHolder = document.getElementById('delete-section-course-id');
        const sectionInput = document.getElementById('section');
        const info = document.getElementById('delete-section-info');
        
        // Set the course ID in the hidden field - this is the SPECIFIC section ID to delete
        if (idHolder) {
            idHolder.value = courseIdNum.toString();
            console.log('Set delete-section-course-id to:', idHolder.value, '- This is the SPECIFIC section ID');
        }
        
        if (info) {
            let sectionText = 'This section';
            // Try to get section from the current form first
            if (sectionInput && sectionInput.value) {
                sectionText = sectionInput.value.toUpperCase();
                info.textContent = `Section: ${sectionText}`;
            } else {
                // Try to get from course_id if available
                const courseIdField = document.getElementById('course_id');
                const courseIdToUse = courseIdNum || (courseIdField ? parseInt(courseIdField.value, 10) : null);
                if (courseIdToUse && !isNaN(courseIdToUse) && typeof fetchCourseDetails === 'function') {
                    // Fetch course details to get section name
                    fetchCourseDetails(courseIdToUse).then(course => {
                        if (course && course.section) {
                            const infoEl = document.getElementById('delete-section-info');
                            if (infoEl) {
                                infoEl.textContent = `Section: ${course.section.toUpperCase()}`;
                            }
                        } else {
                            const infoEl = document.getElementById('delete-section-info');
                            if (infoEl) {
                                infoEl.textContent = `Section: ${sectionText}`;
                            }
                        }
                    }).catch((err) => {
                        console.error('Error fetching course details:', err);
                        // Fallback if fetch fails
                        const infoEl = document.getElementById('delete-section-info');
                        if (infoEl) {
                            infoEl.textContent = `Section: ${sectionText}`;
                        }
                    });
                } else {
                    info.textContent = `Section: ${sectionText}`;
                }
            }
        }
        if (modal) modal.classList.remove('hidden');
    } catch (e) {
        console.error('openDeleteSectionModal error:', e);
        if (typeof showNotification === 'function') {
            showNotification('An error occurred while opening the delete modal.', 'error');
        }
    }
}

function closeDeleteSectionModal() {
    const modal = document.getElementById('deleteSectionModal');
    if (modal) modal.classList.add('hidden');
}

// Delete course from container (only deletes specific course ID, not all sections)
function openDeleteCourseModal(courseId, courseCode, courseName) {
    try {
        const courseIdNum = parseInt(courseId, 10);
        if (isNaN(courseIdNum) || courseIdNum <= 0) {
            console.error('Invalid course ID provided to delete modal:', courseId);
            if (typeof showNotification === 'function') {
                showNotification('Invalid course ID. Cannot delete course.', 'error');
            }
            return;
        }
        
        console.log('Opening delete course modal for course ID:', courseIdNum);
        
        const modal = document.getElementById('deleteCourseModal');
        const idHolder = document.getElementById('delete-course-id');
        const nameHolder = document.getElementById('delete-course-name');
        
        if (idHolder) {
            idHolder.value = courseIdNum.toString();
            console.log('Set delete-course-id to:', idHolder.value);
        }
        
        if (nameHolder) {
            const displayName = courseName || courseCode || `Course ID: ${courseIdNum}`;
            nameHolder.textContent = displayName;
        }
        
        if (modal) modal.classList.remove('hidden');
    } catch (e) {
        console.error('openDeleteCourseModal error:', e);
        if (typeof showNotification === 'function') {
            showNotification('An error occurred while opening the delete modal.', 'error');
        }
    }
}

function closeDeleteCourseModal() {
    const modal = document.getElementById('deleteCourseModal');
    if (modal) modal.classList.add('hidden');
}

function deleteAllSections(courseId) {
    try {
        // Ensure courseId is a number
        const courseIdNum = parseInt(courseId, 10);
        if (isNaN(courseIdNum) || courseIdNum <= 0) {
            console.error('Invalid course ID provided:', courseId);
            if (typeof showNotification === 'function') {
                showNotification('Invalid course ID. Cannot delete course.', 'error');
            } else {
                alert('Invalid course ID. Cannot delete course.');
            }
            return;
        }
        
        console.log('=== DELETING ALL SECTIONS ===');
        console.log('Course ID:', courseIdNum);
        console.log('This will delete ALL sections of this course.');
        
        const url = '{% url "dashboard:instructor_delete_course" 0 %}'.replace('0', courseIdNum.toString());
        console.log('Delete URL (all sections):', url);
        
        // CSRF
        let csrfToken = '{{ csrf_token }}';
        const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfInput) csrfToken = csrfInput.value;
        
        // Create form data to send delete_all_sections parameter
        const formData = new FormData();
        formData.append('delete_all_sections', 'true');
        
        fetch(url, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken },
            body: formData
        }).then(resp => {
            console.log('Delete response status:', resp.status);
            return resp.json();
        })
        .then(data => {
            console.log('Delete response data:', data);
            if (data && data.success) {
                if (typeof showNotification === 'function') {
                    showNotification(data.message || 'All sections deleted successfully.', 'success');
                }
                // Save folder UI state then reload
                if (typeof saveFolderState === 'function') saveFolderState();
                closeCourseModal(true);
                setTimeout(() => window.location.reload(), 600);
            } else {
                const msg = (data && data.message) ? data.message : 'Failed to delete course.';
                console.error('Delete failed:', msg);
                if (typeof showNotification === 'function') {
                    showNotification(msg, 'error');
                } else {
                    alert(msg);
                }
            }
        }).catch(err => {
            console.error('Delete request error:', err);
            if (typeof showNotification === 'function') {
                showNotification('Error deleting course. Please try again.', 'error');
            } else {
                alert('Error deleting course. Please try again.');
            }
        });
    } catch (e) {
        console.error('deleteAllSections error:', e);
        if (typeof showNotification === 'function') {
            showNotification('An error occurred while deleting the course.', 'error');
        } else {
            alert('An error occurred while deleting the course.');
        }
    }
}

function confirmDeleteCourse() {
    const idHolder = document.getElementById('delete-course-id');
    const cid = idHolder ? idHolder.value : '';
    if (!cid) {
        console.error('No course ID found for deletion');
        closeDeleteCourseModal();
        return;
    }
    
    const courseIdNum = parseInt(cid, 10);
    if (isNaN(courseIdNum) || courseIdNum <= 0) {
        console.error('Invalid course ID:', cid);
        if (typeof showNotification === 'function') {
            showNotification('Invalid course ID. Cannot delete course.', 'error');
        }
        closeDeleteCourseModal();
        return;
    }
    
    console.log('Deleting ALL sections of course with ID:', courseIdNum);
    
    // Delete all sections when deleting from course container
    deleteAllSections(courseIdNum);
    closeDeleteCourseModal();
}

function confirmDeleteSection() {
    const idHolder = document.getElementById('delete-section-course-id');
    const cid = idHolder ? idHolder.value : '';
    if (!cid) {
        console.error('No course ID found for deletion');
        closeDeleteSectionModal();
        return;
    }
    // Verify we have a valid numeric ID
    const courseIdNum = parseInt(cid, 10);
    if (isNaN(courseIdNum) || courseIdNum <= 0) {
        console.error('Invalid course ID:', cid);
        if (typeof showNotification === 'function') {
            showNotification('Invalid course ID. Cannot delete section.', 'error');
        }
        closeDeleteSectionModal();
        return;
    }
    console.log('Deleting course section with ID:', courseIdNum);
    deleteCurrentSection(courseIdNum);
    closeDeleteSectionModal();
}
// Random color function + palette helpers
const COLOR_CHOICES = [
    { value: '#3C4770', name: 'Indigo' },
    { value: '#4C1D95', name: 'Deep Violet' },
    { value: '#7C3AED', name: 'Grape' },
    { value: '#8B5CF6', name: 'Lavender' },
    { value: '#A855F7', name: 'Violet' },
    { value: '#D946EF', name: 'Magenta' },
    { value: '#EC4899', name: 'Rose' },
    { value: '#F472B6', name: 'Pink' },
    { value: '#FB7185', name: 'Coral' },
    { value: '#F97316', name: 'Tangerine' },
    { value: '#EA580C', name: 'Amber' },
    { value: '#FFA500', name: 'Orange' },
    { value: '#FFB347', name: 'Apricot' },
    { value: '#F0E68C', name: 'Khaki' },
    { value: '#EAB308', name: 'Gold' },
    { value: '#FACC15', name: 'Sunflower' },
    { value: '#A3E635', name: 'Lime' },
    { value: '#84CC16', name: 'Chartreuse' },
    { value: '#4ADE80', name: 'Mint' },
    { value: '#22C55E', name: 'Emerald' },
    { value: '#2E8B57', name: 'Sea Green' },
    { value: '#0EA5E9', name: 'Sky' },
    { value: '#06B6D4', name: 'Cyan' },
    { value: '#2563EB', name: 'Azure' },
    { value: '#1D4ED8', name: 'Royal Blue' },
    { value: '#0F172A', name: 'Midnight' },
    { value: '#6B7280', name: 'Slate' },
    { value: '#991B1B', name: 'Crimson' },
    { value: '#CD853F', name: 'Peru' },
    { value: '#D2B48C', name: 'Tan' },
    { value: '#2F4F4F', name: 'Dark Slate' }
];

function setCourseColor(colorValue) {
    if (!colorValue) return;
    const colorInput = document.getElementById('color');
    const colorText = document.getElementById('color_text');
    if (colorInput) colorInput.value = colorValue;
    if (colorText) colorText.value = colorValue.toUpperCase();
    highlightColorSwatch(colorValue);
}

function highlightColorSwatch(colorValue) {
    document.querySelectorAll('.color-select-tile').forEach(tile => {
        const tileColor = (tile.dataset.color || '').toLowerCase();
        if (colorValue && colorValue.toLowerCase() === tileColor) {
            tile.classList.add('active');
        } else {
            tile.classList.remove('active');
        }
    });
}

function renderColorPalette() {
    const holder = document.getElementById('color-palette-grid');
    if (!holder) return;
    holder.innerHTML = '';
    COLOR_CHOICES.forEach(choice => {
        const button = document.createElement('button');
        button.type = 'button';
        button.className = 'color-select-tile';
        button.dataset.color = choice.value;
        button.title = `${choice.name} (${choice.value.toUpperCase()})`;
        button.innerHTML = `
            <span class="color-select-circle" style="background:${choice.value};"></span>
            <span class="color-select-label">${choice.name}</span>
        `;
        button.addEventListener('click', () => setCourseColor(choice.value));
        holder.appendChild(button);
    });
    const initialColor = document.getElementById('color')?.value || COLOR_CHOICES[0].value;
    highlightColorSwatch(initialColor);
}

function assignRandomColor() {
    const randomColor = COLOR_CHOICES[Math.floor(Math.random() * COLOR_CHOICES.length)].value;
    setCourseColor(randomColor);
}

// Edit course
function editCourse(courseId) {
    clearFormData();
    fetchCourseDetails(courseId)
        .then(course => {
            const modal = getRequiredElement('courseModal');
            const modalTitle = getRequiredElement('modalTitle');
            const submitButtonText = document.getElementById('submitButtonText');
            const defaultAttendanceSection = document.getElementById('defaultAttendanceSection'); // Optional - attendance window removed
            const defaultScheduleSection = getRequiredElement('defaultScheduleSection');
            const daySchedulesContainer = getRequiredElement('daySchedulesContainer');
            const enableDaySchedules = getRequiredElement('enable_day_schedules');
            const sectionField = document.getElementById('section');
            const startTimeInput = document.getElementById('start_time');
            const endTimeInput = document.getElementById('end_time');
            const switcher = document.getElementById('editSectionSwitcher');
            const switcherSelect = document.getElementById('editSectionSelect');

            const requiredIds = ['course_id', 'code', 'name', 'year_level', 'semester', 'school_year', 'room'];
            const fields = {};
            requiredIds.forEach(id => {
                fields[id] = getRequiredElement(id);
            });
            const programHiddenField = document.getElementById('program');

            const toggleBtn = document.getElementById('toggleOtherProgramsBtn');
            if (toggleBtn) toggleBtn.classList.add('hidden');
            // In edit mode: show delete button, hide "save & add another section"
            const deleteBtn = document.getElementById('deleteSectionBtn');
            const addLink = document.getElementById('editAddSectionLink');
            if (deleteBtn) {
                // Show delete only if there are 2+ sections for this course identity
                const siblings = Array.isArray(course.sibling_sections) ? course.sibling_sections : [];
                if (siblings.length > 1) {
                    deleteBtn.classList.remove('hidden');
                    // Always get the current course ID from the form field, not from closure
                    // This ensures it uses the correct ID even when section is switched
                    deleteBtn.onclick = function() {
                        const currentCourseIdField = document.getElementById('course_id');
                        const currentCourseId = currentCourseIdField ? currentCourseIdField.value : courseId;
                        if (!currentCourseId) {
                            console.error('No course ID found in form field');
                            if (typeof showNotification === 'function') {
                                showNotification('Cannot delete: Course ID not found.', 'error');
                            }
                            return;
                        }
                        const courseIdNum = parseInt(currentCourseId, 10);
                        if (isNaN(courseIdNum) || courseIdNum <= 0) {
                            console.error('Invalid course ID in form field:', currentCourseId);
                            if (typeof showNotification === 'function') {
                                showNotification('Invalid course ID. Cannot delete section.', 'error');
                            }
                            return;
                        }
                        console.log('Delete section button clicked for course ID:', courseIdNum);
                        openDeleteSectionModal(courseIdNum);
                    };
                } else {
                    deleteBtn.classList.add('hidden');
                    deleteBtn.onclick = null;
                }
            }
            const saveAndAddLink = document.getElementById('saveAndAddSectionBtn');
            if (saveAndAddLink) {
                saveAndAddLink.classList.add('hidden');
            }
            // Footer alignment for edit mode: right-align buttons
            const footer = document.getElementById('courseModalFooter');
            if (footer) {
                footer.classList.remove('justify-between');
                footer.classList.add('justify-end');
            }

            modal.classList.remove('hidden');
            modalTitle.textContent = 'Edit Course';
            if (submitButtonText) submitButtonText.textContent = 'Update Course';

            // Populate section switcher if multiple sections exist
            const siblings = Array.isArray(course.sibling_sections) ? course.sibling_sections : [];
            if (switcher && switcherSelect) {
                if (siblings.length > 1) {
                    switcher.classList.remove('hidden');
                    // Build options
                    let opts = siblings.map(s => {
                        const isSelected = String(s.id) === String(courseId);
                        const label = (s.section && s.section.trim()) ? s.section : 'N/A';
                        return `<option value="${s.id}" ${isSelected ? 'selected' : ''}>${label}</option>`;
                    }).join('');
                    // Add "Add another section" option
                    opts += `<option value="__add__">+ Add another section</option>`;
                    switcherSelect.innerHTML = opts;
                    // Attach change handler
                    switcherSelect.onchange = function() {
                        const newId = this.value;
                        if (!newId) return;
                        if (newId === '__add__') {
                            // Prepare form for adding a new section under same course identity
                            try {
                                // Clear course_id so submission triggers "add" endpoint
                                const idField = document.getElementById('course_id');
                                if (idField) idField.value = '';
                                // Keep the program the same as the current course (even if it's in another program)
                                if (programHiddenField && course.program_id) {
                                    programHiddenField.value = String(course.program_id);
                                }
                                
                                // Check if course uses default program - if so, ensure default program mode is active
                                const defaultProgramId = '{{ program.id }}';
                                if (course.program_id && String(course.program_id) === String(defaultProgramId)) {
                                    // Course uses default program - ensure default program mode
                                    if (typeof isOtherProgramsMode !== 'undefined') {
                                        isOtherProgramsMode = false;
                                    }
                                    const defaultInfo = document.getElementById('defaultProgramInfo');
                                    const otherSection = document.getElementById('otherProgramsSection');
                                    const toggleBtn = document.getElementById('toggleOtherProgramsBtn');
                                    if (defaultInfo) defaultInfo.classList.remove('hidden');
                                    if (otherSection) otherSection.classList.add('hidden');
                                    if (toggleBtn) {
                                        toggleBtn.classList.remove('hidden');
                                        toggleBtn.textContent = 'Add course to other program';
                                        toggleBtn.classList.remove('text-gray-600', 'hover:text-gray-800');
                                        toggleBtn.classList.add('text-blue-600', 'hover:text-blue-800');
                                    }
                                    // Reset department and program selects
                                    const departmentSelect = document.getElementById('department');
                                    const programSelect = document.getElementById('program_select');
                                    if (departmentSelect) departmentSelect.value = '';
                                    if (programSelect) {
                                        programSelect.value = '';
                                        programSelect.disabled = true;
                                    }
                                }
                                
                                // Update titles/texts
                                const mt = document.getElementById('modalTitle');
                                if (mt) mt.textContent = 'Add New Section';
                                if (submitButtonText) submitButtonText.textContent = 'Save Section';
                                // Reset only section & schedule-related fields
                                if (typeof resetFieldsForNextSection === 'function') {
                                    resetFieldsForNextSection();
                                }
                                // Focus section input
                                const secIn = document.getElementById('section');
                                if (secIn) secIn.focus();
                                // Keep switcher visible but revert selection to current
                                this.value = String(courseId);
                            } catch (e) {
                                console.error('Error preparing add section flow:', e);
                            }
                            return;
                        }
                        if (newId !== String(courseId)) {
                            editCourse(newId);
                        }
                    };
                    if (addLink) addLink.classList.add('hidden');
                } else {
                    switcher.classList.add('hidden');
                    switcherSelect.innerHTML = '';
                    // Show separate add link for single/no-section case
                    if (addLink) {
                        addLink.classList.remove('hidden');
                        addLink.onclick = function(e) {
                            e.preventDefault();
                            try {
                                const idField = document.getElementById('course_id');
                                if (idField) idField.value = '';
                                // Preserve program for new section
                                if (programHiddenField && course.program_id) {
                                    programHiddenField.value = String(course.program_id);
                                }
                                
                                // Check if course uses default program - if so, ensure default program mode is active
                                const defaultProgramId = '{{ program.id }}';
                                if (course.program_id && String(course.program_id) === String(defaultProgramId)) {
                                    // Course uses default program - ensure default program mode
                                    if (typeof isOtherProgramsMode !== 'undefined') {
                                        isOtherProgramsMode = false;
                                    }
                                    const defaultInfo = document.getElementById('defaultProgramInfo');
                                    const otherSection = document.getElementById('otherProgramsSection');
                                    const toggleBtn = document.getElementById('toggleOtherProgramsBtn');
                                    if (defaultInfo) defaultInfo.classList.remove('hidden');
                                    if (otherSection) otherSection.classList.add('hidden');
                                    if (toggleBtn) {
                                        toggleBtn.classList.remove('hidden');
                                        toggleBtn.textContent = 'Add course to other program';
                                        toggleBtn.classList.remove('text-gray-600', 'hover:text-gray-800');
                                        toggleBtn.classList.add('text-blue-600', 'hover:text-blue-800');
                                    }
                                    // Reset department and program selects
                                    const departmentSelect = document.getElementById('department');
                                    const programSelect = document.getElementById('program_select');
                                    if (departmentSelect) departmentSelect.value = '';
                                    if (programSelect) {
                                        programSelect.value = '';
                                        programSelect.disabled = true;
                                    }
                                }
                                
                                const mt = document.getElementById('modalTitle');
                                if (mt) mt.textContent = 'Add New Section';
                                if (submitButtonText) submitButtonText.textContent = 'Save Section';
                                if (typeof resetFieldsForNextSection === 'function') {
                                    resetFieldsForNextSection();
                                }
                                const secIn = document.getElementById('section');
                                if (secIn) secIn.focus();
                            } catch (e) {
                                console.error('Error preparing add section link flow:', e);
                            }
                            return false;
                        };
                    }
                }
            }

            fields['course_id'].value = courseId;
            fields['code'].value = course.code || '';
            fields['name'].value = course.name || '';
            // Ensure hidden program stays set to the course's actual program for updates/add-section flows
            if (programHiddenField && course.program_id) {
                programHiddenField.value = String(course.program_id);
            }
            // Reflect actual program/department in the info box to avoid confusion (even for other program courses)
            try {
                const defaultInfoBox = document.getElementById('defaultProgramInfo');
                if (defaultInfoBox) {
                    const progLabel = (course.program_code && course.program_name)
                        ? `${course.program_code} - ${course.program_name}`
                        : (course.program_code || course.program_name || (course.program || 'N/A'));
                    const deptLabel = course.department || '';
                    defaultInfoBox.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-indigo-800 mb-1">
                                    <i class="fas fa-info-circle mr-2"></i>Program & Department
                                </p>
                                <p class="text-sm text-indigo-700">
                                    <strong>Program:</strong> ${progLabel}
                                    ${deptLabel ? `<br><strong>Department:</strong> ${deptLabel}` : ''}
                                </p>
                            </div>
                        </div>
                    `;
                }
            } catch (e) {
                console.warn('Could not update program/department info box:', e);
            }
            fields['year_level'].value = course.year_level || '';
            fields['semester'].value = course.semester || '';
            fields['school_year'].value = course.school_year || '';
            fields['room'].value = course.room || '';
            setCourseColor(course.color || '#3C4770');

            if (sectionField) {
                sectionField.value = (course.section || '').toUpperCase();
            }

            addedDaySchedules = [];
            enableDaySchedules.checked = false;
            daySchedulesContainer.classList.add('hidden');
            defaultScheduleSection.classList.remove('hidden');
            defaultAttendanceSection.classList.remove('hidden');

            // Only enable per-day setup if the course is truly using per-day schedules
            // (different times per day), not if it's synchronized (same time across days)
            if (course.is_per_day_schedule && course.day_schedules && course.day_schedules.length > 0) {
                enableDaySchedules.checked = true;
                daySchedulesContainer.classList.remove('hidden');
                defaultScheduleSection.classList.add('hidden');
                defaultAttendanceSection.classList.add('hidden');

                const dayMap = { 'Monday': 'Mon', 'Tuesday': 'Tue', 'Wednesday': 'Wed', 'Thursday': 'Thu', 'Friday': 'Fri', 'Saturday': 'Sat', 'Sunday': 'Sun' };
                course.day_schedules.forEach(schedule => {
                    addedDaySchedules.push({
                        day: dayMap[schedule.day] || schedule.day,
                        startTime: schedule.start_time ? convertTo24Hour(schedule.start_time) : '',
                        endTime: schedule.end_time ? convertTo24Hour(schedule.end_time) : '',
                        room: schedule.room || ''
                    });
                });
                updateDayScheduleList();
            } else {
                if (startTimeInput) startTimeInput.value = course.start_time ? convertTo24Hour(course.start_time) : '';
                if (endTimeInput) endTimeInput.value = course.end_time ? convertTo24Hour(course.end_time) : '';
                if (course.days) {
                    const daysList = course.days.split(',').map(d => d.trim());
                    document.querySelectorAll('.day-checkbox').forEach(checkbox => {
                        checkbox.checked = daysList.includes(checkbox.value);
                        const button = checkbox.closest('.day-button-multi');
                        if (button) {
                            if (checkbox.checked) {
                                button.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
                                button.classList.remove('bg-white', 'text-gray-700', 'border-gray-300');
                            } else {
                                button.classList.remove('bg-blue-600', 'text-white', 'border-blue-600');
                                button.classList.add('bg-white', 'text-gray-700', 'border-gray-300');
                            }
                        }
                    });
                    updateDaysFromCheckboxes();
                }
            }

            setupAutoSave();
        })
        .catch(error => handleActionError(error, 'An error occurred while loading course details.'));
}

// Auto-open edit modal if URL has ?edit_course=ID
document.addEventListener('DOMContentLoaded', function() {
    try {
        const params = new URLSearchParams(window.location.search);
        let editId = params.get('edit_course');
        // Normalize id in case it's a day-specific id like "db_123_Mon"
        if (editId && !/^\d+$/.test(editId)) {
            const m = editId.match(/^db_(\d+)/i);
            if (m && m[1]) {
                editId = m[1];
            }
        }
        if (editId) {
            // Defer to ensure DOM and scripts ready
            setTimeout(() => {
                editCourse(editId);
            }, 100);
        }
    } catch (e) {
        console.warn('Failed to parse edit_course param:', e);
    }
});

// Save folder state to localStorage
function saveFolderState() {
    const state = {
        expandedYears: [],
        expandedSemesters: []
    };
    
    // Get all year folders
    document.querySelectorAll('[id^="year-"]').forEach(yearFolder => {
        if (yearFolder.style.display !== 'none' && yearFolder.id.startsWith('year-')) {
            const yearId = yearFolder.id;
            state.expandedYears.push(yearId);
        }
    });
    
    // Get all semester folders
    document.querySelectorAll('[id^="semester-"]').forEach(semFolder => {
        if (semFolder.style.display !== 'none' && semFolder.id.startsWith('semester-')) {
            const semId = semFolder.id;
            state.expandedSemesters.push(semId);
        }
    });
    
    localStorage.setItem('instructor_courses_folder_state', JSON.stringify(state));
}

// Restore folder state from localStorage
function restoreFolderState() {
    try {
        const stateJson = localStorage.getItem('instructor_courses_folder_state');
        if (!stateJson) return;
        
        const state = JSON.parse(stateJson);
        
        // Restore year folders first
        if (state.expandedYears && state.expandedYears.length > 0) {
            state.expandedYears.forEach(yearId => {
                const folder = document.getElementById(yearId);
                const icon = document.getElementById(yearId.replace('year-', 'year-icon-'));
                if (folder) {
                    folder.style.display = 'block';
                    if (icon) {
                        icon.style.transform = 'rotate(0deg)';
                        icon.style.transition = 'transform 0.3s ease';
                    }
                }
            });
        }
        
        // Restore semester folders (after a small delay to ensure year folders are rendered)
        setTimeout(() => {
            if (state.expandedSemesters && state.expandedSemesters.length > 0) {
                state.expandedSemesters.forEach(semId => {
                    const folder = document.getElementById(semId);
                    const icon = document.getElementById(semId.replace('semester-', 'semester-icon-'));
                    if (folder) {
                        folder.style.display = 'block';
                        if (icon) {
                            icon.style.transform = 'rotate(0deg)';
                            icon.style.transition = 'transform 0.3s ease';
                        }
                    }
                });
            }
        }, 50);
    } catch (e) {
        console.error('Error restoring folder state:', e);
    }
}

// Toggle school year folder - when opening, expand all year levels
function toggleSchoolYearFolder(folderId) {
    const folder = document.getElementById(folderId);
    const icon = document.getElementById(folderId.replace('school-year-', 'school-year-icon-'));
    if (folder) {
        if (folder.style.display === 'none') {
            folder.style.display = 'block';
            if (icon) {
                icon.style.transform = 'rotate(0deg)';
                icon.style.transition = 'transform 0.3s ease';
            }
        } else {
            folder.style.display = 'none';
            if (icon) {
                icon.style.transform = 'rotate(-90deg)';
                icon.style.transition = 'transform 0.3s ease';
            }
        }
        // Save state after toggle
        saveFolderState();
    }
}

// Toggle year folder - when opening, expand all semesters
function toggleYearFolder(folderId) {
    const folder = document.getElementById(folderId);
    const icon = document.getElementById(folderId.replace('year-', 'year-icon-'));
    if (folder) {
        if (folder.style.display === 'none') {
            folder.style.display = 'block';
            if (icon) {
                icon.style.transform = 'rotate(0deg)';
                icon.style.transition = 'transform 0.3s ease';
            }
            
            // Expand all semester folders within this year with animation
            const yearIndex = folderId.replace('year-', '');
            const semesterFolders = folder.querySelectorAll('[id^="semester-' + yearIndex + '-"]');
            semesterFolders.forEach((semFolder, index) => {
                setTimeout(() => {
                    semFolder.style.display = 'block';
                    semFolder.style.animation = 'fadeInSlide 0.3s ease forwards';
                    const semIconId = semFolder.id.replace('semester-', 'semester-icon-');
                    const semIcon = document.getElementById(semIconId);
                    if (semIcon) {
                        semIcon.style.transform = 'rotate(0deg)';
                        semIcon.style.transition = 'transform 0.3s ease';
                    }
                }, index * 50); // Stagger animation
            });
        } else {
            folder.style.display = 'none';
            if (icon) {
                icon.style.transform = 'rotate(-90deg)';
                icon.style.transition = 'transform 0.3s ease';
            }
        }
        // Save state after toggle
        saveFolderState();
    }
}

// Toggle semester folder
function toggleSemesterFolder(folderId) {
    const folder = document.getElementById(folderId);
    const icon = document.getElementById(folderId.replace('semester-', 'semester-icon-'));
    if (folder) {
        if (folder.style.display === 'none') {
            folder.style.display = 'block';
            folder.style.animation = 'fadeInSlide 0.3s ease forwards';
            if (icon) {
                icon.style.transform = 'rotate(0deg)';
                icon.style.transition = 'transform 0.3s ease';
            }
            
            // Reinitialize stars for multi-section courses when folder opens
            setTimeout(() => {
                const starFields = folder.querySelectorAll('.multi-stars-field:not([data-stars-initialized])');
                if (starFields.length > 0 && typeof initStars === 'function') {
                    initStars();
                } else {
                    // Fallback: manually create stars
                    starFields.forEach(field => {
                        if (field.hasAttribute('data-stars-initialized')) return;
                        field.setAttribute('data-stars-initialized', 'true');
                        const STAR_COUNT_DEFAULT = 60;
                        const countAttr = parseInt(field.getAttribute('data-star-count') || `${STAR_COUNT_DEFAULT}`, 10);
                        const count = isNaN(countAttr) ? STAR_COUNT_DEFAULT : Math.max(20, Math.min(150, countAttr));
                        
                        function createStar() {
                            const rect = field.getBoundingClientRect();
                            const width = rect.width || field.clientWidth || 200;
                            const height = rect.height || field.clientHeight || 128;
                            
                            const star = document.createElement('div');
                            star.className = 'star-dot';
                            const size = Math.random() * 3 + 1;
                            star.style.width = `${size}px`;
                            star.style.height = `${size}px`;
                            
                            let x, y;
                            if (Math.random() < 0.7) {
                                if (Math.floor(Math.random() * 2) === 0) {
                                    const band = Math.random() < 0.5 ? 0.12 : 0.88;
                                    y = band * height + (Math.random() - 0.5) * 0.12 * height;
                                    y = Math.max(0, Math.min(height, y));
                                    x = Math.random() * width;
                                } else {
                                    const band = Math.random() < 0.5 ? 0.12 : 0.88;
                                    x = band * width + (Math.random() - 0.5) * 0.12 * width;
                                    x = Math.max(0, Math.min(width, x));
                                    y = Math.random() * height;
                                }
                            } else {
                                x = Math.random() * width;
                                y = Math.random() * height;
                            }
                            star.style.left = `${x}px`;
                            star.style.top = `${y}px`;
                            const duration = Math.random() * 4 + 2;
                            star.style.animationDuration = `${duration}s`;
                            const delay = Math.random() * duration * -1;
                            star.style.animationDelay = `${delay}s`;
                            field.appendChild(star);
                        }
                        
                        for (let i = 0; i < count; i++) {
                            createStar();
                        }
                    });
                }
                
                // Apply gradients to course cards
                folder.querySelectorAll('.course-card-block[data-gradient]').forEach(el => {
                    const grad = el.getAttribute('data-gradient');
                    if (grad && grad.includes('linear-gradient')) {
                        el.style.background = grad;
                    }
                });
            }, 100);
        } else {
            folder.style.display = 'none';
            if (icon) {
                icon.style.transform = 'rotate(-90deg)';
                icon.style.transition = 'transform 0.3s ease';
            }
        }
        // Save state after toggle
        saveFolderState();
    }
}

// Note: filterYearCourses is already defined above, this duplicate is removed to avoid conflicts

function getCsrfToken() {
    const match = document.cookie.match(/csrftoken=([^;]+)/);
    if (match) return match[1];
    const csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
    return csrfInput ? csrfInput.value : '';
}

function getRequiredElement(id) {
    const element = document.getElementById(id);
    if (!element) {
        throw new Error(`Required form element #${id} was not found.`);
    }
    return element;
}

function convertTo24Hour(timeString) {
    if (!timeString) return '';
    const trimmed = timeString.trim();
    if (/^\d{2}:\d{2}$/.test(trimmed)) {
        return trimmed;
    }
    const match = trimmed.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);
    if (!match) {
        return trimmed.substring(0, 5);
    }
    let hours = parseInt(match[1], 10);
    const minutes = match[2];
    const meridiem = match[3].toUpperCase();
    if (meridiem === 'PM' && hours !== 12) {
        hours += 12;
    }
    if (meridiem === 'AM' && hours === 12) {
        hours = 0;
    }
    return `${hours.toString().padStart(2, '0')}:${minutes}`;
}

function fetchCourseDetails(courseId) {
    const url = '{% url "dashboard:instructor_course_detail" 0 %}'.replace('0', courseId);
    return fetch(url, {
        credentials: 'same-origin',
        headers: {
            'Accept': 'application/json'
        }
    })
    .then(response => response.json().catch(() => {
        throw new Error('Received an invalid response from the server.');
    }))
    .then(data => {
        if (!data.success || !data.course) {
            throw new Error(data.message || 'Unable to load course details.');
        }
        return data.course;
    });
}

function handleActionError(error, fallbackMessage) {
    console.error(error);
    const message = error instanceof Error ? error.message : fallbackMessage;
    if (typeof showNotification === 'function') {
        showNotification(message || fallbackMessage, 'error');
    } else {
        alert(message || fallbackMessage);
    }
}

// Copy QR code to clipboard
function copyQRCode(code) {
    if (!code || code === 'Not generated' || code === '') {
        if (typeof showNotification === 'function') {
            showNotification('QR code not available', 'error');
        } else {
            alert('QR code not available');
        }
        return;
    }
    
    navigator.clipboard.writeText(code).then(() => {
        if (typeof showNotification === 'function') {
            showNotification('QR code copied to clipboard!', 'success');
        } else {
            alert('QR code copied to clipboard!');
        }
    }).catch(err => {
        console.error('Failed to copy:', err);
        if (typeof showNotification === 'function') {
            showNotification('Failed to copy QR code. Please copy manually: ' + code, 'error');
        } else {
            alert('Failed to copy QR code. Please copy manually: ' + code);
        }
    });
}

// Copy enrollment code to clipboard
function copyEnrollmentCode(code) {
    if (!code || code === 'Not generated') {
        alert('Enrollment code not available');
        return;
    }
    
    navigator.clipboard.writeText(code).then(() => {
        if (typeof showNotification === 'function') {
            showNotification('Enrollment code copied to clipboard!', 'success');
        } else {
            alert('Enrollment code copied to clipboard!');
        }
    }).catch(err => {
        console.error('Failed to copy:', err);
        alert('Failed to copy code. Please copy manually: ' + code);
    });
}

// Update enrollment status
let pendingEnrollmentStatusChange = null;

window.updateEnrollmentStatus = function(courseId, status) {
    const selectElement = document.getElementById(`enrollmentStatusSelect-${courseId}`);
    const previousValue = selectElement.dataset.previousValue || 'open';
    
    // Store pending change
    pendingEnrollmentStatusChange = {
        courseId: courseId,
        status: status,
        previousValue: previousValue,
        selectElement: selectElement
    };
    
    // Show confirmation modal
    showEnrollmentStatusModal(courseId, status);
};

window.showEnrollmentStatusModal = function(courseId, status) {
    const modal = document.getElementById('enrollmentStatusModal');
    if (!modal) {
        console.error('Enrollment status modal not found');
        return;
    }
    
    const statusText = status === 'open' ? 'open' : 'close';
    const statusAction = status === 'open' ? 'opened' : 'closed';
    
    const messageEl = document.getElementById('enrollmentStatusModalMessage');
    const actionEl = document.getElementById('enrollmentStatusModalAction');
    
    if (messageEl) {
        messageEl.textContent = `Are you sure you want to ${statusText} enrollment for this course?`;
    }
    if (actionEl) {
        actionEl.textContent = `Enrollment will be ${statusAction} and students ${status === 'open' ? 'will be able' : 'will not be able'} to enroll using the enrollment code.`;
    }
    
    modal.classList.remove('hidden');
};

window.closeEnrollmentStatusModal = function() {
    const modal = document.getElementById('enrollmentStatusModal');
    if (modal) {
        modal.classList.add('hidden');
    }
    
    // Reset select if cancelled
    if (pendingEnrollmentStatusChange) {
        pendingEnrollmentStatusChange.selectElement.value = pendingEnrollmentStatusChange.previousValue;
        pendingEnrollmentStatusChange = null;
    }
};

window.confirmEnrollmentStatusChange = function() {
    if (!pendingEnrollmentStatusChange) {
        console.warn('No pending enrollment status change');
        closeEnrollmentStatusModal();
        return;
    }
    
    const { courseId, status, selectElement } = pendingEnrollmentStatusChange;
    
    console.log('Confirming enrollment status change:', { courseId, status });
    
    fetch(`/dashboard/instructor/courses/${courseId}/update-enrollment-status/`, {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}',
            'Accept': 'application/json'
        },
        body: JSON.stringify({ status: status })
    })
    .then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        if (data.success) {
            // Update the select element value
            selectElement.value = status;
            selectElement.dataset.previousValue = status;
            
            if (typeof showNotification === 'function') {
                showNotification(data.message || `Enrollment ${status === 'open' ? 'opened' : 'closed'} successfully.`, 'success');
            } else {
                alert(data.message || `Enrollment ${status === 'open' ? 'opened' : 'closed'} successfully.`);
            }
            closeEnrollmentStatusModal();
            // Refresh the page after successful update
            setTimeout(() => {
                window.location.reload();
            }, 500);
        } else {
            selectElement.value = pendingEnrollmentStatusChange.previousValue;
            if (typeof showNotification === 'function') {
                showNotification(data.message || 'Failed to update enrollment status.', 'error');
            } else {
                alert(data.message || 'Failed to update enrollment status.');
            }
            closeEnrollmentStatusModal();
        }
        pendingEnrollmentStatusChange = null;
    })
    .catch(error => {
        console.error('Error updating enrollment status:', error);
        if (selectElement && pendingEnrollmentStatusChange) {
            selectElement.value = pendingEnrollmentStatusChange.previousValue;
        }
        if (typeof showNotification === 'function') {
            showNotification('An error occurred. Please try again.', 'error');
        } else {
            alert('An error occurred. Please try again.');
        }
        closeEnrollmentStatusModal();
        pendingEnrollmentStatusChange = null;
    });
};

// QR Code Modal Functions
window.showQRCodeModal = function(courseId, courseCode, courseName) {
    try {
        const modal = document.getElementById('qrCodeModal');
        if (!modal) {
            console.error('QR Code modal not found');
            alert('QR Code modal not found. Please refresh the page.');
            return;
        }
        
        const modalImage = document.getElementById('qrCodeModalImage');
        const modalCourseName = document.getElementById('qrCodeModalCourseName');
        const modalCourseCode = document.getElementById('qrCodeModalCourseCode');
        
        if (!modalImage || !modalCourseName || !modalCourseCode) {
            console.error('QR Code modal elements not found');
            alert('QR Code modal elements not found. Please refresh the page.');
            return;
        }
        
        // Set course info
        modalCourseName.textContent = courseName;
        modalCourseCode.textContent = courseCode;
        
        // Get QR code URL - use the same URL as the small image
        const smallImage = document.getElementById(`qr-code-img-${courseId}`);
        let qrCodeUrl = '';
        if (smallImage && smallImage.dataset.url) {
            qrCodeUrl = smallImage.dataset.url;
        } else {
            qrCodeUrl = `/dashboard/instructor/courses/${courseId}/qr-code/`;
        }
        
        // Add cache-busting with current date/day (session-based QR codes)
        const now = new Date();
        const dateStr = now.getFullYear() + String(now.getMonth() + 1).padStart(2, '0') + String(now.getDate()).padStart(2, '0');
        const dayStr = now.getDay();
        qrCodeUrl += `?v=${courseId}${dateStr}${dayStr}&modal=true`;
        
        // Set image source
        modalImage.src = qrCodeUrl;
        modalImage.alt = `QR Code for ${courseCode} - ${courseName}`;
        
        // Show modal
        modal.classList.remove('hidden');
        console.log('QR Code modal opened for course:', courseId);
    } catch (error) {
        console.error('Error opening QR Code modal:', error);
        alert('Error opening QR Code modal. Please try again.');
    }
};

window.closeQRCodeModal = function() {
    try {
        const modal = document.getElementById('qrCodeModal');
        if (modal) {
            modal.classList.add('hidden');
        }
    } catch (error) {
        console.error('Error closing QR Code modal:', error);
    }
};

// View course details
function viewCourseDetails(courseId) {
    closeCourseFormIfOpen();
    fetchCourseDetails(courseId)
    .then(course => {
        try {
            const content = document.getElementById('courseDetailContent');
            const courseColor = course.color || '#3C4770';
            
            // Format program display: "CODE - Name" or just code/name if one is missing
            let programDisplay = 'N/A';
            if (course.program_code && course.program_name) {
                programDisplay = `${course.program_code} - ${course.program_name}`;
            } else if (course.program_code) {
                programDisplay = course.program_code;
            } else if (course.program_name) {
                programDisplay = course.program_name;
            } else if (course.program) {
                programDisplay = course.program;
            }
            
            // Build section switcher if siblings exist
            const hasSiblings = Array.isArray(course.sibling_sections) && course.sibling_sections.length > 1;
            let sectionSwitcherHtml = '';
            if (hasSiblings) {
                sectionSwitcherHtml = `
                    <div class="mb-3">
                        <label class="block text-xs font-semibold text-gray-600 mb-1">Section</label>
                        <select id="courseDetailSectionSelect" class="w-40 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 bg-white">
                            ${course.sibling_sections.map(s => `
                                <option value="${s.id}" ${String(s.id) === String(course.id) ? 'selected' : ''}>${s.section}</option>
                            `).join('')}
                        </select>
                    </div>
                `;
            }
            
            content.innerHTML = `
                <div class="space-y-4">
                    <div class="p-4 rounded-lg border-l-4" style="background: linear-gradient(90deg, ${courseColor}15 0%, #FFFFFF 100%); border-left-color: ${courseColor};">
                        <h3 class="text-xl font-bold text-gray-900 mb-2" style="color: ${courseColor};">${course.code} - ${course.name}</h3>
                        <p class="text-sm text-gray-600 font-medium">
                            <strong>Program:</strong> ${programDisplay}
                        </p>
                    </div>
                    ${sectionSwitcherHtml}
                    <div class="grid grid-cols-2 gap-4">
                        <div><strong>Year Level:</strong> ${formatOrdinalYear(course.year_level)}</div>
                        <div><strong>Semester:</strong> ${course.semester === '1st' ? '1st Semester' : course.semester === '2nd' ? '2nd Semester' : course.semester === 'summer' ? 'Summer' : (course.semester || 'N/A')}</div>
                        <div><strong>School Year:</strong> ${course.school_year || 'N/A'}</div>
                        <div><strong>Section:</strong> ${(course.section || 'N/A').toUpperCase()}</div>
                        <div><strong>Students:</strong> ${typeof course.student_count !== 'undefined' ? course.student_count : '0'}</div>
                    </div>
                    ${course.enrollment_code ? `
                    <div class="border-t pt-4 mt-4">
                        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded">
                            <div class="mb-3">
                                <label class="block text-sm font-semibold text-yellow-800 mb-2">Enrollment Status</label>
                                <select id="enrollmentStatusSelect-${course.id}" 
                                        data-previous-value="${course.enrollment_status || 'open'}"
                                        onfocus="this.dataset.previousValue = this.value"
                                        onchange="updateEnrollmentStatus(${course.id}, this.value)"
                                        class="w-full px-3 py-2 text-sm border border-yellow-300 rounded-lg focus:ring-2 focus:ring-yellow-500 bg-white">
                                    <option value="open" ${course.enrollment_status === 'open' || !course.enrollment_status ? 'selected' : ''}>Open for Enrollment</option>
                                    <option value="closed" ${course.enrollment_status === 'closed' ? 'selected' : ''}>Closed Enrollment</option>
                                </select>
                            </div>
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-semibold text-yellow-800 mb-1">Enrollment Code</p>
                                    <p class="text-2xl font-bold text-yellow-900 font-mono tracking-widest">${course.enrollment_code || 'Not generated'}</p>
                                    <p class="text-xs text-yellow-700 mt-1">Share this code with your students for enrollment</p>
                                </div>
                                <button onclick="copyEnrollmentCode('${course.enrollment_code || ''}')" class="px-4 py-2 bg-yellow-600 text-white text-sm font-semibold rounded-lg hover:bg-yellow-700 transition">
                                    <i class="fas fa-copy mr-2"></i> Copy Code
                                </button>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                    <div class="border-t pt-4">
                        <h4 class="font-semibold mb-2">Schedule</h4>
                        ${course.has_day_schedules && course.day_schedules && course.day_schedules.length > 0 ? `
                        <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
                            <div class="px-4 py-2 border-b border-gray-200" style="background: linear-gradient(90deg, ${courseColor}15 0%, #FFFFFF 100%); border-left: 4px solid ${courseColor};">
                                <h5 class="font-semibold text-gray-800 flex items-center">
                                    <i class="fas fa-calendar-alt mr-2" style="color: ${courseColor};"></i>Asynchronized Schedule (Different schedule for each day)
                                </h5>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200 text-sm">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-3 py-2 text-left text-xs font-semibold text-gray-700">Day</th>
                                            <th class="px-3 py-2 text-left text-xs font-semibold text-gray-700">Start Time</th>
                                            <th class="px-3 py-2 text-left text-xs font-semibold text-gray-700">End Time</th>
                                            <th class="px-3 py-2 text-left text-xs font-semibold text-gray-700">Room</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        ${course.day_schedules.map(schedule => {
                                            // Room priority: schedule room > course room > 'Not specified'
                                            const roomDisplay = (schedule.room && schedule.room.trim() && schedule.room !== 'Not specified') 
                                                ? schedule.room 
                                                : (course.room && course.room.trim() ? course.room : 'Not specified');
                                            return `
                                        <tr>
                                            <td class="px-3 py-2 whitespace-nowrap font-medium">${schedule.day}</td>
                                            <td class="px-3 py-2 whitespace-nowrap">${schedule.start_time || 'N/A'}</td>
                                            <td class="px-3 py-2 whitespace-nowrap">${schedule.end_time || 'N/A'}</td>
                                            <td class="px-3 py-2 whitespace-nowrap">
                                                <span class="flex items-center">
                                                    <i class="fas fa-map-marker-alt mr-1 text-gray-400 text-xs"></i>
                                                    ${roomDisplay}
                                                </span>
                                            </td>
                                        </tr>
                                        `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        ` : `
                        <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
                            <div class="px-4 py-2 border-b border-gray-200" style="background: linear-gradient(90deg, ${courseColor}15 0%, #FFFFFF 100%); border-left: 4px solid ${courseColor};">
                                <h5 class="font-semibold text-gray-800 flex items-center">
                                    <i class="fas fa-calendar-alt mr-2" style="color: ${courseColor};"></i>Synchronized Schedule
                                </h5>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200 text-sm">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-3 py-2 text-left text-xs font-semibold text-gray-700">Day</th>
                                            <th class="px-3 py-2 text-left text-xs font-semibold text-gray-700">Start Time</th>
                                            <th class="px-3 py-2 text-left text-xs font-semibold text-gray-700">End Time</th>
                                            <th class="px-3 py-2 text-left text-xs font-semibold text-gray-700">Room</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        ${(course.days ? course.days.split(',').map(day => day.trim()) : []).map(day => {
                                            const roomDisplay = (course.room && course.room.trim()) ? course.room : 'Not specified';
                                            return `
                                        <tr>
                                            <td class="px-3 py-2 whitespace-nowrap font-medium">${day}</td>
                                            <td class="px-3 py-2 whitespace-nowrap">${course.start_time || 'N/A'}</td>
                                            <td class="px-3 py-2 whitespace-nowrap">${course.end_time || 'N/A'}</td>
                                            <td class="px-3 py-2 whitespace-nowrap">
                                                <span class="flex items-center">
                                                    <i class="fas fa-map-marker-alt mr-1 text-gray-400 text-xs"></i>
                                                    ${roomDisplay}
                                                </span>
                                            </td>
                                        </tr>
                                        `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        `}
                    </div>
                    <div class="flex justify-end space-x-3 pt-4 border-t">
                        <button onclick="closeCourseDetailModal()" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition">
                            Close
                        </button>
                        ${course.instructor_id == currentUserId ? `
                        <button onclick="closeCourseDetailModal(); editCourse(${courseId});" class="px-4 py-2 bg-yellow-600 text-white font-semibold rounded-lg hover:bg-yellow-700 transition">
                            <i class="fas fa-edit mr-2"></i> Edit
                        </button>
                        ` : ''}
                    </div>
                </div>
            `;
            document.getElementById('courseDetailModal').classList.remove('hidden');
            
            // Wire up section switcher
            if (hasSiblings) {
                const sel = document.getElementById('courseDetailSectionSelect');
                if (sel) {
                    sel.addEventListener('change', function() {
                        const newCourseId = this.value;
                        // Reload modal with selected section's course id
                        viewCourseDetails(newCourseId);
                    });
                }
            }
        } catch (renderError) {
            handleActionError(renderError, 'Unable to render course details.');
        }
    })
    .catch(error => handleActionError(error, 'An error occurred while loading course details.'));
}

function closeCourseDetailModal() {
    const modal = document.getElementById('courseDetailModal');
    setTimeout(() => {
        modal.classList.add('hidden');
    }, 150);
}

// Delete course functions
function archiveCourse(courseId, code, name) {
    closeCourseFormIfOpen();
    const modal = document.getElementById('archiveCourseModal');
    if (!modal) {
        console.error('Archive course modal not found');
        if (typeof showNotification === 'function') {
            showNotification('Archive modal not found. Please refresh the page.', 'error');
        }
        return;
    }
    modal.classList.remove('hidden');
    const courseIdInput = document.getElementById('archive-course-id');
    const courseNameDisplay = document.getElementById('archive-course-name');
    if (courseIdInput) courseIdInput.value = courseId;
    if (courseNameDisplay) courseNameDisplay.textContent = code + ' - ' + name;
}

function closeArchiveCourseModal() {
    const modal = document.getElementById('archiveCourseModal');
    modal.classList.add('hidden');
    document.getElementById('archive-course-id').value = '';
    document.getElementById('archive-course-name').textContent = '';
}

function confirmArchiveCourse() {
    const courseId = document.getElementById('archive-course-id').value;
    if (!courseId) return;
    
    closeArchiveCourseModal();
    
    fetch('{% url "dashboard:instructor_archive_course" 0 %}'.replace('0', courseId), {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
            'X-CSRFToken': getCsrfToken(),
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        },
        body: JSON.stringify({})
    })
    .then(response => response.json().catch(() => {
        throw new Error('Unable to archive course at the moment.');
    }))
    .then(data => {
        if (!data.success) {
            throw new Error(data.message || 'Error archiving course.');
        }
        if (typeof showNotification === 'function') {
            showNotification(data.message || 'Course archived successfully!', 'success');
        }
        try {
            localStorage.setItem('course_added', Date.now().toString());
            window.dispatchEvent(new StorageEvent('storage', {
                key: 'course_added',
                newValue: Date.now().toString()
            }));
        } catch (e) {
            console.warn('Could not store course_added flag:', e);
        }
        saveFolderState();
        setTimeout(() => location.reload(), 800);
    })
    .catch(error => {
        console.error('Error archiving course:', error);
        if (typeof showNotification === 'function') {
            showNotification(error.message || 'An error occurred while archiving the course.', 'error');
        } else {
            alert(error.message || 'An error occurred while archiving the course.');
        }
    });
}

function deleteCourse(courseId, code, name) {
    closeCourseFormIfOpen();
    const modal = document.getElementById('deleteCourseModal');
    modal.classList.remove('hidden');
    document.getElementById('delete-course-id').value = courseId;
    document.getElementById('delete-course-name').textContent = code + ' - ' + name;
}

// Delete entire school year folder (all courses in that school year)
function archiveSchoolYearFolder(schoolYearKey) {
    const modal = document.getElementById('archiveSchoolYearModal');
    document.getElementById('archive-school-year-key').value = schoolYearKey;
    document.getElementById('archive-school-year-name').textContent = `School Year: ${schoolYearKey}`;
    modal.classList.remove('hidden');
}

function closeArchiveSchoolYearModal() {
    document.getElementById('archiveSchoolYearModal').classList.add('hidden');
}

function confirmArchiveSchoolYear() {
    const schoolYearKey = document.getElementById('archive-school-year-key').value;
    closeArchiveSchoolYearModal();
    
    // Find the school year folder and get all course IDs
    const schoolYearFolders = document.querySelectorAll('[id^="school-year-"]');
    let targetFolder = null;
    for (let folder of schoolYearFolders) {
        const header = folder.previousElementSibling;
        if (header && header.textContent.includes(schoolYearKey)) {
            targetFolder = folder;
            break;
        }
    }
    
    if (!targetFolder) {
        if (typeof showNotification === 'function') {
            showNotification('School year folder not found.', 'error');
        }
        return;
    }
    
    // Get all course IDs in this school year
    const courseCards = targetFolder.querySelectorAll('.course-card-wrapper[data-course-id]');
    const courseIds = new Set();
    courseCards.forEach(card => {
        const courseId = card.getAttribute('data-course-id');
        if (courseId) {
            courseIds.add(courseId);
        }
    });
    
    const courseIdsArray = Array.from(courseIds);
    
    if (courseIdsArray.length === 0) {
        if (typeof showNotification === 'function') {
            showNotification('No courses found in this school year.', 'error');
        }
        return;
    }
    
    // Send archive request
    fetch('{% url "dashboard:instructor_archive_school_year" %}', {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
            'X-CSRFToken': getCsrfToken(),
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        },
        body: JSON.stringify({ school_year: schoolYearKey, course_ids: courseIdsArray })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (typeof showNotification === 'function') {
                showNotification(data.message, 'success');
            }
            setTimeout(() => location.reload(), 800);
        } else {
            if (typeof showNotification === 'function') {
                showNotification(data.message, 'error');
            }
        }
    })
    .catch(error => {
        console.error('Error archiving school year:', error);
        if (typeof showNotification === 'function') {
            showNotification('An error occurred while archiving the school year.', 'error');
        }
    });
}

function deleteSchoolYearFolder(schoolYearKey) {
    const modal = document.getElementById('deleteSchoolYearModal');
    document.getElementById('delete-school-year-key').value = schoolYearKey;
    document.getElementById('delete-school-year-name').textContent = `School Year: ${schoolYearKey}`;
    modal.classList.remove('hidden');
}

function closeDeleteSchoolYearModal() {
    document.getElementById('deleteSchoolYearModal').classList.add('hidden');
}

function confirmDeleteSchoolYear() {
    const schoolYearKey = document.getElementById('delete-school-year-key').value;
    closeDeleteSchoolYearModal();
    
    // Find the school year folder and get all course IDs
    const schoolYearFolders = document.querySelectorAll('[id^="school-year-"]');
    let targetFolder = null;
    for (let folder of schoolYearFolders) {
        const header = folder.previousElementSibling;
        if (header && header.textContent.includes(schoolYearKey)) {
            targetFolder = folder;
            break;
        }
    }
    
    if (!targetFolder) {
        if (typeof showNotification === 'function') {
            showNotification('School year folder not found.', 'error');
        } else {
            alert('School year folder not found.');
        }
        return;
    }
    
    // Get all course IDs in this school year (from course cards)
    const courseCards = targetFolder.querySelectorAll('.course-card-wrapper[data-course-id]');
    const courseIds = new Set();
    courseCards.forEach(card => {
        const courseId = card.getAttribute('data-course-id');
        if (courseId) {
            courseIds.add(courseId);
        }
    });
    
    // Also check for grouped sections - if a course has grouped_sections, add all their IDs
    courseCards.forEach(card => {
        // Check if this is a multi-section course - we'll let the backend handle getting all sections
        const courseId = card.getAttribute('data-course-id');
        if (courseId) {
            courseIds.add(courseId);
        }
    });
    
    const courseIdsArray = Array.from(courseIds);
    
    if (courseIdsArray.length === 0) {
        if (typeof showNotification === 'function') {
            showNotification('No courses found in this school year.', 'error');
        } else {
            alert('No courses found in this school year.');
        }
        return;
    }
    
    // Send delete request for all courses (backend will handle getting all sections)
    fetch('{% url "dashboard:instructor_delete_semester" %}', {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
            'X-CSRFToken': getCsrfToken(),
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        },
        body: JSON.stringify({
            school_year: schoolYearKey,
            course_ids: courseIdsArray
        })
    })
    .then(response => response.json().catch(() => {
        throw new Error('Unable to delete school year at the moment.');
    }))
    .then(data => {
        if (!data.success) {
            throw new Error(data.message || 'Error deleting school year.');
        }
        if (typeof showNotification === 'function') {
            showNotification(data.message || `All courses in School Year "${schoolYearKey}" deleted successfully!`, 'success');
        }
        setTimeout(() => location.reload(), 800);
    })
    .catch(error => {
        console.error('Error deleting school year:', error);
        if (typeof showNotification === 'function') {
            showNotification(error.message || 'An error occurred while deleting the school year.', 'error');
        } else {
            alert(error.message || 'An error occurred while deleting the school year.');
        }
    });
}

// Delete entire semester folder (all courses in that semester)
function archiveSemesterFolder(yearIndex, semesterKey, yearKey, schoolYearKey) {
    const semesterDisplay = semesterKey === '1st' ? '1st Semester' : semesterKey === '2nd' ? '2nd Semester' : semesterKey === 'summer' ? 'Summer' : semesterKey;
    const modal = document.getElementById('archiveSemesterModal');
    document.getElementById('archive-semester-year-index').value = yearIndex;
    document.getElementById('archive-semester-key').value = semesterKey;
    document.getElementById('archive-semester-year-key').value = yearKey;
    document.getElementById('archive-semester-school-year-key').value = schoolYearKey;
    document.getElementById('archive-semester-name').textContent = `${schoolYearKey}, ${yearKey}, ${semesterDisplay}`;
    modal.classList.remove('hidden');
}

function closeArchiveSemesterModal() {
    document.getElementById('archiveSemesterModal').classList.add('hidden');
}

function confirmArchiveSemester() {
    const yearIndex = document.getElementById('archive-semester-year-index').value;
    const semesterKey = document.getElementById('archive-semester-key').value;
    const yearKey = document.getElementById('archive-semester-year-key').value;
    const schoolYearKey = document.getElementById('archive-semester-school-year-key').value;
    closeArchiveSemesterModal();
    
    // Get all course IDs in this semester
    const semesterFolderId = 'semester-' + yearIndex + '-' + semesterKey;
    let semesterFolder = document.getElementById(semesterFolderId);
    
    if (!semesterFolder) {
        const yearFolder = document.getElementById('year-' + yearIndex);
        if (yearFolder) {
            const allSemesterFolders = yearFolder.querySelectorAll('[id^="semester-' + yearIndex + '-"]');
            for (let folder of allSemesterFolders) {
                const header = folder.previousElementSibling;
                if (header && header.textContent.includes(semesterKey)) {
                    semesterFolder = folder;
                    break;
                }
            }
        }
    }
    
    if (!semesterFolder) {
        if (typeof showNotification === 'function') {
            showNotification('Semester folder not found.', 'error');
        }
        return;
    }
    
    const courseCards = semesterFolder.querySelectorAll('.course-card-wrapper[data-course-id]');
    const courseIds = new Set();
    courseCards.forEach(card => {
        const courseId = card.getAttribute('data-course-id');
        if (courseId) {
            courseIds.add(courseId);
        }
    });
    
    const courseIdsArray = Array.from(courseIds);
    
    if (courseIdsArray.length === 0) {
        if (typeof showNotification === 'function') {
            showNotification('No courses found in this semester.', 'error');
        }
        return;
    }
    
    // Send archive request
    fetch('{% url "dashboard:instructor_archive_semester" %}', {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
            'X-CSRFToken': getCsrfToken(),
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        },
        body: JSON.stringify({
            year_level: yearKey.replace('Year ', ''),
            semester: semesterKey,
            school_year: schoolYearKey,
            course_ids: courseIdsArray
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (typeof showNotification === 'function') {
                showNotification(data.message, 'success');
            }
            setTimeout(() => location.reload(), 800);
        } else {
            if (typeof showNotification === 'function') {
                showNotification(data.message, 'error');
            }
        }
    })
    .catch(error => {
        console.error('Error archiving semester:', error);
        if (typeof showNotification === 'function') {
            showNotification('An error occurred while archiving the semester.', 'error');
        }
    });
}

function deleteSemesterFolder(yearIndex, semesterKey, yearKey, schoolYearKey) {
    const semesterDisplay = semesterKey === '1st' ? '1st Semester' : semesterKey === '2nd' ? '2nd Semester' : semesterKey === 'summer' ? 'Summer' : semesterKey;
    const modal = document.getElementById('deleteSemesterModal');
    document.getElementById('delete-semester-year-index').value = yearIndex;
    document.getElementById('delete-semester-key').value = semesterKey;
    document.getElementById('delete-semester-year-key').value = yearKey;
    document.getElementById('delete-semester-school-year-key').value = schoolYearKey;
    document.getElementById('delete-semester-name').textContent = `${schoolYearKey}, ${yearKey}, ${semesterDisplay}`;
    modal.classList.remove('hidden');
}

function closeDeleteSemesterModal() {
    document.getElementById('deleteSemesterModal').classList.add('hidden');
}

function confirmDeleteSemester() {
    const yearIndex = document.getElementById('delete-semester-year-index').value;
    const semesterKey = document.getElementById('delete-semester-key').value;
    const yearKey = document.getElementById('delete-semester-year-key').value;
    const schoolYearKey = document.getElementById('delete-semester-school-year-key').value;
    closeDeleteSemesterModal();
    
    // Get all course IDs in this semester by finding the semester folder
    // yearIndex format: "school-year-X-year-Y" -> need to extract just the year part
    const yearParts = yearIndex.split('-');
    const semesterFolderId = 'semester-' + yearIndex + '-' + semesterKey;
    let semesterFolder = document.getElementById(semesterFolderId);
    
    if (!semesterFolder) {
        // Try to find by searching within the year folder
        const yearFolder = document.getElementById('year-' + yearIndex);
        if (yearFolder) {
            const allSemesterFolders = yearFolder.querySelectorAll('[id^="semester-' + yearIndex + '-"]');
            for (let folder of allSemesterFolders) {
                const header = folder.previousElementSibling;
                if (header && header.textContent.includes(semesterKey)) {
                    semesterFolder = folder;
                    break;
                }
            }
        }
    }
    
    if (!semesterFolder) {
        if (typeof showNotification === 'function') {
            showNotification('Semester folder not found.', 'error');
        } else {
            alert('Semester folder not found.');
        }
        return;
    }
    
    // Get all course IDs from course cards in this semester
    const courseCards = semesterFolder.querySelectorAll('.course-card-wrapper[data-course-id]');
    const courseIds = new Set();
    courseCards.forEach(card => {
        const courseId = card.getAttribute('data-course-id');
        if (courseId) {
            courseIds.add(courseId);
        }
    });
    
    const courseIdsArray = Array.from(courseIds);
    
    if (courseIdsArray.length === 0) {
        if (typeof showNotification === 'function') {
            showNotification('No courses found in this semester.', 'error');
        } else {
            alert('No courses found in this semester.');
        }
        return;
    }
    
    // Send delete request for all courses
    fetch('{% url "dashboard:instructor_delete_semester" %}', {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
            'X-CSRFToken': getCsrfToken(),
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        },
        body: JSON.stringify({
            year_level: yearKey.replace('Year ', ''),
            semester: semesterKey,
            school_year: schoolYearKey,
            course_ids: courseIdsArray
        })
    })
    .then(response => response.json().catch(() => {
        throw new Error('Unable to delete semester at the moment.');
    }))
    .then(data => {
        if (!data.success) {
            throw new Error(data.message || 'Error deleting semester.');
        }
        if (typeof showNotification === 'function') {
            showNotification(data.message || `All courses in ${semesterDisplay} deleted successfully!`, 'success');
        }
        setTimeout(() => location.reload(), 800);
    })
    .catch(error => {
        console.error('Error deleting semester:', error);
        if (typeof showNotification === 'function') {
            showNotification(error.message || 'An error occurred while deleting the semester.', 'error');
        } else {
            alert(error.message || 'An error occurred while deleting the semester.');
        }
    });
}

function closeDeleteCourseModal() {
    const modal = document.getElementById('deleteCourseModal');
    setTimeout(() => {
        modal.classList.add('hidden');
    }, 150);
}

function confirmDeleteCourse() {
    const idHolder = document.getElementById('delete-course-id');
    const cid = idHolder ? idHolder.value : '';
    if (!cid) {
        console.error('No course ID found for deletion');
        closeDeleteCourseModal();
        return;
    }
    
    const courseIdNum = parseInt(cid, 10);
    if (isNaN(courseIdNum) || courseIdNum <= 0) {
        console.error('Invalid course ID:', cid);
        if (typeof showNotification === 'function') {
            showNotification('Invalid course ID. Cannot delete course.', 'error');
        }
        closeDeleteCourseModal();
        return;
    }
    
    console.log('Deleting ALL sections of course with ID:', courseIdNum);
    
    // Delete all sections when deleting from course container
    deleteAllSections(courseIdNum);
    closeDeleteCourseModal();
}

// Close modals when clicking outside
document.getElementById('courseModal')?.addEventListener('click', function(e) {
    if (e.target === this) closeCourseModal();
});

document.getElementById('courseDetailModal')?.addEventListener('click', function(e) {
    if (e.target === this) closeCourseDetailModal();
});

document.getElementById('deleteCourseModal')?.addEventListener('click', function(e) {
    if (e.target === this) closeDeleteCourseModal();
});

// Restore folder state on page load
document.addEventListener('DOMContentLoaded', function() {
    // Wait a bit for the page to fully render
    setTimeout(() => {
        restoreFolderState();
        
        // Restore filter states for all year levels
        // Use a Set to track which years we've already restored to avoid duplicates
        const restoredYears = new Set();
        document.querySelectorAll('[id^="section-filter-"]').forEach(filter => {
            const filterId = filter.id;
            // Extract year number from filter ID (e.g., "section-filter-1" -> 1)
            const yearMatch = filterId.match(/(\d+)$/);
            if (yearMatch) {
                const year = parseInt(yearMatch[1]);
                if (!restoredYears.has(year)) {
                    restoredYears.add(year);
                    // Restore with a longer delay to ensure DOM is fully ready
                    setTimeout(() => {
                        restoreFilterState(year);
                    }, 200);
                }
            }
        });
    }, 150);
    
    // Wrap toggleYearFolder to restore filters when year folders are opened
    const originalToggleYearFolder = window.toggleYearFolder;
    if (typeof originalToggleYearFolder === 'function') {
        window.toggleYearFolder = function(yearId) {
            const result = originalToggleYearFolder.call(this, yearId);
            // Extract year number and restore filters
            const yearMatch = yearId.match(/(\d+)$/);
            if (yearMatch) {
                const year = parseInt(yearMatch[1]);
                setTimeout(() => {
                    restoreFilterState(year);
                }, 100);
            }
            return result;
        };
    }
    
    // Also listen for any filter changes to ensure they're always saved
    document.querySelectorAll('[id^="section-filter-"], [id^="school-year-filter-"]').forEach(filter => {
        filter.addEventListener('change', function() {
            const filterId = this.id;
            const yearMatch = filterId.match(/(\d+)$/);
            if (yearMatch) {
                const year = parseInt(yearMatch[1]);
                const sectionFilter = document.getElementById('section-filter-' + year);
                const schoolYearFilter = document.getElementById('school-year-filter-' + year);
                if (sectionFilter && schoolYearFilter) {
                    saveFilterState(year, sectionFilter.value, schoolYearFilter.value);
                }
            }
        });
    });
});
</script>
{% if auto_open_add_modal %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    if (typeof openAddCourseModal === 'function') {
        openAddCourseModal();
        try {
            const url = new URL(window.location.href);
            url.searchParams.delete('open_add_modal');
            const search = url.searchParams.toString();
            const newUrl = url.pathname + (search ? '?' + search : '') + (url.hash || '');
            window.history.replaceState({}, document.title, newUrl);
        } catch (e) {
            console.warn('Unable to clean modal param:', e);
        }
    }
});
</script>
{% endif %}
<script>
// Handle edit_course URL parameter
document.addEventListener('DOMContentLoaded', function() {
    try {
        const url = new URL(window.location.href);
        const editCourseId = url.searchParams.get('edit_course');
        if (editCourseId && typeof editCourse === 'function') {
            // Wait a bit for the page to fully load
            setTimeout(() => {
                editCourse(parseInt(editCourseId));
                // Clean up URL parameter
                url.searchParams.delete('edit_course');
                const search = url.searchParams.toString();
                const newUrl = url.pathname + (search ? '?' + search : '') + (url.hash || '');
                window.history.replaceState({}, document.title, newUrl);
            }, 300);
        }
    } catch (e) {
        console.warn('Unable to handle edit_course param:', e);
    }
});
</script>
<script>
document.addEventListener('DOMContentLoaded', renderColorPalette);
</script>
{% endblock %}


