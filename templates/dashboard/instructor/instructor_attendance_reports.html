{% extends 'dashboard/instructor/teacher.html' %}
{% load static %}

{% block title %}Attendance Reports{% endblock %}

{% block dashboard_content %}
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="{% static 'css/mobile_responsive.css' %}">

<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
    body { font-family: 'Inter', sans-serif; }
    
    ::-webkit-scrollbar {
        width: 10px;
        height: 10px;
    }
    ::-webkit-scrollbar-track {
        background: #f5f5f5;
        border-radius: 10px;
    }
    ::-webkit-scrollbar-thumb {
        background: #d1d5db;
        border-radius: 10px;
        border: 2px solid #f5f5f5;
    }
    ::-webkit-scrollbar-thumb:hover {
        background: #9ca3af;
    }
    
    .course-card-wrapper {
        animation: fadeInScale 0.4s ease-out;
        animation-fill-mode: both;
    }
    .course-card-wrapper:nth-child(1) { animation-delay: 0.05s; }
    .course-card-wrapper:nth-child(2) { animation-delay: 0.1s; }
    .course-card-wrapper:nth-child(3) { animation-delay: 0.15s; }
    .course-card-wrapper:nth-child(4) { animation-delay: 0.2s; }
    .course-card-wrapper:nth-child(5) { animation-delay: 0.25s; }
    .course-card-wrapper:nth-child(6) { animation-delay: 0.3s; }
    .course-card-wrapper:nth-child(n+7) { animation-delay: 0.35s; }
    
    @keyframes fadeInScale {
        from {
            opacity: 0;
            transform: scale(0.95) translateY(10px);
        }
        to {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
    }
    
    .course-card-block {
        position: relative;
        transform-style: preserve-3d;
        background: linear-gradient(135deg, var(--course-color-start, #3C4770) 0%, var(--course-color-end, #447294) 100%);
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .course-card-block:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.15);
    }
    
    .course-card-title {
        font-size: 0.95rem;
        font-weight: 700;
        color: white;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        word-wrap: break-word;
        overflow-wrap: break-word;
        hyphens: auto;
    }
    
    .course-card-meta {
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.9);
        font-weight: 500;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
    }
    
    .attendance-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .attendance-table thead {
        background-color: #f3f4f6;
    }
    
    .attendance-table th {
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: #374151;
        border-bottom: 2px solid #e5e7eb;
    }
    
    .attendance-table td {
        padding: 12px;
        border-bottom: 1px solid #e5e7eb;
        color: #6b7280;
    }
    
    .attendance-table tbody tr:hover {
        background-color: #f9fafb;
    }
    
    .date-folder-card {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }
    
    .date-folder-card:hover {
        box-shadow: 0 12px 16px -2px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
    }
    
    .date-folder-card.open .folder-content {
        max-height: 1000px;
        padding: 1rem;
    }
    
    .date-folder-card.open .folder-icon {
        transform: rotate(180deg);
    }
    
    .folder-icon {
        transition: transform 0.3s ease;
    }
    
    .status-badge {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 9999px;
        font-size: 12px;
        font-weight: 600;
    }
    
    .status-present {
        background-color: #d1fae5;
        color: #065f46;
    }
    
    .status-absent {
        background-color: #fee2e2;
        color: #991b1b;
    }
    
    .status-late {
        background-color: #fef3c7;
        color: #92400e;
    }
    
    .student-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 12px;
    }
</style>

<div class="p-4 md:p-8 bg-gradient-to-br from-gray-50 via-white to-gray-50 flex-grow rounded-2xl min-h-full" style="background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 50%, #f0f4f8 100%);">
    {% if selected_course %}
    <!-- Back Button Above the Card -->
    <div class="mb-4">
        <button onclick="goBackButton()" class="px-0 py-2 text-gray-700 hover:text-indigo-600 transition flex items-center gap-2 font-semibold">
            <i class="fas fa-arrow-left text-xs"></i>Back
        </button>
    </div>
    
    <!-- Selected Course Attendance View -->
    <div class="bg-white rounded-2xl shadow-xl border border-gray-200 mb-6 overflow-hidden">
        <!-- Header with Course Info -->
        <div class="bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-600 px-6 py-6 relative">
            
            <div>
                <p class="text-xs tracking-widest uppercase text-white/80 font-semibold mb-2">
                    {% if request.GET.date %}Attendance Details - {{ request.GET.date|stringformat:'s'|date:'M d, Y' }}{% else %}Attendance Report{% endif %}
                </p>
                <h1 class="text-2xl md:text-3xl font-bold text-white drop-shadow flex flex-wrap items-center gap-2 truncate" title="{{ selected_course.code }} • {{ selected_course.name }}">
                    {{ selected_course.code }} <span class="text-white/70 text-2xl">•</span> {{ selected_course.name }}
                </h1>
                <div class="flex flex-wrap items-center gap-3 text-sm text-white/80 mt-2">
                    <span class="flex items-center gap-1"><i class="fas fa-list text-xs"></i>Total Records: {{ attendance_data|length }}</span>
                </div>
            </div>
        </div>

        <!-- Attendance by Date (Folder View) - Only show when no specific date selected -->
        {% if not request.GET.date %}
        <div class="p-6">
            {% if attendance_data %}
            <div class="mb-6">
                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-3">
                    <div class="w-1 h-8 bg-gradient-to-b from-indigo-600 to-purple-600 rounded-full"></div>
                    Attendance Records by Date
                </h2>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                {% regroup attendance_data|dictsort:"attendance_date" by attendance_date as records_by_date %}
                {% for date, records in records_by_date %}
                <div class="date-folder-card group rounded-xl shadow-md hover:shadow-xl transition-all duration-300 cursor-pointer folder-clickable" 
                     data-folder-date="{{ date|date:'Y-m-d' }}"
                     data-course-id="{{ selected_course.id }}">
                    <!-- Folder Header -->
                    <div class="bg-gradient-to-br from-amber-50 to-orange-50 border-t-4 border-amber-400 rounded-t-xl p-5 hover:bg-amber-100/50 transition-colors group-hover:shadow-lg">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-4">
                                <div class="w-14 h-14 bg-gradient-to-br from-amber-400 to-orange-500 rounded-lg flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform">
                                    <i class="fas fa-folder text-white text-2xl"></i>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-600 uppercase tracking-wide">{{ date|date:"l" }}</p>
                                    <p class="text-xl font-bold text-gray-900">{{ date|date:"M d, Y" }}</p>
                                </div>
                            </div>
                            <div class="text-center">
                                <p class="text-3xl font-bold text-amber-600">{{ records|length }}</p>
                                <p class="text-xs text-gray-600 font-medium">Records</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Folder Footer - Click Hint -->
                        <div class="bg-white border border-t-0 border-gray-200 rounded-b-xl p-4 flex items-center justify-between">
                            <p class="text-sm text-gray-600 flex items-center justify-center gap-2">
                                <i class="fas fa-arrow-right text-indigo-600"></i>Click to view details
                            </p>
                            <a href="{% url 'dashboard:instructor_attendance_reports_download' %}?course={{ selected_course.id }}&date={{ date|date:'Y-m-d' }}" class="inline-flex items-center gap-2 text-sm text-gray-700 hover:text-green-600" onclick="event.stopPropagation();">
                                <i class="fas fa-download text-gray-500"></i>
                                <span class="text-xs font-semibold">Download</span>
                            </a>
                        </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="flex items-center justify-center p-16 text-center">
                <div>
                    <div class="w-16 h-16 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-inbox text-3xl text-gray-400"></i>
                    </div>
                    <p class="text-xl font-semibold text-gray-700">No attendance records found</p>
                    <p class="text-sm text-gray-500 mt-2">Students and their attendance will appear here once they are marked.</p>
                </div>
            </div>
            {% endif %}
        </div>
        {% else %}
        <!-- Attendance Details for Selected Date -->
        <div class="p-6">
            {% if attendance_data %}
            <div class="mb-6 flex items-center justify-between">
                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-3">
                    <div class="w-1 h-8 bg-gradient-to-b from-indigo-600 to-purple-600 rounded-full"></div>
                    Attendance Details
                </h2>
                <a href="{% url 'dashboard:instructor_attendance_reports_download' %}?course={{ selected_course.id }}&date={{ request.GET.date }}" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg text-sm font-semibold transition flex items-center gap-2">
                    <i class="fas fa-download text-xs"></i>Download Excel
                </a>
            </div>
            
            <div class="space-y-3">
                {% for record in attendance_data %}
                <div class="flex items-center justify-between p-4 bg-gradient-to-r from-gray-50 to-gray-100 rounded-lg hover:from-gray-100 hover:to-gray-150 transition border border-gray-200" data-section="{{ record.section }}" data-date="{{ record.attendance_date|date:'Y-m-d' }}">
                    <div class="flex-1">
                        <div class="flex items-center gap-3 mb-2">
                            {% if record.student_profile_picture %}
                                <img src="{{ record.student_profile_picture }}" alt="{{ record.student_name }}" class="w-10 h-10 rounded-full object-cover shadow-sm">
                            {% else %}
                                <div class="student-avatar w-10 h-10 flex items-center justify-center text-sm font-bold text-white bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full">{{ record.student_name|first }}</div>
                            {% endif %}
                            <div class="flex-1">
                                <span class="font-semibold text-gray-900 block">{{ record.student_name }}</span>
                                <span class="text-sm text-gray-600">ID: {{ record.student_id_number }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-4 ml-4">
                        <div class="text-right">
                            <p class="text-sm text-gray-600 font-medium">
                                {% if record.attendance_time %}
                                    {{ record.attendance_time|time:"g:i A" }}
                                {% else %}
                                    —
                                {% endif %}
                            </p>
                        </div>
                        {% if record.status == 'present' %}
                            <span class="status-badge status-present text-sm px-4 py-2">✓ Present</span>
                        {% elif record.status == 'absent' %}
                            <span class="status-badge status-absent text-sm px-4 py-2">✗ Absent</span>
                        {% elif record.status == 'late' %}
                            <span class="status-badge status-late text-sm px-4 py-2">⏱ Late</span>
                        {% else %}
                            <span class="text-gray-500 text-sm bg-gray-200 px-4 py-2 rounded-full font-medium">{{ record.status|title }}</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="flex items-center justify-center p-16 text-center">
                <div>
                    <div class="w-16 h-16 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-inbox text-3xl text-gray-400"></i>
                    </div>
                    <p class="text-xl font-semibold text-gray-700">No attendance records for this date</p>
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}
    </div>
    {% else %}
    <!-- Subjects Selection View -->
    <div class="bg-gradient-to-r from-rose-400 via-orange-300 to-sky-400 rounded-2xl shadow-2xl mb-6 p-6 md:p-8 relative overflow-hidden">
        <div class="absolute top-0 right-0 w-64 h-64 bg-white opacity-10 rounded-full -mr-32 -mt-32"></div>
        <div class="absolute bottom-0 left-0 w-48 h-48 bg-white opacity-10 rounded-full -ml-24 -mb-24"></div>
        <div class="relative z-10">
            <h1 class="text-3xl md:text-4xl font-bold text-white mb-2 drop-shadow-lg flex items-center gap-3">
                <i class="fas fa-file-alt text-3xl"></i>
                Attendance Reports
            </h1>
            <p class="text-white/90 text-base font-medium">Select a subject to view attendance records</p>
        </div>
    </div>

    {% if grouped_courses %}
    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-5">
        {% for course in grouped_courses %}
        <div class="course-card-wrapper" data-course-id="{{ course.id }}">
            <div class="course-card-block group rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-300 text-center py-8 px-4 min-h-[140px] flex flex-col justify-center items-center relative overflow-hidden border-2 border-white/20 cursor-pointer"
                 style="--course-color-start: #3C4770; --course-color-end: #447294; background: linear-gradient(135deg, #3C4770 0%, #447294 100%);"
                 data-course-id="{{ course.id }}">
                <!-- Decorative Pattern Overlay -->
                <div class="absolute inset-0 opacity-10">
                    <div class="absolute top-0 right-0 w-20 h-20 bg-white rounded-full -mr-10 -mt-10"></div>
                    <div class="absolute bottom-0 left-0 w-16 h-16 bg-white rounded-full -ml-8 -mb-8"></div>
                </div>
                
                <!-- Course Code with Icon -->
                <div class="relative z-10 w-full flex flex-col items-center">
                    <div class="mb-2 text-3xl">
                        <i class="fas fa-book text-white/90"></i>
                    </div>
                    <h3 class="course-card-title text-white leading-tight px-2 text-center line-clamp-2 font-bold">
                        {{ course.code }}
                    </h3>
                    <p class="course-card-meta text-white/75 text-xs mt-2 line-clamp-2 px-2">
                        {{ course.name }}
                    </p>
                    {% if course.semester %}
                    <p class="course-card-meta text-white/60 text-xs mt-1">
                        {{ course.semester }}
                    </p>
                    {% endif %}
                </div>

                <!-- Hover Effect Indicator -->
                <div class="absolute bottom-0 left-0 right-0 h-1 bg-white/30 transform scale-x-0 group-hover:scale-x-100 transition-transform duration-300"></div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-16 bg-white rounded-2xl shadow-lg border border-gray-200">
        <div class="w-24 h-24 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center">
            <i class="fas fa-book-open text-4xl text-gray-400"></i>
        </div>
        <p class="text-xl font-semibold text-gray-700">No subjects found</p>
        <p class="text-sm text-gray-500 mt-2">You don't have any active subjects</p>
    </div>
    {% endif %}
    {% endif %}
</div>

<script>
    // Handle course card clicks - wait for DOM to be ready
    function attachCardClickListeners() {
        const cards = document.querySelectorAll('.course-card-block');
        console.log('Found ' + cards.length + ' course cards');
        cards.forEach(card => {
            card.addEventListener('click', function(event) {
                event.preventDefault();
                event.stopPropagation();
                const courseId = this.getAttribute('data-course-id');
                console.log('Card clicked, courseId:', courseId);
                if (courseId) {
                    window.location.href = "?course=" + courseId;
                }
            });
        });
    }

    // Attach listeners when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', attachCardClickListeners);
    } else {
        attachCardClickListeners();
    }

    function selectCourse(courseId, event) {
        if (event) {
            event.preventDefault();
        }
        window.location.href = "?course=" + courseId;
    }

    function clearCourse() {
        window.location.href = window.location.pathname;
    }

    function toggleDateFolder(event, card) {
        event.stopPropagation();
        card.classList.toggle('open');
    }

    function goBackButton() {
        const params = new URLSearchParams(window.location.search);
        if (params.has('date')) {
            // If date is selected, go back to folder list
            const courseId = params.get('course');
            window.location.href = "?course=" + courseId;
        } else {
            // Otherwise go back to subject list
            clearCourse();
        }
    }

    function attachDownloadListeners() {
        const downloadBtns = document.querySelectorAll('.download-date-btn');
        downloadBtns.forEach(btn => {
            btn.addEventListener('click', function(event) {
                event.stopPropagation();
                const date = this.getAttribute('data-date');
                downloadExcelByDate(date);
            });
        });
    }

    function attachFolderClickListeners() {
        const folderCards = document.querySelectorAll('.folder-clickable');
        folderCards.forEach(card => {
            card.addEventListener('click', function(event) {
                event.stopPropagation();
                const date = this.getAttribute('data-folder-date');
                const courseId = this.getAttribute('data-course-id');
                if (date && courseId) {
                    window.location.href = "?course=" + courseId + "&date=" + date;
                }
            });
        });
    }

    function downloadExcelByDate(date) {
        // Find the folder for this date
        const folderCard = document.querySelector('[data-folder-date="' + date + '"]');
        if (!folderCard) {
            alert('Folder not found');
            return;
        }

        // Determine course/subject name for the sheet header
        const courseCode = document.querySelector('h1.text-2xl');
        const courseName = courseCode ? courseCode.textContent.split('•')[0].trim() : 'Course';

        const rows = [];
        // First row: Subject
        rows.push(['Subject', courseName]);
        // Blank row for spacing
        rows.push([]);
        const headerRow = ['#', 'Student', 'ID Number', 'Date', 'Time', 'Status', 'Section'];
        rows.push(headerRow);

        // Get all records from this folder
        const records = folderCard.querySelectorAll('.folder-content .flex.items-center.justify-between');
        let counter = 1;
        
        records.forEach(record => {
            const nameEl = record.querySelector('.font-semibold');
            const idEl = record.querySelector('.text-xs.text-gray-500');
            const timeEl = Array.from(record.querySelectorAll('.text-xs')).find(el => el.textContent.includes(':') || el.textContent === '—');
            const statusEl = record.querySelector('[class*="status-badge"], [class*="status-"], .text-gray-500.text-xs');
            
            if (nameEl) {
                const row = [
                    counter++,
                    nameEl.textContent.trim(),
                    idEl ? idEl.textContent.trim() : '—',
                    new Date(date).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }),
                    timeEl ? timeEl.textContent.trim() : '—',
                    statusEl ? statusEl.textContent.trim() : '—',
                    '' // Section column (empty for now)
                ];
                rows.push(row);
            }
        });

        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(rows);
        
        ws['!cols'] = [
            { wch: 5 },
            { wch: 25 },
            { wch: 15 },
            { wch: 15 },
            { wch: 12 },
            { wch: 12 },
            { wch: 12 }
        ];

        // Style header row (make bold) and highlight status cells
        try {
            // Header is at row index 2 (0-based) because we added Subject + blank rows
            const headerRowIndex = 2;
            const statusColIndex = 5; // zero-based
            const range = XLSX.utils.decode_range(ws['!ref']);

            // Bold header cells
            for (let c = range.s.c; c <= range.e.c; ++c) {
                const addr = XLSX.utils.encode_cell({ c: c, r: headerRowIndex });
                if (!ws[addr]) continue;
                ws[addr].s = ws[addr].s || {};
                ws[addr].s.font = Object.assign({}, ws[addr].s.font, { bold: true });
            }

            // Color status cells based on value
            for (let r = headerRowIndex + 1; r <= range.e.r; ++r) {
                const addr = XLSX.utils.encode_cell({ c: statusColIndex, r: r });
                const cell = ws[addr];
                if (!cell) continue;
                const val = (cell.v || '').toString().toLowerCase();
                let fillColor = null;
                let fontColor = null;
                if (val.includes('present') || val.includes('✓')) {
                    fillColor = 'FFD1FAE5'; // light green
                    fontColor = 'FF065F46';
                } else if (val.includes('absent') || val.includes('✗')) {
                    fillColor = 'FFFEE2E2'; // light red
                    fontColor = 'FF991B1B';
                } else if (val.includes('late') || val.includes('⏱')) {
                    fillColor = 'FFFEF3C7'; // light yellow
                    fontColor = 'FF92400E';
                }
                if (fillColor) {
                    cell.s = cell.s || {};
                    cell.s.fill = { fgColor: { rgb: fillColor } };
                    cell.s.font = Object.assign({}, cell.s.font, { color: { rgb: fontColor }, bold: true });
                }
            }
        } catch (e) {
            // Styling may not be supported in some environments; fail gracefully
            console.warn('Excel styling failed', e);
        }

        XLSX.utils.book_append_sheet(wb, ws, "Attendance");

        const filename = `Attendance_${courseName}_${date}.xlsx`;
        XLSX.writeFile(wb, filename);
    }

    function downloadExcelByDateDetail() {
        const params = new URLSearchParams(window.location.search);
        const date = params.get('date');
        const courseCode = document.querySelector('h1.text-2xl');
        const courseName = courseCode ? courseCode.textContent.split('•')[0].trim() : 'Course';
        
        const rows = [];
        // Subject row + blank row + header
        rows.push(['Subject', courseName]);
        rows.push([]);
        const headerRow = ['#', 'Student', 'ID Number', 'Date', 'Time', 'Status', 'Section'];
        rows.push(headerRow);

        // Get all records from the detail view
        const records = document.querySelectorAll('.flex.items-center.justify-between[class*="bg-gradient"]');
        let counter = 1;
        
        records.forEach(record => {
            const nameEl = record.querySelector('.font-semibold');
            if (nameEl) {
                const idEl = record.querySelector('.text-gray-600');
                const timeEl = record.querySelector('.text-sm.text-gray-600.font-medium');
                const statusEl = record.querySelector('[class*="status-badge"], [class*="status-"]');
                const section = record.getAttribute('data-section') || '';
                const recordDate = record.getAttribute('data-date') || date;
                
                const row = [
                    counter++,
                    nameEl.textContent.trim(),
                    idEl ? idEl.textContent.replace('ID: ', '').trim() : '—',
                    recordDate ? new Date(recordDate).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) : '—',
                    timeEl ? timeEl.textContent.trim() : '—',
                    statusEl ? statusEl.textContent.trim() : '—',
                    section || '—'
                ];
                rows.push(row);
            }
        });

        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(rows);
        
        // Add table style
        ws['!cols'] = [
            { wch: 5 },
            { wch: 25 },
            { wch: 15 },
            { wch: 15 },
            { wch: 12 },
            { wch: 12 },
            { wch: 12 }
        ];

        // Apply header bold and status highlight similar to folder export
        try {
            const headerRowIndex = 2;
            const statusColIndex = 5;
            const range = XLSX.utils.decode_range(ws['!ref']);

            for (let c = range.s.c; c <= range.e.c; ++c) {
                const addr = XLSX.utils.encode_cell({ c: c, r: headerRowIndex });
                if (!ws[addr]) continue;
                ws[addr].s = ws[addr].s || {};
                ws[addr].s.font = Object.assign({}, ws[addr].s.font, { bold: true });
            }

            for (let r = headerRowIndex + 1; r <= range.e.r; ++r) {
                const addr = XLSX.utils.encode_cell({ c: statusColIndex, r: r });
                const cell = ws[addr];
                if (!cell) continue;
                const val = (cell.v || '').toString().toLowerCase();
                let fillColor = null;
                let fontColor = null;
                if (val.includes('present') || val.includes('✓')) {
                    fillColor = 'FFD1FAE5';
                    fontColor = 'FF065F46';
                } else if (val.includes('absent') || val.includes('✗')) {
                    fillColor = 'FFFEE2E2';
                    fontColor = 'FF991B1B';
                } else if (val.includes('late') || val.includes('⏱')) {
                    fillColor = 'FFFEF3C7';
                    fontColor = 'FF92400E';
                }
                if (fillColor) {
                    cell.s = cell.s || {};
                    cell.s.fill = { fgColor: { rgb: fillColor } };
                    cell.s.font = Object.assign({}, cell.s.font, { color: { rgb: fontColor }, bold: true });
                }
            }
        } catch (e) {
            console.warn('Excel styling failed', e);
        }

        XLSX.utils.book_append_sheet(wb, ws, "Attendance");
        
        const filename = `Attendance_${courseName}_${date}.xlsx`;
        XLSX.writeFile(wb, filename);
    }

    // Attach all listeners when DOM is ready
    function attachAllListeners() {
        attachCardClickListeners();
        attachDownloadListeners();
        attachFolderClickListeners();
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', attachAllListeners);
    } else {
        attachAllListeners();
    }
</script>

{% endblock %}
