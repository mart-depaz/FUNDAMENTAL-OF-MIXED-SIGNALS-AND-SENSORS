{% extends 'dashboard/student/student.html' %}
{% block title %}Related{% endblock %}
{% block dashboard_content %}
<!-- Notification System -->
{% include 'dashboard/shared/notification_system.html' %}

<div class="max-w-7xl mx-auto space-y-3 px-1">
    <div class="bg-white rounded-lg shadow-sm p-2 md:p-3 border border-gray-100">
        <div class="flex items-center justify-between">
            <h2 class="text-xl font-bold text-gray-900">My Attendance</h2>
            <a href="{% url 'dashboard:weekly_timetable' %}" class="text-xs text-indigo-600 font-semibold hover:underline">Go to Timetable</a>
        </div>
        <p class="text-sm text-gray-600 mt-1">View your classes for today and quickly scan QR codes for attendance.</p>
    </div>
    
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-3 md:gap-4" style="align-items: start;">
        <div class="bg-white rounded-lg shadow-sm p-2 md:p-3 border border-gray-100 flex flex-col">
            <h3 class="text-xs md:text-sm font-semibold text-gray-800 mb-2 flex-shrink-0">Quick Pick</h3>
            <div class="space-y-2 overflow-y-auto" style="height: calc(5 * 4.5rem); max-height: calc(5 * 4.5rem);">
                {% if schedule_entries %}
                    {% for e in schedule_entries %}
                    <a href="?course={{ e.course_id }}&schedule={{ e.schedule_id }}" 
                       class="quick-pick-item flex items-center justify-between p-3 rounded-xl border transition border-gray-200 no-underline hover:no-underline flex-shrink-0 {% if focus_schedule_id and focus_schedule_id == e.schedule_id %}border-indigo-500 bg-indigo-50 shadow-md{% else %}hover:border-indigo-300 hover:bg-indigo-50/40{% endif %}"
                       data-course-id="{{ e.course_id }}"
                       data-schedule-id="{{ e.schedule_id }}">
                        <div class="min-w-0">
                            {% if e.section %}
                            <p class="mb-1">
                                <span class="px-2 py-0.5 rounded-full font-bold text-[10px] text-white" style="background-color: {{ e.color }};">Section {{ e.section }}</span>
                            </p>
                            {% endif %}
                            <p class="text-sm font-semibold text-gray-900 truncate">{{ e.code }} • {{ e.name }}</p>
                            <p class="text-[11px] text-gray-600 uppercase tracking-wide mt-0.5 truncate">{{ e.date_label }} • {{ e.time_label }}</p>
                        </div>
                        {% comment %} Quick Pick shows course status, not attendance status {% endcomment %}
                        {% if e.status == 'live' %}
                            <span class="ml-3 flex-shrink-0 px-2 py-0.5 rounded-full text-[10px] font-bold bg-green-100 text-green-700 uppercase">Live</span>
                        {% elif e.status == 'starting_today' %}
                            <span class="ml-3 flex-shrink-0 px-2 py-0.5 rounded-full text-[10px] font-bold bg-blue-100 text-blue-700 uppercase">Starting Today</span>
                        {% elif e.status == 'tomorrow' %}
                            <span class="ml-3 flex-shrink-0 px-2 py-0.5 rounded-full text-[10px] font-bold bg-orange-100 text-orange-700 uppercase">Tomorrow</span>
                        {% elif e.status == 'upcoming' %}
                            <span class="ml-3 flex-shrink-0 px-2 py-0.5 rounded-full text-[10px] font-bold bg-yellow-100 text-yellow-700 uppercase">Upcoming</span>
                        {% elif e.status == 'soon' %}
                            <span class="ml-3 flex-shrink-0 px-2 py-0.5 rounded-full text-[10px] font-bold bg-purple-100 text-purple-700 uppercase">Soon</span>
                        {% elif e.status == 'ongoing' %}
                            <span class="ml-3 flex-shrink-0 px-2 py-0.5 rounded-full text-[10px] font-bold bg-indigo-100 text-indigo-700 uppercase">Ongoing</span>
                        {% else %}
                            <span class="ml-3 flex-shrink-0 px-2 py-0.5 rounded-full text-[10px] font-bold bg-gray-100 text-gray-600 uppercase">Finished</span>
                        {% endif %}
                    </a>
                    {% endfor %}
                {% else %}
                    <p class="text-xs text-gray-500">No active schedules yet.</p>
                {% endif %}
            </div>
        </div>
        
        <div class="lg:col-span-2 bg-white rounded-lg shadow-sm p-2 md:p-3 border border-gray-100 flex flex-col">
            <div class="flex items-center justify-between mb-2 flex-shrink-0">
                <h3 class="text-sm font-semibold text-gray-800">Monitoring</h3>
                {% if focus_course %}
                <span class="px-2 py-1 rounded-lg text-xs font-semibold text-white" style="background-color: {{ focus_course.color|default:'#3C4770' }};">
                    Section {{ focus_course.section|default:'—' }}
                </span>
                {% endif %}
            </div>
            <div class="space-y-3 flex-1 overflow-y-auto" style="min-height: 0;">
                {% if focus_course %}
                <!-- Course Info -->
                <div class="p-3 rounded-xl border border-gray-200" style="background-color: {{ focus_course.color|default:'#3C4770' }};">
                    <div class="flex items-center justify-between gap-3">
                        <div>
                            <p class="text-xs text-white font-semibold mb-1">{{ focus_course.code }} - {{ focus_course.name }}</p>
                            <p class="text-xs text-white/90">Room: {{ focus_course.room|default:'TBA' }}</p>
                        </div>
                        {% if focus_course_next_entry %}
                        <div class="text-right">
                            <p class="text-[11px] text-white font-semibold whitespace-nowrap">{{ focus_course_next_entry.date_label }}</p>
                            <p class="text-[11px] text-white/90 whitespace-nowrap">{{ focus_course_next_entry.time_label }}</p>
                        </div>
                        {% endif %}
                    </div>
                    <div class="flex items-center justify-between gap-3 mt-2">
                        <p class="text-xs text-white/90">Semester: {{ focus_course.semester|default:'—' }} • SY: {{ focus_course.school_year|default:'—' }}</p>
                    </div>
                </div>
                
                <!-- Attendance Status -->
                <div class="p-4 rounded-xl border border-gray-200 bg-gradient-to-r from-indigo-50 to-purple-50">
                    <div class="flex items-center justify-between mb-3">
                        <p class="text-xs font-semibold text-gray-700 uppercase tracking-wider">Attendance Status{% if focus_course_next_entry and focus_course_next_entry.day_label %} ({{ focus_course_next_entry.day_label }}){% endif %}</p>
                        {% if focus_course_next_entry and focus_course_next_entry.attendance_status %}
                            {% if focus_course_next_entry.attendance_status == 'open' %}
                            <span class="px-2 py-1 rounded-full text-[10px] font-bold bg-green-100 text-green-700">Open</span>
                            {% elif focus_course_next_entry.attendance_status == 'closed' %}
                            <span class="px-2 py-1 rounded-full text-[10px] font-bold bg-gray-100 text-gray-700">Closed</span>
                            {% elif focus_course_next_entry.attendance_status == 'stopped' %}
                            <span class="px-2 py-1 rounded-full text-[10px] font-bold bg-red-100 text-red-700">Stopped</span>
                            {% elif focus_course_next_entry.attendance_status == 'postponed' %}
                            <span class="px-2 py-1 rounded-full text-[10px] font-bold bg-yellow-100 text-yellow-700">Postponed</span>
                            {% else %}
                            <span class="px-2 py-1 rounded-full text-[10px] font-bold bg-gray-100 text-gray-700">Closed</span>
                            {% endif %}
                        {% else %}
                            {% if focus_course.attendance_status == 'open' %}
                            <span class="px-2 py-1 rounded-full text-[10px] font-bold bg-green-100 text-green-700">Open</span>
                            {% elif focus_course.attendance_status == 'closed' %}
                            <span class="px-2 py-1 rounded-full text-[10px] font-bold bg-gray-100 text-gray-700">Closed</span>
                            {% elif focus_course.attendance_status == 'stopped' %}
                            <span class="px-2 py-1 rounded-full text-[10px] font-bold bg-red-100 text-red-700">Stopped</span>
                            {% elif focus_course.attendance_status == 'postponed' %}
                            <span class="px-2 py-1 rounded-full text-[10px] font-bold bg-yellow-100 text-yellow-700">Postponed</span>
                            {% else %}
                            <span class="px-2 py-1 rounded-full text-[10px] font-bold bg-gray-100 text-gray-700">Closed</span>
                            {% endif %}
                        {% endif %}
                    </div>
                    
                    <!-- Attendance Control Status Display -->
                    {% if focus_course_next_entry %}
                    <div class="mt-3 p-3 bg-white rounded-lg border-2 {% if focus_course_next_entry.attendance_status == 'open' %}border-green-300 bg-green-50{% elif focus_course_next_entry.attendance_status == 'closed' %}border-red-300 bg-red-50{% elif focus_course_next_entry.attendance_status == 'stopped' %}border-orange-300 bg-orange-50{% elif focus_course_next_entry.attendance_status == 'postponed' %}border-yellow-300 bg-yellow-50{% else %}border-gray-300 bg-gray-50{% endif %}">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs font-semibold text-gray-600 uppercase tracking-wider mb-1">Attendance Control</p>
                                <p class="text-sm font-bold {% if focus_course_next_entry.attendance_status == 'open' %}text-green-700{% elif focus_course_next_entry.attendance_status == 'closed' %}text-red-700{% elif focus_course_next_entry.attendance_status == 'stopped' %}text-orange-700{% elif focus_course_next_entry.attendance_status == 'postponed' %}text-yellow-700{% else %}text-gray-700{% endif %}">
                                    {% if focus_course_next_entry.attendance_status == 'open' %}
                                        <i class="fas fa-check-circle"></i> Open
                                    {% elif focus_course_next_entry.attendance_status == 'closed' %}
                                        <i class="fas fa-times-circle"></i> Closed
                                    {% elif focus_course_next_entry.attendance_status == 'stopped' %}
                                        <i class="fas fa-stop-circle"></i> Stopped
                                    {% elif focus_course_next_entry.attendance_status == 'postponed' %}
                                        <i class="fas fa-pause-circle"></i> Postponed
                                    {% else %}
                                        Closed
                                    {% endif %}
                                </p>
                            </div>
                            {% if focus_course_next_entry.attendance_status == 'open' %}
                                <span class="px-3 py-1.5 rounded-full text-xs font-bold bg-green-100 text-green-700">OPEN</span>
                            {% elif focus_course_next_entry.attendance_status == 'closed' %}
                                <span class="px-3 py-1.5 rounded-full text-xs font-bold bg-red-100 text-red-700">CLOSED</span>
                            {% elif focus_course_next_entry.attendance_status == 'stopped' %}
                                <span class="px-3 py-1.5 rounded-full text-xs font-bold bg-orange-100 text-orange-700">STOPPED</span>
                            {% elif focus_course_next_entry.attendance_status == 'postponed' %}
                                <span class="px-3 py-1.5 rounded-full text-xs font-bold bg-yellow-100 text-yellow-700">POSTPONED</span>
                            {% else %}
                                <span class="px-3 py-1.5 rounded-full text-xs font-bold bg-red-100 text-red-700">CLOSED</span>
                            {% endif %}
                        </div>
                        <!-- Student-visible present window countdown -->
                        <div id="student-active-window-display" class="mt-3 text-xs font-semibold text-indigo-600 min-w-12 text-center hidden">
                            <div class="text-sm font-bold"><span id="student-window-time">—</span></div>
                            <div class="text-[11px] text-indigo-700 mt-1" id="student-window-minutes" style="display:none">—</div>
                            <p class="text-[10px] text-gray-500 mt-1">Present window</p>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Student Attendance Status Display in Monitoring -->
                    {% if student_attendance_today and show_student_status %}
                    <div id="student-your-status" class="mt-3 p-3 bg-white rounded-lg border-2 {% if student_attendance_today.status == 'present' %}border-green-300 bg-green-50{% elif student_attendance_today.status == 'late' %}border-yellow-300 bg-yellow-50{% elif student_attendance_today.status == 'absent' %}border-red-300 bg-red-50{% else %}border-gray-300 bg-gray-50{% endif %}">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs font-semibold text-gray-600 uppercase tracking-wider mb-1">Your Status</p>
                                <p class="text-sm font-bold {% if student_attendance_today.status == 'present' %}text-green-700{% elif student_attendance_today.status == 'late' %}text-yellow-700{% elif student_attendance_today.status == 'absent' %}text-red-700{% else %}text-gray-700{% endif %}">
                                    {% if student_attendance_today.status == 'present' %}
                                        <i class="fas fa-check-circle"></i> Present
                                    {% elif student_attendance_today.status == 'late' %}
                                        <i class="fas fa-clock"></i> Late
                                    {% elif student_attendance_today.status == 'absent' %}
                                        <i class="fas fa-times-circle"></i> Absent
                                    {% else %}
                                        {{ student_attendance_today.status|title }}
                                    {% endif %}
                                </p>
                            </div>
                            {% if student_attendance_today.status == 'present' %}
                                <span class="px-3 py-1.5 rounded-full text-xs font-bold bg-green-100 text-green-700">PRESENT</span>
                            {% elif student_attendance_today.status == 'late' %}
                                <span class="px-3 py-1.5 rounded-full text-xs font-bold bg-yellow-100 text-yellow-700">LATE</span>
                            {% elif student_attendance_today.status == 'absent' %}
                                <span class="px-3 py-1.5 rounded-full text-xs font-bold bg-red-100 text-red-700">ABSENT</span>
                            {% else %}
                                <span class="px-3 py-1.5 rounded-full text-xs font-bold bg-gray-100 text-gray-700">{{ student_attendance_today.status|upper }}</span>
                            {% endif %}
                        </div>
                        <p class="text-xs text-gray-600 mt-2">
                            Scanned at: {{ student_attendance_today.attendance_time|time:"g:i A" }}
                        </p>
                    </div>
                    {% else %}
                    <div id="student-your-status" class="mt-3 p-3 bg-white rounded-lg border-2 border-gray-300 bg-gray-50">
                        <p class="text-xs font-semibold text-gray-600 uppercase tracking-wider mb-1">Your Status</p>
                        <p class="text-sm font-bold text-gray-500 mb-2">Not yet marked</p>
                        {% if focus_course_next_entry %}
                            {% if focus_course_next_entry.status == 'live' %}
                                <p class="text-xs text-green-600 italic font-medium">
                                    <i class="fas fa-circle text-green-500 mr-1 animate-pulse"></i>Class is live now. Scan the QR code to mark your attendance.
                                </p>
                            {% elif focus_course_next_entry.status == 'starting_today' %}
                                <p class="text-xs text-blue-600 italic font-medium">
                                    <i class="fas fa-info-circle mr-1"></i>Class starts today. Scan the QR code when the class begins.
                                </p>
                            {% elif focus_course_next_entry.status == 'tomorrow' %}
                                <p class="text-xs text-orange-600 italic font-medium">
                                    <i class="fas fa-calendar-day mr-1"></i>This class is scheduled for tomorrow. Scan the QR code tomorrow during class time for attendance.
                                </p>
                            {% elif focus_course_next_entry.status == 'upcoming' %}
                                <p class="text-xs text-yellow-600 italic font-medium">
                                    <i class="fas fa-clock mr-1"></i>Class is upcoming. Scan the QR code during the scheduled class time.
                                </p>
                            {% elif focus_course_next_entry.status == 'soon' %}
                                <p class="text-xs text-purple-600 italic font-medium">
                                    <i class="fas fa-hourglass-half mr-1"></i>Class is scheduled soon. Scan the QR code during class time.
                                </p>
                            {% elif focus_course_next_entry.status == 'ongoing' %}
                                <p class="text-xs text-indigo-600 italic font-medium">
                                    <i class="fas fa-chalkboard-teacher mr-1"></i>Course is ongoing. Scan the QR code during scheduled class time.
                                </p>
                            {% elif focus_course_next_entry.status == 'finished' or course_finished %}
                                <p class="text-xs text-gray-600 italic font-medium">
                                    <i class="fas fa-check-circle mr-1"></i>Class time has passed. Please contact your instructor if you need to mark attendance.
                                </p>
                                {% if course_finished %}
                                <div class="mt-3 p-3 bg-blue-50 rounded-lg border border-blue-200">
                                    <p class="text-xs text-blue-800 font-semibold mb-1">
                                        <i class="fas fa-info-circle mr-1"></i>Schedule Finished
                                    </p>
                                    <p class="text-xs text-blue-700 mb-2">This class schedule has ended. View your attendance records in the Attendance Log section.</p>
                                    <a href="{% url 'dashboard:student_attendance_log' %}?course={{ focus_course.id }}" 
                                       class="inline-block px-3 py-1.5 bg-blue-600 text-white text-xs font-semibold rounded-lg hover:bg-blue-700 transition duration-150">
                                        <i class="fas fa-list mr-1"></i> View Attendance Records
                                    </a>
                                </div>
                                {% endif %}
                            {% else %}
                                <p class="text-xs text-gray-600 italic font-medium">
                                    <i class="fas fa-info-circle mr-1"></i>Please scan the QR code during class time to mark your attendance.
                                </p>
                            {% endif %}
                        {% else %}
                            <p class="text-xs text-gray-600 italic font-medium">
                                <i class="fas fa-info-circle mr-1"></i>Please scan the QR code during class time to mark your attendance.
                            </p>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                
                <!-- Course Details -->
                <div class="grid grid-cols-2 gap-3">
                    <div class="p-3 rounded-xl border border-gray-200 bg-blue-50">
                        <p class="text-xs font-semibold text-gray-600 uppercase tracking-wider mb-1">Instructor</p>
                        <p class="text-sm font-bold text-gray-900">{{ focus_course.instructor.full_name|default:focus_course.instructor.username }}</p>
                    </div>
                    <div class="p-3 rounded-xl border border-gray-200 bg-purple-50">
                        <p class="text-xs font-semibold text-gray-600 uppercase tracking-wider mb-1">Program</p>
                        <p class="text-sm font-bold text-gray-900">{{ focus_course.program.code|default:'N/A' }}</p>
                    </div>
                </div>
                {% else %}
                <div class="flex flex-col items-center justify-center py-12 text-center">
                    <i class="fas fa-calendar-check text-4xl text-gray-300 mb-3"></i>
                    <p class="text-xs text-gray-500">Select a course on the left to view details and scan QR code.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- QR Scanner Modal -->
<div id="qrScannerModal" class="fixed inset-0 bg-black bg-opacity-75 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 relative">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold text-gray-900 flex items-center">
                <i class="fas fa-qrcode mr-2 text-indigo-600"></i> Scan QR Code
            </h3>
            <button onclick="closeQRScannerModal()" class="text-gray-400 hover:text-gray-600 transition">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <div id="qr-scanner-container" class="mb-4" style="width: 100%; max-width: 400px; margin: 0 auto;">
            <!-- QR Scanner will be initialized here -->
        </div>
        <div id="qr-scanner-message" class="hidden p-3 rounded-lg mb-4"></div>
        <button onclick="closeQRScannerModal()" class="w-full px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-150">
            Close
        </button>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
<style>
    #qr-scanner-container video {
        transform: scaleX(1) !important;
        -webkit-transform: scaleX(1) !important;
        width: 100% !important;
        height: auto !important;
    }
    #qr-scanner-container canvas {
        transform: scaleX(1) !important;
        -webkit-transform: scaleX(1) !important;
    }
</style>

<script>
let qrScanner = null;
let currentCourseId = null;
let currentAttendanceStatus = null;

function scanQRCodeForCourse(courseId, qrCode, attendanceStatus, dayLabel) {
    // STRICT VALIDATION: Only allow scanning if attendance status is "open"
    if (attendanceStatus !== 'open') {
        let message = 'Attendance is currently ';
        if (attendanceStatus === 'closed') {
            message += 'CLOSED';
        } else if (attendanceStatus === 'stopped') {
            message += 'STOPPED';
        } else if (attendanceStatus === 'postponed') {
            message += 'POSTPONED';
        } else {
            message += 'NOT OPEN';
        }
        message += ' for this schedule';
        if (dayLabel) {
            message += ` (${dayLabel})`;
        }
        message += '. Please contact your instructor.';
        
        if (typeof showNotification === 'function') {
            showNotification(message, 'error');
        } else {
            alert(message);
        }
        return;
    }
    
    currentCourseId = courseId;
    currentAttendanceStatus = attendanceStatus || 'automatic';
    
    // Show modal
    document.getElementById('qrScannerModal').classList.remove('hidden');
    document.getElementById('qr-scanner-message').classList.add('hidden');
    
    // Initialize scanner
    const container = document.getElementById('qr-scanner-container');
    container.innerHTML = '<div id="html5-qrcode-anchor"></div>';
    
    if (qrScanner) {
        qrScanner.clear();
    }
    
    qrScanner = new Html5Qrcode("html5-qrcode-anchor");
    qrScanner.start(
        { facingMode: "environment" },
        {
            fps: 30,  // Increased from 10 to 30 for much faster scanning
            qrbox: { width: 250, height: 250 },  // Optimal size for speed
            aspectRatio: 1.0,
            disableFlip: false,
            videoConstraints: {
                facingMode: "environment",
                width: { ideal: 640, max: 1280 },  // Lower resolution for speed
                height: { ideal: 480, max: 720 }
            },
            rememberLastUsedCamera: true,
            showTorchButtonIfSupported: false  // Disable torch to reduce overhead
        },
            (decodedText, decodedResult) => {
            console.log('QR Code scanned:', decodedText);
            
            // Pause scanner temporarily
            try {
                qrScanner.pause();
            } catch (e) {
                console.log('Could not pause scanner:', e);
            }
            
            // Clean the scanned text - remove any URL encoding or extra characters
            let cleanedQRCode = decodedText.trim();
            
            // Remove common URL patterns if present
            if (cleanedQRCode.startsWith('http://') || cleanedQRCode.startsWith('https://')) {
                // Extract from URL if it's a URL
                try {
                    const url = new URL(cleanedQRCode);
                    cleanedQRCode = url.searchParams.get('qr_code') || url.pathname.split('/').pop() || cleanedQRCode;
                } catch (e) {
                    // If URL parsing fails, try to extract hex string
                    const hexMatch = cleanedQRCode.match(/([a-f0-9]{32})/i);
                    if (hexMatch) {
                        cleanedQRCode = hexMatch[1];
                    }
                }
            }
            
            console.log('Cleaned QR Code:', cleanedQRCode);
            
            // Send to server
            fetch('{% url "dashboard:student_scan_qr_attendance" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ qr_code: cleanedQRCode })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (typeof showNotification === 'function') {
                        showNotification(data.message || 'Attendance marked successfully!', 'success');
                    } else {
                        alert('✓ Success!\n\n' + (data.message || 'Attendance marked successfully!'));
                    }
                    
                    // Close modal after 1.5 seconds (faster)
                    // Play success sound and update the "Your Status" area immediately so user sees their status
                    try {
                        playScanSuccessSound();
                        const status = data.status || 'present';
                        const attendanceTime = data.attendance_time || new Date().toLocaleTimeString();
                        updateStudentStatus(status, attendanceTime);
                    } catch (e) {
                        console.error('Failed to update student status UI or play sound:', e);
                    }

                    setTimeout(() => {
                        closeQRScannerModal();
                        // Optionally reload after short delay to fully sync state
                        // window.location.reload();
                    }, 1200);
                } else {
                    // Check if already scanned
                    if (data.already_scanned) {
                        if (typeof showNotification === 'function') {
                            showNotification(data.message || 'You have already marked your attendance for today.', 'warning');
                        } else {
                            alert('ℹ Already Scanned\n\n' + (data.message || 'You have already marked your attendance for today.'));
                        }
                        
                            // Play error/info sound and update UI with existing status and close modal
                            try {
                                playScanErrorSound();
                                const existingStatus = data.existing_status || 'present';
                                const existingTime = data.existing_time || null;
                                updateStudentStatus(existingStatus, existingTime);
                            } catch (e) {
                                console.error('Failed to update existing status UI or play sound:', e);
                            }
                        setTimeout(() => {
                            closeQRScannerModal();
                            // window.location.reload();
                        }, 1600);
                        return;
                    }
                    
                    let errorMessage = data.message || 'Failed to mark attendance.';
                    
                    if (data.attendance_status === 'closed') {
                        errorMessage = 'Attendance is currently CLOSED for this course. Please contact your instructor.';
                    } else if (data.attendance_status === 'stopped') {
                        errorMessage = 'Attendance has been STOPPED for this course. Please contact your instructor.';
                    } else if (data.attendance_status === 'postponed') {
                        errorMessage = 'Attendance has been POSTPONED for this course. Please contact your instructor.';
                    } else if (data.attendance_status === 'open') {
                        errorMessage = 'Attendance is OPEN. You can scan the QR code.';
                    }
                    
                    if (typeof showNotification === 'function') {
                        if (data.attendance_status === 'open') {
                            showNotification(errorMessage, 'success');
                        } else {
                            showNotification(errorMessage, 'error');
                        }
                    } else {
                        alert(errorMessage);
                    }
                    
                    // Restart scanner quickly after 2 seconds (reduced from 4)
                    setTimeout(() => {
                        try {
                            qrScanner.resume();
                        } catch (e) {
                            // If resume fails, restart scanner with optimized config
                            const container = document.getElementById('qr-scanner-container');
                            container.innerHTML = '<div id="html5-qrcode-anchor"></div>';
                            qrScanner = new Html5Qrcode("html5-qrcode-anchor");
                            qrScanner.start(
                                { facingMode: "environment" },
                                {
                                    fps: 30,  // Fast scanning
                                    qrbox: { width: 250, height: 250 },
                                    aspectRatio: 1.0,
                                    disableFlip: false,
                                    videoConstraints: {
                                        facingMode: "environment",
                                        width: { ideal: 640, max: 1280 },
                                        height: { ideal: 480, max: 720 }
                                    },
                                    rememberLastUsedCamera: true,
                                    showTorchButtonIfSupported: false
                                },
                                arguments[0], // onScanSuccess
                                () => {} // onScanFailure
                            );
                        }
                    }, 2000);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                const messageDiv = document.getElementById('qr-scanner-message');
                messageDiv.classList.remove('hidden');
                messageDiv.className = 'p-3 rounded-lg mb-4 bg-red-100 border border-red-200';
                messageDiv.innerHTML = `<p class="text-red-800 font-semibold"><i class="fas fa-exclamation-circle mr-2"></i>An error occurred. Please try again.</p>`;
                
                if (typeof showNotification === 'function') {
                    showNotification('An error occurred. Please try again.', 'error');
                }
            });
        },
        (error) => {
            // Ignore scanning errors
        }
    ).catch(err => {
        console.error('Unable to start QR scanner:', err);
        document.getElementById('qr-scanner-message').classList.remove('hidden');
        document.getElementById('qr-scanner-message').className = 'p-3 rounded-lg mb-4 bg-red-100 border border-red-200';
        document.getElementById('qr-scanner-message').innerHTML = '<p class="text-red-800 font-semibold">Unable to access camera. Please ensure you have granted camera permissions.</p>';
    });
}

function closeQRScannerModal() {
    if (qrScanner) {
        qrScanner.stop().then(() => {
            qrScanner.clear();
        }).catch(() => {});
        qrScanner = null;
    }
    document.getElementById('qrScannerModal').classList.add('hidden');
    document.getElementById('qr-scanner-container').innerHTML = '';
    document.getElementById('qr-scanner-message').classList.add('hidden');
    currentCourseId = null;
    currentAttendanceStatus = null;
}

function updateStudentStatus(status, attendanceTime) {
    const container = document.getElementById('student-your-status');
    if (!container) return;

    // Normalize
    const s = (status || '').toLowerCase();
    let titleText = '';
    let badgeText = '';
    let badgeClass = '';
    let textClass = '';

    if (s === 'present') {
        titleText = '<i class="fas fa-check-circle"></i> Present';
        badgeText = 'PRESENT';
        badgeClass = 'px-3 py-1.5 rounded-full text-xs font-bold bg-green-100 text-green-700';
        textClass = 'text-green-700';
    } else if (s === 'late') {
        titleText = '<i class="fas fa-clock"></i> Late';
        badgeText = 'LATE';
        badgeClass = 'px-3 py-1.5 rounded-full text-xs font-bold bg-yellow-100 text-yellow-700';
        textClass = 'text-yellow-700';
    } else if (s === 'absent') {
        titleText = '<i class="fas fa-times-circle"></i> Absent';
        badgeText = 'ABSENT';
        badgeClass = 'px-3 py-1.5 rounded-full text-xs font-bold bg-red-100 text-red-700';
        textClass = 'text-red-700';
    } else {
        titleText = s ? s.charAt(0).toUpperCase() + s.slice(1) : 'Marked';
        badgeText = (s || 'MARKED').toUpperCase();
        badgeClass = 'px-3 py-1.5 rounded-full text-xs font-bold bg-gray-100 text-gray-700';
        textClass = 'text-gray-700';
    }

    const attendanceTimeText = attendanceTime ? `Scanned at: ${attendanceTime}` : '';

    container.innerHTML = `
        <div class="flex items-center justify-between">
            <div>
                <p class="text-xs font-semibold text-gray-600 uppercase tracking-wider mb-1">Your Status</p>
                <p class="text-sm font-bold ${textClass}">${titleText}</p>
            </div>
            <div>
                <span class="${badgeClass}">${badgeText}</span>
            </div>
        </div>
        <p class="text-xs text-gray-600 mt-2">${attendanceTimeText}</p>
    `;
}

// Audio feedback for student scanning using Web Audio API
function playScanSuccessSound() {
    try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        // Classic barcode beep: two quick 1200 Hz beeps (40ms each, 60ms gap)
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'sine';
        o.frequency.value = 1200; // Barcode scanner pitch
        o.connect(g);
        g.connect(ctx.destination);
        
        // First beep
        g.gain.setValueAtTime(0.3, ctx.currentTime);
        o.start(ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.04);
        o.stop(ctx.currentTime + 0.04);
        
        // Second beep (after 100ms total from start)
        g.gain.setValueAtTime(0.3, ctx.currentTime + 0.1);
        o.start(ctx.currentTime + 0.1);
        g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.14);
        o.stop(ctx.currentTime + 0.14);
    } catch (e) { console.debug('Audio not supported', e); }
}

function playScanErrorSound() {
    try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        // Error buzzer: low pitch (500Hz) longer tone with quick fade
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'sawtooth';
        o.frequency.value = 500; // Lower barcode-like tone for error
        o.connect(g);
        g.connect(ctx.destination);
        g.gain.setValueAtTime(0.25, ctx.currentTime);
        o.start(ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
        o.stop(ctx.currentTime + 0.2);
    } catch (e) { console.debug('Audio not supported', e); }
}

// Close modal when clicking outside
document.getElementById('qrScannerModal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        closeQRScannerModal();
    }
});
</script>
{% comment %} Persist present window expiry to localStorage when instructor opens attendance {% endcomment %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    try {
        const expiryMs = {{ focus_present_window_expiry_ms|default:'null' }};
        const minutes = {{ focus_present_duration_minutes|default:'null' }};
        const scheduleId = '{{ focus_present_schedule_id|default:"" }}';
        const courseId = '{{ focus_course.id|default:"" }}';
        // Determine attendance status safely (avoid accessing attribute on None)
        {% if focus_course_next_entry %}
            const focusAttendanceStatus = '{{ focus_course_next_entry.attendance_status|default:"" }}';
        {% else %}
            const focusAttendanceStatus = '{{ focus_course.attendance_status|default:"" }}';
        {% endif %}
        // Only use server-provided expiry. Do NOT compute a local expiry from minutes alone.
        // This prevents countdowns appearing unless the instructor explicitly opened the present window.
        let effectiveExpiry = expiryMs;

        // Only persist and show countdown when server provided expiry AND attendance control is OPEN
        if (effectiveExpiry && effectiveExpiry > Date.now() && courseId && String(focusAttendanceStatus) === 'open') {
            const key = `present_window_expiry_${courseId}_${scheduleId || 'none'}`;
            try { localStorage.setItem(key, String(effectiveExpiry)); } catch (e) { console.warn('localStorage set failed', e); }
            // show configured minutes on UI
            if (minutes && minutes > 0 && expiryMs) {
                const minEl = document.getElementById('student-window-minutes');
                if (minEl) {
                    minEl.style.display = 'block';
                    minEl.textContent = minutes + ' minute' + (minutes > 1 ? 's' : '') + ' allowed for Present';
                }
            }
            // Dispatch storage event to trigger other tabs' listeners
            // Immediately start/resume countdown in this tab
            try {
                // Prefer direct start if available; otherwise call resume (or retry shortly)
                const key = `present_window_expiry_${courseId}_${scheduleId || 'none'}`;
                const expiryVal = Number(effectiveExpiry);
                if (window.createStudentTimer) {
                    try { window.createStudentTimer(key, expiryVal); } catch (e) { console.warn('createStudentTimer failed', e); }
                } else if (window.resumeStudentPresentCountdownFromStorage) {
                    try { window.resumeStudentPresentCountdownFromStorage(); } catch (e) { console.warn('resumeStudentPresentCountdownFromStorage failed', e); }
                } else {
                    // Retry shortly in case the timer code hasn't been initialized yet
                    setTimeout(() => {
                        try { if (window.resumeStudentPresentCountdownFromStorage) window.resumeStudentPresentCountdownFromStorage(); } catch (e) { console.warn('delayed resume failed', e); }
                    }, 150);
                }
            } catch (e) { console.warn('student present start fallback failed', e); }
        } else {
            // no active present window OR attendance not open - hide minutes element and cleanup any stale keys
            const minEl = document.getElementById('student-window-minutes');
            if (minEl) minEl.style.display = 'none';
            try {
                if (courseId) {
                    const key = `present_window_expiry_${courseId}_${scheduleId || 'none'}`;
                    localStorage.removeItem(key);
                    // also remove any other keys for this course to be safe
                    for (let i = 0; i < localStorage.length; i++) {
                        const k = localStorage.key(i);
                        if (k && k.startsWith(`present_window_expiry_${courseId}_`)) {
                            localStorage.removeItem(k);
                        }
                    }
                }
            } catch (e) { console.warn('localStorage cleanup failed', e); }
        }
    } catch (err) { console.error('persist present window', err); }
});
</script>
<script>
// Student-side present-window countdown (reads expiry persisted by instructor)
(function() {
    function getPresentKey(courseId, scheduleId) {
        return `present_window_expiry_${courseId}_${scheduleId || 'none'}`;
    }

    function createStudentTimer(key, expiry) {
        // clear any existing
        try {
            if (window.studentPresentTimer) {
                if (window.studentPresentTimer.interval) clearInterval(window.studentPresentTimer.interval);
                if (window.studentPresentTimer.timeout) clearTimeout(window.studentPresentTimer.timeout);
            }
        } catch (e) {}

        function updateFn() {
            const now = Date.now();
            const remaining = expiry - now;
            const displayEl = document.getElementById('student-window-time');
            const wrapper = document.getElementById('student-active-window-display');
            if (!displayEl) return;
            if (remaining <= 0) {
                displayEl.textContent = '00:00';
                if (wrapper) wrapper.classList.add('opacity-60');
                // cleanup persisted key
                try { localStorage.removeItem(key); } catch (e) {}
                // clear timers
                if (window.studentPresentTimer && window.studentPresentTimer.interval) clearInterval(window.studentPresentTimer.interval);
                // notify student that present window ended
                try {
                    const msg = 'Present window ended — students who scan now will be marked late.';
                    if (typeof showNotification === 'function') {
                        showNotification(msg, 'error');
                    } else {
                        // gentle alert fallback
                        alert(msg);
                    }
                } catch (e) { console.warn('student notify fail', e); }
                return;
            }
            const secs = Math.floor(remaining / 1000);
            const mm = String(Math.floor(secs / 60)).padStart(2, '0');
            const ss = String(secs % 60).padStart(2, '0');
            displayEl.textContent = `${mm}:${ss}`;
            if (wrapper) wrapper.classList.remove('hidden');
        }

        // initial update and aligned ticking
        updateFn();
        const msToNextSecond = 1000 - (Date.now() % 1000) || 1000;
        const timeout = setTimeout(() => {
            updateFn();
            const interval = setInterval(updateFn, 1000);
            window.studentPresentTimer = { interval: interval, timeout: null, expiry: expiry };
        }, msToNextSecond);
        window.studentPresentTimer = { interval: null, timeout: timeout, expiry: expiry };
    }

    function resumeStudentPresentCountdownFromStorage() {
        try {
            const courseId = '{{ focus_course.id|default:"" }}';
            const scheduleId = '{{ focus_course_next_entry.schedule_id|default:"none" }}';
            // Determine attendance status safely (avoid accessing attribute on None)
            {% if focus_course_next_entry %}
                const focusAttendanceStatus = '{{ focus_course_next_entry.attendance_status|default:"" }}';
            {% else %}
                const focusAttendanceStatus = '{{ focus_course.attendance_status|default:"" }}';
            {% endif %}
            if (!courseId) return;
            // Use raw identifiers so the present window is specific to this schedule
            const key = getPresentKey(courseId, scheduleId || 'none');
            let expiryStr = localStorage.getItem(key);
            // If attendance isn't open for this focused schedule, clean up any keys and do not resume
            if (String(focusAttendanceStatus) !== 'open') {
                try {
                    if (expiryStr) localStorage.removeItem(key);
                    for (let i = 0; i < localStorage.length; i++) {
                        const k = localStorage.key(i);
                        if (k && k.startsWith(`present_window_expiry_${courseId}_`)) localStorage.removeItem(k);
                    }
                } catch (e) { console.warn('cleanup while not open failed', e); }
                return;
            }
            let usedKey = key;
            // fallback: scan localStorage for keys that include both courseId and scheduleId
            if (!expiryStr) {
                for (let i = 0; i < localStorage.length; i++) {
                    const k = localStorage.key(i);
                    if (!k || !k.startsWith('present_window_expiry_')) continue;
                    if (k.includes(String(courseId)) && k.includes(String(scheduleId))) {
                        expiryStr = localStorage.getItem(k);
                        usedKey = k;
                        break;
                    }
                }
                // second fallback: any key that contains the courseId (schedule may be missing or different)
                if (!expiryStr) {
                    for (let i = 0; i < localStorage.length; i++) {
                        const k = localStorage.key(i);
                        if (!k || !k.startsWith('present_window_expiry_')) continue;
                        if (k.includes(String(courseId))) {
                            expiryStr = localStorage.getItem(k);
                            usedKey = k;
                            break;
                        }
                    }
                }
            }
            if (!expiryStr) return;
            const expiry = parseInt(expiryStr, 10);
            if (!isNaN(expiry) && expiry > Date.now()) {
                createStudentTimer(usedKey, expiry);
            } else {
                // expired
                localStorage.removeItem(usedKey);
            }
        } catch (e) { console.error('resumeStudentPresentCountdownFromStorage', e); }
    }

    // Sync across tabs
    window.addEventListener('storage', function(e) {
        try {
            if (!e.key || !e.key.startsWith('present_window_expiry_')) return;
            if (e.newValue) {
                const expiry = parseInt(e.newValue, 10);
                if (!isNaN(expiry) && expiry > Date.now()) {
                    createStudentTimer(e.key, expiry);
                }
            } else {
                if (window.studentPresentTimer) {
                    if (window.studentPresentTimer.interval) clearInterval(window.studentPresentTimer.interval);
                    if (window.studentPresentTimer.timeout) clearTimeout(window.studentPresentTimer.timeout);
                    const wrapper = document.getElementById('student-active-window-display');
                    if (wrapper) wrapper.classList.add('hidden');
                    window.studentPresentTimer = null;
                }
            }
        } catch (err) { console.error('student storage handler', err); }
    });

    document.addEventListener('DOMContentLoaded', function() {
        try { resumeStudentPresentCountdownFromStorage(); } catch (e) { console.warn(e); }
    });
    // expose resume function to other scripts
    try { window.resumeStudentPresentCountdownFromStorage = resumeStudentPresentCountdownFromStorage; } catch (e) { /* ignore */ }
    // expose direct timer starter so other scripts can start the student timer immediately
    try { window.createStudentTimer = createStudentTimer; } catch (e) { /* ignore */ }
})();
</script>
{% endblock %}

