{% extends 'dashboard/student/student.html' %}
{% load dashboard_filters %}
{% block title %}Enroll Course{% endblock %}
{% block dashboard_content %}
<style>
    /* Course card styling matching instructor dashboard */
    .course-card-student {
        transition: all 0.3s ease;
        min-height: 280px;
        display: flex;
        flex-direction: column;
        padding: 1rem;
    }
    .course-card-student:hover {
        transform: translateY(-4px);
        box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.2) !important;
    }
    .course-title-student {
        font-size: clamp(1rem, 2.2vw, 1.3rem);
        line-height: 1.25;
        word-break: break-word;
        text-wrap: balance;
        display: -webkit-box;
        -webkit-line-clamp: 1;
        line-clamp: 1;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
    }
</style>
<div class="max-w-4xl mx-auto px-1" data-student-id="{{ user.school_id }}">
    <h2 class="text-xl md:text-2xl font-bold mb-4 px-2" style="color: #3C4770;">Enroll in Course</h2>
    
    <!-- Enrollment Form -->
    <div class="bg-white rounded-lg shadow-sm p-3 md:p-4 mb-3 border border-gray-100">
        <h3 class="text-lg font-semibold mb-4 text-gray-800">Enter Course Code</h3>
        <form id="enrollmentForm" class="space-y-4">
            {% csrf_token %}
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Course Enrollment Code <span class="text-red-500">*</span></label>
                <input type="text" id="enrollment_code" name="enrollment_code" required 
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white text-lg font-mono text-center tracking-widest uppercase"
                       placeholder="Enter 8-character code" maxlength="8" autocomplete="off">
                <p class="text-xs text-gray-500 mt-1">Enter the enrollment code provided by your instructor</p>
            </div>
            <button type="button" onclick="verifyEnrollmentCode()" 
                    class="w-full px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition shadow-md hover:shadow-lg">
                <i class="fas fa-search mr-2"></i> Verify Code
            </button>
        </form>
    </div>
    
    <!-- Course Information (Hidden until code is verified) -->
    <div id="courseInfoSection" class="bg-white rounded-lg shadow-sm p-3 md:p-4 mb-3 border border-gray-100 hidden">
        <h3 class="text-base md:text-lg font-semibold mb-3 text-gray-800">Course Information</h3>
        <div id="courseInfoContent" class="space-y-2"></div>
    </div>
    
    <!-- Student Information Form (Hidden until code is verified) -->
    <div id="studentInfoSection" class="bg-white rounded-lg shadow-sm p-3 md:p-4 mb-3 border border-gray-100 hidden">
        <h3 class="text-lg font-semibold mb-4 text-gray-800">Your Information</h3>
        <form id="studentInfoForm" class="space-y-4">
            {% csrf_token %}
            <input type="hidden" id="course_id" name="course_id">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Full Name <span class="text-red-500">*</span></label>
                    <input type="text" id="full_name" name="full_name" required 
                           class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white"
                           placeholder="Enter your full name">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Year Level <span class="text-red-500">*</span></label>
                    <select id="year_level" name="year_level" required 
                            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                        <option value="">Select Year Level</option>
                        <option value="1">1st Year</option>
                        <option value="2">2nd Year</option>
                        <option value="3">3rd Year</option>
                        <option value="4">4th Year</option>
                        <option value="5">5th Year</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Section <span class="text-red-500">*</span></label>
                    <input type="text" id="section" name="section" required 
                           class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white uppercase"
                           placeholder="e.g., A, B, 1, 2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">School Email <span class="text-red-500">*</span></label>
                    <input type="email" id="email" name="email" required 
                           class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white"
                           placeholder="your.email@school.edu">
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Student ID <span class="text-red-500">*</span></label>
                    <input type="text" id="student_id" name="student_id" required 
                           class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white"
                           placeholder="Enter your student ID number">
                </div>
            </div>
            <button type="button" onclick="submitEnrollment()" 
                    class="w-full px-6 py-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition shadow-md hover:shadow-lg">
                <i class="fas fa-check mr-2"></i> Enroll in Course
            </button>
        </form>
    </div>
    
    <!-- Enrolled Courses - Grid Display -->
    <div class="bg-white rounded-2xl shadow p-4 border border-gray-100">
        <div class="flex items-center justify-between mb-4 gap-2 flex-wrap">
            <h3 class="text-lg font-semibold text-gray-800">My Enrolled Courses</h3>
            <div class="flex gap-2 flex-wrap">
                <button onclick="openRegistrationInstructorsModal()" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition flex items-center gap-2">
                    <i class="fas fa-user-check"></i> Teacher Registration
                </button>
                <button onclick="safeOpenDroppedModal()" class="px-4 py-2 bg-gray-600 text-white rounded-lg font-semibold hover:bg-gray-700 transition flex items-center gap-2">
                    <i class="fas fa-trash"></i> Dropped Courses
                </button>
            </div>
        </div>
        {% if enrolled_courses %}
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3" id="enrolled-courses-grid">
                {% for enrollment in enrolled_courses %}
                <div class="course-card-student group relative rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 cursor-pointer text-white" 
                     style="background: linear-gradient(135deg, {{ enrollment.course.color|default:'#3C4770' }} 0%, {{ enrollment.course.color|default:'#447294' }} 100%); box-shadow: 0 10px 20px -5px rgba(60, 71, 112, 0.3);"
                     onclick="showEnrolledCourseDetails({{ enrollment.id }}, '{{ enrollment.course.code|escapejs }}', '{{ enrollment.course.name|escapejs }}', '{{ enrollment.course.program.code|escapejs }}', '{{ enrollment.course.program.name|escapejs }}', {{ enrollment.course.year_level }}, '{{ enrollment.course.semester|escapejs }}', '{{ enrollment.course.school_year|escapejs }}', '{{ enrollment.course.instructor.full_name|default:enrollment.course.instructor.username|escapejs }}', '{{ enrollment.course.room|default:'TBA'|escapejs }}', '{{ enrollment.enrolled_at|date:'F d, Y'|escapejs }}', '{{ enrollment.section|default:'N/A'|escapejs }}', '{{ enrollment.course.color|default:'#3C4770'|escapejs }}', {{ enrollment.has_qr|lower }})">
                    <div class="flex justify-between items-start mb-3">
                        <i class="fas fa-book-open text-2xl opacity-70"></i>
                    </div>
                    <h3 class="course-title-student font-bold mb-1 text-base">{{ enrollment.course.code }}</h3>
                    <p class="text-xs font-medium opacity-90 mb-2 line-clamp-2">{{ enrollment.course.name }}</p>
                    {% if enrollment.section %}
                    <p class="text-xs font-semibold opacity-80 mb-2 flex items-center">
                        <i class="fas fa-users mr-1"></i> Section {{ enrollment.section|upper }}
                    </p>
                    {% endif %}
                    <p class="text-xs font-semibold opacity-80 flex items-center">
                        <i class="fas fa-map-marker-alt mr-1"></i> {{ enrollment.course.room|default:'TBA' }}
                    </p>
                </div>
                {% endfor %}
            </div>
        {% else %}
        <div class="text-center py-8 text-gray-500">
            <i class="fas fa-book-open text-3xl mb-2"></i>
            <p class="text-sm">No enrolled courses yet</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Schedule Conflict Modal -->
<div id="scheduleConflictModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 backdrop-blur-sm hidden z-[60] flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col">
        <div class="bg-gradient-to-r from-yellow-500 to-orange-500 px-6 py-4 flex justify-between items-center">
            <h3 class="text-xl font-bold text-white flex items-center">
                <i class="fas fa-exclamation-triangle w-6 h-6 mr-2"></i> Schedule Conflict Detected
            </h3>
            <button onclick="closeScheduleConflictModal()" class="text-white hover:text-gray-200 transition">
                <i class="fas fa-times w-6 h-6"></i>
            </button>
        </div>
        <div class="p-6 overflow-y-auto flex-1">
            <div class="mb-4">
                <p class="text-gray-700 font-semibold mb-2">The course you're trying to enroll in has schedule conflicts with your existing enrolled courses:</p>
                <div id="conflictCourseInfo" class="mb-4 p-3 rounded-lg border-l-4" style="border-left-color: #3C4770;">
                    <!-- Course info will be inserted here -->
                </div>
            </div>
            <div class="space-y-3">
                <h4 class="font-semibold text-gray-800 mb-2">Conflicts:</h4>
                <div id="conflictsList" class="space-y-3">
                    <!-- Conflicts will be inserted here -->
                </div>
            </div>
            <div class="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                <p class="text-sm text-yellow-800">
                    <i class="fas fa-info-circle mr-2"></i>
                    <strong>Note:</strong> If you proceed with enrollment, both courses will appear in your timetable with overlapping schedules. 
                    You may need to coordinate with your instructors or consider dropping one of the courses.
                </p>
            </div>
        </div>
        <div class="px-6 py-4 border-t border-gray-200 bg-gray-50 flex justify-end gap-3">
            <button onclick="closeScheduleConflictModal()" class="px-5 py-2.5 text-gray-700 bg-gray-200 font-semibold rounded-lg hover:bg-gray-300 transition">
                Cancel
            </button>
            <button onclick="forceEnrollWithConflicts()" class="px-5 py-2.5 bg-orange-600 text-white font-semibold rounded-lg hover:bg-orange-700 transition shadow-md">
                <i class="fas fa-check mr-2"></i> Force Enroll Anyway
            </button>
        </div>
    </div>
</div>

<!-- Invalid Code Modal -->
<div id="invalidCodeModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 md:p-8">
        <div class="flex justify-between items-start mb-6">
            <h3 class="text-2xl font-bold flex items-center text-red-600">
                <i class="fas fa-exclamation-circle w-6 h-6 mr-2"></i> Invalid Enrollment Code
            </h3>
            <button onclick="closeInvalidCodeModal()" class="text-gray-400 hover:text-gray-600 transition duration-150 hover:opacity-75">
                <i class="fas fa-times w-6 h-6"></i>
            </button>
        </div>
        <div class="space-y-4">
            <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded">
                <p class="text-gray-800 font-medium" id="invalidCodeMessage">No course found with this enrollment code.</p>
            </div>
            <div class="text-sm text-gray-600 space-y-2">
                <p><strong>Please check:</strong></p>
                <ul class="list-disc list-inside space-y-1 ml-2">
                    <li>The code is correct (8 characters)</li>
                    <li>You entered it correctly (no spaces or typos)</li>
                    <li>The course is still active</li>
                    <li>You received the code from your instructor</li>
                </ul>
            </div>
        </div>
        <div class="flex justify-end space-x-3 pt-6 border-t border-gray-200 mt-6">
            <button onclick="closeInvalidCodeModal()" class="px-5 py-2.5 text-gray-700 bg-gray-200 font-semibold rounded-xl hover:bg-gray-300 transition duration-150 shadow-sm hover:shadow-md">
                Close
            </button>
        </div>
    </div>
</div>

<script>
function showInvalidCodeModal(message) {
    const modal = document.getElementById('invalidCodeModal');
    const messageEl = document.getElementById('invalidCodeMessage');
    if (modal && messageEl) {
        messageEl.textContent = message || 'No course found with this enrollment code.';
        modal.classList.remove('hidden');
    }
}

function closeInvalidCodeModal() {
    const modal = document.getElementById('invalidCodeModal');
    if (modal) {
        modal.classList.add('hidden');
    }
}

// Close modal when clicking outside
document.getElementById('invalidCodeModal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        closeInvalidCodeModal();
    }
});
function verifyEnrollmentCode() {
    const code = document.getElementById('enrollment_code').value.trim().toUpperCase();
    if (!code) {
        alert('Please enter an enrollment code');
        return;
    }
    
    const button = document.querySelector('button[onclick="verifyEnrollmentCode()"]');
    const originalText = button ? button.innerHTML : '';
    if (button) {
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Verifying...';
    }
    
    fetch('{% url "dashboard:verify_enrollment_code" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ enrollment_code: code })
    })
    .then(response => response.json())
    .then(data => {
        if (button) {
            button.disabled = false;
            button.innerHTML = originalText;
        }
        
        if (data.success) {
            // Check for schedule conflicts
            if (data.has_conflicts && data.conflicts && data.conflicts.length > 0) {
                // Show conflict modal
                showScheduleConflictModal(data.course, data.conflicts);
            } else {
                // No conflicts, show course info and student form
                showCourseInfo(data.course);
            }
        } else {
            // Show modal for invalid enrollment code
            showInvalidCodeModal(data.message || 'Invalid enrollment code. Please check and try again.');
        }
    })
    .catch(error => {
        if (button) {
            button.disabled = false;
            button.innerHTML = originalText;
        }
        console.error('Error:', error);
        showInvalidCodeModal('An error occurred while verifying the code. Please try again.');
    });
}

// Force Section to uppercase as the user types
document.addEventListener('DOMContentLoaded', function() {
    const sectionInput = document.getElementById('section');
    if (sectionInput) {
        sectionInput.addEventListener('input', function() {
            const pos = this.selectionStart;
            this.value = this.value.toUpperCase();
            this.setSelectionRange(pos, pos);
        });
    }
});

let currentConflicts = null;
let currentCourse = null;

function showScheduleConflictModal(course, conflicts) {
    currentConflicts = conflicts;
    currentCourse = course;
    
    const modal = document.getElementById('scheduleConflictModal');
    const courseInfo = document.getElementById('conflictCourseInfo');
    const conflictsList = document.getElementById('conflictsList');
    
    // Display course info
    courseInfo.innerHTML = `
        <h4 class="font-bold text-gray-900 mb-1">${course.code} - ${course.name}</h4>
        <p class="text-sm text-gray-600">Program: ${course.program_code || ''} - ${course.program_name || ''}</p>
    `;
    
    // Display conflicts
    conflictsList.innerHTML = '';
    conflicts.forEach((conflict, index) => {
        const conflictItem = document.createElement('div');
        conflictItem.className = 'p-4 bg-red-50 border border-red-200 rounded-lg';
        conflictItem.innerHTML = `
            <div class="flex items-start gap-3">
                <div class="flex-shrink-0 w-8 h-8 rounded-full bg-red-500 text-white flex items-center justify-center font-bold text-sm">
                    ${index + 1}
                </div>
                <div class="flex-1">
                    <h5 class="font-semibold text-red-900 mb-2">Conflict with: ${conflict.conflicting_course_code} - ${conflict.conflicting_course_name}</h5>
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div>
                            <p class="text-gray-600 font-medium mb-1">Day:</p>
                            <p class="text-gray-900 font-semibold">${conflict.day}</p>
                        </div>
                        <div>
                            <p class="text-gray-600 font-medium mb-1">New Course Time:</p>
                            <p class="text-gray-900 font-semibold">${conflict.new_course_time}</p>
                            <p class="text-xs text-gray-500">Room: ${conflict.new_course_room}</p>
                        </div>
                        <div>
                            <p class="text-gray-600 font-medium mb-1">Conflicting Course Time:</p>
                            <p class="text-gray-900 font-semibold">${conflict.conflicting_course_time}</p>
                            <p class="text-xs text-gray-500">Room: ${conflict.conflicting_course_room}</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
        conflictsList.appendChild(conflictItem);
    });
    
    modal.classList.remove('hidden');
}

function closeScheduleConflictModal() {
    const modal = document.getElementById('scheduleConflictModal');
    modal.classList.add('hidden');
    currentConflicts = null;
    currentCourse = null;
}

function forceEnrollWithConflicts() {
    closeScheduleConflictModal();
    // Show course info and form, then submit with force_enroll flag
    showCourseInfo(currentCourse);
    // Store that we should force enroll
    document.getElementById('studentInfoForm').setAttribute('data-force-enroll', 'true');
}

function showCourseInfo(course) {
    // Show course info and student form
    document.getElementById('courseInfoSection').classList.remove('hidden');
    document.getElementById('studentInfoSection').classList.remove('hidden');
    
    document.getElementById('course_id').value = course.id;
    
    // Display course information
    document.getElementById('courseInfoContent').innerHTML = `
        <div class="p-4 rounded-lg border-l-4" style="background: linear-gradient(90deg, ${course.color || '#3C4770'}15 0%, #FFFFFF 100%); border-left-color: ${course.color || '#3C4770'};">
            <h4 class="text-lg font-bold mb-2" style="color: ${course.color || '#3C4770'};">${course.code} - ${course.name}</h4>
            <div class="grid grid-cols-2 gap-2 text-sm text-gray-700">
                <div><strong>Year Level:</strong> ${course.year_level || 'N/A'}</div>
                <div><strong>Semester:</strong> ${course.semester === '1st' ? '1st Semester' : course.semester === '2nd' ? '2nd Semester' : course.semester || 'N/A'}</div>
                <div><strong>School Year:</strong> ${course.school_year || 'N/A'}</div>
                <div><strong>Instructor:</strong> ${course.instructor_name || 'N/A'}</div>
                <div><strong>Room:</strong> ${course.room || 'N/A'}</div>
            </div>
        </div>
    `;
    
    // Pre-fill student info if available
    {% if user.full_name %}
    document.getElementById('full_name').value = '{{ user.full_name }}';
    {% endif %}
    {% if user.year_level %}
    document.getElementById('year_level').value = '{{ user.year_level }}';
    {% endif %}
    {% if user.section %}
    document.getElementById('section').value = '{{ user.section }}';
    {% endif %}
    {% if user.email %}
    document.getElementById('email').value = '{{ user.email }}';
    {% endif %}
    {% if user.school_id %}
    document.getElementById('student_id').value = '{{ user.school_id }}';
    {% endif %}
}

function submitEnrollment() {
    const form = document.getElementById('studentInfoForm');
    const formData = new FormData(form);
    
    // Add enrollment code to form data
    const enrollmentCode = document.getElementById('enrollment_code').value.trim().toUpperCase();
    formData.append('enrollment_code', enrollmentCode);
    
    // Check if force enrollment is needed
    const forceEnroll = form.getAttribute('data-force-enroll') === 'true';
    if (forceEnroll) {
        formData.append('force_enroll', 'true');
    }
    
    const button = event.target;
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Enrolling...';
    
    fetch('{% url "dashboard:enroll_course" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        button.disabled = false;
        button.innerHTML = originalText;
        
        if (data.success) {
            alert('Successfully enrolled in the course!');
            window.location.reload();
        } else {
            if (data.has_conflicts && data.conflicts) {
                // Show conflict modal again
                showScheduleConflictModal(currentCourse || data.course, data.conflicts);
            } else {
                alert(data.message || 'Failed to enroll. Please try again.');
            }
        }
    })
    .catch(error => {
        button.disabled = false;
        button.innerHTML = originalText;
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
    });
}

// Close conflict modal when clicking outside
document.getElementById('scheduleConflictModal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        closeScheduleConflictModal();
    }
});

function showUnenrollModal(enrollmentId, courseCode, courseName) {
    document.getElementById('unenroll-enrollment-id').value = enrollmentId;
    document.getElementById('unenroll-course-name').textContent = `${courseCode} - ${courseName}`;
    document.getElementById('unenrollModal').classList.remove('hidden');
}

function closeUnenrollModal() {
    document.getElementById('unenrollModal').classList.add('hidden');
    document.getElementById('unenroll-enrollment-id').value = '';
    document.getElementById('unenroll-course-name').textContent = '';
}

function confirmUnenroll() {
    const enrollmentId = document.getElementById('unenroll-enrollment-id').value;
    if (!enrollmentId) {
        closeUnenrollModal();
        return;
    }
    
    closeUnenrollModal();
    
    fetch(`{% url "dashboard:unenroll_course" 0 %}`.replace('0', enrollmentId), {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (typeof showNotification === 'function') {
                showNotification('Successfully unenrolled from the course.', 'success');
            } else {
                alert('Successfully unenrolled from the course.');
            }
            setTimeout(() => window.location.reload(), 800);
        } else {
            if (typeof showNotification === 'function') {
                showNotification(data.message || 'Failed to unenroll. Please try again.', 'error');
            } else {
                alert(data.message || 'Failed to unenroll. Please try again.');
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        if (typeof showNotification === 'function') {
            showNotification('An error occurred. Please try again.', 'error');
        } else {
            alert('An error occurred. Please try again.');
        }
    });
}

// Allow Enter key to verify code
document.getElementById('enrollment_code').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        verifyEnrollmentCode();
    }
});

function showEnrolledCourseDetails(enrollmentId, code, name, programCode, programName, yearLevel, semester, schoolYear, instructor, room, enrolledAt, section, color, hasQR) {
    let modal = document.getElementById('enrolledCourseDetailsModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'enrolledCourseDetailsModal';
        modal.className = 'fixed inset-0 bg-black bg-opacity-40 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm';
        modal.innerHTML = `
            <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div class="flex items-center justify-between px-6 py-4 border-b border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-900 flex items-center gap-2">
                        <i class="fas fa-book"></i>
                        <span id="modal-course-code">Course Details</span>
                    </h2>
                    <button onclick="closeEnrolledCourseDetails()" class="text-gray-400 hover:text-gray-600 transition">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div class="p-6 space-y-4" id="modal-course-content">
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    const ordinalYear = yearLevel === 1 ? '1st Year' : yearLevel === 2 ? '2nd Year' : yearLevel === 3 ? '3rd Year' : yearLevel === 4 ? '4th Year' : yearLevel + 'th Year';
    const semesterDisplay = semester === '1st' ? '1st Semester' : semester === '2nd' ? '2nd Semester' : semester || 'N/A';
    
    document.getElementById('modal-course-code').textContent = code + ' - ' + name;
    
    // Note: QR registration has been moved to the "Register" button. No registration button in this modal.
    
    document.getElementById('modal-course-content').innerHTML = `
        <div class="p-4 rounded-xl border-l-4" style="background: linear-gradient(90deg, ${color}15 0%, #FFFFFF 100%); border-left-color: ${color};">
            <h4 class="text-lg font-bold mb-2" style="color: ${color};">${code} - ${name}</h4>
            <div class="grid grid-cols-2 gap-2 text-sm text-gray-700">
                <div><strong>Year Level:</strong> ${ordinalYear}</div>
                <div><strong>Semester:</strong> ${semesterDisplay}</div>
                <div><strong>School Year:</strong> ${schoolYear || 'N/A'}</div>
                <div><strong>Section:</strong> ${section || 'N/A'}</div>
                <div><strong>Instructor:</strong> ${instructor || 'N/A'}</div>
                <div><strong>Room:</strong> ${room || 'TBA'}</div>
                <div><strong>Enrolled on:</strong> ${enrolledAt}</div>
            </div>
        </div>
        <div class="mt-4 flex gap-3 justify-end border-t border-gray-200 pt-4">
            <button onclick="closeEnrolledCourseDetails()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition">
                Cancel
            </button>
            <button onclick="showUnenrollModal(${enrollmentId}, '${code}', '${name}')" class="px-4 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition flex items-center gap-2">
                <i class="fas fa-user-minus"></i> Drop Course
            </button>
        </div>
    `;
    modal.classList.remove('hidden');
}

function closeEnrolledCourseDetails() {
    const modal = document.getElementById('enrolledCourseDetailsModal');
    if (modal) {
        modal.classList.add('hidden');
    }
}
</script>

<!-- Registration Instructors Functions -->
<script>
function openRegistrationInstructorsModal() {
    const modal = document.getElementById('registrationInstructorsModal');
    const content = document.getElementById('registrationInstructorsContent');
    
    if (!modal) {
        console.error('Registration modal not found');
        return;
    }
    
    // Show loading state
    content.innerHTML = '<div class="text-center py-8 text-gray-500"><i class="fas fa-spinner fa-spin text-2xl mb-2"></i><p>Loading registration data...</p></div>';
    modal.classList.remove('hidden');
    
    // Fetch registration data
    fetch('{% url "dashboard:student_get_registration_instructors" %}')
        .then(r => r.json())
        .then(data => {
            if (!data.success) {
                content.innerHTML = `<div class="text-red-600 p-4 text-center">${data.message || 'Failed to load registration data.'}</div>`;
                return;
            }
            
            if (!data.instructors || data.instructors.length === 0) {
                content.innerHTML = '<div class="text-center py-8 text-gray-500"><i class="fas fa-inbox text-3xl mb-2"></i><p>No instructors have registration enabled for your courses.</p></div>';
                return;
            }
            
            // Build instructor cards
            let html = '<div class="space-y-3">';
            data.instructors.forEach(instructor => {
                const profilePic = instructor.profile_picture ? `<img src="${instructor.profile_picture}" alt="${instructor.name}" class="w-12 h-12 rounded-full object-cover">` : `<div class="w-12 h-12 rounded-full bg-blue-600 flex items-center justify-center text-white font-bold">${instructor.name.charAt(0)}</div>`;
                html += `
                    <div class="p-4 rounded-lg border-2 border-blue-200 bg-blue-50 hover:bg-blue-100 transition">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center gap-3">
                                ${profilePic}
                                <div>
                                    <h4 class="font-bold text-lg text-gray-900">${instructor.name}</h4>
                                    <p class="text-xs text-gray-600">${instructor.courses.length} course(s)</p>
                                </div>
                            </div>
                            <button onclick="openInstructorRegistration(${instructor.id}, '${instructor.name.replace(/'/g, "\\'")}', '${instructor.profile_picture || ''}', ${JSON.stringify(instructor.courses).replace(/"/g, '&quot;')})" class="px-3 py-1 bg-blue-600 text-white rounded text-sm font-semibold hover:bg-blue-700 transition">
                                Register
                            </button>
                        </div>
                        <div class="space-y-1 ml-15">
                            ${instructor.courses.map(course => `
                                <div class="text-sm text-gray-700 flex items-center gap-2">
                                    <i class="fas fa-book text-blue-600"></i>
                                    <span class="font-medium">${course.code}</span> - ${course.name}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            content.innerHTML = html;
        })
        .catch(err => {
            content.innerHTML = '<div class="text-red-600 p-4 text-center">Error loading registration data.</div>';
            console.error(err);
        });
}

function closeRegistrationInstructorsModal() {
    const modal = document.getElementById('registrationInstructorsModal');
    if (modal) {
        modal.classList.add('hidden');
    }
}

function openInstructorRegistration(instructorId, instructorName, profilePicture, courses) {
    // Create a modal for this specific instructor showing their courses
    let modal = document.getElementById('instructorRegistrationDetailsModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'instructorRegistrationDetailsModal';
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 hidden z-[120] flex items-center justify-center p-4 backdrop-blur-sm';
        document.body.appendChild(modal);
    }
    
    const profilePic = profilePicture ? `<img src="${profilePicture}" alt="${instructorName}" class="w-16 h-16 rounded-full object-cover border-2 border-blue-300">` : `<div class="w-16 h-16 rounded-full bg-blue-600 flex items-center justify-center text-white font-bold text-2xl">${instructorName.charAt(0)}</div>`;
    
    let coursesHtml = courses.map(course => `
        <div class="p-3 rounded-lg border border-gray-200 bg-gray-50">
            <div class="font-semibold text-gray-900">${course.code} - ${course.name}</div>
        </div>
    `).join('');
    
    modal.innerHTML = `
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
            <div class="flex justify-between items-start mb-6">
                <div class="flex items-center gap-3">
                    ${profilePic}
                    <div>
                        <h3 class="text-xl font-bold text-gray-900">Register with</h3>
                        <p class="text-lg font-semibold text-blue-600">${instructorName}</p>
                    </div>
                </div>
                <button onclick="closeInstructorRegistrationModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            
            <div class="space-y-3 mb-6">
                <h4 class="font-semibold text-gray-800 text-sm">Your courses with this instructor:</h4>
                ${coursesHtml}
            </div>
            
            <div class="space-y-3">
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="openQRCodeRegistration(${instructorId}, '${instructorName.replace(/'/g, "\\'")}')" class="px-4 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition flex items-center justify-center gap-2">
                        <i class="fas fa-qrcode"></i> QR Code
                    </button>
                    <button onclick="openBiometricRegistration(${instructorId}, '${instructorName.replace(/'/g, "\\'")}')" class="px-4 py-3 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 transition flex items-center justify-center gap-2">
                        <i class="fas fa-fingerprint"></i> Biometric
                    </button>
                </div>
                <p class="text-xs text-gray-500 text-center">Choose registration method or use both</p>
            </div>
            <button onclick="closeInstructorRegistrationModal()" class="w-full mt-2 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition">
                Close
            </button>
        </div>
    `;
    
    modal.classList.remove('hidden');
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeInstructorRegistrationModal();
        }
    });
}

function closeInstructorRegistrationModal() {
    const modal = document.getElementById('instructorRegistrationDetailsModal');
    if (modal) {
        modal.classList.add('hidden');
    }
}

function openRegistrationMethods(instructorId, instructorName) {
    // Close modals first
    closeInstructorRegistrationModal();
    closeRegistrationInstructorsModal();
    
    // Set the registration mode to student self-registration
    window.isStudentRegisterMode = true;
    
    // Store instructor ID for backend reference
    window.currentInstructorId = instructorId;
    
    // Set student ID prefill from page data if available
    const studentIdPrefill = document.querySelector('[data-student-id]')?.getAttribute('data-student-id') || '';
    
    // Get all courses from the current registration modal (before we close it)
    // In the QR scanner, we'll use courseId 0 as a special marker for multi-course registration
    console.log('Opening QR Scanner in student registration mode for instructor:', instructorId);
    
    // Open QR Scanner - courseId of 0 indicates student registering with instructor (multi-course)
    if (typeof window.openQRScanner === 'function') {
        window.openQRScanner(0, studentIdPrefill, '');
    } else {
        console.error('QR Scanner function not available');
        alert('QR Scanner is not available. Please refresh the page and try again.');
    }
}

// Open QR Code Registration
function openQRCodeRegistration(instructorId, instructorName) {
    // Close modals first
    closeInstructorRegistrationModal();
    closeRegistrationInstructorsModal();
    
    // Set the registration mode to student self-registration
    window.isStudentRegisterMode = true;
    
    // Store instructor ID for backend reference
    window.currentInstructorId = instructorId;
    
    // Set student ID prefill from page data if available
    const studentIdPrefill = document.querySelector('[data-student-id]')?.getAttribute('data-student-id') || '';
    
    console.log('Opening QR Scanner for instructor:', instructorId);
    
    // Open QR Scanner - courseId of 0 indicates student registering with instructor (multi-course)
    if (typeof window.openQRScanner === 'function') {
        window.openQRScanner(0, studentIdPrefill, '');
    } else {
        console.error('QR Scanner function not available');
        alert('QR Scanner is not available. Please refresh the page and try again.');
    }
}

// Open Biometric Registration
function openBiometricRegistration(instructorId, instructorName) {
    console.log('Opening biometric registration for instructor:', instructorId, instructorName);
    
    // Close modals first
    closeInstructorRegistrationModal();
    closeRegistrationInstructorsModal();
    
    // Fetch enrolled courses for this student with this instructor
    console.log(`Fetching enrolled courses from: /dashboard/api/student/enrolled-courses/?instructor_id=${instructorId}`);
    
    fetch(`/dashboard/api/student/enrolled-courses/?instructor_id=${instructorId}`)
        .then(response => {
            console.log('API response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('API response data:', data);
            
            if (!data.success) {
                console.error('API error:', data.message);
                showNotification(`Error loading courses: ${data.message}`, 'error');
                return;
            }
            
            if (!data.courses || data.courses.length === 0) {
                console.warn('No enrolled courses found with this instructor', instructorId);
                showNotification('You are not enrolled in any courses with this instructor', 'warning');
                return;
            }
            
            console.log(`Found ${data.courses.length} enrolled courses`);
            
            // Store course IDs for enrollment
            window.enrollmentCourseIds = data.courses.map(c => c.id);
            
            // Create biometric registration modal (simplified without course selection)
            let modal = document.getElementById('biometricRegistrationModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'biometricRegistrationModal';
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 hidden z-[120] flex items-center justify-center p-4 backdrop-blur-sm overflow-y-auto';
                document.body.appendChild(modal);
            }
            
            // Build course list display
            let coursesListHtml = data.courses.map(course => `
                <div class="p-3 rounded-lg border border-green-200 bg-green-50">
                    <div class="font-semibold text-gray-900">${course.code}</div>
                    <div class="text-sm text-gray-600">${course.name}</div>
                </div>
            `).join('');
            
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-xl max-w-sm w-full p-6">
                    <!-- Header -->
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                            <i class="fas fa-fingerprint text-purple-600"></i> Fingerprint
                        </h3>
                        <button onclick="closeBiometricRegistrationModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-lg"></i>
                        </button>
                    </div>
                    
                    <!-- Scan Icon and Status -->
                    <div class="flex flex-col items-center justify-center py-6 mb-4 bg-purple-50 rounded-lg">
                        <i id="scanIcon" class="fas fa-fingerprint text-5xl text-purple-600 mb-3"></i>
                        <p id="scanTitle" class="text-base font-semibold text-gray-800">Ready to Scan</p>
                        <p id="scanSubtitle" class="text-xs text-gray-600 mt-1">0/5</p>
                    </div>
                    
                    <!-- Progress Display - Large Percentage -->
                    <div class="mb-4">
                        <div class="flex flex-col items-center justify-center p-6 bg-purple-50 rounded-lg">
                            <div class="text-6xl font-bold text-purple-600 mb-2" id="percentageDisplay">0%</div>
                            <div class="text-sm text-gray-600 text-center mb-2">
                                <span id="enrollmentCounter" class="text-lg font-semibold text-purple-600">0/5</span> scans completed
                            </div>
                            <div id="enrollmentStatus" class="text-xs text-gray-600 text-center">
                                Ready to start
                            </div>
                        </div>
                    </div>
                    
                    <!-- Results -->
                    <div id="confirmationsList" class="space-y-1 mb-4 max-h-24 overflow-y-auto hidden">
                        <!-- Results appear here -->
                    </div>
                    
                    <!-- Buttons -->
                    <div class="space-y-2">
                        <button id="startEnrollBtn" onclick="startBiometricEnrollment('${instructorName.replace(/'/g, "\\'")}')" class="w-full px-4 py-2.5 bg-purple-600 hover:bg-purple-700 text-white font-semibold text-sm rounded-lg transition">
                            <i class="fas fa-play mr-1"></i> Start
                        </button>
                        <button onclick="closeBiometricRegistrationModal()" class="w-full px-4 py-2 bg-gray-100 text-gray-700 font-medium text-sm rounded-lg hover:bg-gray-200 transition">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            
            modal.classList.remove('hidden');
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeBiometricRegistrationModal();
                }
            });
        })
        .catch(error => {
            console.error('Error fetching courses:', error);
            showNotification(`Error loading courses: ${error.message}`, 'error');
        });
}

// Close Biometric Registration Modal
function closeBiometricRegistrationModal() {
    const modal = document.getElementById('biometricRegistrationModal');
    if (modal) {
        modal.classList.add('hidden');
    }
}

// Start Biometric Enrollment with Real-Time WebSocket Updates
function startBiometricEnrollment(instructorName) {
    console.log('[ENROLLMENT] Starting biometric enrollment');
    
    // Get pre-stored enrolled course IDs
    const courseIds = window.enrollmentCourseIds;
    if (!courseIds || courseIds.length === 0) {
        showNotification('No courses found for enrollment', 'warning');
        return;
    }
    
    console.log(`[ENROLLMENT] Enrolling in ${courseIds.length} courses:`, courseIds);
    
    const btn = document.getElementById('startEnrollBtn');
    const statusEl = document.getElementById('enrollmentStatus');
    const percentageDisplay = document.getElementById('percentageDisplay');
    const counter = document.getElementById('enrollmentCounter');
    const scanIcon = document.getElementById('scanIcon');
    const scanTitle = document.getElementById('scanTitle');
    const scanSubtitle = document.getElementById('scanSubtitle');
    
    // Check if all required elements exist
    if (!btn || !statusEl || !percentageDisplay || !counter || !scanIcon || !scanTitle || !scanSubtitle) {
        console.error('[ENROLLMENT] Missing required modal elements');
        console.error('btn:', btn);
        console.error('statusEl:', statusEl);
        console.error('percentageDisplay:', percentageDisplay);
        console.error('counter:', counter);
        console.error('scanIcon:', scanIcon);
        console.error('scanTitle:', scanTitle);
        console.error('scanSubtitle:', scanSubtitle);
        showNotification('Error: Modal elements missing', 'danger');
        return;
    }
    
    console.log('[ENROLLMENT] All modal elements found');
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Connecting...';
    
    // Generate unique enrollment ID
    const enrollmentId = `enrollment_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    const biometricTemplate = `template_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    
    console.log('[ENROLLMENT] Generated enrollment ID:', enrollmentId);
    
    // Create WebSocket connection for real-time updates
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    let wsHost = window.location.host;
    // If running on localhost with different port, adjust
    if (!wsHost.includes(':') && window.location.hostname === 'localhost') {
        wsHost = 'localhost:8000'; // Explicitly use port 8000 for development
    }
    const wsUrl = `${protocol}//${wsHost}/ws/biometric/enrollment/${enrollmentId}/`;
    
    console.log(`[ENROLLMENT] Connecting to WebSocket: ${wsUrl}`);
    console.log(`[ENROLLMENT] Enrollment ID for group: ${enrollmentId}`);
    
    const socket = new WebSocket(wsUrl);
    let confirmations = 0;
    let confirmationResults = [];
    const R307_IP = '192.168.1.26';
    
    socket.onopen = async (event) => {
        console.log('[WEBSOCKET] âœ“ Connection established');
        console.log('[WEBSOCKET] Socket ready state:', socket.readyState);
        btn.innerHTML = '<i class="fas fa-fingerprint mr-1"></i> Starting scans...';
        // Add small delay to ensure connection is fully ready
        setTimeout(() => startNextScan(), 500);
    };
    
    socket.onmessage = (event) => {
        try {
            console.log('[WEBSOCKET] Raw message data received:', event.data);
            const message = JSON.parse(event.data);
            console.log('[WEBSOCKET] Parsed message:', JSON.stringify(message));
            console.log('[WEBSOCKET] Message type:', message.type);
            
            switch(message.type) {
                case 'scan_update':
                    console.log('[WEBSOCKET] Handling scan_update with slot:', message.slot);
                    handleScanUpdate(message);
                    break;
                case 'enrollment_complete':
                    console.log('[WEBSOCKET] Handling enrollment_complete');
                    handleEnrollmentComplete(message);
                    break;
                case 'enrollment_error':
                    console.log('[WEBSOCKET] Handling enrollment_error');
                    handleEnrollmentError(message);
                    break;
                default:
                    console.log('[WEBSOCKET] Unknown message type:', message.type);
            }
        } catch (error) {
            console.error('[WEBSOCKET] Error parsing message:', error, 'Raw:', event.data);
        }
    };
    
    socket.onerror = (error) => {
        console.error('[WEBSOCKET] ERROR:', error);
        console.error('[WEBSOCKET] Ready state:', socket.readyState);
        showNotification('WebSocket connection error', 'danger');
    };
    
    socket.onclose = (event) => {
        console.log('[WEBSOCKET] Connection closed');
        console.log('[WEBSOCKET] Close code:', event.code);
        console.log('[WEBSOCKET] Close reason:', event.reason);
    };
    
    // Handle scan update from server
    function handleScanUpdate(message) {
        console.log('[SCAN] Processing update with data:', message);
        
        // Extract fields from message
        const slot = message.slot || message.scan_step || 0;
        const success = message.success || false;
        const quality = message.quality || message.quality_score || 0;
        const progress = message.progress || (slot / 5) * 100;
        
        console.log(`[SCAN] Extracted: slot=${slot}, success=${success}, quality=${quality}, progress=${progress}%`);
        
        if (!success) {
            console.warn('[SCAN] Scan failed');
            showNotification(`Scan failed: ${message.message}`, 'warning');
            return;
        }
        
        confirmations = slot;
        confirmationResults.push({success: true, quality: quality, message: message.message});
        
        // Update percentage display - THIS IS THE KEY PART
        const percentageDisplay = document.getElementById('percentageDisplay');
        if (percentageDisplay) {
            const newPercentage = Math.round(progress);
            percentageDisplay.textContent = newPercentage + '%';
            percentageDisplay.style.color = newPercentage === 100 ? '#10b981' : '#9333ea';
            console.log('[PROGRESS] Updated percentage to:', newPercentage + '%');
        } else {
            console.error('[PROGRESS] percentageDisplay element not found!');
        }
        
        // Update counter
        const counter = document.getElementById('enrollmentCounter');
        if (counter) {
            const newText = `${confirmations}/5`;
            counter.textContent = newText;
            console.log('[PROGRESS] Updated counter to:', newText);
        } else {
            console.error('[PROGRESS] counter element not found!');
        }
        
        // Update status
        const statusEl = document.getElementById('enrollmentStatus');
        if (statusEl) {
            statusEl.innerHTML = `<i class="fas fa-fingerprint mr-2"></i> Scan ${confirmations}/5 captured - Quality: ${quality}%`;
        }
        
        // Update icon
        const scanIcon = document.getElementById('scanIcon');
        if (scanIcon) {
            scanIcon.innerHTML = '<i class="fas fa-circle-check text-5xl text-green-500 mb-3"></i>';
        }
        const scanTitle = document.getElementById('scanTitle');
        if (scanTitle) {
            scanTitle.textContent = `Scan ${confirmations}/5`;
        }
        const scanSubtitle = document.getElementById('scanSubtitle');
        if (scanSubtitle) {
            scanSubtitle.textContent = `Quality: ${quality}%`;
        }
        
        console.log('[SCAN] Update complete - slot:', confirmations, 'progress:', progress + '%');
        
        if (confirmations < 5) {
            setTimeout(() => {
                startNextScan();
            }, 500);
        } else {
            handleEnrollmentComplete({success: true, courses_enrolled: courseIds.length});
        }
    }
    
    function handleEnrollmentComplete(message) {
        console.log('[ENROLLMENT] Complete:', message);
        statusEl.innerHTML = '<i class="fas fa-check mr-2"></i> Enrollment complete!';
        scanTitle.textContent = 'Success!';
        scanSubtitle.textContent = `${courseIds.length} course(s) enrolled`;
        submitBiometricEnrollment(confirmations, biometricTemplate, courseIds);
        if (socket.readyState === WebSocket.OPEN) socket.close();
    }
    
    function handleEnrollmentError(message) {
        console.error('[ENROLLMENT] Error:', message);
        showNotification(`Error: ${message.message}`, 'danger');
        scanIcon.innerHTML = '<i class="fas fa-exclamation-triangle text-5xl text-red-500 mb-3"></i>';
        scanTitle.textContent = 'Error';
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-redo mr-1"></i> Retry';
        if (socket.readyState === WebSocket.OPEN) socket.close();
    }
    
    // Start scanning for next fingerprint
    async function startNextScan() {
        confirmations++;
        console.log('[SCAN] Starting scan', confirmations);
        
        scanIcon.innerHTML = '<i class="fas fa-fingerprint text-5xl text-blue-500 mb-3 animate-pulse"></i>';
        scanTitle.textContent = `Scan ${confirmations} of 5`;
        scanSubtitle.textContent = 'Place your finger on sensor';
        statusEl.innerHTML = `<i class="fas fa-fingerprint mr-2"></i> Ready for scan ${confirmations}...`;
        
        try {
            const enrollPayload = {
                slot: confirmations,
                template_id: enrollmentId
            };
            
            console.log('[SCAN] Sending to Arduino:', JSON.stringify(enrollPayload));
            
            const response = await fetch(`http://${R307_IP}/enroll`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(enrollPayload)
            });
            
            const r307Data = await response.json();
            console.log('[SCAN] Arduino response:', r307Data);
            
            if (r307Data.success) {
                statusEl.innerHTML = `<i class="fas fa-fingerprint mr-2"></i> Scanning fingerprint ${confirmations}/5...`;
            } else {
                console.error('[SCAN] Arduino returned error:', r307Data.message);
            }
        } catch (error) {
            console.error('[SCAN] Arduino error:', error);
            showNotification(`Cannot reach Arduino at ${R307_IP}`, 'danger');
            scanIcon.innerHTML = '<i class="fas fa-exclamation-triangle text-5xl text-red-500 mb-3"></i>';
            scanTitle.textContent = 'Connection Error';
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-redo mr-1"></i> Retry';
        }
    }
}

// Submit biometric enrollment to backend
function submitBiometricEnrollment(confirmations, biometricTemplate, courseIds) {
    // Get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Submit for each selected course
    let successCount = 0;
    let failureCount = 0;
    const totalCourses = courseIds.length;
    
    courseIds.forEach((courseId, index) => {
        const enrollmentData = {
            course_id: courseId,
            biometric_data: biometricTemplate,
            biometric_type: 'fingerprint',
            confirmations: confirmations
        };
        
        console.log(`Submitting biometric enrollment for course ${courseId}:`, enrollmentData);
        
        fetch('{% url "dashboard:api_biometric_enroll" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(enrollmentData)
        })
        .then(response => response.json())
        .then(data => {
            console.log(`Enrollment response for course ${courseId}:`, data);
            
            if (data.success) {
                successCount++;
            } else {
                failureCount++;
            }
            
            // Update UI when all courses are processed
            if (successCount + failureCount === totalCourses) {
                const statusEl = document.getElementById('enrollmentStatus');
                const scanTitle = document.getElementById('scanTitle');
                const scanSubtitle = document.getElementById('scanSubtitle');
                const scanIcon = document.getElementById('scanIcon');
                
                if (failureCount === 0) {
                    // All successful
                    scanIcon.innerHTML = '<i class="fas fa-check-circle text-6xl text-green-500 mb-4"></i>';
                    scanTitle.textContent = 'Enrollment Successful!';
                    scanSubtitle.textContent = `Fingerprint registered in ${successCount} course(s)`;
                    statusEl.innerHTML = `<i class="fas fa-check mr-2 text-green-600"></i> <span class="text-green-700">Fingerprint enrolled successfully</span>`;
                    
                    showNotification(`Fingerprint enrolled in ${successCount} course(s) with 5 confirmations!`, 'success');
                    
                    setTimeout(() => {
                        closeBiometricRegistrationModal();
                    }, 2000);
                } else {
                    // Partial or complete failure
                    scanIcon.innerHTML = '<i class="fas fa-exclamation-circle text-6xl text-orange-500 mb-4"></i>';
                    scanTitle.textContent = failureCount === totalCourses ? 'Enrollment Failed' : 'Partial Enrollment';
                    scanSubtitle.textContent = `Success: ${successCount}/${totalCourses}`;
                    statusEl.innerHTML = `<i class="fas fa-warning mr-2 text-orange-600"></i> <span class="text-orange-700">Enrolled in ${successCount}/${totalCourses} courses</span>`;
                    
                    showNotification(`Enrolled in ${successCount}/${totalCourses} courses`, failureCount === totalCourses ? 'error' : 'warning');
                    
                    // Re-enable start button
                    const btn = document.getElementById('startEnrollBtn');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-play mr-2"></i> Start Enrollment';
                }
            }
        })
        .catch(error => {
            console.error(`Enrollment error for course ${courseId}:`, error);
            failureCount++;
            
            if (successCount + failureCount === totalCourses) {
                showNotification(`Error during enrollment: ${error.message}`, 'error');
                
                // Re-enable start button
                const btn = document.getElementById('startEnrollBtn');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-play mr-2"></i> Start Enrollment';
            }
        });
    });
}

function openRegistrationMethods(instructorId, instructorName) {
    // Close modals first
    closeInstructorRegistrationModal();
    closeRegistrationInstructorsModal();
    
    // Set the registration mode to student self-registration
    window.isStudentRegisterMode = true;
    
    // Store instructor ID for backend reference
    window.currentInstructorId = instructorId;
    
    // Set student ID prefill from page data if available
    const studentIdPrefill = document.querySelector('[data-student-id]')?.getAttribute('data-student-id') || '';
    
    // Get all courses from the current registration modal (before we close it)
    // In the QR scanner, we'll use courseId 0 as a special marker for multi-course registration
    console.log('Opening QR Scanner in student registration mode for instructor:', instructorId);
    
    // Open QR Scanner - courseId of 0 indicates student registering with instructor (multi-course)
    if (typeof window.openQRScanner === 'function') {
        window.openQRScanner(0, studentIdPrefill, '');
    } else {
        console.error('QR Scanner function not available');
        alert('QR Scanner is not available. Please refresh the page and try again.');
    }
}
</script>

<script>
function safeOpenDroppedModal() {
    try {
        console.log('[Dropped] safeOpenDroppedModal clicked');
        if (typeof openDroppedModal === 'function') {
            openDroppedModal();
            return;
        }
        const modal = document.getElementById('droppedEnrollmentsModal');
        const list = document.getElementById('droppedList');
        if (!modal || !list) {
            console.warn('Dropped modal or list not found in DOM');
            return;
        }
        list.innerHTML = '<div class="text-center py-8 text-gray-500">Loading...</div>';
        modal.classList.remove('hidden');
        fetch('{% url "dashboard:student_dropped_enrollments" %}')
            .then(r => r.json())
            .then(data => {
                if (!data.success) {
                    list.innerHTML = `<div class="text-red-600 p-4">${data.message || 'Failed to load dropped enrollments.'}</div>`;
                    return;
                }
                if (!data.dropped_enrollments || data.dropped_enrollments.length === 0) {
                    list.innerHTML = '<div class="text-center py-8 text-gray-500">No dropped enrollments.</div>';
                    return;
                }
                list.innerHTML = '';
                data.dropped_enrollments.forEach(en => {
                    const daysLeft = en.days_left !== null && en.days_left !== undefined ? `${en.days_left} day(s) left` : 'N/A';
                    const item = document.createElement('div');
                    item.className = 'p-3 border rounded-lg flex items-center justify-between gap-3';
                    item.innerHTML = `
                        <div>
                            <div class="font-semibold">${en.course_code} - ${en.course_name}</div>
                            <div class="text-xs text-gray-500">Dropped: ${en.dropped_date} â€¢ ${daysLeft}</div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="promptDroppedAction('restore', ${en.id}, '${en.course_code} - ${en.course_name}')" class="px-3 py-1 bg-emerald-600 text-white rounded text-sm">Restore</button>
                            <button onclick="promptDroppedAction('delete', ${en.id}, '${en.course_code} - ${en.course_name}')" class="px-3 py-1 bg-red-600 text-white rounded text-sm">Delete</button>
                        </div>
                    `;
                    list.appendChild(item);
                });
            })
            .catch(err => {
                list.innerHTML = '<div class="text-red-600 p-4">Error loading dropped enrollments.</div>';
                console.error(err);
            });
    } catch (e) {
        console.error('safeOpenDroppedModal error', e);
    }
}

</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const btn = document.getElementById('openDroppedBtn');
    if (btn) {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            if (typeof openDroppedModal === 'function') {
                openDroppedModal();
                return;
            }

            // Fallback: perform fetch and show modal even if openDroppedModal is unavailable
            const modal = document.getElementById('droppedEnrollmentsModal');
            const list = document.getElementById('droppedList');
            if (!modal || !list) return;
            list.innerHTML = '<div class="text-center py-8 text-gray-500">Loading...</div>';
            modal.classList.remove('hidden');

            fetch('{% url "dashboard:student_dropped_enrollments" %}')
                .then(r => r.json())
                .then(data => {
                    if (!data.success) {
                        list.innerHTML = `<div class="text-red-600 p-4">${data.message || 'Failed to load dropped enrollments.'}</div>`;
                        return;
                    }
                    if (!data.dropped_enrollments || data.dropped_enrollments.length === 0) {
                        list.innerHTML = '<div class="text-center py-8 text-gray-500">No dropped enrollments.</div>';
                        return;
                    }
                    list.innerHTML = '';
                    data.dropped_enrollments.forEach(en => {
                        const daysLeft = en.days_left !== null && en.days_left !== undefined ? `${en.days_left} day(s) left` : 'N/A';
                        const item = document.createElement('div');
                        item.className = 'p-3 border rounded-lg flex items-center justify-between gap-3';
                        item.innerHTML = `
                            <div>
                                <div class="font-semibold">${en.course_code} - ${en.course_name}</div>
                                <div class="text-xs text-gray-500">Dropped: ${en.dropped_date} â€¢ ${daysLeft}</div>
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="promptDroppedAction('restore', ${en.id}, '${en.course_code} - ${en.course_name}')" class="px-3 py-1 bg-emerald-600 text-white rounded text-sm">Restore</button>
                                <button onclick="promptDroppedAction('delete', ${en.id}, '${en.course_code} - ${en.course_name}')" class="px-3 py-1 bg-red-600 text-white rounded text-sm">Delete</button>
                            </div>
                        `;
                        list.appendChild(item);
                    });
                })
                .catch(err => {
                    list.innerHTML = '<div class="text-red-600 p-4">Error loading dropped enrollments.</div>';
                    console.error(err);
                });
        });
    }
});
</script>

<!-- Unenroll Confirmation Modal -->
<div id="unenrollModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 backdrop-blur-sm hidden z-[110] flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 md:p-8">
        <div class="flex justify-between items-start mb-6">
            <h3 class="text-2xl font-bold flex items-center text-red-600">
                <i class="fas fa-user-minus w-6 h-6 mr-2"></i> Drop this Course
            </h3>
            <button onclick="closeUnenrollModal()" class="text-gray-400 hover:text-gray-600 transition duration-150 hover:opacity-75">
                <i class="fas fa-times w-6 h-6"></i>
            </button>
        </div>
        <div class="space-y-4">
            <p class="text-gray-700 font-semibold">Are you sure you want to drop from this course?</p>
            <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded">
                <p class="font-semibold text-red-800" id="unenroll-course-name"></p>
            </div>
            <p class="text-sm text-gray-600">This action cannot be undone.</p>
            <input type="hidden" id="unenroll-enrollment-id">
            <div class="flex justify-end space-x-3 pt-6 border-t border-gray-100">
                <button onclick="closeUnenrollModal()" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition duration-150 shadow-sm">
                    Cancel
                </button>
                <button onclick="confirmUnenroll()" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-150 shadow-sm">
                    <i class="fas fa-user-minus mr-2"></i> Drop
                </button>
            </div>
        </div>
    </div>
</div>
{% include 'dashboard/partials/qr_scanner_basic.html' %}

<!-- Registration Instructors Modal -->
<div id="registrationInstructorsModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 backdrop-blur-sm hidden z-[115] flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[80vh] overflow-y-auto">
        <div class="flex justify-between items-center px-6 py-4 border-b border-gray-200 sticky top-0 bg-white">
            <h3 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                <i class="fas fa-clipboard-check"></i> Registration
            </h3>
            <button onclick="closeRegistrationInstructorsModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-lg"></i></button>
        </div>
        <div id="registrationInstructorsContent" class="p-6">
            <div class="text-center py-8 text-gray-500">
                <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                <p>Loading registration data...</p>
            </div>
        </div>
    </div>
</div>

        <!-- Dropped Enrollments Modal (inserted) -->
        <div id="droppedEnrollmentsModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 backdrop-blur-sm hidden z-[115] flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl p-6 md:p-8 max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">Dropped Courses</h3>
                    <button onclick="document.getElementById('droppedEnrollmentsModal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
                </div>
                <div id="droppedList" class="space-y-3">
                    <!-- Dropped enrollments will be loaded here -->
                </div>
                <div class="mt-6 text-sm text-gray-600">Dropped enrollments are kept for 14 days before permanent deletion.</div>
            </div>
        </div>

        <!-- Confirmation Modal for Dropped Actions -->
        <div id="droppedConfirmModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden z-[120] flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-xl w-full max-w-md p-6">
                <h3 class="text-lg font-bold mb-2" id="droppedConfirmTitle">Confirm action</h3>
                <p class="text-sm text-gray-700 mb-4" id="droppedConfirmMessage">Are you sure?</p>
                <div class="flex justify-end gap-3">
                    <button onclick="closeDroppedConfirm()" class="px-4 py-2 bg-gray-200 rounded">Cancel</button>
                    <button id="droppedConfirmBtn" onclick="executeDroppedAction()" class="px-4 py-2 bg-red-600 text-white rounded">Confirm</button>
                </div>
            </div>
        </div>

        <script>
        // State for pending action
        window._droppedPending = { type: null, id: null, name: null };

        function promptDroppedAction(type, enrollmentId, name) {
            // type: 'restore' or 'delete'
            window._droppedPending = { type: type, id: enrollmentId, name: name };
            const title = type === 'restore' ? 'Restore enrollment' : 'Permanently delete enrollment';
            const message = type === 'restore' ? `Restore ${name}? This will re-activate your enrollment.` : `Permanently delete ${name}? This cannot be undone.`;
            document.getElementById('droppedConfirmTitle').textContent = title;
            document.getElementById('droppedConfirmMessage').textContent = message;
            document.getElementById('droppedConfirmBtn').textContent = type === 'restore' ? 'Restore' : 'Delete permanently';
            // style confirm button
            document.getElementById('droppedConfirmBtn').className = type === 'restore' ? 'px-4 py-2 bg-emerald-600 text-white rounded' : 'px-4 py-2 bg-red-600 text-white rounded';
            document.getElementById('droppedConfirmModal').classList.remove('hidden');
        }

        function closeDroppedConfirm() {
            document.getElementById('droppedConfirmModal').classList.add('hidden');
            window._droppedPending = { type: null, id: null, name: null };
        }

        function executeDroppedAction() {
            const pending = window._droppedPending;
            if (!pending || !pending.id || !pending.type) return closeDroppedConfirm();

            const enrollmentId = pending.id;
            const action = pending.type;
            const url = action === 'restore' ? `{% url 'dashboard:student_restore_enrollment' 0 %}`.replace('0', enrollmentId) : `{% url 'dashboard:student_permanent_delete_enrollment' 0 %}`.replace('0', enrollmentId);
            const method = 'POST';
            const headers = { 'Content-Type': 'application/json', 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value };

            // Disable confirm button while processing
            const btn = document.getElementById('droppedConfirmBtn');
            const origText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';

            fetch(url, { method: method, headers: headers })
                .then(r => r.json())
            .then(data => {
                btn.disabled = false;
                btn.innerHTML = origText;
                closeDroppedConfirm();
                if (data && data.success) {
                    if (typeof showNotification === 'function') {
                        showNotification(data.message || 'Success', 'success');
                    } else {
                        alert(data.message || 'Success');
                    }
                    // Always reload the page shortly after success to reflect changes
                    setTimeout(() => { window.location.reload(); }, 600);
                } else {
                    if (typeof showNotification === 'function') {
                        showNotification(data.message || 'Failed', 'error');
                    } else {
                        alert(data.message || 'Failed');
                    }
                }
            })
                .catch(err => {
                    btn.disabled = false;
                    btn.innerHTML = origText;
                    closeDroppedConfirm();
                    console.error(err);
                    if (typeof showNotification === 'function') {
                        showNotification('An error occurred. Please try again.', 'error');
                    } else {
                        alert('An error occurred. Please try again.');
                    }
                });
        }
        </script>

{% endblock %}

