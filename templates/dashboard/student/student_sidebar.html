<!-- templates/dashboard/student/student_sidebar.html -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<style>
    .cropper-container {
        max-width: 100%;
        max-height: 500px;
        min-height: 300px;
        position: relative;
    }
    
    .cropper-container .cropper-crop-box {
        border: 2px solid #3b82f6 !important;
        box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5) !important;
        background-color: transparent !important;
    }
    
    .cropper-container .cropper-canvas {
        background-color: transparent !important;
    }
    
    .cropper-container .cropper-view-box {
        outline: 1px solid rgba(59, 130, 246, 0.5) !important;
        background-color: transparent !important;
    }
    
    /* Background overlay for the entire cropper container (outside the image) */
    .cropper-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: -1;
    }
    
    .cropper-container .cropper-crop-box .cropper-point {
        width: 10px !important;
        height: 10px !important;
        background-color: #3b82f6 !important;
        border: 2px solid white !important;
        border-radius: 50% !important;
    }
    
    .cropper-container .cropper-crop-box .cropper-point:hover {
        background-color: #2563eb !important;
        transform: scale(1.15);
        transition: all 0.2s;
    }
    /* Remove underlines from all sidebar links and buttons */
    .sidebar-link,
    .sidebar-link:hover,
    .sidebar-link:focus,
    .sidebar-link:active,
    .sidebar-link:visited {
        text-decoration: none !important;
    }
    
    .sidebar-link span,
    .sidebar-link .font-medium {
        text-decoration: none !important;
    }
    
    #sidebar a,
    #sidebar a:hover,
    #sidebar a:focus,
    #sidebar a:active,
    #sidebar a:visited {
        text-decoration: none !important;
    }
    
    #sidebar button,
    #sidebar button:hover,
    #sidebar button:focus,
    #sidebar button:active {
        text-decoration: none !important;
    }

    /* Rainbow Loading Spinner */
    .rainbow-spinner {
        position: relative;
        width: 120px;
        height: 120px;
    }

    .rainbow-spinner::before {
        content: '';
        position: absolute;
        inset: 0;
        border-radius: 50%;
        background: conic-gradient(
            from 0deg,
            #FF0000, #FF7F00, #FFFF00, #00FF00, #0000FF, #4B0082, #9400D3, #FF0000
        );
        animation: rainbowSpin 2s linear infinite;
        padding: 4px;
    }

    .rainbow-spinner::after {
        content: '';
        position: absolute;
        inset: 4px;
        border-radius: 50%;
        background: white;
        z-index: 10;
    }

    .rainbow-spinner img {
        position: absolute;
        width: 70px;
        height: 70px;
        border-radius: 50%;
        object-fit: contain;
        z-index: 11;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }

    @keyframes rainbowSpin {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
    }
</style>
<!-- Mobile Overlay -->
<div id="sidebar-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-40 lg:hidden hidden" onclick="toggleSidebar()"></div>

<!-- Sidebar Content -->
<aside id="sidebar" class="fixed inset-y-0 left-0 transform -translate-x-full lg:translate-x-0 lg:fixed lg:w-64 w-64 text-white p-6 shadow-2xl transition-transform duration-300 ease-in-out z-40 flex flex-col relative overflow-hidden" style="background: linear-gradient(180deg, #3C4770 0%, #447294 100%); box-shadow: 2px 0 10px rgba(60, 71, 112, 0.3); top: 64px; height: calc(100vh - 64px);">
    <!-- Header - Fixed at top -->
    <div class="flex items-center justify-between mb-8 pb-4 border-b flex-shrink-0" style="border-color: rgba(190, 129, 153, 0.3);">
        <div class="flex items-center">
            <i class="fas fa-graduation-cap text-2xl mr-2" style="color: #BE8199;"></i>
            <h2 class="text-2xl font-bold tracking-wider">Student</h2>
        </div>
        <button class="lg:hidden p-1 rounded-full hover:bg-white/20" onclick="toggleSidebar()">
            <i class="fas fa-times text-xl"></i>
        </button>
    </div>

    <!-- Navigation - Scrollable area in the middle -->
    <nav id="sidebar-nav" class="space-y-4 flex-1 overflow-y-auto min-h-0" style="scrollbar-width: thin; scrollbar-color: #BE8199 #3C4770; overscroll-behavior: contain;">
        <!-- Navigation Section -->
        <div class="space-y-2">
            <div class="px-4 py-2">
                <h3 class="text-xs font-semibold uppercase tracking-wider" style="color: rgba(190, 129, 153, 0.8);">Navigation</h3>
            </div>
            <a href="{% url 'dashboard:student_dashboard' %}" class="sidebar-link flex items-center w-full px-4 py-3 rounded-xl transition duration-150 {% if request.resolver_match.url_name == 'student_dashboard' %}shadow-lg{% else %}hover:bg-white/10{% endif %}" style="{% if request.resolver_match.url_name == 'student_dashboard' %}background-color: #BE8199; color: #3C4770;{% else %}color: #ffffff;{% endif %}">
                <i class="fas fa-home w-5 h-5 mr-3 flex-shrink-0" style="{% if request.resolver_match.url_name == 'student_dashboard' %}color: #3C4770;{% else %}color: #BE8199;{% endif %}"></i>
                <span class="font-medium text-left flex-grow">Home</span>
            </a>
        </div>

        <!-- School Section -->
        <div class="space-y-2">
            <div class="px-4 py-2">
                <h3 class="text-xs font-semibold uppercase tracking-wider" style="color: rgba(190, 129, 153, 0.8);">School</h3>
            </div>
            <a href="{% url 'dashboard:weekly_timetable' %}" class="sidebar-link flex items-center w-full px-4 py-3 rounded-xl transition duration-150 {% if request.resolver_match.url_name == 'weekly_timetable' %}shadow-lg{% else %}hover:bg-white/10{% endif %}" style="{% if request.resolver_match.url_name == 'weekly_timetable' %}background-color: #BE8199; color: #3C4770;{% else %}color: #ffffff;{% endif %}">
                <i class="fas fa-calendar w-5 h-5 mr-3 flex-shrink-0" style="{% if request.resolver_match.url_name == 'weekly_timetable' %}color: #3C4770;{% else %}color: #BE8199;{% endif %}"></i>
                <span class="font-medium text-left flex-grow">Class Schedule</span>
            </a>
            <a href="{% url 'dashboard:enroll_course' %}" class="sidebar-link flex items-center w-full px-4 py-3 rounded-xl transition duration-150 {% if request.resolver_match.url_name == 'enroll_course' %}shadow-lg{% else %}hover:bg-white/10{% endif %}" style="{% if request.resolver_match.url_name == 'enroll_course' %}background-color: #BE8199; color: #3C4770;{% else %}color: #ffffff;{% endif %}">
                <i class="fas fa-user-plus w-5 h-5 mr-3 flex-shrink-0" style="{% if request.resolver_match.url_name == 'enroll_course' %}color: #3C4770;{% else %}color: #BE8199;{% endif %}"></i>
                <span class="font-medium text-left flex-grow">Enroll Course</span>
            </a>
            <a href="{% url 'dashboard:student_todays_status' %}" class="sidebar-link flex items-center w-full px-4 py-3 rounded-xl transition duration-150 {% if request.resolver_match.url_name == 'student_todays_status' %}shadow-lg{% else %}hover:bg-white/10{% endif %}" style="{% if request.resolver_match.url_name == 'student_todays_status' %}background-color: #BE8199; color: #3C4770;{% else %}color: #ffffff;{% endif %}">
                <i class="fas fa-clock w-5 h-5 mr-3 flex-shrink-0" style="{% if request.resolver_match.url_name == 'student_todays_status' %}color: #3C4770;{% else %}color: #BE8199;{% endif %}"></i>
                <span class="font-medium text-left flex-grow">My Attendance</span>
            </a>
            <a href="{% url 'dashboard:student_attendance_log' %}" class="sidebar-link flex items-center w-full px-4 py-3 rounded-xl transition duration-150 {% if request.resolver_match.url_name == 'student_attendance_log' %}shadow-lg{% else %}hover:bg-white/10{% endif %}" style="{% if request.resolver_match.url_name == 'student_attendance_log' %}background-color: #BE8199; color: #3C4770;{% else %}color: #ffffff;{% endif %}">
                <i class="fas fa-list w-5 h-5 mr-3 flex-shrink-0" style="{% if request.resolver_match.url_name == 'student_attendance_log' %}color: #3C4770;{% else %}color: #BE8199;{% endif %}"></i>
                <span class="font-medium text-left flex-grow">Attendance Log</span>
            </a>
        </div>

    </nav>

    <!-- Profile Section - Fixed at Bottom -->
    <div class="pt-4 mt-6 border-t flex-shrink-0" style="border-color: rgba(190, 129, 153, 0.3);">
        <button onclick="openProfileModal()" class="w-full flex items-center mb-4 hover:bg-white/10 rounded-xl p-2 transition cursor-pointer group" style="color: #ffffff;">
            {% if user.profile_picture %}
            <img id="sidebar-profile-picture" src="{{ user.profile_picture.url }}?v={{ user.id }}" alt="Profile" class="w-10 h-10 rounded-full object-cover border-2 border-white flex-shrink-0">
            <div id="sidebar-profile-placeholder" class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg border-2 border-white text-white flex-shrink-0 hidden" style="background: rgba(190, 129, 153, 0.3);">
                {{ user.full_name|first|upper|default:"S" }}
            </div>
            {% else %}
            <img id="sidebar-profile-picture" src="" alt="Profile" class="w-10 h-10 rounded-full object-cover border-2 border-white flex-shrink-0 hidden">
            <div id="sidebar-profile-placeholder" class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg border-2 border-white text-white flex-shrink-0" style="background: rgba(190, 129, 153, 0.3);">
                {{ user.full_name|first|upper|default:"S" }}
            </div>
            {% endif %}
            <div class="ml-3 flex-1 min-w-0 text-left">
                <div class="text-sm font-semibold text-white truncate">{{ user.full_name|default:"Student" }}</div>
                <div class="text-xs truncate" style="color: rgba(255, 255, 255, 0.8);">ID: {{ user.school_id|default:"N/A" }}</div>
                {% if user.school_name %}
                <div class="text-xs truncate" style="color: rgba(190, 129, 153, 0.9);">{{ user.school_name }}</div>
                {% endif %}
            </div>
        </button>
        <a href="javascript:void(0)" data-logout-url="{% url 'logout' %}" onclick="showLogoutLoadingModal(this.dataset.logoutUrl)" class="flex items-center w-full px-4 py-3 rounded-xl transition duration-150 shadow-md hover:bg-white/20" style="color: rgba(255, 255, 255, 0.9); background: rgba(190, 129, 153, 0.2);">
            <i class="fas fa-sign-out-alt w-5 h-5 mr-3"></i>
            <span class="font-medium">Logout</span>
        </a>
    </div>
</aside>

<script>
    // Maintain active state on click for student sidebar
    document.addEventListener('DOMContentLoaded', function() {
        const sidebarLinks = document.querySelectorAll('#sidebar-nav .sidebar-link');
        
        // Function to apply active styling
        function applyActiveStyle(link) {
            link.classList.add('shadow-lg');
            link.style.backgroundColor = '#BE8199';
            link.style.color = '#3C4770';
            const icon = link.querySelector('i');
            if (icon) {
                icon.style.color = '#3C4770';
            }
        }
        
        // Function to remove active styling
        function removeActiveStyle(link) {
            link.classList.remove('shadow-lg');
            link.style.backgroundColor = '';
            link.style.color = '#ffffff';
            const icon = link.querySelector('i');
            if (icon) {
                icon.style.color = '#BE8199';
            }
        }
        
        // Set initial active state based on Django template
        sidebarLinks.forEach(link => {
            if (link.classList.contains('shadow-lg') || link.style.backgroundColor === 'rgb(190, 129, 153)') {
                applyActiveStyle(link);
            } else {
                removeActiveStyle(link);
            }
        });
        
        // Handle clicks to maintain active state and show loading
        sidebarLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                const href = this.getAttribute('href');
                
                // Show loading if it's a valid link (not #)
                if (href && href !== '#') {
                    // Show loading overlay
                    const loadingOverlay = document.createElement('div');
                    loadingOverlay.id = 'sidebar-loading-overlay';
                    loadingOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 z-[10000] flex items-center justify-center';
                    loadingOverlay.innerHTML = `
                        <div class="rainbow-spinner">
                            <img src="/static/img/attendance-logo.png" alt="Loading">
                        </div>
                    `;
                    document.body.appendChild(loadingOverlay);
                    console.log('[SIDEBAR] Loading overlay shown for:', href);
                }
                
                // Remove active state from all links
                sidebarLinks.forEach(l => {
                    removeActiveStyle(l);
                });
                
                // Apply active state to clicked link
                applyActiveStyle(this);
            });
        });
        
        // Monitor for URL changes to update active state
        let currentUrl = window.location.pathname;
        setInterval(function() {
            if (window.location.pathname !== currentUrl) {
                currentUrl = window.location.pathname;
                // Re-check active states after navigation
                sidebarLinks.forEach(link => {
                    const href = link.getAttribute('href');
                    if (href && href !== '#' && (currentUrl.includes(href.split('/').pop()) || 
                        currentUrl === href || 
                        currentUrl.endsWith(href))) {
                        sidebarLinks.forEach(l => removeActiveStyle(l));
                        applyActiveStyle(link);
                    }
                });
            }
        }, 100);
    });
</script>

<!-- Profile Modal -->
<div id="profile-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 backdrop-blur-sm hidden z-[110] flex items-start justify-center p-4 overflow-y-auto" style="padding-top: 5vh;">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl mt-8 mb-8 p-6 md:p-8">
        <div class="flex justify-between items-start mb-6">
            <h3 class="text-2xl font-bold flex items-center" style="color: #3C4770;">
                <i class="fas fa-user-circle w-6 h-6 mr-2"></i> Student Profile
            </h3>
            <button onclick="closeProfileModal()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times w-6 h-6"></i>
            </button>
        </div>
        
        <form id="profileForm" method="POST" action="{% url 'dashboard:student_update_profile' %}" enctype="multipart/form-data" class="space-y-6">
            {% csrf_token %}
            <!-- Profile Header -->
            <div class="flex items-center space-x-6 pb-6 border-b border-gray-200">
                <div class="relative">
                    {% if user.profile_picture %}
                    <img src="{{ user.profile_picture.url }}?v={{ user.id }}" alt="Profile" id="profile-picture-preview" class="w-24 h-24 rounded-full object-cover border-4" style="border-color: rgba(190, 129, 153, 0.3);" data-original-src="{{ user.profile_picture.url }}?v={{ user.id }}">
                    <div id="profile-picture-placeholder" class="w-24 h-24 rounded-full flex items-center justify-center font-bold text-4xl border-4 text-white hidden" style="background-color: #3C4770; border-color: rgba(190, 129, 153, 0.3);">
                        {{ user.full_name|first|upper|default:"S" }}
                    </div>
                    {% else %}
                    <img src="" alt="Profile" id="profile-picture-preview" class="w-24 h-24 rounded-full object-cover border-4 hidden" style="border-color: rgba(190, 129, 153, 0.3);" data-original-src="">
                    <div id="profile-picture-placeholder" class="w-24 h-24 rounded-full flex items-center justify-center font-bold text-4xl border-4 text-white" style="background-color: #3C4770; border-color: rgba(190, 129, 153, 0.3);">
                        {{ user.full_name|first|upper|default:"S" }}
                    </div>
                    {% endif %}
                    <label for="profile_picture_input" id="profile-picture-edit-label" class="absolute bottom-0 right-0 w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center cursor-pointer hover:bg-blue-600 transition shadow-lg hidden">
                        <i class="fas fa-camera text-white text-sm"></i>
                    </label>
                    <input type="file" name="profile_picture" id="profile_picture_input" accept="image/*" class="hidden" onchange="openProfilePictureCropper(this)">
                </div>
                <div class="flex-1">
                    <div id="profile-name-container">
                        <h2 class="text-2xl font-bold text-gray-900 mb-2" id="profile-name-display" data-original-value="{{ user.full_name|default:'Student' }}">{{ user.full_name|default:"Student" }}</h2>
                        <input type="hidden" name="full_name" id="profile-name-input" value="{{ user.full_name|default:'' }}">
                        <div id="profile-name-fields" class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-2" style="display: none;">
                            <div>
                                <label for="profile-first-name-input" class="block text-xs font-medium text-gray-600 mb-1">First Name</label>
                                <input type="text" name="first_name" id="profile-first-name-input" class="w-full px-3 py-2 border-2 border-blue-400 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white text-gray-900 font-semibold" placeholder="First">
                            </div>
                            <div>
                                <label for="profile-middle-name-input" class="block text-xs font-medium text-gray-600 mb-1">Middle Name</label>
                                <input type="text" name="middle_name" id="profile-middle-name-input" class="w-full px-3 py-2 border-2 border-blue-400 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white text-gray-900 font-semibold" placeholder="Middle (optional)">
                            </div>
                            <div>
                                <label for="profile-last-name-input" class="block text-xs font-medium text-gray-600 mb-1">Last Name</label>
                                <input type="text" name="last_name" id="profile-last-name-input" class="w-full px-3 py-2 border-2 border-blue-400 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white text-gray-900 font-semibold" placeholder="Last">
                            </div>
                        </div>
                    </div>
                    <p class="text-gray-600 mb-2">{{ user.email }}</p>
                    <span class="inline-block mt-2 px-3 py-1 rounded-full text-sm font-semibold" style="background-color: #DFCFD5; color: #3C4770;">
                        <i class="fas fa-graduation-cap mr-1"></i>Student
                    </span>
                </div>
            </div>

            <!-- Profile Details -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Department Input -->
                <div class="bg-gray-50 p-4 rounded-xl">
                    <label class="block text-sm font-medium text-gray-500 mb-1">DEPARTMENT</label>
                    <p id="profile-department-display" class="text-lg font-semibold text-gray-900" style="text-transform: uppercase;">{{ user.department|default:"Not Assigned" }}</p>
                    <input type="text" name="department" id="profile-department-input" value="" class="w-full px-3 py-2 border-2 border-blue-400 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white text-gray-900 font-semibold text-lg" style="display: none; text-transform: uppercase;" placeholder="Enter Department">
                </div>
                
                <div class="bg-gray-50 p-4 rounded-xl">
                    <label class="block text-sm font-medium text-gray-500 mb-1">ID Number</label>
                    <p class="text-lg font-semibold text-gray-900 font-mono">{{ user.school_id|default:"Not Set" }}</p>
                </div>
                
                <!-- Program Input -->
                <div class="bg-gray-50 p-4 rounded-xl">
                    <label class="block text-sm font-medium text-gray-500 mb-1">PROGRAM</label>
                    <p id="profile-program-display" class="text-lg font-semibold text-gray-900" style="text-transform: uppercase;">
                        {% if user.program_text %}
                            {{ user.program_text }}
                        {% elif user.program %}
                            {% if user.program.code %}{{ user.program.code }} - {% endif %}{{ user.program.name }}
                        {% else %}
                            Not Assigned
                        {% endif %}
                    </p>
                    <input type="text" name="program" id="profile-program-input" value="" class="w-full px-3 py-2 border-2 border-blue-400 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white text-gray-900 font-semibold text-lg" style="display: none; text-transform: uppercase;" placeholder="Enter Program" data-program-code="{% if user.program %}{{ user.program.code }}{% endif %}" data-program-name="{% if user.program %}{{ user.program.name }}{% endif %}">
                </div>
                
                <!-- Account Status -->
                <div class="bg-gray-50 p-4 rounded-xl">
                    <label class="block text-sm font-medium text-gray-500 mb-1">Account Status</label>
                    <p class="text-lg font-semibold text-green-600">
                        <i class="fas fa-check-circle mr-1"></i>Active
                    </p>
                </div>
                
                {% if user.year_level %}
                <div class="bg-gray-50 p-4 rounded-xl">
                    <label class="block text-sm font-medium text-gray-500 mb-1">Year Level</label>
                    <p class="text-lg font-semibold text-gray-900">{{ user.year_level }}{% if user.year_level == 1 %}st{% elif user.year_level == 2 %}nd{% elif user.year_level == 3 %}rd{% else %}th{% endif %} Year</p>
                </div>
                {% endif %}
                
                {% if user.section %}
                <div class="bg-gray-50 p-4 rounded-xl">
                    <label class="block text-sm font-medium text-gray-500 mb-1">Section</label>
                    <p class="text-lg font-semibold text-gray-900">{{ user.section }}</p>
                </div>
                {% endif %}
                
                <div class="bg-gray-50 p-4 rounded-xl">
                    </p>
                </div>
                
                {% if user.temporary_password_record %}
                <div class="bg-gray-50 p-4 rounded-xl">
                    <label class="block text-sm font-medium text-gray-500 mb-1">Temporary Password</label>
                    <div class="flex items-center space-x-2">
                        <p class="text-lg font-semibold text-gray-900 font-mono" id="profile-password-display" style="display: none;">{{ user.temporary_password_record.password }}</p>
                        <p class="text-lg font-semibold text-gray-900 font-mono" id="profile-password-hidden">••••••••</p>
                        <button type="button" onclick="togglePasswordVisibility()" class="ml-2 px-2 py-1 text-sm text-blue-600 hover:text-blue-800 transition duration-150">
                            <i class="fas fa-eye" id="password-toggle-icon"></i>
                        </button>
                    </div>
                </div>
                {% endif %}
                
                <!-- Custom Password Section -->
                <div class="bg-gray-50 p-4 rounded-xl col-span-1 md:col-span-2">
                    <label class="block text-sm font-medium text-gray-500 mb-2" id="profile-password-label">
                        {% if user.custom_password %}Change Your Password{% else %}Add Your Password{% endif %}
                    </label>
                    {% if user.custom_password %}
                    <div class="mb-3 p-3 bg-white rounded-lg border border-gray-300">
                        <label class="block text-xs font-medium text-gray-600 mb-1">Your Custom Password</label>
                        <div class="flex items-center space-x-2">
                            <p class="text-lg font-semibold text-gray-900 font-mono" id="profile-custom-password-display" style="display: none;">{% if user.custom_password_record %}{{ user.custom_password_record.password }}{% else %}••••••••{% endif %}</p>
                            <p class="text-lg font-semibold text-gray-900 font-mono" id="profile-custom-password-hidden">••••••••</p>
                            <button type="button" onclick="toggleCustomPasswordVisibility()" class="ml-2 px-2 py-1 text-sm text-blue-600 hover:text-blue-800 transition duration-150">
                                <i class="fas fa-eye" id="custom-password-toggle-icon"></i>
                            </button>
                        </div>
                    </div>
                    {% endif %}
                    <div id="profile-password-section" style="display: none;">
                        <div class="space-y-3">
                            {% if user.custom_password %}
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">Current Password</label>
                                <div class="relative">
                                    <input type="password" name="current_password" id="profile-current-password" class="w-full px-3 py-2 pr-10 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white" placeholder="Enter current password">
                                    <button type="button" onclick="togglePasswordFieldVisibility('profile-current-password', 'current-password-toggle')" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700">
                                        <i class="fas fa-eye" id="current-password-toggle"></i>
                                    </button>
                                </div>
                            </div>
                            {% endif %}
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">{% if user.custom_password %}New Password{% else %}Password{% endif %}</label>
                                <div class="relative">
                                    <input type="password" name="new_password" id="profile-new-password" class="w-full px-3 py-2 pr-10 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white" placeholder="Enter {% if user.custom_password %}new {% endif %}password (min 6 characters)">
                                    <button type="button" onclick="togglePasswordFieldVisibility('profile-new-password', 'new-password-toggle')" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700">
                                        <i class="fas fa-eye" id="new-password-toggle"></i>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">Confirm {% if user.custom_password %}New {% endif %}Password</label>
                                <div class="relative">
                                    <input type="password" name="confirm_new_password" id="profile-confirm-password" class="w-full px-3 py-2 pr-10 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white" placeholder="Confirm {% if user.custom_password %}new {% endif %}password">
                                    <button type="button" onclick="togglePasswordFieldVisibility('profile-confirm-password', 'confirm-password-toggle')" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700">
                                        <i class="fas fa-eye" id="confirm-password-toggle"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="button" id="profile-change-password-btn" onclick="togglePasswordSection()" class="mt-2 px-3 py-1.5 text-sm text-blue-600 hover:text-blue-800 transition duration-150 border border-blue-300 rounded-lg hover:bg-blue-50 opacity-50 cursor-not-allowed" disabled>
                        <i class="fas fa-key mr-1"></i><span id="profile-password-btn-text">{% if user.custom_password %}Change Password{% else %}Add Password{% endif %}</span>
                    </button>
                    <p class="text-xs text-gray-500 mt-2 italic" id="profile-password-hint">Please click "Edit Profile" first to enable password changes.</p>
                </div>
            </div>

            <!-- Signup Information -->
            <div class="p-4 rounded-xl border" style="background-color: #DFCFD5; border-color: rgba(60, 71, 112, 0.3);">
                <h5 class="font-semibold mb-3 flex items-center" style="color: #3C4770;">
                    <i class="fas fa-info-circle mr-2"></i>Account Information
                </h5>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Username:</span>
                        <span class="font-mono font-semibold text-gray-900">{{ user.username }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Email:</span>
                        <span class="font-semibold text-gray-900">{{ user.email }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Date Joined:</span>
                        <span class="font-semibold text-gray-900">{{ user.date_joined|date:"F d, Y" }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Last Login:</span>
                        <span class="font-semibold text-gray-900">
                            {% if user.last_login %}{{ user.last_login|date:"F d, Y g:i A" }}{% else %}Never{% endif %}
                        </span>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                <button type="button" id="profile-edit-btn" onclick="enableProfileEdit()" class="px-5 py-2 text-white font-semibold rounded-xl transition duration-150 shadow-md hover:shadow-lg transform hover:scale-105" style="background-color: #3C4770;" onmouseover="this.style.backgroundColor='#447294';" onmouseout="this.style.backgroundColor='#3C4770';">
                    <i class="fas fa-edit mr-2"></i>Edit Profile
                </button>
                <button type="button" id="profile-cancel-btn" onclick="cancelProfileEdit()" class="px-5 py-2 text-gray-700 bg-gray-200 font-semibold rounded-xl hover:bg-gray-300 hover:shadow-md transition duration-150 hidden">
                    Cancel
                </button>
                <button type="submit" id="profile-save-btn" class="px-5 py-2 text-white font-semibold rounded-xl transition duration-150 shadow-md hover:shadow-lg transform hover:scale-105 hidden" style="background-color: #3C4770;" onmouseover="this.style.backgroundColor='#447294';" onmouseout="this.style.backgroundColor='#3C4770';" onclick="showProfileLoadingAnimation()">
                    <i class="fas fa-save mr-2"></i>Save Changes
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Profile Picture Cropper Modal -->
<div id="profile-cropper-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 backdrop-blur-sm hidden z-[120] flex items-center justify-center p-4 overflow-y-auto">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl my-8 p-6 md:p-8 border-2 border-gray-200">
        <div class="flex justify-between items-start mb-6">
            <h3 class="text-2xl font-bold flex items-center" style="color: #3C4770;">
                <i class="fas fa-crop w-6 h-6 mr-2"></i> Crop Profile Picture
            </h3>
            <button onclick="closeProfileCropperModal()" class="text-gray-400 hover:text-gray-600 transition duration-150 hover:opacity-75">
                <i class="fas fa-times w-6 h-6"></i>
            </button>
        </div>
        
        <div class="mb-4">
            <div id="profile-cropper-container-wrapper" class="cropper-container" style="max-height: 500px; min-height: 300px; position: relative;">
                <img id="profile-cropper-image" src="" alt="Crop" style="max-width: 100%; display: block;">
            </div>
        </div>
        
        <div class="flex justify-end space-x-3 pt-6 border-t border-gray-200 bg-gray-50 -mx-6 md:-mx-8 -mb-6 md:-mb-8 px-6 md:px-8 pb-6 md:pb-8 rounded-b-2xl">
            <button type="button" onclick="closeProfileCropperModal()" class="px-5 py-2.5 text-gray-700 bg-white border-2 border-gray-300 font-semibold rounded-xl hover:bg-gray-50 hover:border-gray-400 transition duration-150 shadow-sm hover:shadow-md">
                Done
            </button>
            <button type="button" onclick="applyProfileCrop()" class="px-6 py-2.5 text-white font-semibold rounded-xl transition duration-150 shadow-md hover:shadow-lg border-2 border-green-600" style="background-color: #10b981;" onmouseover="this.style.backgroundColor='#059669'; this.style.borderColor='#047857';" onmouseout="this.style.backgroundColor='#10b981'; this.style.borderColor='#059669';">
                <i class="fas fa-check mr-2"></i> Apply Crop
            </button>
        </div>
    </div>
</div>

<script>
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        const isOpen = !sidebar.classList.contains('-translate-x-full');
        
        if (isOpen) {
            sidebar.classList.add('-translate-x-full');
            overlay.classList.add('hidden');
        } else {
            sidebar.classList.remove('-translate-x-full');
            overlay.classList.remove('hidden');
        }
    }

    function openProfileModal() {
        const modal = document.getElementById('profile-modal');
        if (modal) {
            modal.classList.remove('hidden');
            cancelProfileEdit();
        }
    }

    function closeProfileModal() {
        const modal = document.getElementById('profile-modal');
        if (modal) {
            modal.classList.add('hidden');
            cancelProfileEdit();
        }
    }

    function parseStudentFullName(fullName) {
        const normalized = String(fullName || '').trim().replace(/\s+/g, ' ');
        if (!normalized) {
            return { first: '', middle: '', last: '' };
        }

        const tokens = normalized.split(' ').filter(Boolean);
        if (tokens.length === 1) {
            return { first: tokens[0], middle: '', last: '' };
        }

        const particleTokens = new Set([
            'de', 'del', 'dela', 'da', 'di', 'la', 'las', 'los', 'van', 'von', 'bin', 'binti', 'al', 'ibn'
        ]);

        let lastStart = tokens.length - 1;
        let foundParticle = false;
        for (let i = tokens.length - 2; i >= 1; i--) {
            const t = tokens[i].toLowerCase();
            if (particleTokens.has(t)) {
                lastStart = i;
                foundParticle = true;
                break;
            }
        }

        // Default parsing (no multi-word surname particles detected)
        if (!foundParticle) {
            const first = tokens[0] || '';
            const last = tokens[tokens.length - 1] || '';
            const middle = tokens.length > 2 ? tokens.slice(1, -1).join(' ').trim() : '';
            return { first, middle, last };
        }

        const last = tokens.slice(lastStart).join(' ').trim();
        const remaining = tokens.slice(0, lastStart);

        if (remaining.length === 0) {
            return { first: '', middle: '', last };
        }
        if (remaining.length === 1) {
            return { first: remaining[0], middle: '', last };
        }
        if (remaining.length === 2) {
            return { first: remaining.join(' ').trim(), middle: '', last };
        }

        return {
            first: remaining.slice(0, -1).join(' ').trim(),
            middle: remaining[remaining.length - 1].trim(),
            last
        };
    }
    
    function enableProfileEdit() {
        // Show profile picture upload button
        const pictureLabel = document.getElementById('profile-picture-edit-label');
        if (pictureLabel) {
            pictureLabel.classList.remove('hidden');
        }
        
        // Make name editable (students: First/Middle/Last)
        const nameDisplay = document.getElementById('profile-name-display');
        const fullNameInput = document.getElementById('profile-name-input');
        const nameFields = document.getElementById('profile-name-fields');
        const firstNameInput = document.getElementById('profile-first-name-input');
        const middleNameInput = document.getElementById('profile-middle-name-input');
        const lastNameInput = document.getElementById('profile-last-name-input');
        if (nameDisplay && fullNameInput && nameFields && firstNameInput && middleNameInput && lastNameInput) {
            const originalFullName = (nameDisplay.getAttribute('data-original-value') || '').trim();
            const parsed = parseStudentFullName(originalFullName);
            firstNameInput.value = parsed.first;
            middleNameInput.value = parsed.middle;
            lastNameInput.value = parsed.last;

            nameDisplay.style.display = 'none';
            nameFields.style.display = 'grid';
            firstNameInput.focus();
        }
        
        // Make department editable - keep current value
        const departmentDisplay = document.getElementById('profile-department-display');
        const departmentInput = document.getElementById('profile-department-input');
        if (departmentDisplay && departmentInput) {
            departmentInput.value = departmentDisplay.textContent.trim();  // Keep the current value
            departmentDisplay.style.display = 'none';
            departmentInput.style.display = 'block';
            departmentInput.focus();
        }
        
        // Make program editable - keep current value
        const programDisplay = document.getElementById('profile-program-display');
        const programInput = document.getElementById('profile-program-input');
        if (programDisplay && programInput) {
            programInput.value = programDisplay.textContent.trim();  // Keep the current value
            programDisplay.style.display = 'none';
            programInput.style.display = 'block';
        }
        
        // Enable password button
        const changePasswordBtn = document.getElementById('profile-change-password-btn');
        const passwordHint = document.getElementById('profile-password-hint');
        if (changePasswordBtn) {
            changePasswordBtn.disabled = false;
            changePasswordBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
        if (passwordHint) {
            passwordHint.style.display = 'none';
        }
        
        // Show/hide buttons
        const editBtn = document.getElementById('profile-edit-btn');
        const cancelBtn = document.getElementById('profile-cancel-btn');
        const saveBtn = document.getElementById('profile-save-btn');
        
        if (editBtn) editBtn.classList.add('hidden');
        if (cancelBtn) cancelBtn.classList.remove('hidden');
        if (saveBtn) saveBtn.classList.remove('hidden');
    }
    
    function cancelProfileEdit() {
        // Hide profile picture upload button
        const pictureLabel = document.getElementById('profile-picture-edit-label');
        if (pictureLabel) {
            pictureLabel.classList.add('hidden');
        }
        
        // Reset profile picture input
        const pictureInput = document.getElementById('profile_picture_input');
        if (pictureInput) {
            pictureInput.value = '';
        }
        
        // Reset name fields
        const nameDisplay = document.getElementById('profile-name-display');
        const fullNameInput = document.getElementById('profile-name-input');
        const nameFields = document.getElementById('profile-name-fields');
        const firstNameInput = document.getElementById('profile-first-name-input');
        const middleNameInput = document.getElementById('profile-middle-name-input');
        const lastNameInput = document.getElementById('profile-last-name-input');
        if (nameDisplay && fullNameInput && nameFields && firstNameInput && middleNameInput && lastNameInput) {
            const originalValue = (nameDisplay.getAttribute('data-original-value') || '').trim();
            const parsed = parseStudentFullName(originalValue);
            firstNameInput.value = parsed.first;
            middleNameInput.value = parsed.middle;
            lastNameInput.value = parsed.last;
            fullNameInput.value = originalValue;

            nameDisplay.style.display = 'block';
            nameFields.style.display = 'none';
        }
        
        // Reset department field - revert to display mode
        const departmentDisplay = document.getElementById('profile-department-display');
        const departmentInput = document.getElementById('profile-department-input');
        if (departmentDisplay && departmentInput) {
            departmentInput.value = '';  // Clear input when canceling
            departmentDisplay.style.display = 'block';
            departmentInput.style.display = 'none';
        }
        
        // Reset program field - revert to display mode
        const programDisplay = document.getElementById('profile-program-display');
        const programInput = document.getElementById('profile-program-input');
        if (programDisplay && programInput) {
            programInput.value = '';  // Clear input when canceling
            programDisplay.style.display = 'block';
            programInput.style.display = 'none';
        }
        
        // Reset password section
        const passwordSection = document.getElementById('profile-password-section');
        const changePasswordBtn = document.getElementById('profile-change-password-btn');
        const passwordHint = document.getElementById('profile-password-hint');
        const passwordBtnText = document.getElementById('profile-password-btn-text');
        const hasCustomPassword = '{{ user.custom_password|yesno:"true,false" }}' === 'True';
        
        if (passwordSection && changePasswordBtn) {
            passwordSection.style.display = 'none';
            if (passwordBtnText) {
                passwordBtnText.textContent = hasCustomPassword ? 'Change Password' : 'Add Password';
            }
            changePasswordBtn.classList.remove('text-gray-600', 'border-gray-300', 'hover:bg-gray-50');
            changePasswordBtn.classList.add('text-blue-600', 'border-blue-300', 'hover:bg-blue-50');
            changePasswordBtn.disabled = true;
            changePasswordBtn.classList.add('opacity-50', 'cursor-not-allowed');
            // Clear password fields
            const currentPassword = document.getElementById('profile-current-password');
            const newPassword = document.getElementById('profile-new-password');
            const confirmPassword = document.getElementById('profile-confirm-password');
            if (currentPassword) currentPassword.value = '';
            if (newPassword) newPassword.value = '';
            if (confirmPassword) confirmPassword.value = '';
        }
        if (passwordHint) {
            passwordHint.style.display = 'block';
        }
        
        // Show/hide buttons
        const editBtn = document.getElementById('profile-edit-btn');
        const cancelBtn = document.getElementById('profile-cancel-btn');
        const saveBtn = document.getElementById('profile-save-btn');
        
        if (editBtn) editBtn.classList.remove('hidden');
        if (cancelBtn) cancelBtn.classList.add('hidden');
        if (saveBtn) saveBtn.classList.add('hidden');
    }
    
    function togglePasswordFieldVisibility(fieldId, toggleIconId) {
        const passwordField = document.getElementById(fieldId);
        const toggleIcon = document.getElementById(toggleIconId);
        
        if (passwordField && toggleIcon) {
            if (passwordField.type === 'password') {
                passwordField.type = 'text';
                toggleIcon.classList.remove('fa-eye');
                toggleIcon.classList.add('fa-eye-slash');
            } else {
                passwordField.type = 'password';
                toggleIcon.classList.remove('fa-eye-slash');
                toggleIcon.classList.add('fa-eye');
            }
        }
    }
    
    function togglePasswordSection() {
        const changePasswordBtn = document.getElementById('profile-change-password-btn');
        const saveBtn = document.getElementById('profile-save-btn');
        
        // Check if edit mode is enabled
        if (!saveBtn || saveBtn.classList.contains('hidden')) {
            if (typeof showNotification === 'function') {
                showNotification('Please click "Edit Profile" first to enable password changes.', 'warning');
            } else {
                alert('Please click "Edit Profile" first to enable password changes.');
            }
            return;
        }
        
        const passwordSection = document.getElementById('profile-password-section');
        const passwordLabel = document.getElementById('profile-password-label');
        const passwordBtnText = document.getElementById('profile-password-btn-text');
        const hasCustomPassword = '{{ user.custom_password|yesno:"true,false" }}' === 'True';
        
        if (passwordSection && changePasswordBtn) {
            if (passwordSection.style.display === 'none') {
                passwordSection.style.display = 'block';
                if (passwordBtnText) {
                    passwordBtnText.textContent = hasCustomPassword ? 'Cancel Password Change' : 'Cancel Add Password';
                }
                changePasswordBtn.classList.remove('text-blue-600', 'border-blue-300', 'hover:bg-blue-50');
                changePasswordBtn.classList.add('text-gray-600', 'border-gray-300', 'hover:bg-gray-50');
            } else {
                passwordSection.style.display = 'none';
                if (passwordBtnText) {
                    passwordBtnText.textContent = hasCustomPassword ? 'Change Password' : 'Add Password';
                }
                changePasswordBtn.classList.remove('text-gray-600', 'border-gray-300', 'hover:bg-gray-50');
                changePasswordBtn.classList.add('text-blue-600', 'border-blue-300', 'hover:bg-blue-50');
                // Clear password fields
                const currentPassword = document.getElementById('profile-current-password');
                const newPassword = document.getElementById('profile-new-password');
                const confirmPassword = document.getElementById('profile-confirm-password');
                if (currentPassword) currentPassword.value = '';
                if (newPassword) newPassword.value = '';
                if (confirmPassword) confirmPassword.value = '';
            }
        }
    }
    
    function cancelProfileEdit() {
        // Hide profile picture upload button
        const pictureLabel = document.getElementById('profile-picture-edit-label');
        if (pictureLabel) {
            pictureLabel.classList.add('hidden');
        }
        
        // Reset profile picture input and preview
        const pictureInput = document.getElementById('profile_picture_input');
        if (pictureInput) {
            pictureInput.value = '';
        }
        
        // Reset profile picture preview to original
        const preview = document.getElementById('profile-picture-preview');
        const placeholder = document.getElementById('profile-picture-placeholder');
        if (preview && placeholder) {
            // Check if there's an original image
            const originalSrc = preview.getAttribute('data-original-src');
            if (originalSrc) {
                preview.src = originalSrc;
                preview.style.display = 'block';
                preview.classList.remove('hidden');
                placeholder.style.display = 'none';
                placeholder.classList.add('hidden');
            } else {
                preview.style.display = 'none';
                preview.classList.add('hidden');
                placeholder.style.display = 'flex';
                placeholder.classList.remove('hidden');
            }
        }
        
        // Show/hide buttons
        const editBtn = document.getElementById('profile-edit-btn');
        const cancelBtn = document.getElementById('profile-cancel-btn');
        const saveBtn = document.getElementById('profile-save-btn');
        
        if (editBtn) editBtn.classList.remove('hidden');
        if (cancelBtn) cancelBtn.classList.add('hidden');
        if (saveBtn) saveBtn.classList.add('hidden');
    }
    
    // Profile picture cropper instance
    let profilePictureCropper = null;
    
    function openProfilePictureCropper(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            
            if (!file.type.startsWith('image/')) {
                if (typeof showNotification === 'function') {
                    showNotification('Please select a valid image file.', 'error');
                } else {
                    alert('Please select a valid image file.');
                }
                input.value = '';
                return;
            }
            
            if (file.size > 10 * 1024 * 1024) {
                if (typeof showNotification === 'function') {
                    showNotification('Image size must be less than 10MB.', 'error');
                } else {
                    alert('Image size must be less than 10MB.');
                }
                input.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('profile-cropper-image').src = e.target.result;
                document.getElementById('profile-cropper-modal').classList.remove('hidden');
                
                setTimeout(() => {
                    const image = document.getElementById('profile-cropper-image');
                    if (profilePictureCropper) {
                        profilePictureCropper.destroy();
                    }
                    profilePictureCropper = new Cropper(image, {
                        aspectRatio: 1,
                        viewMode: 1,
                        dragMode: 'move',
                        autoCropArea: 0.8,
                        restore: false,
                        guides: true,
                        center: true,
                        highlight: false,
                        cropBoxMovable: true,
                        cropBoxResizable: true,
                        toggleDragModeOnDblclick: false,
                    });
                }, 100);
            };
            reader.readAsDataURL(file);
        }
    }
    
    function closeProfileCropperModal() {
        document.getElementById('profile-cropper-modal').classList.add('hidden');
        if (profilePictureCropper) {
            profilePictureCropper.destroy();
            profilePictureCropper = null;
        }
    }
    
    function applyProfileCrop() {
        if (!profilePictureCropper) {
            closeProfileCropperModal();
            return;
        }
        
        const canvas = profilePictureCropper.getCroppedCanvas({
            width: 400,
            height: 400,
            imageSmoothingEnabled: true,
            imageSmoothingQuality: 'high',
        });
        
        if (canvas) {
            canvas.toBlob(function(blob) {
                if (blob) {
                    const file = new File([blob], 'cropped-profile.png', { type: 'image/png' });
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    
                    const input = document.getElementById('profile_picture_input');
                    if (input) {
                        input.files = dataTransfer.files;
                    }
                    
                    const profileImg = document.getElementById('profile-picture-preview');
                    const profileDiv = document.getElementById('profile-picture-placeholder');
                    const previewDataUrl = canvas.toDataURL('image/png');
                    
                    if (profileImg) {
                        profileImg.src = previewDataUrl;
                        profileImg.style.display = 'block';
                        profileImg.classList.remove('hidden');
                        if (profileDiv) {
                            profileDiv.style.display = 'none';
                            profileDiv.classList.add('hidden');
                        }
                    } else if (profileDiv) {
                        const newImg = document.createElement('img');
                        newImg.id = 'profile-picture-preview';
                        newImg.src = previewDataUrl;
                        newImg.alt = 'Profile';
                        newImg.className = 'w-24 h-24 rounded-full object-cover border-4';
                        newImg.style.borderColor = 'rgba(190, 129, 153, 0.3)';
                        profileDiv.parentNode.replaceChild(newImg, profileDiv);
                    }
                    
                    updateTopBarProfilePicture(canvas.toDataURL('image/png'));
                    closeProfileCropperModal();
                }
            }, 'image/png', 0.9);
        }
    }
    
    function updateTopBarProfilePicture(imageSrc) {
        // Update top bar right side (profile button)
        const topbarImg = document.getElementById('topbar-profile-picture');
        const topbarPlaceholder = document.getElementById('topbar-profile-placeholder');
        
        if (topbarImg) {
            topbarImg.src = imageSrc;
            topbarImg.style.display = 'block';
            topbarImg.classList.remove('hidden');
            if (topbarPlaceholder) {
                topbarPlaceholder.style.display = 'none';
                topbarPlaceholder.classList.add('hidden');
            }
        } else if (topbarPlaceholder) {
            const newImg = document.createElement('img');
            newImg.id = 'topbar-profile-picture';
            newImg.src = imageSrc;
            newImg.alt = 'Profile';
            newImg.className = 'h-8 w-8 rounded-full object-cover border-2 border-white flex-shrink-0';
            topbarPlaceholder.parentNode.replaceChild(newImg, topbarPlaceholder);
        }
        
        // Update sidebar
        const sidebarImg = document.getElementById('sidebar-profile-picture');
        const sidebarPlaceholder = document.getElementById('sidebar-profile-placeholder');
        
        if (sidebarImg) {
            sidebarImg.src = imageSrc;
            sidebarImg.style.display = 'block';
            sidebarImg.classList.remove('hidden');
            if (sidebarPlaceholder) {
                sidebarPlaceholder.style.display = 'none';
                sidebarPlaceholder.classList.add('hidden');
            }
        } else if (sidebarPlaceholder) {
            const newImg = document.createElement('img');
            newImg.id = 'sidebar-profile-picture';
            newImg.src = imageSrc;
            newImg.alt = 'Profile';
            newImg.className = 'w-10 h-10 rounded-full object-cover border-2 border-white flex-shrink-0';
            sidebarPlaceholder.parentNode.replaceChild(newImg, sidebarPlaceholder);
        }
    }
    
    function togglePasswordVisibility() {
        const passwordDisplay = document.getElementById('profile-password-display');
        const passwordHidden = document.getElementById('profile-password-hidden');
        const toggleIcon = document.getElementById('password-toggle-icon');
        
        if (passwordDisplay && passwordHidden && toggleIcon) {
            if (passwordDisplay.style.display === 'none') {
                passwordDisplay.style.display = 'block';
                passwordHidden.style.display = 'none';
                toggleIcon.classList.remove('fa-eye');
                toggleIcon.classList.add('fa-eye-slash');
            } else {
                passwordDisplay.style.display = 'none';
                passwordHidden.style.display = 'block';
                toggleIcon.classList.remove('fa-eye-slash');
                toggleIcon.classList.add('fa-eye');
            }
        }
    }
    
    function toggleCustomPasswordVisibility() {
        const passwordDisplay = document.getElementById('profile-custom-password-display');
        const passwordHidden = document.getElementById('profile-custom-password-hidden');
        const toggleIcon = document.getElementById('custom-password-toggle-icon');
        
        if (passwordDisplay && passwordHidden && toggleIcon) {
            if (passwordDisplay.style.display === 'none') {
                passwordDisplay.style.display = 'block';
                passwordHidden.style.display = 'none';
                toggleIcon.classList.remove('fa-eye');
                toggleIcon.classList.add('fa-eye-slash');
            } else {
                passwordDisplay.style.display = 'none';
                passwordHidden.style.display = 'block';
                toggleIcon.classList.remove('fa-eye-slash');
                toggleIcon.classList.add('fa-eye');
            }
        }
    }

    // Close modal when clicking outside
    document.getElementById('profile-modal')?.addEventListener('click', function(e) {
        if (e.target === this) {
            closeProfileModal();
        }
    });
    
    // Handle profile form submission
    const profileForm = document.getElementById('profileForm');
    if (profileForm) {
        profileForm.addEventListener('submit', function(e) {
            e.preventDefault();

            // Combine First/Middle/Last into full_name before building FormData
            const firstNameInput = document.getElementById('profile-first-name-input');
            const middleNameInput = document.getElementById('profile-middle-name-input');
            const lastNameInput = document.getElementById('profile-last-name-input');
            const fullNameInput = document.getElementById('profile-name-input');
            if (fullNameInput && firstNameInput && lastNameInput) {
                const first = (firstNameInput.value || '').trim();
                const middle = (middleNameInput ? (middleNameInput.value || '').trim() : '');
                const last = (lastNameInput.value || '').trim();
                if (!first || !last) {
                    if (typeof showNotification === 'function') {
                        showNotification('First Name and Last Name are required.', 'error');
                    } else {
                        alert('First Name and Last Name are required.');
                    }
                    return;
                }
                fullNameInput.value = [first, middle, last].filter(Boolean).join(' ').trim();
            }
            
            const formData = new FormData(this);
            const saveBtn = document.getElementById('profile-save-btn');
            const originalText = saveBtn ? saveBtn.innerHTML : '';
            
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
            }
            
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            })
            .then(response => response.json())
            .then(data => {
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = originalText;
                }
                
                if (data.success) {
                    // No notification needed - loading animation will be visible
                    
                    // Update profile picture in topbar and sidebar if provided
                    if (data.profile_picture_url) {
                        updateTopBarProfilePicture(data.profile_picture_url);
                    } else {
                        // If we have a cropped preview, use that
                        const profilePreview = document.getElementById('profile-picture-preview');
                        if (profilePreview && profilePreview.src && profilePreview.src.startsWith('data:')) {
                            updateTopBarProfilePicture(profilePreview.src);
                        }
                    }
                    
                    // Update display values with uppercase formatting using response data
                    const departmentDisplay = document.getElementById('profile-department-display');
                    const programDisplay = document.getElementById('profile-program-display');
                    const programInput = document.getElementById('profile-program-input');
                    
                    if (departmentDisplay && data.department) {
                        const deptValue = data.department.toUpperCase();
                        departmentDisplay.textContent = deptValue;
                        departmentDisplay.style.textTransform = 'uppercase';
                    }
                    
                    if (programDisplay && data.program) {
                        const progValue = data.program.toUpperCase();
                        programDisplay.textContent = progValue;
                        programDisplay.style.textTransform = 'uppercase';
                        console.log('Updated program display to:', progValue);
                    }
                    
                    // Update program input data attributes for next cancel/edit
                    if (programInput && data.program && data.program !== 'NOT ASSIGNED') {
                        // Parse the program string to extract code and name
                        if (data.program.includes(' - ')) {
                            const parts = data.program.split(' - ');
                            const code = parts[0].trim().toUpperCase();
                            const name = parts.slice(1).join(' - ').trim().toUpperCase();
                            programInput.setAttribute('data-program-code', code);
                            programInput.setAttribute('data-program-name', name);
                            programInput.value = `${code} - ${name}`;
                            console.log('Program data attributes updated - code:', code, 'name:', name);
                        } else {
                            programInput.setAttribute('data-program-code', '');
                            programInput.setAttribute('data-program-name', data.program.toUpperCase());
                            programInput.value = data.program.toUpperCase();
                        }
                    } else if (programInput) {
                        // Clear attributes if "NOT ASSIGNED"
                        programInput.setAttribute('data-program-code', '');
                        programInput.setAttribute('data-program-name', '');
                        programInput.value = 'NOT ASSIGNED';
                    }
                    
                    cancelProfileEdit();
                    
                    // Reload after notification shows
                    setTimeout(() => {
                        window.location.reload(true);
                    }, 1500);
                } else {
                    if (typeof showNotification === 'function') {
                        showNotification(data.message || 'An error occurred', 'error');
                    } else {
                        alert(data.message || 'An error occurred');
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = originalText;
                }
                if (typeof showNotification === 'function') {
                    showNotification('An error occurred while updating profile.', 'error');
                } else {
                    alert('An error occurred while updating profile.');
                }
            });
        });
    }
    
    // Independent scrolling: sidebar scrolls when cursor is over it
    const sidebar = document.getElementById('sidebar');
    const sidebarNav = document.getElementById('sidebar-nav');
    
    if (sidebar) {
        sidebar.addEventListener('wheel', function(e) {
            // Only scroll sidebar if cursor is over it
            if (e.target.closest('#sidebar')) {
                e.stopPropagation();
            }
        });
    }

    // Logout loading animation
    function showLogoutLoadingModal(url) {
        const loadingOverlay = document.createElement('div');
        loadingOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 z-[10000] flex items-center justify-center';
        loadingOverlay.innerHTML = `
            <div class="rainbow-spinner">
                <img src="/static/img/attendance-logo.png" alt="Loading">
            </div>
        `;
        document.body.appendChild(loadingOverlay);
        setTimeout(() => {
            window.location.href = url;
        }, 300);
    }

    window.showLogoutLoadingModal = showLogoutLoadingModal;

    // Profile save loading animation
    function showProfileLoadingAnimation() {
        const loadingOverlay = document.createElement('div');
        loadingOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 z-[10000] flex items-center justify-center';
        loadingOverlay.innerHTML = `
            <div class="rainbow-spinner">
                <img src="/static/img/attendance-logo.png" alt="Loading">
            </div>
        `;
        document.body.appendChild(loadingOverlay);
    }

    window.showProfileLoadingAnimation = showProfileLoadingAnimation;
</script>

