<!--
templates folder: library_system/templates/dashboard/student.html
-->

{% extends 'partials/base.html' %}
{% load static %}
{% block title %}Student Dashboard{% endblock %}
{% block navigation %}
<!-- Override default navigation - no top bar for student -->
{% endblock %}
{% block content %}
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<link rel="stylesheet" href="{% static 'css/mobile_responsive.css' %}">
<style>
    body { 
        font-family: 'Inter', sans-serif; 
        background: #f4f5fb;
    }
    
    /* Ultra-small mobile portrait (320px - 479px) */
    @media (max-width: 479px) {
        .text-3xl {
            font-size: 1.5rem !important;
        }
        
        .text-2xl {
            font-size: 1.25rem !important;
        }
        
        .px-4 {
            padding-left: 0.5rem !important;
            padding-right: 0.5rem !important;
        }
        
        .py-2 {
            padding-top: 0.375rem !important;
            padding-bottom: 0.375rem !important;
        }
        
        .gap-6 {
            gap: 1rem !important;
        }
        
        .gap-4 {
            gap: 0.75rem !important;
        }
        
        .p-5 {
            padding: 0.75rem !important;
        }
        
        .w-12 {
            width: 2rem !important;
        }
        
        .h-12 {
            height: 2rem !important;
        }
        
        .text-xl {
            font-size: 0.875rem !important;
        }
    }
</style>
<style>
    /* Small-screen container fixes to prevent decorative overflow and align content with other pages */
    @media (max-width: 600px) {
        .max-w-7xl.mx-auto, .max-w-4xl.mx-auto { padding-left: 8px; padding-right: 8px; }
        /* Hide large absolute decorative elements that may cause horizontal overflow on small screens */
        .bg-gradient-to-br .absolute, .bg-gradient-to-br .-mr-16, .bg-gradient-to-br .-ml-12 { display: none !important; }
        /* Ensure main content doesn't overflow horizontally */
        #main-content { overflow-x: hidden; }
        /* Prevent inner wrapper from forcing extra height on mobile so content appears at top */
        #main-content { margin-top: 0 !important; padding-top: 0 !important; }
        #main-content > div { min-height: 0 !important; margin-top: 0 !important; }
        /* If an mt-16 class is accidentally present, override it on small screens */
        main#main-content[class*="mt-"] { margin-top: 0 !important; }
          /* Ensure main is positioned below header and fills remaining viewport.
              Use fixed positioning on small screens to avoid layout shifts and ensure
              the main content starts immediately under the header. */
          main#main-content { position: fixed !important; top: calc(var(--header-offset, 64px)) !important; left: 0 !important; right: 0 !important; bottom: 0 !important; height: calc(100vh - var(--header-offset, 64px)) !important; overflow: auto !important; z-index: 10 !important; }
    }
</style>

<!-- Notification System -->
{% include 'dashboard/shared/notification_system.html' %}

<!-- Student Top Bar -->
{% include 'dashboard/student/student_topbar.html' %}

<div id="student-page-wrapper" class="min-h-screen bg-gray-100 flex flex-col lg:flex-row">
    <!-- Sidebar -->
    {% include 'dashboard/student/student_sidebar.html' %}

    <!-- Main Content -->
    <!-- No top margin on mobile; keep lg offset on large screens -->
    <main id="main-content" class="flex-grow p-0 lg:p-3 lg:ml-64 mt-0 lg:mt-16 overflow-y-auto" style="overscroll-behavior: contain;">
        <div class="p-2 md:p-3 bg-white lg:bg-gray-50 flex-grow rounded-lg shadow-inner min-h-full" style="margin-top: 0; padding: 0.25rem 0.35rem;">
            {% block dashboard_content %}
            {% include 'dashboard/student/student_home.html' %}
            {% endblock %}
        </div>
    </main>
</div>
<script>
    /* Mobile header adjustment: position main under fixed header on small screens (<=600px) */
    (function() {
        function adjustStudentMainForHeader() {
            try {
                if (window.innerWidth > 600) {
                    // remove mobile inline styles
                    document.getElementById('main-content')?.style.removeProperty('position');
                    document.getElementById('main-content')?.style.removeProperty('top');
                    document.getElementById('main-content')?.style.removeProperty('left');
                    document.getElementById('main-content')?.style.removeProperty('right');
                    document.getElementById('main-content')?.style.removeProperty('bottom');
                    document.documentElement.style.setProperty('--header-offset', '64px');
                    return;
                }

                // Check if we're on schedule page - use relative positioning instead
                const isSchedulePage = window.location.pathname.includes('/schedule/');
                
                const header = document.getElementById('student-top-bar');
                const main = document.getElementById('main-content');
                const notif = document.getElementById('notification-container');
                if (!main) return;
                let extra = 0;
                if (notif) {
                    const r = notif.getBoundingClientRect();
                    if (r.height > 0) extra = Math.ceil(r.height) + 8;
                }
                const h = header ? Math.ceil(header.getBoundingClientRect().height) : 64;
                const offset = (h + extra);
                try { document.documentElement.style.setProperty('--header-offset', offset + 'px'); } catch (e) {}

                // For schedule page, use relative positioning to let content flow naturally
                if (isSchedulePage) {
                    main.style.position = 'relative';
                    main.style.top = '0';
                    main.style.left = '0';
                    main.style.right = '0';
                    main.style.bottom = 'auto';
                    main.style.height = 'auto';
                    main.style.marginTop = '0px';
                    main.style.margin = '0';
                    main.style.paddingTop = '0px';
                } else {
                    // Position main absolutely under header so content appears immediately below it
                    main.style.position = 'absolute';
                    main.style.top = 'var(--header-offset)';
                    main.style.left = '0';
                    main.style.right = '0';
                    main.style.bottom = 'auto';
                    // Force-remove any top margin classes and inline spacing that may push content down
                    try { main.classList.remove('mt-16'); } catch(e){}
                    try { main.style.marginTop = '0px'; main.style.margin = '0'; main.style.paddingTop = '0px'; } catch(e){}
                    // ensure main height matches the viewport minus header offset
                    try { main.style.height = 'calc(100vh - ' + offset + 'px)'; } catch(e) { main.style.height = 'auto'; }
                }
                main.style.overflow = 'auto';

                // Align sidebar under header
                const aside = document.querySelector('aside#sidebar, aside');
                if (aside) {
                    try { aside.style.top = 'var(--header-offset)'; aside.style.height = 'calc(100vh - var(--header-offset))'; } catch(e){}
                }
                // ensure wrapper doesn't add extra spacing
                const wrapper = document.getElementById('student-page-wrapper');
                if (wrapper) wrapper.style.minHeight = 'auto';
                try { window.scrollTo(0,0); } catch(e){}
            } catch (e) {
                console.error('adjustStudentMainForHeader error', e);
            }
        }
        window.addEventListener('load', adjustStudentMainForHeader);
        window.addEventListener('resize', adjustStudentMainForHeader);
        document.addEventListener('DOMContentLoaded', adjustStudentMainForHeader);
        
        // Add loading effect to dashboard navigation links
        console.log('[STUDENT DASHBOARD] Initializing loading effects');
        
        // Find all dashboard action links (not sidebar, only dashboard content)
        const dashboardLinks = document.querySelectorAll('a[href*="dashboard:"]');
        
        dashboardLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                const href = this.getAttribute('href');
                const isDashboardNav = href && (
                    href.includes('weekly_timetable') ||
                    href.includes('enroll_course') ||
                    href.includes('student_todays_status') ||
                    href.includes('student_attendance_log')
                );
                
                // Only show loading for main dashboard navigation links
                if (isDashboardNav && href !== window.location.pathname) {
                    e.preventDefault();
                    
                    // Show loading overlay
                    const loadingOverlay = document.createElement('div');
                    loadingOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 z-[10000] flex items-center justify-center';
                    loadingOverlay.innerHTML = `
                        <div class="bg-white rounded-lg shadow-2xl p-8 flex flex-col items-center gap-4">
                            <div class="animate-spin">
                                <i class="fas fa-spinner text-4xl" style="color: #4F46E5;"></i>
                            </div>
                            <p class="text-lg font-semibold text-gray-800">Loading...</p>
                            <p class="text-sm text-gray-600">Please wait while we load the page</p>
                        </div>
                    `;
                    document.body.appendChild(loadingOverlay);
                    console.log('[STUDENT DASHBOARD] Loading overlay shown for:', href);
                    
                    // Navigate after short delay
                    setTimeout(() => {
                        window.location.href = href;
                    }, 300);
                }
            });
        });
    })();
</script>
{% endblock %}
