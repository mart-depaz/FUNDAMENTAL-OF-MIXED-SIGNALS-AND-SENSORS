<!DOCTYPE html>
<html>
<head>
    <title>Notification Delete Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
        }
        .code-block {
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            margin: 10px 0;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px 5px 5px 0;
        }
        button:hover {
            background-color: #0056b3;
        }
        .console-output {
            background-color: #222;
            color: #0f0;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .console-output p {
            margin: 2px 0;
        }
        .error {
            color: #ff6b6b;
        }
        .success {
            color: #51cf66;
        }
        .info {
            color: #74c0fc;
        }
        .warning {
            color: #ffd43b;
        }
        .input-group {
            margin: 10px 0;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .input-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Notification Delete System Test & Debugging</h1>
        
        <div class="test-section">
            <h3>1Ô∏è‚É£ CSRF Token Detection</h3>
            <p>Check if CSRF token can be found:</p>
            <button onclick="testCSRFToken()">Test CSRF Token</button>
            <div id="csrfOutput" class="console-output"></div>
        </div>

        <div class="test-section">
            <h3>2Ô∏è‚É£ Notification Element Detection</h3>
            <p>Check if notifications are visible in the DOM:</p>
            <button onclick="testNotificationElements()">Test Elements</button>
            <div id="elementOutput" class="console-output"></div>
        </div>

        <div class="test-section">
            <h3>3Ô∏è‚É£ Manual API Test</h3>
            <p>Test the delete API endpoint directly:</p>
            <div class="input-group">
                <label>Notification ID:</label>
                <input type="number" id="notificationId" placeholder="Enter notification ID">
            </div>
            <button onclick="testDeleteAPI()">Test Delete API</button>
            <div id="apiOutput" class="console-output"></div>
        </div>

        <div class="test-section">
            <h3>4Ô∏è‚É£ JavaScript Console Simulation</h3>
            <p>Simulate the deleteNotification function:</p>
            <div class="input-group">
                <label>Notification ID:</label>
                <input type="number" id="simNotificationId" placeholder="Enter notification ID">
            </div>
            <button onclick="testSimulateDelete()">Simulate Delete Function</button>
            <div id="simOutput" class="console-output"></div>
        </div>

        <div class="test-section">
            <h3>5Ô∏è‚É£ Network Requests Monitor</h3>
            <p>Monitor all network requests from this page</p>
            <button onclick="enableNetworkMonitoring()">Enable Network Monitoring</button>
            <button onclick="clearNetworkLog()">Clear Network Log</button>
            <div id="networkOutput" class="console-output"></div>
        </div>

        <div class="test-section">
            <h3>üìã System Information</h3>
            <button onclick="showSystemInfo()">Show System Info</button>
            <div id="sysOutput" class="console-output"></div>
        </div>
    </div>

    <script>
        // Utility function to add output to console
        function addOutput(elementId, text, type = 'info') {
            const output = document.getElementById(elementId);
            const p = document.createElement('p');
            p.className = type;
            p.textContent = `[${new Date().toLocaleTimeString()}] ${text}`;
            output.appendChild(p);
            output.scrollTop = output.scrollHeight;
        }

        function clearOutput(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        // Test 1: CSRF Token
        function testCSRFToken() {
            clearOutput('csrfOutput');
            addOutput('csrfOutput', 'üîç Searching for CSRF token...', 'info');
            
            // Method 1: From hidden input
            let token = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
            if (token) {
                addOutput('csrfOutput', `‚úÖ Found in hidden input: ${token.substring(0, 20)}...`, 'success');
                return;
            }
            
            // Method 2: From cookies
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [name, value] = cookie.trim().split('=');
                if (name === 'csrftoken') {
                    token = decodeURIComponent(value);
                    addOutput('csrfOutput', `‚úÖ Found in cookies: ${token.substring(0, 20)}...`, 'success');
                    return;
                }
            }
            
            addOutput('csrfOutput', '‚ùå CSRF token not found! This will cause POST requests to fail.', 'error');
        }

        // Test 2: Notification Elements
        function testNotificationElements() {
            clearOutput('elementOutput');
            addOutput('elementOutput', 'üîç Searching for notification elements...', 'info');
            
            const notifications = document.querySelectorAll('[data-notification-id]');
            addOutput('elementOutput', `Found ${notifications.length} notification(s)`, 
                notifications.length > 0 ? 'success' : 'warning');
            
            notifications.forEach((notif, i) => {
                const id = notif.dataset.notificationId;
                const deleteBtn = notif.querySelector('.deleteNotificationBtn');
                addOutput('elementOutput', 
                    `  [${i+1}] ID: ${id}, Delete button: ${deleteBtn ? '‚úÖ' : '‚ùå'}`, 
                    'info');
            });

            if (notifications.length === 0) {
                addOutput('elementOutput', '‚ÑπÔ∏è No notifications found in DOM. Make sure notifications are loaded.', 'warning');
            }
        }

        // Test 3: Delete API
        async function testDeleteAPI() {
            clearOutput('apiOutput');
            const notifId = document.getElementById('notificationId').value;
            
            if (!notifId) {
                addOutput('apiOutput', '‚ùå Please enter a notification ID', 'error');
                return;
            }

            addOutput('apiOutput', `üöÄ Testing DELETE API for notification ID: ${notifId}`, 'info');

            // Get CSRF token
            let csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
            if (!csrfToken) {
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    const [name, value] = cookie.trim().split('=');
                    if (name === 'csrftoken') {
                        csrfToken = decodeURIComponent(value);
                        break;
                    }
                }
            }

            if (!csrfToken) {
                addOutput('apiOutput', '‚ùå CSRF token not found!', 'error');
                return;
            }

            const url = `/dashboard/notifications/${notifId}/delete/`;
            addOutput('apiOutput', `URL: ${url}`, 'info');
            addOutput('apiOutput', `CSRF Token: ${csrfToken.substring(0, 20)}...`, 'info');

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/json',
                    }
                });

                addOutput('apiOutput', `üì® Response status: ${response.status}`, 
                    response.ok ? 'success' : 'error');

                const data = await response.json();
                addOutput('apiOutput', `üìä Response data: ${JSON.stringify(data)}`, 
                    data.success ? 'success' : 'error');

                if (data.success) {
                    addOutput('apiOutput', '‚úÖ Notification deleted successfully!', 'success');
                } else {
                    addOutput('apiOutput', `‚ùå API returned error: ${data.message}`, 'error');
                }
            } catch (error) {
                addOutput('apiOutput', `‚ùå Fetch error: ${error.message}`, 'error');
                addOutput('apiOutput', `Stack: ${error.stack}`, 'error');
            }
        }

        // Test 4: Simulate Delete
        function testSimulateDelete() {
            clearOutput('simOutput');
            const notifId = document.getElementById('simNotificationId').value;
            
            if (!notifId) {
                addOutput('simOutput', '‚ùå Please enter a notification ID', 'error');
                return;
            }

            addOutput('simOutput', `üé≠ Simulating deleteNotification(${notifId})`, 'info');

            const csrfToken = testGetCSRF();
            const notificationEl = document.querySelector(`[data-notification-id="${notifId}"]`);
            
            addOutput('simOutput', `CSRF Token: ${csrfToken ? '‚úÖ' : '‚ùå'}`, 
                csrfToken ? 'success' : 'error');
            addOutput('simOutput', `Notification element: ${notificationEl ? '‚úÖ' : '‚ùå'}`, 
                notificationEl ? 'success' : 'error');

            if (!notificationEl) {
                addOutput('simOutput', `‚ùå No notification element found with ID ${notifId}`, 'error');
                return;
            }

            addOutput('simOutput', 'üìù Would add fade-out animation...', 'info');
            addOutput('simOutput', '‚è±Ô∏è Would wait 300ms...', 'info');
            addOutput('simOutput', 'üöÄ Would send POST request to /dashboard/notifications/' + notifId + '/delete/', 'info');
        }

        function testGetCSRF() {
            let token = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
            if (!token) {
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    const [name, value] = cookie.trim().split('=');
                    if (name === 'csrftoken') {
                        token = decodeURIComponent(value);
                        break;
                    }
                }
            }
            return token;
        }

        // Test 5: Network Monitoring
        const originalFetch = window.fetch;
        let networkLog = [];

        function enableNetworkMonitoring() {
            clearOutput('networkOutput');
            clearOutput('networkOutput');
            addOutput('networkOutput', 'üì° Network monitoring enabled', 'success');
            
            window.fetch = function(...args) {
                const [resource, config] = args;
                const method = (config?.method || 'GET').toUpperCase();
                const url = resource.toString();
                
                addOutput('networkOutput', 
                    `üì§ ${method} ${url}`, 'info');
                
                return originalFetch.apply(this, args)
                    .then(response => {
                        addOutput('networkOutput', 
                            `üì• Response: ${response.status} ${response.statusText}`, 
                            response.ok ? 'success' : 'error');
                        return response;
                    })
                    .catch(error => {
                        addOutput('networkOutput', 
                            `‚ùå Error: ${error.message}`, 'error');
                        throw error;
                    });
            };
        }

        function clearNetworkLog() {
            clearOutput('networkOutput');
            addOutput('networkOutput', 'üóëÔ∏è Network log cleared', 'info');
        }

        // Test 6: System Info
        function showSystemInfo() {
            clearOutput('sysOutput');
            
            const info = {
                'User Agent': navigator.userAgent.substring(0, 50) + '...',
                'Current URL': window.location.href,
                'Page Title': document.title,
                'Cookies Enabled': navigator.cookieEnabled ? '‚úÖ' : '‚ùå',
                'LocalStorage Available': typeof(Storage) !== 'undefined' ? '‚úÖ' : '‚ùå',
                'JavaScript Version': 'ES' + (function() {
                    try {
                        eval('(() => {})');
                        return '6+';
                    } catch {
                        return '5';
                    }
                })()
            };

            for (const [key, value] of Object.entries(info)) {
                addOutput('sysOutput', `${key}: ${value}`, 'info');
            }

            // Check for Django
            if (window.django) {
                addOutput('sysOutput', 'Django: ‚úÖ Available', 'success');
            } else {
                addOutput('sysOutput', 'Django: ‚ùå Not available', 'warning');
            }

            // Check for jQuery
            if (window.jQuery) {
                addOutput('sysOutput', `jQuery: ‚úÖ ${window.jQuery.fn.jquery}`, 'success');
            } else {
                addOutput('sysOutput', 'jQuery: ‚ùå Not available', 'warning');
            }
        }

        // Auto-show initial info on load
        window.addEventListener('load', function() {
            addOutput('elementOutput', '‚è≥ Waiting for user action...', 'info');
        });
    </script>
</body>
</html>
